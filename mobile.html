<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>WeldPro Mobile</title>
<style>
:root {
  --blue: #0078D4;
  --blue-dark: #005a9e;
  --green: #10b981;
  --red: #ef4444;
  --orange: #f59e0b;
  --gray: #6b7280;
  --bg: #f3f4f6;
  --white: #ffffff;
  --nav-h: 64px;
  --header-h: 56px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  overflow: hidden;
  height: 100vh;
  width: 100vw;
}

/* ===== HEADER ===== */
.header {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--header-h);
  background: var(--blue);
  color: white;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.header-title { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
.header-sub { font-size: 11px; opacity: 0.8; margin-top: 1px; }
.header-user {
  font-size: 13px; background: rgba(255,255,255,0.2);
  padding: 6px 12px; border-radius: 20px; cursor: pointer;
  border: none; color: white;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--nav-h);
  background: white;
  border-top: 1px solid #e5e7eb;
  display: flex;
  z-index: 1000;
  box-shadow: 0 -2px 12px rgba(0,0,0,0.1);
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  border: none; background: transparent; cursor: pointer;
  font-size: 10px; color: var(--gray); gap: 3px;
  transition: background 0.15s;
  touch-action: manipulation;
}
.nav-btn .icon { font-size: 24px; }
.nav-btn.active { color: var(--blue); background: #eff6ff; }
.nav-btn.active .icon { transform: scale(1.1); }

/* ===== PAGES ===== */
.page {
  position: fixed; top: var(--header-h); bottom: var(--nav-h); left: 0; right: 0;
  overflow-y: auto; overflow-x: hidden;
  display: none;
  -webkit-overflow-scrolling: touch;
}
.page.active { display: block; }



/* ===== KNIZNICA ===== */
.part-tab {
  padding: 6px 14px; border: 1.5px solid #d1d5db; border-radius: 20px;
  background: white; font-size: 13px; font-weight: 600; cursor: pointer;
  white-space: nowrap; touch-action: manipulation; color: #374151;
  flex-shrink: 0;
}
.part-tab.active { background: var(--blue); border-color: var(--blue); color: white; }

/* ===== KNIZNICA ===== */
.search-bar {
  padding: 12px 16px;
  background: white;
  border-bottom: 1px solid #e5e7eb;
  position: sticky; top: 0; z-index: 10;
}
.search-input {
  width: 100%; padding: 10px 14px; border: 1.5px solid #d1d5db;
  border-radius: 10px; font-size: 15px; outline: none;
  background: var(--bg);
}
.search-input:focus { border-color: var(--blue); background: white; }

.project-card {
  margin: 8px 12px; background: white; border-radius: 12px;
  padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  cursor: pointer; touch-action: manipulation;
  border: 2px solid transparent; transition: border-color 0.15s;
  display: flex; align-items: center; gap: 14px;
}
.project-card:active { border-color: var(--blue); background: #eff6ff; }
.project-icon { font-size: 32px; flex-shrink: 0; }
.project-info { flex: 1; min-width: 0; }
.project-name { font-size: 14px; font-weight: 600; color: #111; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.project-meta { font-size: 12px; color: var(--gray); margin-top: 2px; }
.project-part { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; color: white; }
.part-SUL { background: #3b82f6; }
.part-LIG { background: #10b981; }
.part-DRY { background: #f59e0b; }
.part-FLA { background: #8b5cf6; }
.part-LHT { background: #ef4444; }
.part-other { background: #6b7280; }

.section-header {
  padding: 10px 16px 4px;
  font-size: 11px; font-weight: 700; color: var(--gray);
  text-transform: uppercase; letter-spacing: 0.5px;
}

/* ===== MONTAZ ===== */
#montazPage { overflow: hidden; display: none; flex-direction: column; }
#montazPage.active { display: flex; }

.montaz-toolbar {
  background: #1e293b; padding: 8px 12px;
  display: flex; gap: 8px; align-items: center;
  overflow-x: auto; flex-shrink: 0;
  scrollbar-width: none;
}
.montaz-toolbar::-webkit-scrollbar { display: none; }

.tool-btn {
  padding: 8px 14px; border: none; border-radius: 8px;
  font-size: 12px; font-weight: 600; cursor: pointer;
  white-space: nowrap; touch-action: manipulation;
  background: #334155; color: #94a3b8;
  transition: all 0.15s; flex-shrink: 0;
}
.tool-btn.active { background: var(--blue); color: white; }
.tool-btn.green { background: #064e3b; color: #34d399; }
.tool-btn.green.active { background: var(--green); color: white; }
.tool-btn.red { background: #450a0a; color: #f87171; }

.canvas-container {
  flex: 1; overflow: auto; background: #f8fafc;
  touch-action: pan-x pan-y;
  -webkit-overflow-scrolling: touch;
  position: relative;
}
canvas#mca { display: block; }

.montaz-info {
  background: #1e293b; color: #94a3b8;
  padding: 6px 12px; font-size: 11px;
  display: flex; justify-content: space-between; align-items: center;
  flex-shrink: 0;
}
.montaz-info span { color: white; font-weight: 600; }

/* ===== WELDBOOK ===== */
.wb-filters {
  background: white; padding: 10px 12px;
  border-bottom: 1px solid #e5e7eb;
  position: sticky; top: 0; z-index: 10;
  display: flex; flex-direction: column; gap: 8px;
}
.wb-filters-row { display: flex; gap: 8px; }
.wb-select {
  flex: 1; padding: 8px 10px; border: 1.5px solid #d1d5db;
  border-radius: 8px; font-size: 13px; outline: none;
  background: var(--bg); min-width: 0;
}
.wb-select:focus { border-color: var(--blue); }
.wb-search {
  width: 100%; padding: 8px 12px; border: 1.5px solid #d1d5db;
  border-radius: 8px; font-size: 13px; outline: none; background: var(--bg);
}
.wb-count { font-size: 12px; color: var(--gray); text-align: right; padding: 0 2px; }

.wb-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.wb-table {
  width: 100%; border-collapse: collapse; font-size: 13px;
  min-width: 500px;
}
.wb-table thead { background: #1e293b; color: white; position: sticky; top: 0; z-index: 5; }
.wb-table th { padding: 10px 8px; text-align: left; font-weight: 600; white-space: nowrap; font-size: 11px; }
.wb-table td { padding: 10px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
.wb-table tr:active td { background: #eff6ff; }
.wb-table tr { cursor: pointer; }
.weld-status {
  width: 10px; height: 10px; border-radius: 50%; display: inline-block; flex-shrink: 0;
}
.status-done { background: var(--green); }
.status-todo { background: #d1d5db; }

/* ===== MODALS ===== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
  display: none; align-items: flex-end; justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal-sheet {
  background: white; border-radius: 20px 20px 0 0; width: 100%; max-width: 480px;
  padding: 0; max-height: 90vh; overflow-y: auto;
  animation: slideUp 0.25s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle {
  width: 40px; height: 4px; background: #d1d5db; border-radius: 2px;
  margin: 12px auto 0;
}
.modal-title { padding: 16px 20px 12px; font-size: 18px; font-weight: 700; }
.modal-body { padding: 0 20px 20px; }
.modal-label { font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.4px; }
.modal-input {
  width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb;
  border-radius: 10px; font-size: 16px; outline: none; margin-bottom: 12px;
}
.modal-input:focus { border-color: var(--blue); }
.modal-row { display: flex; gap: 10px; margin-top: 16px; }
.btn-primary {
  flex: 2; padding: 14px; background: var(--green); color: white;
  border: none; border-radius: 10px; font-size: 16px; font-weight: 700;
  cursor: pointer; touch-action: manipulation;
}
.btn-secondary {
  flex: 1; padding: 14px; background: #f3f4f6; color: #374151;
  border: none; border-radius: 10px; font-size: 15px;
  cursor: pointer; touch-action: manipulation;
}
.btn-danger {
  width: 100%; padding: 12px; background: #fef2f2; color: var(--red);
  border: 1.5px solid #fecaca; border-radius: 10px; font-size: 14px; font-weight: 600;
  cursor: pointer; touch-action: manipulation; margin-top: 8px;
}
.weld-info-box {
  background: #f8fafc; border-radius: 10px; padding: 12px 14px;
  margin-bottom: 16px; border: 1px solid #e5e7eb;
}
.weld-info-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
.weld-info-label { color: var(--gray); }
.weld-info-val { font-weight: 600; color: #111; }

/* Toast */
.toast {
  position: fixed; bottom: calc(var(--nav-h) + 16px); left: 50%; transform: translateX(-50%);
  background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px;
  font-size: 14px; font-weight: 500; z-index: 3000;
  opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap;
}
.toast.show { opacity: 1; }

/* Loading */
.loading {
  position: fixed; inset: 0; background: rgba(255,255,255,0.9);
  display: none; align-items: center; justify-content: center; flex-direction: column;
  z-index: 5000; gap: 12px;
}
.loading.show { display: flex; }
.spinner {
  width: 40px; height: 40px; border: 3px solid #e5e7eb;
  border-top-color: var(--blue); border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 14px; color: var(--gray); font-weight: 500; }

/* Empty state */
.empty { text-align: center; padding: 60px 20px; color: var(--gray); }

/* Login page */
.login-page {
  position: fixed; inset: 0; background: #0f172a;
  display: flex; align-items: center; justify-content: center;
  z-index: 9999; padding: 24px;
}
.login-page.hidden { display: none; }
.login-box {
  background: #1e293b; border-radius: 16px; padding: 32px 24px;
  width: 100%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.login-logo { text-align: center; font-size: 40px; margin-bottom: 8px; }
.login-title { text-align: center; color: white; font-size: 22px; font-weight: 700; margin-bottom: 4px; }
.login-sub { text-align: center; color: #94a3b8; font-size: 13px; margin-bottom: 28px; }
.login-label { color: #94a3b8; font-size: 13px; font-weight: 500; margin-bottom: 6px; display: block; }
.login-input {
  width: 100%; padding: 14px; border-radius: 10px; border: 1.5px solid #334155;
  background: #0f172a; color: white; font-size: 16px; box-sizing: border-box;
  margin-bottom: 16px; outline: none;
}
.login-input:focus { border-color: #3b82f6; }
.login-btn {
  width: 100%; padding: 15px; background: #3b82f6; color: white;
  border: none; border-radius: 10px; font-size: 16px; font-weight: 700;
  cursor: pointer; margin-top: 4px;
}
.login-btn:active { background: #2563eb; }
.login-err { color: #f87171; font-size: 13px; margin-top: 10px; text-align: center; display: none; }
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-text { font-size: 15px; font-weight: 500; }
.empty-sub { font-size: 13px; margin-top: 4px; }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="login-page" id="loginPage">
  <div class="login-box">
    <div class="login-logo">üîß</div>
    <div class="login-title">WeldPro</div>
    <div class="login-sub">Mobile verzia</div>
    <label class="login-label">Meno / Username</label>
    <input class="login-input" id="loginUser" placeholder="Zadaj meno..." autocapitalize="none" autocorrect="off">
    <label class="login-label">Heslo</label>
    <input class="login-input" id="loginPass" type="password" placeholder="Zadaj heslo..."
      onkeydown="if(event.key==='Enter') doLogin()">
    <button class="login-btn" onclick="doLogin()">üîê Prihl√°si≈• sa</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- HEADER -->
<div class="header" id="mainHeader" style="display:none">
  <div>
    <div class="header-title">üîß WeldPro</div>
    <div class="header-sub" id="headerSub">Mobile</div>
  </div>
  <span id="headerUser" style="font-size:13px;color:rgba(255,255,255,0.8);cursor:pointer" onclick="doLogout()">üë§</span>
</div>

<!-- PAGES -->
<div class="page active" id="kniznicaPage">
  <div class="search-bar">
    <input class="search-input" id="kSearch" placeholder="üîç Hƒæadaj v√Ωkres..." oninput="filterProjects()">
    <div style="display:flex;gap:6px;margin-top:8px;overflow-x:auto;padding-bottom:2px">
      <button class="part-tab" onclick="selectPart('')" id="ptAll">V≈°etky</button>
      <button class="part-tab active" onclick="selectPart('SUL')" id="ptSUL">SUL</button>
      <button class="part-tab" onclick="selectPart('LIG')" id="ptLIG">LIG</button>
      <button class="part-tab" onclick="selectPart('DRY')" id="ptDRY">DRY</button>
      <button class="part-tab" onclick="selectPart('FLA')" id="ptFLA">FLA</button>
      <button class="part-tab" onclick="selectPart('LHT')" id="ptLHT">LHT</button>
    </div>
    <div id="kCount" style="font-size:12px;color:#6b7280;margin-top:4px"></div>
  </div>
  <div id="kList"><div class="empty"><div class="empty-icon">üìö</div><div class="empty-text">Naƒç√≠tavam projekty...</div></div></div>
</div>

<div class="page" id="montazPage">
  <div class="montaz-toolbar" id="montazToolbar">
    <button class="tool-btn active" id="btnModeSelect" onclick="setMontazMode('select')">üëÜ Zvar</button>
    <button class="tool-btn" id="btnModeWeld" onclick="setMontazMode('weld')">‚ûï Kresli≈• zvar</button>
    <button class="tool-btn" id="btnModeDelete" onclick="setMontazMode('delete')" style="background:#450a0a;color:#f87171">üóëÔ∏è Vymaza≈•</button>
    <button class="tool-btn" id="btnModeLine" onclick="setMontazMode('line')">‚ï± Paliƒçka</button>
    <button class="tool-btn" id="btnModeText" onclick="setMontazMode('text')">T Text</button>
    <button class="tool-btn" id="btnModeCloud" onclick="setMontazMode('cloud')">üí¨ Oblaƒçik</button>
    <button class="tool-btn" id="btnModeArrow" onclick="setMontazMode('arrow')">‚Üí ≈†√≠pka</button>
    <button class="tool-btn" id="btnModeDblArrow" onclick="setMontazMode('dblarrow')">‚Üî 2x≈†√≠pka</button>
    <div style="width:1px;background:#475569;flex-shrink:0;margin:4px 2px"></div>
    <button class="tool-btn" onclick="mUndo()" style="background:#292d3e;color:#94a3b8">‚Ü©</button>
    <button class="tool-btn" onclick="mSave()" style="background:#064e3b;color:#34d399">üíæ</button>
    <button class="tool-btn" onclick="mZoomIn()" style="padding:8px 10px">+</button>
    <button class="tool-btn" onclick="mZoomOut()" style="padding:8px 10px">‚àí</button>
    <button class="tool-btn" onclick="mZoomFit()" style="font-size:11px">Fit</button>
  </div>
  <div class="canvas-container" id="mCanvasWrap">
    <canvas id="mca"></canvas>
  </div>
  <div class="montaz-info">
    <div id="mInfo">Otvor v√Ωkres z Kni≈ænice</div>
    <div id="mWeldCount">0 zvarov</div>
  </div>
</div>

<div class="page" id="weldbookPage">
  <div class="wb-filters">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input class="wb-search" id="wbSearch" placeholder="üîç Hƒæadaj..." oninput="filterWB()" style="flex:1">
      <button class="tool-btn green" onclick="openAddWbModal()" style="flex-shrink:0;padding:8px 12px">‚ûï Prida≈•</button>
    </div>
    <div class="wb-filters-row">
      <select class="wb-select" id="wbFPart" onchange="onWbPartChange()">
        <option value="">V≈°etky ƒçasti</option>
        <option value="SUL">SUL</option>
        <option value="LIG">LIG</option>
        <option value="DRY">DRY</option>
        <option value="FLA">FLA</option>
        <option value="LHT">LHT</option>
      </select>
      <select class="wb-select" id="wbFIso" onchange="filterWB()">
        <option value="">V≈°etky izometrie</option>
      </select>
    </div>
    <div class="wb-count" id="wbCount">Naƒç√≠tavam...</div>
  </div>
  <div class="wb-table-wrap">
    <table class="wb-table">
      <thead>
        <tr>
          <th></th>
          <th>ƒå.zvaru</th>
          <th>Izometria</th>
          <th>Sh.</th>
          <th>Zvaraƒç</th>
          <th>D√°tum</th>
        </tr>
      </thead>
      <tbody id="wbBody"></tbody>
    </table>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav" id="bottomNav" style="display:none">
  <button class="nav-btn active" onclick="switchPage('kniznica')" id="navKniznica">
    <span class="icon">üìö</span>
    <span>Kni≈ænica</span>
  </button>
  <button class="nav-btn" onclick="switchPage('montaz')" id="navMontaz">
    <span class="icon">üèóÔ∏è</span>
    <span>Mont√°≈æ</span>
  </button>
  <button class="nav-btn" onclick="switchPage('weldbook')" id="navWeldbook">
    <span class="icon">üìó</span>
    <span>WeldBook</span>
  </button>
</div>

<!-- MODALS -->
<!-- Welder modal -->
<div class="modal-overlay" id="welderModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üîß Priradi≈• zvaraƒça</div>
    <div class="modal-body">
      <div class="weld-info-box">
        <div class="weld-info-row"><span class="weld-info-label">ƒå. zvaru</span><span class="weld-info-val" id="wm_weldNum">#1</span></div>
        <div class="weld-info-row"><span class="weld-info-label">Izometria</span><span class="weld-info-val" id="wm_iso" style="font-size:11px">-</span></div>
      </div>
      <label class="modal-label">Welder ID</label>
      <input class="modal-input" id="wm_welder" placeholder="Zadaj Welder ID..." autocapitalize="characters">
      <label class="modal-label">D√°tum zv√°rania</label>
      <input class="modal-input" id="wm_date" type="date">
      <div class="modal-row">
        <button class="btn-secondary" onclick="closeWelderModal()">Zru≈°i≈•</button>
        <button class="btn-primary" onclick="saveWelderModal()">‚úÖ Ulo≈æi≈•</button>
      </div>
      <button class="btn-danger" onclick="deleteWeldModal()" style="margin-top:8px">üóëÔ∏è Vymaza≈• zvar</button>
    </div>
  </div>
</div>

<!-- WB Edit modal -->
<div class="modal-overlay" id="wbModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">‚úèÔ∏è Upravi≈• zvar</div>
    <div class="modal-body">
      <div class="weld-info-box">
        <div class="weld-info-row"><span class="weld-info-label">ƒå. zvaru</span><span class="weld-info-val" id="wb_weldNum">-</span></div>
        <div class="weld-info-row"><span class="weld-info-label">Izometria</span><span class="weld-info-val" id="wb_iso" style="font-size:11px">-</span></div>
        <div class="weld-info-row"><span class="weld-info-label">Sheet</span><span class="weld-info-val" id="wb_sheet">-</span></div>
      </div>
      <label class="modal-label">Welder ID</label>
      <input class="modal-input" id="wb_welder" placeholder="Zadaj Welder ID..." autocapitalize="characters">
      <label class="modal-label">D√°tum zv√°rania</label>
      <input class="modal-input" id="wb_date" type="date">
      <div class="modal-row">
        <button class="btn-secondary" onclick="closeWbModal()">Zru≈°i≈•</button>
        <button class="btn-primary" onclick="saveWbModal()">‚úÖ Ulo≈æi≈•</button>
      </div>
      <button class="btn-danger" id="wb_remove" onclick="removeWbModal()" style="display:none">üóëÔ∏è Odstr√°ni≈• zvaraƒça</button>
      <button class="btn-danger" onclick="deleteWbRowModal()" style="margin-top:4px;background:#7f1d1d">üóëÔ∏è Vymaza≈• zvar</button>
    </div>
  </div>
</div>

<!-- Add WB entry modal -->
<div class="modal-overlay" id="addWbModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">‚ûï Prida≈• zvar do WeldBook</div>
    <div class="modal-body">
      <label class="modal-label">ƒåas≈•</label>
      <select class="modal-input" id="awb_part">
        <option value="SUL">SUL</option>
        <option value="LIG">LIG</option>
        <option value="DRY">DRY</option>
        <option value="FLA">FLA</option>
        <option value="LHT">LHT</option>
      </select>
      <label class="modal-label">Izometria</label>
      <input class="modal-input" id="awb_iso" placeholder="napr. KF-712-20002-4-25-10H1A">
      <label class="modal-label">ƒå√≠slo zvaru</label>
      <input class="modal-input" id="awb_weldid" placeholder="napr. 5 alebo 2B" autocapitalize="characters">
      <label class="modal-label">Welder ID</label>
      <input class="modal-input" id="awb_welder" placeholder="Zadaj Welder ID..." autocapitalize="characters">
      <label class="modal-label">D√°tum zv√°rania</label>
      <input class="modal-input" id="awb_date" type="date">
      <div class="modal-row">
        <button class="btn-secondary" onclick="closeAddWbModal()">Zru≈°i≈•</button>
        <button class="btn-primary" onclick="saveAddWbModal()">‚úÖ Prida≈•</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="loading" id="loading"><div class="spinner"></div><div class="loading-text" id="loadingText">Naƒç√≠tavam...</div></div>

<!-- FIREBASE - sekvenƒçn√© naƒç√≠tanie (app ‚Üí firestore ‚Üí auth) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
// ===== FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyDYFCovgo873FIrX4_pEdG1LpDKevxxEU4",
  authDomain: "weldpro-66d2a-8336e.firebaseapp.com",
  projectId: "weldpro-66d2a-8336e",
  storageBucket: "weldpro-66d2a-8336e.firebasestorage.app",
  messagingSenderId: "1062303461642",
  appId: "1:1062303461642:web:e90ff234366c88a5eccaf3"
};

let db = null, auth = null;
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

function showError(msg) {
  document.body.innerHTML = '<div style="padding:40px;text-align:center;font-family:sans-serif"><div style="font-size:48px">‚ö†Ô∏è</div><h2 style="color:#ef4444;margin:16px 0">Chyba</h2><p style="color:#374151">'+msg+'</p><button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:#0078D4;color:white;border:none;border-radius:8px;font-size:16px">Sk√∫si≈• znova</button></div>';
}

async function initFirebase() {
  if (typeof firebase === 'undefined') {
    showError('Firebase SDK sa nenaƒç√≠tal. Skontroluj pripojenie na internet a obnov str√°nku.');
    return false;
  }
  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    console.log('Firebase ready');
    return true;
  } catch(e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

// ===== STATE =====
let currentUser = null;
let weldBookData = [];
let allProjects = [];
let currentProject = null; // { name, welds: [], originalFileName }
let montazMode = 'select';
let newWeldPt1 = null;
let annPt1 = null; // First point for annotations (line/arrow/cloud/dblarrow)
let weldCounter = 1;
let currentWeldForModal = null; // { weld, wbEntry }
let currentWbRow = null;
let mScale = 1;
let mOffX = 0, mOffY = 0;
let mImg = null; // background image

// Canvas - inicializovan√© v DOMContentLoaded
let mca = null;
let mctx = null;

// ===== UTILS =====
function showToast(msg, duration=2000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}
function showLoading(text='Naƒç√≠tavam...') {
  const lt = document.getElementById('loadingText');
  const ld = document.getElementById('loading');
  if (lt) lt.textContent = text;
  if (ld) ld.classList.add('show');
}
function hideLoading() {
  const ld = document.getElementById('loading');
  if (ld) ld.classList.remove('show');
}
function today() {
  return new Date().toISOString().split('T')[0];
}

// ===== LOGIN =====
async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginErr');
  if (!user || !pass) { err.textContent = 'Zadaj meno aj heslo'; err.style.display='block'; return; }

  showLoading('Prihlasovanie...');
  try {
    const doc = await db.collection('users').doc(user).get();
    if (!doc.exists) throw new Error('Pou≈æ√≠vateƒæ neexistuje');
    const data = doc.data();
    if (data.password !== pass && data.passwordHash !== pass) throw new Error('Zl√© heslo');
    currentUser = { username: user, ...data };
    localStorage.setItem('mobileUser', JSON.stringify(currentUser));
    showApp();
  } catch(e) {
    err.textContent = e.message;
    err.style.display = 'block';
  }
  hideLoading();
}

function doLogout() {
  if (!confirm('Odhl√°si≈• sa?')) return;
  currentUser = null;
  localStorage.removeItem('mobileUser');
  location.reload();
}

async function showApp() {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('mainHeader').style.display = 'flex';
  document.getElementById('bottomNav').style.display = 'flex';
  document.getElementById('headerUser').textContent = 'üë§ ' + currentUser.username;
  loadWeldBook();
  loadProjects();
}

// Auto login
window.addEventListener('DOMContentLoaded', async () => {
  // Init canvas
  mca = document.getElementById('mca');
  if (mca) mctx = mca.getContext('2d');

  // Canvas touch/click listeners
  if (mca) {
    mca.addEventListener('touchstart', function(e) {
      if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        _pinchDist = Math.sqrt(dx*dx + dy*dy);
        return;
      }
      if (e.touches.length !== 1) return;
      const t = e.touches[0];
      _tSX = t.clientX; _tSY = t.clientY;
      _tTime = Date.now(); _tMoved = false;
    }, {passive: true});

    mca.addEventListener('touchmove', function(e) {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (_pinchDist > 0) {
          const ratio = dist / _pinchDist;
          mScale = Math.max(0.3, Math.min(8, mScale * ratio));
          mDraw();
        }
        _pinchDist = dist;
        return;
      }
      if (e.touches.length !== 1) return;
      const t = e.touches[0];
      if (Math.abs(t.clientX - _tSX) > 8 || Math.abs(t.clientY - _tSY) > 8) _tMoved = true;
    }, {passive: false});

    mca.addEventListener('touchend', function(e) {
      _pinchDist = 0;
      if (_tMoved || Date.now() - _tTime > 500) return;
      if (e.changedTouches.length !== 1) return;
      e.preventDefault();
      const t = e.changedTouches[0];
      handleCanvasTap(t.clientX, t.clientY);
    }, {passive: false});

    mca.addEventListener('click', function(e) {
      if ('ontouchstart' in window) return;
      handleCanvasTap(e.clientX, e.clientY);
    });
  }

  // Modal overlay listeners
  const welderModal = document.getElementById('welderModal');
  if (welderModal) welderModal.addEventListener('click', function(e) { if (e.target === this) closeWelderModal(); });
  const wbModal = document.getElementById('wbModal');
  if (wbModal) wbModal.addEventListener('click', function(e) { if (e.target === this) closeWbModal(); });
  const addWbModal = document.getElementById('addWbModal');
  if (addWbModal) addWbModal.addEventListener('click', function(e) { if (e.target === this) closeAddWbModal(); });

  const ok = await initFirebase();
  if (!ok) {
    document.getElementById('loginErr').textContent = '‚ùå Firebase error - skontroluj internet';
    document.getElementById('loginErr').style.display = 'block';
    return;
  }
  // Sk√∫s auto-login z localStorage
  const saved = localStorage.getItem('mobileUser');
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      // Overenie ≈æe pou≈æ√≠vateƒæ st√°le existuje
      const doc = await db.collection('users').doc(currentUser.username).get();
      if (doc.exists) {
        showApp();
        return;
      }
    } catch(e) {}
    localStorage.removeItem('mobileUser');
  }
  // Zobraz login
  document.getElementById('loginPage').classList.remove('hidden');
});

// ===== NAVIGATION =====
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const pageEl = document.getElementById(page + 'Page');
  if (pageEl) pageEl.classList.add('active');
  const navId = 'nav' + page.charAt(0).toUpperCase() + page.slice(1);
  const navEl = document.getElementById(navId);
  if (navEl) navEl.classList.add('active');
  document.getElementById('headerSub').textContent =
    page === 'kniznica' ? 'Kni≈ænica' :
    page === 'montaz' ? (currentProject ? currentProject.name.substring(0,30) : 'Mont√°≈æ') :
    'WeldBook';
  if (page === 'montaz') setTimeout(mDraw, 100);
}

// ===== KNIZNICA =====
let selectedPart = 'SUL'; // Default - naƒç√≠taj len SUL

async function loadProjects() {
  const el = document.getElementById('kList');
  el.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div><div class="empty-text">Naƒç√≠tavam ' + (selectedPart||'v≈°etky') + '...</div></div>';
  try {
    let query = db.collection('projects');
    // Filtruj podƒæa ƒçasti ak je vybran√° - Firebase query namiesto load all
    if (selectedPart) {
      query = query.where('part', '==', selectedPart);
    }
    const snap = await query.get();
    allProjects = [];
    for (const doc of snap.docs) {
      if (doc.id === 'weldbook_main' || doc.id.startsWith('_')) continue;
      const meta = doc.data();
      // Ak part nie je v metadatach, zisti z ID
      if (!meta.part) meta.part = getPart(doc.id);
      allProjects.push({ id: doc.id, meta });
    }
    allProjects.sort((a,b) => a.id.localeCompare(b.id));
    filterProjects();
  } catch(e) { 
    showToast('‚ùå Chyba: ' + e.message); 
    el.innerHTML = '<div class="empty"><div class="empty-icon">‚ùå</div><div class="empty-text">'+e.message+'</div></div>';
  }
}

function getPart(name) {
  if (!name) return 'other';
  const m = name.match(/^([A-Z]{2,6})[_,]/);
  if (m) return m[1];
  // Sk√∫s aj bez oddelovaƒça
  const m2 = name.match(/^(SUL|LIG|DRY|FLA|LHT)/);
  return m2 ? m2[1] : 'other';
}

function selectPart(part) {
  selectedPart = part;
  document.querySelectorAll('.part-tab').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('pt' + (part || 'All'));
  if (btn) btn.classList.add('active');
  allProjects = []; // Reset - naƒç√≠taj z Firebase pre t√∫to ƒças≈•
  loadProjects();
}

function filterProjects() {
  const q = document.getElementById('kSearch').value.toLowerCase().trim();
  let filtered = allProjects.filter(p => {
    if (selectedPart && getPart(p.id) !== selectedPart) return false;
    if (q && !p.id.toLowerCase().includes(q)) return false;
    return true;
  });

  const el = document.getElementById('kList');
  const countEl = document.getElementById('kCount');
  if (countEl) countEl.textContent = filtered.length + ' v√Ωkresov' + (selectedPart ? ' (' + selectedPart + ')' : '');

  if (!filtered.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-text">≈Ωiadne v√Ωkresy</div><div class="empty-sub">' + (selectedPart ? 'Pre ƒças≈• ' + selectedPart : '') + '</div></div>';
    return;
  }

  // Render po 50 naraz pre r√Ωchlos≈•
  el.innerHTML = filtered.slice(0, 50).map(p => {
    const part = getPart(p.id);
    const weldCount = p.meta.count || '?';
    // Skr√°≈• dlh√Ω n√°zov
    const shortName = p.id.replace(/^(SUL|LIG|DRY|FLA|LHT)[_,]?/,'').replace(/_/g,' ').replace(/PIPE ISOMETRIC,?/i,'');
    return `<div class="project-card" onclick="openProject('${p.id}')">
      <div class="project-icon">üìê</div>
      <div class="project-info">
        <div class="project-name">${shortName}</div>
        <div class="project-meta">${weldCount} zvarov</div>
      </div>
      <span class="project-part part-${part}">${part}</span>
    </div>`;
  }).join('') + (filtered.length > 50 ? `<div style="text-align:center;padding:16px;color:#6b7280;font-size:13px">+ ${filtered.length-50} ƒèal≈°√≠ch... Pou≈æite filter</div>` : '');
}

async function openProject(projId) {
  showLoading('Naƒç√≠tavam v√Ωkres...');
  try {
    const docRef = db.collection('projects').doc(projId);
    const metaDoc = await docRef.get();
    const meta = metaDoc.data();
    const chunks = [];
    for (let i = 0; i < (meta.chunks||1); i++) {
      const c = await docRef.collection('data').doc('c'+i).get();
      if (c.exists) chunks.push(c.data().d);
    }
    const parsed = JSON.parse(chunks.join(''));
    currentProject = {
      id: projId,
      name: projId,
      originalFileName: parsed.projectName || projId,
      welds: parsed.welds || [],
      image: parsed.pdfData || null
    };
    // Max weld counter
    weldCounter = Math.max(1, ...currentProject.welds.map(w => parseInt(w.displayNum)||0)) + 1;
    newWeldPt1 = null;
    mScale = 1;

    // Naƒç√≠taj obr√°zok ak existuje
    if (currentProject.image) {
      const img = new Image();
      img.onload = () => { mImg = img; mZoomFit(); mDraw(); };
      img.src = currentProject.image;
    } else {
      mImg = null;
      mZoomFit();
      mDraw();
    }

    document.getElementById('mInfo').textContent = projId.substring(0,35);
    document.getElementById('mWeldCount').textContent = currentProject.welds.length + ' zvarov';
    switchPage('montaz');
    showToast('‚úÖ Naƒç√≠tan√©: ' + currentProject.welds.length + ' zvarov');
  } catch(e) { showToast('‚ùå ' + e.message); console.error(e); }
  hideLoading();
}

// ===== MONTAZ CANVAS =====
function mGetWbEntry(weld) {
  if (!weldBookData || !currentProject) return null;
  const weldId = String(weld.displayNum);
  const fn = currentProject.originalFileName || '';
  const isoFromSplit = splitIso(fn).iso; // napr. "KF-712-20002-4-25-10H1A"

  return weldBookData.find(r => {
    if (String(r.weldId) !== weldId) return false;
    const ri = (r.isometric || '').trim();
    if (!ri) return false;
    // Sk√∫s r√¥zne kombin√°cie matchingu
    if (ri === isoFromSplit) return true;
    if (ri === fn) return true;
    if (fn.includes(ri)) return true;
    if (ri.includes(isoFromSplit) || isoFromSplit.includes(ri)) return true;
    return false;
  }) || null;
}

// Vr√°ti isometric key rovnak√Ω ako pou≈æ√≠va WeldBook pre dan√Ω projekt
function getProjectIso() {
  if (!currentProject) return '';
  const fn = currentProject.originalFileName || '';
  // Najprv sk√∫s n√°js≈• existuj√∫ci z√°znam v WB aby sme pou≈æili rovnak√Ω kƒæ√∫ƒç
  const sample = weldBookData.find(r => {
    const ri = (r.isometric || '').trim();
    return ri && fn.includes(ri);
  });
  if (sample) return sample.isometric;
  return splitIso(fn).iso || fn;
}

function getProjectPart() {
  if (!currentProject) return '';
  const fn = currentProject.originalFileName || '';
  const fromSplit = splitIso(fn).part;
  if (fromSplit) return fromSplit;
  // Sk√∫s z existuj√∫ceho WB z√°znamu
  const sample = weldBookData.find(r => {
    const ri = (r.isometric || '').trim();
    return ri && fn.includes(ri);
  });
  return sample ? (sample.part || '') : '';
}

// Kreslenie anot√°ci√≠ (paliƒçka, ≈°√≠pka, text, oblaƒçik)
function drawAnnotation(ctx, a, W, H) {
  const x1 = a.x1 * W, y1 = a.y1 * H;
  const x2 = (a.x2||a.x) * W, y2 = (a.y2||a.y) * H;
  ctx.save();
  ctx.strokeStyle = '#0000FF';
  ctx.fillStyle = '#0000FF';
  ctx.lineWidth = 2;

  if (a.type === 'line') {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

  } else if (a.type === 'arrow') {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    drawArrowHead(ctx, x1, y1, x2, y2);

  } else if (a.type === 'dblarrow') {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    drawArrowHead(ctx, x1, y1, x2, y2);
    drawArrowHead(ctx, x2, y2, x1, y1);

  } else if (a.type === 'cloud') {
    const mx = Math.min(x1,x2), my = Math.min(y1,y2);
    const mw = Math.abs(x2-x1), mh = Math.abs(y2-y1);
    const r = Math.min(18, mw/4, mh/3);
    // Simple rounded rect as cloud
    ctx.beginPath();
    ctx.roundRect(mx, my, mw, mh, r);
    ctx.fillStyle = 'rgba(255,255,200,0.7)';
    ctx.fill();
    ctx.strokeStyle = '#0000FF';
    ctx.stroke();

  } else if (a.type === 'text') {
    ctx.font = 'bold 14px Arial';
    ctx.fillStyle = '#0000FF';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    // Background
    const tw = ctx.measureText(a.text).width;
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    ctx.fillRect(x2-2, y2-2, tw+4, 18);
    ctx.fillStyle = '#0000FF';
    ctx.fillText(a.text, x2, y2);
  }
  ctx.restore();
}

function drawArrowHead(ctx, fromX, fromY, toX, toY) {
  const angle = Math.atan2(toY - fromY, toX - fromX);
  const size = 12;
  ctx.beginPath();
  ctx.moveTo(toX, toY);
  ctx.lineTo(toX - size * Math.cos(angle - Math.PI/6), toY - size * Math.sin(angle - Math.PI/6));
  ctx.lineTo(toX - size * Math.cos(angle + Math.PI/6), toY - size * Math.sin(angle + Math.PI/6));
  ctx.closePath();
  ctx.fill();
}

function mDraw() {
  if (!mca) return;
  const wrap = document.getElementById('mCanvasWrap');

  // Canvas = veƒækos≈• obr√°zka (rovnako ako v app.html)
  // Scrollovanie zabezpeƒç√≠ #mCanvasWrap
  const imgW = mImg ? mImg.naturalWidth : (wrap.clientWidth || window.innerWidth);
  const imgH = mImg ? mImg.naturalHeight : (wrap.clientHeight || 600);
  mca.width = Math.round(imgW * mScale);
  mca.height = Math.round(imgH * mScale);

  mctx.clearRect(0, 0, mca.width, mca.height);
  mctx.save();
  mctx.scale(mScale, mScale);

  // Background image
  if (mImg) {
    // Nakresli obr√°zok v jeho skutoƒçnej veƒækosti (zvary s√∫ normalizovan√© voƒçi nej)
    mctx.drawImage(mImg, 0, 0, mImg.naturalWidth, mImg.naturalHeight);
  } else {
    mctx.fillStyle = '#f8fafc';
    mctx.fillRect(0, 0, mca.width / mScale, mca.height / mScale);
    if (!currentProject) {
      mctx.fillStyle = '#94a3b8';
      mctx.font = '16px sans-serif';
      mctx.textAlign = 'center';
      mctx.fillText('Otvor v√Ωkres z Kni≈ænice', mca.width / mScale / 2, mca.height / mScale / 2);
    }
  }

  // Draw welds
  if (currentProject) {
    const W = mImg ? mImg.naturalWidth : mca.width / mScale;
    const H = mImg ? mImg.naturalHeight : mca.height / mScale;

    // Draw annotations (lines, text, arrows, clouds)
    if (currentProject.annotations) {
      currentProject.annotations.forEach(a => drawAnnotation(mctx, a, W, H));
    }

    currentProject.welds.forEach(w => {
      const ex = w.end.x * W;
      const ey = w.end.y * H;
      const sx = w.start.x * W;
      const sy = w.start.y * H;
      const wbEntry = mGetWbEntry(w);
      const hasDone = wbEntry && wbEntry.welderId && wbEntry.welderId.trim();

      const weldColor = '#FF0000';
      // Dynamick√Ω radius podƒæa dƒ∫≈æky ƒç√≠sla (ako PC)
      const displayText = String(w.displayNum);
      const tLen = displayText.length;
      const ry = 18; // z√°kladn√Ω radius Y
      const rx = tLen <= 2 ? ry : Math.max(ry, tLen * 11 * 0.6 / 2 + 6);

      // V√Ωpoƒçet prieseƒçn√≠ka l√≠nie s elipsou (ako PC)
      const dirX = sx - ex;
      const dirY = sy - ey;
      const dirLen = Math.sqrt(dirX*dirX + dirY*dirY);
      let lineEndX = ex, lineEndY = ey;
      if (dirLen > 0) {
        const ndx = dirX / dirLen;
        const ndy = dirY / dirLen;
        const t = 1 / Math.sqrt((ndx/rx)*(ndx/rx) + (ndy/ry)*(ndy/ry));
        lineEndX = ex + ndx * t;
        lineEndY = ey + ndy * t;
      }

      // Linka konƒç√≠ na kraji kr√∫≈æku
      mctx.beginPath();
      mctx.moveTo(sx, sy);
      mctx.lineTo(lineEndX, lineEndY);
      mctx.strokeStyle = weldColor;
      mctx.lineWidth = 2;
      mctx.stroke();

      // Kr√∫≈æok (elipsa pre dlh√© ƒç√≠sla)
      mctx.beginPath();
      mctx.ellipse(ex, ey, rx, ry, 0, 0, Math.PI * 2);
      if (hasDone) {
        mctx.fillStyle = '#00FF00';
        mctx.fill();
      }
      mctx.strokeStyle = weldColor;
      mctx.lineWidth = 2;
      mctx.stroke();

      // ƒå√≠slo zvaru
      const fontSize = tLen >= 5 ? 10 : tLen >= 3 ? 12 : 14;
      mctx.fillStyle = hasDone ? '#000000' : weldColor;
      mctx.font = fontSize + 'px Arial';
      mctx.textAlign = 'center';
      mctx.textBaseline = 'middle';
      mctx.fillText(displayText, ex, ey);
    });

    // New weld pt1 indicator
    if (newWeldPt1 && montazMode === 'new') {
      const W2 = mImg ? mImg.naturalWidth : mca.width / mScale;
      const H2 = mImg ? mImg.naturalHeight : mca.height / mScale;
      const px = newWeldPt1.x * W2;
      const py = newWeldPt1.y * H2;
      mctx.beginPath();
      mctx.arc(px, py, 8, 0, Math.PI * 2);
      mctx.fillStyle = '#3b82f6';
      mctx.fill();
    }
  }
  mctx.restore();
}

function mZoomIn() { mScale = Math.min(mScale * 1.3, 8); mDraw(); }
function mZoomOut() { mScale = Math.max(mScale / 1.3, 0.3); mDraw(); }
function mZoomFit() {
  if (mImg) {
    const wrap = document.getElementById('mCanvasWrap');
    const scaleX = wrap.clientWidth / mImg.naturalWidth;
    mScale = Math.min(scaleX, 1.5); // Fit width, max 1.5x
  } else {
    mScale = 1;
  }
  mDraw();
  // Scroll to top
  const wrap = document.getElementById('mCanvasWrap');
  wrap.scrollTop = 0; wrap.scrollLeft = 0;
}

const TOOL_LABELS = {
  select: 'Tap na kr√∫≈æok = priradi≈• zvaraƒça',
  weld: 'Tap = 1. bod zvaru, Tap = 2. bod',
  delete: 'Tap na zvar = vymaza≈•',
  line: 'Tap = zaƒçiatok paliƒçky, Tap = koniec',
  text: 'Tap = miesto textu',
  cloud: 'Tap = 1. roh oblaƒçika, Tap = 2. roh',
  arrow: 'Tap = zaƒçiatok ≈°√≠pky, Tap = koniec',
  dblarrow: 'Tap = 1. bod, Tap = 2. bod'
};

function setMontazMode(mode) {
  montazMode = mode;
  annPt1 = null;
  newWeldPt1 = null;
  const modeIdMap = {
    select:'btnModeSelect', weld:'btnModeWeld', delete:'btnModeDelete',
    line:'btnModeLine', text:'btnModeText', cloud:'btnModeCloud',
    arrow:'btnModeArrow', dblarrow:'btnModeDblArrow'
  };
  Object.entries(modeIdMap).forEach(([m, id]) => {
    const btn = document.getElementById(id);
    if (btn) btn.classList.toggle('active', m === mode);
  });
  mDraw();
  showToast(TOOL_LABELS[mode] || mode);
}

function mUndo() {
  if (!currentProject) return;
  // Undo annotations first, then welds
  if (currentProject.annotations && currentProject.annotations.length > 0) {
    currentProject.annotations.pop();
    mDraw();
    showToast('‚Ü© Zru≈°en√° anot√°cia');
  } else if (currentProject.welds.length > 0) {
    currentProject.welds.pop();
    weldCounter = Math.max(1, ...currentProject.welds.map(w => parseInt(w.displayNum)||0)) + 1;
    document.getElementById('mWeldCount').textContent = currentProject.welds.length + ' zvarov';
    mDraw();
    showToast('‚Ü© Zru≈°en√Ω posledn√Ω zvar');
  }
}

async function mSave() {
  if (!currentProject || !db) return;
  showLoading('Uklad√°m projekt...');
  try {
    const docRef = db.collection('projects').doc(currentProject.id);
    // Naƒç√≠taj existuj√∫ce d√°ta (aby sme zachovali pdfData a ostatn√© polia)
    const metaDoc = await docRef.get();
    const meta = metaDoc.data() || {};
    const chunks = [];
    for (let i = 0; i < (meta.chunks||1); i++) {
      const c = await docRef.collection('data').doc('c'+i).get();
      if (c.exists) chunks.push(c.data().d);
    }
    let parsed = {};
    try { parsed = JSON.parse(chunks.join('')); } catch(e) {}

    // Aktualizuj len zvary, zachovaj pdfData a ostatn√©
    parsed.welds = currentProject.welds;
    parsed.projectName = currentProject.originalFileName || currentProject.id;

    // Ulo≈æ sp√§≈•
    const json = JSON.stringify(parsed);
    const CHUNK = 800 * 1024;
    const newChunks = [];
    for (let i = 0; i < json.length; i += CHUNK) newChunks.push(json.slice(i, i + CHUNK));

    await Promise.all(newChunks.map((c, i) =>
      docRef.collection('data').doc('c' + i).set({ d: c })
    ));
    await docRef.set({
      ...meta,
      chunks: newChunks.length,
      lastModified: new Date().toISOString(),
      modifiedBy: currentUser?.username || 'mobile'
    });

    // Ulo≈æ aj WeldBook
    await saveWeldBookToFirebase();

    showToast('‚úÖ Projekt ulo≈æen√Ω (' + currentProject.welds.length + ' zvarov)');
  } catch(e) {
    console.error('mSave error:', e);
    showToast('‚ùå Chyba: ' + e.message);
  }
  hideLoading();
}

// Touch handling on canvas
let _tSX=0,_tSY=0,_tTime=0,_tMoved=false;
// Pinch zoom
let _pinchDist=0;

// mca listeners sa registruj√∫ v DOMContentLoaded

function handleCanvasTap(clientX, clientY) {
  if (!currentProject) { showToast('Najprv otvor v√Ωkres z Kni≈ænice'); return; }
  const rect = mca.getBoundingClientRect();
  const rawX = clientX - rect.left;
  const rawY = clientY - rect.top;
  // Canvas coords (canvas je u≈æ mScale-ovan√Ω tak≈æe del√≠me mScale)
  const canvasX = rawX / mScale;
  const canvasY = rawY / mScale;
  const W = mImg ? mImg.naturalWidth : mca.width / mScale;
  const H = mImg ? mImg.naturalHeight : mca.height / mScale;

  const pt = { x: canvasX / W, y: canvasY / H };

  if (montazMode === 'select') {
    const tapRadius = 40 / mScale;
    let found = null;
    for (const w of currentProject.welds) {
      const ex = w.end.x * W;
      const ey = w.end.y * H;
      if (Math.sqrt((canvasX-ex)**2 + (canvasY-ey)**2) < tapRadius) { found = w; break; }
    }
    if (found) openWelderModal(found);
    else showToast('Klikni priamo na kr√∫≈æok zvaru');

  } else if (montazMode === 'delete') {
    // Vyma≈æ zvar na ktor√Ω klikol
    const tapRadius = 40 / mScale;
    let foundIdx = -1;
    for (let i = 0; i < currentProject.welds.length; i++) {
      const w = currentProject.welds[i];
      const ex = w.end.x * W;
      const ey = w.end.y * H;
      if (Math.sqrt((canvasX-ex)**2 + (canvasY-ey)**2) < tapRadius) { foundIdx = i; break; }
    }
    if (foundIdx !== -1) {
      const weld = currentProject.welds[foundIdx];
      currentProject.welds.splice(foundIdx, 1);
      // Vyma≈æ aj z WeldBooku
      const iso = getProjectIso();
      const wbIdx = weldBookData.findIndex(r =>
        String(r.weldId) === String(weld.displayNum) &&
        (r.isometric === iso || (iso && r.isometric && (iso.includes(r.isometric) || r.isometric.includes(iso))))
      );
      if (wbIdx !== -1) weldBookData.splice(wbIdx, 1);
      weldCounter = currentProject.welds.length > 0
        ? Math.max(...currentProject.welds.map(w => parseInt(w.displayNum)||0)) + 1
        : 1;
      document.getElementById('mWeldCount').textContent = currentProject.welds.length + ' zvarov';
      mDraw();
      saveWeldBookToFirebase().catch(()=>{});
      showToast('üóëÔ∏è Zvar #' + weld.displayNum + ' vymazan√Ω');
    } else {
      showToast('Klikni priamo na kr√∫≈æok zvaru');
    }

  } else if (montazMode === 'weld') {
    if (!newWeldPt1) {
      newWeldPt1 = pt;
      mDraw();
      showToast('‚úÖ 1. bod. Tap = koniec zvaru');
    } else {
      // Op√Ωtaj sa na ƒç√≠slo zvaru
      const suggestedNum = weldCounter;
      const numInput = prompt('ƒå√≠slo zvaru (napr. ' + suggestedNum + ' alebo 2B):', String(suggestedNum));
      if (!numInput) { newWeldPt1 = null; mDraw(); return; }
      const displayNum = numInput.trim();
      const weld = { id: Date.now()+'_'+Math.random(), start: newWeldPt1, end: pt, displayNum: displayNum, source: 'new' };
      currentProject.welds.push(weld);
      // Aktualizuj counter
      const parsed = parseInt(displayNum);
      if (!isNaN(parsed) && parsed >= weldCounter) weldCounter = parsed + 1;
      newWeldPt1 = null;
      document.getElementById('mWeldCount').textContent = currentProject.welds.length + ' zvarov';
      mDraw();
      openWelderModal(weld);
    }

  } else if (montazMode === 'line' || montazMode === 'arrow' || montazMode === 'dblarrow') {
    if (!annPt1) {
      annPt1 = pt;
      showToast('1. bod. Tap = koniec');
    } else {
      if (!currentProject.annotations) currentProject.annotations = [];
      currentProject.annotations.push({ type: montazMode, x1: annPt1.x, y1: annPt1.y, x2: pt.x, y2: pt.y });
      annPt1 = null;
      mDraw();
    }

  } else if (montazMode === 'cloud') {
    if (!annPt1) {
      annPt1 = pt;
      showToast('1. roh. Tap = 2. roh');
    } else {
      if (!currentProject.annotations) currentProject.annotations = [];
      currentProject.annotations.push({ type: 'cloud', x1: annPt1.x, y1: annPt1.y, x2: pt.x, y2: pt.y });
      annPt1 = null;
      mDraw();
    }

  } else if (montazMode === 'text') {
    const txt = prompt('Zadaj text:');
    if (txt && txt.trim()) {
      if (!currentProject.annotations) currentProject.annotations = [];
      currentProject.annotations.push({ type: 'text', x: pt.x, y: pt.y, text: txt.trim() });
      mDraw();
    }
  }
}

// ===== WELDER MODAL =====
function openWelderModal(weld) {
  const wbEntry = mGetWbEntry(weld);
  currentWeldForModal = { weld, wbEntry };

  document.getElementById('wm_weldNum').textContent = '#' + weld.displayNum;
  document.getElementById('wm_iso').textContent = currentProject ? currentProject.originalFileName.substring(0,40) : '-';

  const hasWelder = wbEntry && wbEntry.welderId && wbEntry.welderId.trim() !== '';
  document.getElementById('wm_welder').value = hasWelder ? wbEntry.welderId : '';
  document.getElementById('wm_date').value = (wbEntry && wbEntry.dateWelding) ? wbEntry.dateWelding : today();

  const _el_welderModal_add = document.getElementById('welderModal'); if (_el_welderModal_add) _el_welderModal_add.classList.add('show');
  setTimeout(() => document.getElementById('wm_welder').focus(), 300);
}

function closeWelderModal() {
  const _el_welderModal_remove = document.getElementById('welderModal'); if (_el_welderModal_remove) _el_welderModal_remove.classList.remove('show');
  currentWeldForModal = null;
}

function saveWelderModal() {
  const welder = document.getElementById('wm_welder').value.trim();
  const date = document.getElementById('wm_date').value;
  if (!welder) { showToast('‚ö†Ô∏è Zadaj Welder ID'); return; }

  const { weld, wbEntry } = currentWeldForModal;
  if (wbEntry) {
    wbEntry.welderId = welder;
    wbEntry.dateWelding = date;
  } else {
    // Nov√Ω z√°znam - vlo≈æ na spr√°vne miesto zoraden√© podƒæa weldId
    const newRow = {
      part: getProjectPart(),
      isometric: getProjectIso(),
      sheets: 1,
      weldId: String(weld.displayNum),
      welderId: welder,
      dateWelding: date
    };
    wbInsertSorted(newRow);
  }
  mDraw();
  closeWelderModal();
  showToast('üíæ Uklad√°m...');
  saveWeldBookToFirebase().then(() => {
    showToast('‚úÖ Zvar #' + weld.displayNum + ' ‚Üí ' + welder);
  });
}

// Vlo≈æ WB z√°znam zoraden√Ω podƒæa ƒç√≠sla zvaru (2B ide medzi 2 a 3)
function wbInsertSorted(newRow) {
  // N√°jdi blok riadkov s rovnakou izometriou
  const iso = newRow.isometric || '';
  const part = (newRow.part || '').toUpperCase();

  // Pomocn√° funkcia na porovnanie ƒç√≠siel zvarov (2B < 3, 1 < 2B < 2)
  function weldNumVal(id) {
    const s = String(id);
    const n = parseFloat(s);
    if (!isNaN(n)) return n;
    // "2B" ‚Üí 2.5 (za ƒç√≠slom, pred nasleduj√∫cim cel√Ωm)
    const m = s.match(/^(\d+)([A-Za-z]+)$/);
    if (m) return parseFloat(m[1]) + 0.5;
    return 999999;
  }

  const newVal = weldNumVal(newRow.weldId);

  // N√°jdi prv√Ω index s rovnakou izometriou
  const firstIsoIdx = weldBookData.findIndex(r =>
    (r.isometric || '') === iso && (r.part || '').toUpperCase() === part
  );

  if (firstIsoIdx === -1) {
    // Izometria neexistuje - pridaj na koniec
    weldBookData.push(newRow);
    return;
  }

  // N√°jdi spr√°vn√∫ poz√≠ciu v r√°mci izometrie
  let insertIdx = -1;
  for (let i = firstIsoIdx; i < weldBookData.length; i++) {
    const r = weldBookData[i];
    if ((r.isometric || '') !== iso || (r.part || '').toUpperCase() !== part) {
      // Skonƒçila sekcia tejto izometrie - vlo≈æ tu
      insertIdx = i;
      break;
    }
    if (weldNumVal(r.weldId) > newVal) {
      insertIdx = i;
      break;
    }
  }

  if (insertIdx === -1) weldBookData.push(newRow);
  else weldBookData.splice(insertIdx, 0, newRow);
}

function removeWelderModal() {
  const { weld, wbEntry } = currentWeldForModal;
  if (wbEntry) { wbEntry.welderId = ''; wbEntry.dateWelding = ''; }
  mDraw();
  closeWelderModal();
  saveWeldBookToFirebase().then(() => showToast('üóëÔ∏è Zvaraƒç odstr√°nen√Ω: zvar #' + weld.displayNum));
}

function deleteWeldModal() {
  if (!currentWeldForModal || !currentProject) return;
  const { weld } = currentWeldForModal;
  if (!confirm('Vymaza≈• zvar #' + weld.displayNum + '?')) return;
  // Vyma≈æ zo zoznamu zvarov
  currentProject.welds = currentProject.welds.filter(w => w.id !== weld.id);
  weldCounter = currentProject.welds.length > 0
    ? Math.max(...currentProject.welds.map(w => parseInt(w.displayNum)||0)) + 1
    : 1;
  document.getElementById('mWeldCount').textContent = currentProject.welds.length + ' zvarov';
  // Vyma≈æ aj z WeldBooku
  const iso = getProjectIso();
  const wbIdx = weldBookData.findIndex(r =>
    String(r.weldId) === String(weld.displayNum) &&
    (r.isometric === iso || (iso && r.isometric && (iso.includes(r.isometric) || r.isometric.includes(iso))))
  );
  if (wbIdx !== -1) weldBookData.splice(wbIdx, 1);
  mDraw();
  closeWelderModal();
  saveWeldBookToFirebase().then(() => showToast('üóëÔ∏è Zvar #' + weld.displayNum + ' vymazan√Ω'));
}

// ===== ADD WB ENTRY MODAL =====
function openAddWbModal() {
  // Predvypl≈à ƒças≈• z akt√≠vneho filtra
  const part = document.getElementById('wbFPart').value || 'SUL';
  document.getElementById('awb_part').value = part;
  document.getElementById('awb_iso').value = '';
  document.getElementById('awb_weldid').value = '';
  document.getElementById('awb_welder').value = '';
  document.getElementById('awb_date').value = today();
  const _el_addWbModal_add = document.getElementById('addWbModal'); if (_el_addWbModal_add) _el_addWbModal_add.classList.add('show');
  setTimeout(() => document.getElementById('awb_iso').focus(), 300);
}

function closeAddWbModal() {
  const _el_addWbModal_remove = document.getElementById('addWbModal'); if (_el_addWbModal_remove) _el_addWbModal_remove.classList.remove('show');
}

function saveAddWbModal() {
  const part = document.getElementById('awb_part').value;
  const iso = document.getElementById('awb_iso').value.trim();
  const weldId = document.getElementById('awb_weldid').value.trim();
  const welder = document.getElementById('awb_welder').value.trim();
  const date = document.getElementById('awb_date').value;
  if (!iso) { showToast('‚ö†Ô∏è Zadaj izometriu'); return; }
  if (!weldId) { showToast('‚ö†Ô∏è Zadaj ƒç√≠slo zvaru'); return; }
  const newRow = { part, isometric: iso, sheets: 1, weldId, welderId: welder, dateWelding: date };
  wbInsertSorted(newRow);
  closeAddWbModal();
  showToast('üíæ Uklad√°m...');
  saveWeldBookToFirebase().then(() => {
    filterWB();
    showToast('‚úÖ Zvar #' + weldId + ' pridan√Ω');
  });
}

// addWbModal listener sa registruje v DOMContentLoaded

// Close modal on overlay click
// welderModal listener sa registruje v DOMContentLoaded

// ===== WELDBOOK =====
async function loadWeldBook() {
  try {
    await loadWbForPart(document.getElementById('wbFPart').value || null);
  } catch(e) { console.error('WB load error:', e); }
}

async function loadWbForPart(part) {
  const docId = part ? (part.toUpperCase() + '_main') : 'weldbook_main';
  try {
    // Sk√∫s part doc
    const doc = await db.collection('weldbook').doc(docId).get();
    if (doc.exists) {
      const meta = doc.data();
      const cps = [];
      for (let i=0; i<(meta.chunks||1); i++)
        cps.push(db.collection('weldbook').doc(docId).collection('data').doc('c'+i).get());
      const cds = await Promise.all(cps);
      weldBookData = JSON.parse(cds.filter(c=>c.exists).map(c=>c.data().d).join(''));
    } else {
      // Fallback na weldbook_main + filter
      const mainDoc = await db.collection('weldbook').doc('weldbook_main').get();
      if (mainDoc.exists) {
        const meta = mainDoc.data();
        const cps = [];
        for (let i=0; i<(meta.chunks||1); i++)
          cps.push(db.collection('weldbook').doc('weldbook_main').collection('data').doc('c'+i).get());
        const cds = await Promise.all(cps);
        const all = JSON.parse(cds.filter(c=>c.exists).map(c=>c.data().d).join(''));
        weldBookData = part ? all.filter(r=>(r.part||'').toUpperCase()===part.toUpperCase()) : all;
      }
    }
    // Cache
    try { localStorage.setItem('wbCache_'+(part||'ALL'), JSON.stringify(weldBookData)); } catch(e){}
    renderWeldBook(weldBookData);
    document.getElementById('wbCount').textContent = weldBookData.length + ' zvarov' + (part ? ' ('+part+')' : '');
  } catch(e) { console.error('WB load part error:', e); }
}

async function saveWeldBookToFirebase() {
  if (!db) return;
  try {
    // Zisti akt√≠vnu ƒças≈• - z WB filtru, alebo z projektu, alebo z d√°t
    let part = null;
    const wbFilterPart = document.getElementById('wbFPart') ? document.getElementById('wbFPart').value : '';
    if (wbFilterPart) {
      part = wbFilterPart.toUpperCase();
    } else if (currentProject) {
      part = getProjectPart() || null;
    } else if (selectedPart) {
      part = selectedPart.toUpperCase();
    }
    // Ak nem√°me part, zisti z d√°t samotn√Ωch (v≈°etky riadky musia ma≈• rovnak√Ω part)
    if (!part && weldBookData.length > 0) {
      const parts = [...new Set(weldBookData.map(r => (r.part||'').toUpperCase()).filter(Boolean))];
      if (parts.length === 1) part = parts[0];
    }

    const partRows = part
      ? weldBookData.filter(r => (r.part||'').toUpperCase() === part)
      : weldBookData;

    const docId = part ? (part + '_main') : 'weldbook_main';
    const json = JSON.stringify(partRows);
    const CHUNK = 800*1024;
    const chunks = [];
    for(let i=0;i<json.length;i+=CHUNK) chunks.push(json.slice(i,i+CHUNK));

    // 1. Najprv chunky
    await Promise.all(chunks.map((c,i)=>
      db.collection('weldbook').doc(docId).collection('data').doc('c'+i).set({d:c})
    ));

    // 2. Metadata
    await db.collection('weldbook').doc(docId).set({
      type:'part', part: part||'ALL', chunks:chunks.length, count:partRows.length,
      modifiedBy: currentUser?.username||'mobile', date:new Date().toISOString()
    });

    // 3. Signal
    await db.collection('weldbook_signal').doc('latest').set({
      by: currentUser?.username||'mobile',
      at: new Date().toISOString(),
      part: part||'ALL',
      count: partRows.length
    });
    console.log('‚úÖ WeldBook [' + (part||'ALL') + '] ulo≈æen√Ω:', partRows.length, 'zvarov');
  } catch(e) { console.error('WB save error:', e); showToast('‚ùå Chyba ukladania: ' + e.message); }
}

function onWbPartChange() {
  const part = document.getElementById('wbFPart').value;
  // Naƒç√≠taj z Firebase pre t√∫to ƒças≈•
  document.getElementById('wbCount').textContent = 'Naƒç√≠tavam ' + (part||'v≈°etko') + '...';
  loadWbForPart(part || null).then(() => {
    // Obnov izometrie dropdown
    const isoSel = document.getElementById('wbFIso');
    const isos = [...new Set(weldBookData.map(r=>r.isometric||'').filter(Boolean))].sort();
    isoSel.innerHTML = '<option value="">V≈°etky izometrie (' + isos.length + ')</option>' +
      isos.map(v=>`<option value="${v}">${v}</option>`).join('');
    filterWB();
  });
}

let _wbTimer = null;
function filterWB() {
  clearTimeout(_wbTimer);
  _wbTimer = setTimeout(_applyWbFilter, 150);
}

function _applyWbFilter() {
  const search = document.getElementById('wbSearch').value.toLowerCase().trim();
  const part = document.getElementById('wbFPart').value;
  const iso = document.getElementById('wbFIso').value;

  const filtered = weldBookData.filter(r => {
    if (part && (r.part||'').toUpperCase() !== part) return false;
    if (iso && (r.isometric||'') !== iso) return false;
    if (search) {
      const s = [r.isometric,r.weldId,r.welderId,r.dateWelding].join(' ').toLowerCase();
      if (!s.includes(search)) return false;
    }
    return true;
  });
  renderWeldBook(filtered);
  document.getElementById('wbCount').textContent = filtered.length + ' / ' + weldBookData.length + ' zvarov';
}

function renderWeldBook(rows) {
  const tbody = document.getElementById('wbBody');
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:32px;color:#9ca3af">≈Ωiadne z√°znamy</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map((r,i) => {
    const done = r.welderId && r.welderId.trim();
    return `<tr onclick="openWbModal(${weldBookData.indexOf(r)})">
      <td><span class="weld-status ${done?'status-done':'status-todo'}"></span></td>
      <td style="font-weight:700;color:#111">${r.weldId||'-'}</td>
      <td style="font-size:11px;color:#374151;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.isometric||'-'}</td>
      <td style="color:#6b7280">${r.sheets||1}</td>
      <td style="font-weight:${done?'600':'400'};color:${done?'#059669':'#9ca3af'}">${r.welderId||'‚Äî'}</td>
      <td style="font-size:12px;color:#6b7280">${r.dateWelding||'‚Äî'}</td>
    </tr>`;
  }).join('');
}

function openWbModal(idx) {
  const r = weldBookData[idx];
  if (!r) return;
  currentWbRow = { idx, row: r };
  document.getElementById('wb_weldNum').textContent = r.weldId || '-';
  document.getElementById('wb_iso').textContent = (r.isometric||'-').substring(0,40);
  document.getElementById('wb_sheet').textContent = r.sheets || 1;
  document.getElementById('wb_welder').value = r.welderId || '';
  document.getElementById('wb_date').value = r.dateWelding || today();
  // Zobraz tlaƒçidlo Odstr√°ni≈• len ak m√° zvaraƒça
  document.getElementById('wb_remove').style.display = (r.welderId && r.welderId.trim()) ? 'block' : 'none';
  const _el_wbModal_add = document.getElementById('wbModal'); if (_el_wbModal_add) _el_wbModal_add.classList.add('show');
  setTimeout(() => document.getElementById('wb_welder').focus(), 300);
}

function closeWbModal() {
  const _el_wbModal_remove = document.getElementById('wbModal'); if (_el_wbModal_remove) _el_wbModal_remove.classList.remove('show');
  currentWbRow = null;
}

function saveWbModal() {
  const welder = document.getElementById('wb_welder').value.trim();
  const date = document.getElementById('wb_date').value;
  if (!welder) { showToast('‚ö†Ô∏è Zadaj Welder ID'); return; }
  const r = currentWbRow.row;
  r.welderId = welder;
  r.dateWelding = date;
  closeWbModal();
  showToast('üíæ Uklad√°m...');
  saveWeldBookToFirebase().then(() => {
    filterWB();
    showToast('‚úÖ Ulo≈æen√©: zvar #' + r.weldId + ' ‚Üí ' + welder);
  });
}

function removeWbModal() {
  if (!currentWbRow) return;
  const r = currentWbRow.row;
  const weldId = r.weldId;
  r.welderId = '';
  r.dateWelding = '';
  closeWbModal();
  showToast('üíæ Odstra≈àujem...');
  saveWeldBookToFirebase().then(() => {
    filterWB();
    showToast('üóëÔ∏è Zvaraƒç odstr√°nen√Ω: zvar #' + weldId);
  });
}

function deleteWbRowModal() {
  if (!currentWbRow) return;
  const r = currentWbRow.row;
  const weldId = r.weldId;
  const iso = r.isometric || '';
  // Vyma≈æ z weldBookData
  const idx = weldBookData.indexOf(r);
  if (idx !== -1) weldBookData.splice(idx, 1);
  closeWbModal();
  showToast('üíæ Ma≈æem...');
  saveWeldBookToFirebase().then(() => {
    filterWB();
    showToast('üóëÔ∏è Zvar #' + weldId + ' vymazan√Ω');
  });
}

// wbModal listener sa registruje v DOMContentLoaded

// ===== HELPERS =====
function splitIso(fullName) {
  if (!fullName) return { part:'', iso:'' };
  if (fullName.includes(',')) {
    const last = fullName.lastIndexOf(',');
    const rawPart = fullName.substring(0, last);
    const iso = fullName.substring(last+1).trim();
    const m = rawPart.match(/^([A-Z]{2,6})/);
    return { part: m?m[1]:'', iso };
  }
  return { part:'', iso: fullName.trim() };
}

// ===== RESIZE =====
window.addEventListener('resize', () => {
  if (document.getElementById('montazPage').classList.contains('active')) mDraw();
});
</script>
</body>
</html>
