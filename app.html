<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeldPro 1.0 - Professional Welding Management</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#F0F0F0;min-height:100vh;color:#333333}
.header{position:fixed;top:0;left:0;right:0;background:#E8E8E8;border-bottom:1px solid #D0D0D0;padding:12px 20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);z-index:1000}
h1{margin:0 0 10px 0;color:#333333;font-size:14px;font-weight:600;letter-spacing:0.3px}
.controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:0}
input{padding:6px 10px;border:1px solid #D0D0D0;border-radius:3px;font-size:11px;background:#FFFFFF;transition:all 0.15s;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
input:focus{outline:none;border-color:#0078D4;box-shadow:0 0 0 2px rgba(0,120,212,0.1)}
input:disabled{background:#F0F0F0;font-weight:600;color:#666666}
button{padding:6px 12px;border:1px solid #D0D0D0;border-radius:3px;font-size:11px;font-weight:500;cursor:pointer;color:#555555;transition:all 0.15s;box-shadow:0 1px 2px rgba(0,0,0,0.05);background:#FFFFFF}
button:hover:not(:disabled){background:#F8F8F8;border-color:#B0B0B0;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
button:active:not(:disabled){transform:translateY(1px)}
button:disabled{opacity:0.5;cursor:not-allowed}
.btn-blue{background:#0078D4;color:white;border-color:#0078D4}.btn-blue:hover{background:#106EBE;border-color:#106EBE}
.btn-green{background:#10b981;color:white;border-color:#10b981}.btn-green:hover{background:#059669;border-color:#059669}
.btn-red{background:#E81123;color:white;border-color:#E81123}.btn-red:hover{background:#C5000B;border-color:#C5000B}
.btn-gray{background:#6b7280;color:white;border-color:#6b7280}.btn-gray:hover{background:#4b5563;border-color:#4b5563}
.btn-secondary{background:#8b5cf6;color:white;border-color:#8b5cf6}.btn-secondary:hover{background:#7c3aed;border-color:#7c3aed}
.btn-orange{background:#f97316;color:white;border-color:#f97316}.btn-orange:hover{background:#ea580c;border-color:#ea580c}
.main{padding-top:110px;display:flex;gap:20px;max-width:1920px;margin:0 auto;padding-left:20px;padding-right:20px}
.pdf-area{flex:1;background:#FFFFFF;padding:24px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px;border:1px solid #D0D0D0}
.weld-log-panel{width:30%;min-width:350px;max-width:500px;background:#FFFFFF;padding:24px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #D0D0D0;height:calc(100vh - 130px);overflow-y:auto;display:none}
.weld-log-panel.active{display:block}
.spool-panel{width:25%;min-width:300px;max-width:400px;background:white;padding:20px;border-radius:4px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.05);height:calc(100vh - 160px);overflow-y:auto;display:none;position:fixed;right:20px;top:160px}
.spool-panel.active{display:block}
.spool-panel h3{font-size:18px;font-weight:700;color:#667eea;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.spool-item{background:linear-gradient(135deg,#f0f4ff,#e0e7ff);padding:14px;border-radius:10px;margin-bottom:12px;border-left:4px solid #667eea}
.spool-item strong{display:block;color:#667eea;font-size:14px;margin-bottom:6px}
.spool-welds{color:#1f2937;font-size:13px;font-weight:600}
.spool-count{background:#667eea;color:white;padding:2px 8px;border-radius:3px;font-size:11px;margin-left:8px}
.weld-log-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e5e7eb}
.weld-log-header h2{font-size:20px;font-weight:700;color:#1f2937;margin-bottom:10px}
.materials-section{background:#f8fafc;padding:16px;border-radius:3px;margin-bottom:20px;border:1px solid #e5e7eb}
.materials-section h3{font-size:14px;font-weight:600;color:#4b5563;margin-bottom:12px}
.material-item{background:white;padding:10px 12px;border-radius:3px;margin-bottom:8px;font-size:13px;color:#1f2937;border:1px solid #e5e7eb}
.weld-entry{background:#ffffff;padding:16px;border-radius:3px;margin-bottom:16px;border:2px solid #e5e7eb;transition:all 0.2s}
.weld-entry:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.1)}
.weld-entry-header{font-size:15px;font-weight:700;color:#667eea;margin-bottom:12px}
.weld-field{margin-bottom:12px}
.weld-field label{display:block;font-size:12px;font-weight:600;color:#6b7280;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.weld-field select{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:3px;font-size:13px;background:white;cursor:pointer;transition:all 0.2s}
.weld-field select:hover{border-color:#cbd5e1}
.weld-field select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.btn-small{padding:8px 14px;font-size:12px;border-radius:6px}
.upload-zone{border:3px dashed #cbd5e1;border-radius:4px;padding:80px 40px;text-align:center;background:#f8fafc;min-height:400px;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all 0.3s}
.upload-zone:hover{border-color:#667eea;background:#f0f4ff}
.canvas-wrapper{position:relative;border:1px solid #e2e8f0;border-radius:4px;height:calc(100vh - 200px);background:#ffffff;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.05)}
#pdfCanvas{display:block;background:white;position:relative}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.canvas-inner{position:relative;display:inline-block}
.weld-focus-view{display:none;position:fixed;left:20px;top:100px;width:calc(70% - 40px);height:calc(100vh - 120px);background:white;border-radius:4px;box-shadow:0 8px 32px rgba(0,0,0,0.2);z-index:1500;overflow:hidden}
.weld-focus-view.active{display:flex;flex-direction:column}
.weld-zoom-section{flex:1;overflow:hidden;border-bottom:2px solid #e5e7eb;position:relative;background:#f9fafb}
.materials-table-section{height:300px;overflow:auto;padding:20px;background:white}
.weld-zoom-canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain}
.close-focus-btn{position:absolute;top:15px;right:15px;background:rgba(255,255,255,0.9);border:none;border-radius:50%;width:40px;height:40px;font-size:24px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:10}
.close-focus-btn:hover{background:white;transform:scale(1.1)}
.mto-window{position:fixed;top:100px;right:50px;width:600px;background:white;border-radius:3px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:2500;display:none;flex-direction:column;max-height:80vh}
.mto-window.active{display:flex}
.mto-window.minimized{width:300px;height:60px;top:auto;bottom:20px;right:20px}
.mto-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 20px;border-radius:3px 12px 0 0;display:flex;justify-content:space-between;align-items:center;cursor:move;user-select:none}
.mto-header h3{margin:0;font-size:18px;font-weight:600}
.mto-controls{display:flex;gap:10px}
.mto-controls button{background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.2s}
.mto-controls button:hover{background:rgba(255,255,255,0.3);transform:scale(1.1)}
.mto-body{padding:20px;overflow-y:auto;flex:1}
.mto-body.hidden{display:none}
.mto-file-list{max-height:300px;overflow-y:auto;margin:15px 0}
.mto-file-item{padding:12px;background:#f9fafb;border-radius:3px;margin-bottom:10px;border:1px solid #e5e7eb}
.mto-file-name{font-weight:500;color:#1f2937;margin-bottom:8px;font-size:14px}
.mto-progress-bar{width:100%;height:24px;background:#e5e7eb;border-radius:3px;overflow:hidden;position:relative}
.mto-progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:600}
.mto-summary{padding:15px;background:#f0f4ff;border-radius:3px;margin:15px 0;border-left:4px solid #667eea}
.mto-footer{padding:15px 20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end}
.instruction{background:linear-gradient(135deg,#e0e7ff,#ddd6fe);padding:18px;border-radius:3px;margin-top:15px;border-left:4px solid #667eea;font-size:13px;line-height:1.7;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
.zoom-info{position:fixed;bottom:24px;left:24px;background:white;padding:16px 20px;border-radius:3px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:1000;font-weight:600;color:#1f2937;border:1px solid rgba(0,0,0,0.05)}
.quality-badge{background:linear-gradient(135deg,#10b981,#059669);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:bold;display:inline-block;margin-top:12px;box-shadow:0 2px 8px rgba(16,185,129,0.3)}
#progressContainer{margin-top:12px;display:none}
.progress-bar-bg{background:#e9ecef;border-radius:3px;overflow:hidden;height:28px;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
#progressBar{background:linear-gradient(90deg,#10b981,#059669);height:100%;width:0%;transition:width 0.3s ease}
#progressText{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:13px;font-weight:700;color:#1f2937;z-index:1}
@media(max-width:1024px){.main{padding-top:160px}.header{padding:10px 15px}.controls{gap:5px}button{padding:8px 12px;font-size:12px}}
/* BOÄŒNÃ PANEL PRE PROJEKTY */
.projects-panel{position:fixed;left:0;top:110px;height:calc(100vh - 110px);width:200px;background:#D8D8D8;box-shadow:2px 0 4px rgba(0,0,0,0.1);transform:translateX(-170px);transition:transform 0.2s ease;z-index:5000;border-right:1px solid #C0C0C0}
.projects-panel:hover{transform:translateX(0)}
.panel-tab{position:absolute;right:-30px;top:50%;transform:translateY(-50%);width:30px;height:60px;background:#D8D8D8;border:1px solid #C0C0C0;border-left:none;border-radius:0 4px 4px 0;display:flex;align-items:center;justify-content:center;color:#555555;font-size:14px;cursor:pointer;box-shadow:1px 0 3px rgba(0,0,0,0.1)}
.panel-content{padding:12px;height:100%;overflow-y:auto;color:#333333}
.panel-header{font-size:11px;font-weight:600;margin-bottom:12px;color:#555555;text-transform:uppercase;letter-spacing:0.5px;padding-bottom:8px;border-bottom:1px solid #C0C0C0}
.panel-section{background:#E8E8E8;border-radius:4px;padding:12px;margin-bottom:12px;border:1px solid #D0D0D0}
.section-label{font-size:10px;font-weight:600;color:#666666;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px}
.current-display{background:#FFFFFF;color:#333333;padding:6px 10px;border-radius:3px;margin-bottom:8px;font-weight:500;font-size:11px;word-break:break-word;border:1px solid #C0C0C0;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
.btn-panel{background:#0078D4;color:white;border:none;padding:6px 12px;border-radius:3px;font-weight:600;cursor:pointer;width:100%;font-size:10px;transition:all 0.15s;text-transform:uppercase;letter-spacing:0.3px;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
.btn-panel:hover{background:#106EBE;box-shadow:0 2px 4px rgba(0,0,0,0.15)}
.parts-list{background:#F0F0F0;border-radius:3px;padding:6px;max-height:300px;overflow-y:auto;border:1px solid #D0D0D0}
.part-item{background:#FFFFFF;padding:6px 8px;border-radius:2px;margin-bottom:4px;font-size:11px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all 0.15s;border:1px solid #E0E0E0}
.part-item:hover{background:#F8F8F8;border-color:#B0B0B0}
.part-item.active{background:#CCE4F7;border-left:3px solid #0078D4;border-color:#0078D4;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
.part-count{background:#E8E8E8;color:#555555;padding:2px 6px;border-radius:2px;font-size:9px;font-weight:600;border:1px solid #D0D0D0}

/* RIBBON MENU - Excel Style */
.ribbon-container{background:#F8F8F8;border-bottom:1px solid #D0D0D0;padding:0;box-shadow:0 1px 2px rgba(0,0,0,0.05)}
.ribbon-tabs{display:flex;gap:2px;background:#E8E8E8;padding:4px 8px;border-bottom:1px solid #D0D0D0}
.ribbon-tab{background:transparent;border:none;padding:6px 16px;font-size:11px;font-weight:500;color:#555555;cursor:pointer;border-radius:3px 3px 0 0;transition:all 0.15s}
.ribbon-tab:hover{background:#F0F0F0;color:#333333}
.ribbon-tab.active{background:#F8F8F8;color:#333333;font-weight:600;border:1px solid #D0D0D0;border-bottom:1px solid #F8F8F8;position:relative;bottom:-1px}
.ribbon-content{display:none;padding:4px 12px;min-height:36px;align-items:center;gap:6px}
.ribbon-content.active{display:flex}
.ribbon-group{display:flex;gap:4px;padding-right:12px;border-right:1px solid #D0D0D0;align-items:center}
.ribbon-group:last-child{border-right:none}
.toolbar-main{display:flex;gap:6px;padding:6px 12px;background:#F0F0F0;border-bottom:1px solid #D0D0D0;align-items:center}
@keyframes pulse {
0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
50% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
}
#chatFloatingBtn:hover {
transform: scale(1.1);
box-shadow: 0 12px 32px rgba(102,126,234,0.5);
}
.chat-user-item {
padding: 12px;
border-radius: 8px;
cursor: pointer;
margin-bottom: 8px;
transition: all 0.2s;
background: white;
border: 2px solid #e5e7eb;
}
.chat-user-item:hover {
background: #f3f4f6;
border-color: #667eea;
}
.chat-user-item.active {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
border-color: #667eea;
}
.chat-message {
margin-bottom: 15px;
display: flex;
gap: 10px;
}
.chat-message.own {
flex-direction: row-reverse;
}
.chat-bubble {
max-width: 70%;
padding: 12px 16px;
border-radius: 16px;
font-size: 14px;
line-height: 1.4;
}
.chat-bubble.own {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
border-bottom-right-radius: 4px;
}
.chat-bubble.other {
background: #f3f4f6;
color: #1f2937;
border-bottom-left-radius: 4px;
}
.new-chat-user-item:hover {
background: #f3f4f6 !important;
border-color: #667eea !important;
}

/* PDF PREVIEW MODAL */
#pdfPreviewModal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.7);
z-index: 99999;
justify-content: center;
align-items: center;
}
#pdfPreviewModal.active {
display: flex;
}
.preview-container {
background: white;
border-radius: 8px;
padding: 20px;
width: 90vw;
height: 90vh;
display: flex;
flex-direction: column;
box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.preview-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
padding-bottom: 10px;
border-bottom: 2px solid #e5e7eb;
flex-shrink: 0;
}
.preview-header h2 {
margin: 0;
font-size: 18px;
color: #1f2937;
}
.preview-canvas-wrapper {
flex: 1;
overflow: auto;
border: 1px solid #d1d5db;
border-radius: 4px;
background: #f9fafb;
display: flex;
justify-content: center;
align-items: center;
min-height: 0;
}
.preview-controls {
display: flex;
justify-content: center;
align-items: center;
gap: 15px;
margin-top: 15px;
padding-top: 15px;
border-top: 2px solid #e5e7eb;
}
.preview-scale-control {
display: flex;
align-items: center;
gap: 10px;
padding: 8px 15px;
background: #f3f4f6;
border-radius: 6px;
}
.preview-scale-control button {
padding: 8px 15px;
font-size: 18px;
background: white;
border: 1px solid #d1d5db;
border-radius: 4px;
cursor: pointer;
transition: all 0.2s;
}
.preview-scale-control button:hover {
background: #667eea;
color: white;
border-color: #667eea;
}
.preview-scale-display {
min-width: 60px;
text-align: center;
font-weight: bold;
font-size: 16px;
color: #1f2937;
}
.preview-actions {
display: flex;
gap: 10px;
}
.preview-btn {
padding: 10px 25px;
font-size: 14px;
font-weight: 600;
border: none;
border-radius: 6px;
cursor: pointer;
transition: all 0.2s;
}
.preview-btn-export {
background: #10b981;
color: white;
}
.preview-btn-export:hover {
background: #059669;
}
.preview-btn-cancel {
background: #ef4444;
color: white;
}
.preview-btn-cancel:hover {
background: #dc2626;
}
</style>
<!-- QR Scanner Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<!-- jsPDF Library for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
var jsPDF = window.jspdf.jsPDF;
</script>

<!-- Firebase -->
<!-- Firebase SDK - UNPKG CDN (alternatÃ­va ku gstatic.com) -->
<!-- Firebase v9 Modular SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
  import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
  import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBxM-CWiN7-m8bYOp0-0BQ9TvPl3XqGHrc",
    authDomain: "weldpro-66d2a-8336e.firebaseapp.com",
    projectId: "weldpro-66d2a-8336e",
    storageBucket: "weldpro-66d2a-8336e.firebasestorage.app",
    messagingSenderId: "1062303461642",
    appId: "1:1062303461642:web:e90ff234366c88a5eccaf3"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
  window.auth = getAuth(app);
  
  signInAnonymously(window.auth)
    .then(() => {
      console.log('âœ… Firebase v9 ready!');
      window.firebaseReady = true;
    })
    .catch(err => console.error('âŒ Firebase auth error:', err));
</script>

<!-- Fallback pre starÅ¡ie browsery -->
<script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-app-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-auth-compat.js"></script>

<script>
// ğŸ”’ SESSION CHECK - Ochrana proti neautorizovanÃ©mu prÃ­stupu
(function() {
  const session = localStorage.getItem('weldpro_session') || sessionStorage.getItem('weldpro_session');
  
  if (!session) {
    console.log('âŒ Nie ste prihlÃ¡senÃ½! Presmerovanie na login...');
    window.location.href = 'login.html';
    return;
  }
  
  try {
    const userData = JSON.parse(session);
    console.log('âœ… PrihlÃ¡senÃ½ ako:', userData.displayName, '(' + userData.role + ')');
    
    // UloÅ¾ do globÃ¡lnej premennej
    window.currentUser = userData;
    
    // âœ… Å TART HEARTBEAT HNEÄ!
    window.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Starting heartbeat for:', userData.username);
      if(typeof startHeartbeat === 'function'){
        startHeartbeat();
      } else {
        // Ak funkcia eÅ¡te neexistuje, poÄkaj a skÃºs znova
        setTimeout(function(){
          if(typeof startHeartbeat === 'function'){
            startHeartbeat();
            console.log('âœ… Heartbeat started (delayed)');
          }
        }, 2000);
      }
    });
    
    // Zobraz ADMIN tlaÄidlo ak je admin
    if (userData.role === 'admin') {
      window.addEventListener('DOMContentLoaded', function() {
        const adminBtn = document.getElementById('adminBtn');
        const adminChatHistoryBtn = document.getElementById('adminChatHistoryBtn');
        if (adminBtn) {
          adminBtn.style.display = 'inline-block';
        }
        if (adminChatHistoryBtn) {
          adminChatHistoryBtn.style.display = 'inline-block';
        }
      });
    }
    
  } catch (e) {
    console.error('âŒ NeplatnÃ¡ session!', e);
    localStorage.removeItem('weldpro_session');
    sessionStorage.removeItem('weldpro_session');
    window.location.href = 'login.html';
  }
})();

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDYFCovgo873FIrX4_pEdG1LpDKevxxEU4",
  authDomain: "weldpro-66d2a-8336e.firebaseapp.com",
  projectId: "weldpro-66d2a-8336e",
  storageBucket: "weldpro-66d2a-8336e.firebasestorage.app",
  messagingSenderId: "1062303461642",
  appId: "1:1062303461642:web:e90ff234366c88a5eccaf3"
};

let db = null;
let auth = null;
let firebaseReady = false;

// KRITICKÃ OPRAVA - PoÄkaj na Firebase SDK a potom inicializuj
async function initFirebase() {
  // PoÄkaj na Firebase SDK (max 10 sekÃºnd)
  let attempts = 0;
  while (typeof firebase === 'undefined' && attempts < 100) {
    console.log('â³ ÄŒakÃ¡m na Firebase SDK... (pokus', attempts + 1, '/ 100)');
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  
  if (typeof firebase === 'undefined') {
    console.error('âŒ Firebase SDK sa nenaÄÃ­tal!');
    return;
  }
  
  try {
    console.log('ğŸ”¥ Inicializujem Firebase...');
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    
    // PrihlÃ¡s sa anonymne
    await auth.signInAnonymously();
    console.log('âœ… Firebase ready!');
    firebaseReady = true;
  } catch(err) {
    console.error('âŒ Firebase init chyba:', err);
    firebaseReady = false;
  }
}

// Spusti inicializÃ¡ciu hneÄ
initFirebase();

async function uploadProjectToFirebase(projectData) {
  if (!db) throw new Error('Firebase not ready');
  
  console.log('ğŸ”¥ UPLOAD TO FIREBASE - DEBUG:');
  console.log('  projectData.welds.length:', projectData.welds?.length || 0);
  console.log('  projectData.projectName:', projectData.projectName);
  console.log('  projectData.partName:', projectData.partName);
  
  const projectName = projectData.projectName || 'project';
  const partName = projectData.partName;
  
  // Ak je ÄasÅ¥ definovanÃ¡, pouÅ¾i projectName_partName, inak len projectName
  const docId = partName ? (projectName + '_' + partName) : projectName;
  
  console.log('ğŸ”¥ Budem ukladaÅ¥ ako docId:', docId);
  
  const jsonString = JSON.stringify(projectData);
  console.log('ğŸ”¥ JSON string size:', (jsonString.length / 1024).toFixed(1), 'KB');
  
  // VERIFY: PoÄet zvarov po stringify
  const parsed = JSON.parse(jsonString);
  console.log('ğŸ”¥ VERIFY po stringify: welds.length =', parsed.welds.length);
  if(parsed.welds.length !== projectData.welds.length){
    console.error('âŒ CHYBA! PoÄet zvarov sa zmenil pri stringify!', projectData.welds.length, 'â†’', parsed.welds.length);
  }
  
  const CHUNK_SIZE = 800 * 1024;
  const chunks = [];
  for (let i = 0; i < jsonString.length; i += CHUNK_SIZE) chunks.push(jsonString.slice(i, i + CHUNK_SIZE));
  
  console.log('ğŸ”¥ PoÄet chunkov:', chunks.length);
  
  const metadata = {
    name: projectName, 
    chunks: chunks.length, 
    size: jsonString.length, 
    date: new Date().toISOString()
  };
  
  // Pridaj part len ak je definovanÃ½
  if(partName) metadata.part = partName;
  
  // VYMAZAÅ¤ STARÃ‰ CHUNKY PRED ULOÅ½ENÃM NOVÃCH!
  console.log('ğŸ—‘ï¸ VymazÃ¡vam starÃ© chunky pre:', docId);
  const oldChunks = await db.collection('projects').doc(docId).collection('data').get();
  console.log('ğŸ—‘ï¸ NaÅ¡iel som', oldChunks.docs.length, 'starÃ½ch chunkov');
  for(const chunkDoc of oldChunks.docs) {
    await chunkDoc.ref.delete();
  }
  console.log('ğŸ—‘ï¸ StarÃ© chunky vymazanÃ©');
  
  console.log('ğŸ’¾ UkladÃ¡m metadata...');
  await db.collection('projects').doc(docId).set(metadata);
  console.log('ğŸ’¾ UkladÃ¡m chunky...');
  for (let i = 0; i < chunks.length; i++) {
    await db.collection('projects').doc(docId).collection('data').doc('c' + i).set({d: chunks[i]});
    console.log('ğŸ’¾ Chunk', i+1, '/', chunks.length, 'uloÅ¾enÃ½');
  }
  console.log('âœ… Uploaded:',docId);
}

async function downloadProjectFromFirebase(projectName) {
  console.log('ğŸ“¥ DOWNLOAD FROM FIREBASE - DEBUG:');
  console.log('  projectName:', projectName);
  
  if (!db) throw new Error('Firebase not ready');
  const doc = await db.collection('projects').doc(projectName).get();
  if (!doc.exists) throw new Error('Not found');
  const meta = doc.data();
  
  console.log('ğŸ“¥ Metadata:', meta);
  console.log('ğŸ“¥ OÄakÃ¡vanÃ½ poÄet chunkov:', meta.chunks);
  
  const chunks = [];
  for (let i = 0; i < meta.chunks; i++) {
    const c = await db.collection('projects').doc(projectName).collection('data').doc('c' + i).get();
    if (c.exists) {
      chunks.push(c.data().d);
      console.log('ğŸ“¥ Chunk', i, 'naÄÃ­tanÃ½, size:', c.data().d.length);
    } else {
      console.error('âŒ Chunk', i, 'NEEXISTUJE!');
    }
  }
  
  console.log('ğŸ“¥ SpÃ¡jam', chunks.length, 'chunkov...');
  const jsonString = chunks.join('');
  console.log('ğŸ“¥ CelkovÃ¡ veÄ¾kosÅ¥ JSON:', (jsonString.length / 1024).toFixed(1), 'KB');
  
  const parsed = JSON.parse(jsonString);
  console.log('ğŸ“¥ PARSED: welds.length =', parsed.welds?.length || 0);
  
  return parsed;
}

async function listProjectsFromFirebase() {
  if (!db) return [];
  const currentPart = projectsData.currentPart;
  const snap = await db.collection('projects').get();
  return snap.docs
    .map(d => d.data())
    .filter(p => {
      if (!currentPart) return true;
      return p.part === currentPart;
    });
}
</script>

</head>
<body>

<!-- ğŸ”” UPDATE NOTIFICATION BANNER -->
<div id="updateNotification" style="display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:100000;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:15px 25px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideDown 0.5s ease;min-width:450px;max-width:650px">
  <div style="display:flex;align-items:center;gap:15px">
    <div style="font-size:32px">âš ï¸</div>
    <div style="flex:1">
      <div style="font-weight:bold;font-size:16px;margin-bottom:5px">Projekt bol aktualizovanÃ½!</div>
      <div id="updateNotificationProject" style="font-size:14px;font-weight:600;margin-bottom:3px"></div>
      <div style="font-size:12px;opacity:0.85">Klikni na ğŸ”” pre detail zmien</div>
    </div>
    <button onclick="refreshProjectFromNotification(event)" style="background:white;color:#d97706;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:14px;transition:all 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
      ğŸ”„ NaÄÃ­taÅ¥
    </button>
    <button onclick="ignoreUpdateNotification(event)" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);padding:10px 18px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
      â­ï¸ IgnorovaÅ¥
    </button>
    <button onclick="dismissUpdateNotification(event)" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold;line-height:1" title="ZavrieÅ¥">
      âœ•
    </button>
  </div>
</div>

<style>
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}
</style>

<div class="header">
<h1>ğŸ”§ WeldPro 1.0</h1>

<!-- INFO PANEL -->
<div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;padding:6px 12px;background:#E8E8E8;border-radius:3px;margin-bottom:6px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;font-weight:600;color:#555555">SÃºbor:</span>
<span id="fileName" style="font-size:11px;color:#333333;font-weight:500">Å½iadny sÃºbor</span>
</div>
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;font-weight:600;color:#555555">ZaÄaÅ¥ od:</span>
<input type="number" id="startNumInput" value="1" min="1" style="width:50px;padding:4px;font-size:11px">
<button onclick="setStartNumber()" id="setstart" style="padding:4px 8px;font-size:10px">âš™ï¸ NastaviÅ¥</button>
</div>
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;font-weight:600;color:#555555">Zvarov:</span>
<span id="weldCount" style="font-size:12px;color:#0078D4;font-weight:700">0</span>
</div>
</div>

<!-- HLAVNÃ LIÅ TA - vÅ¡etko v jednom riadku -->
<div class="toolbar-main">
<button onclick="document.getElementById('f').click()">ğŸ“ NahraÅ¥ PDF</button>
<button onclick="openLibraryManagerReal()" style="background:#8b5cf6;color:white">ğŸ“š KniÅ¾nica (Advanced)</button>
<button onclick="openLibrary()" style="background:#10b981;color:white">ğŸ“š Online KniÅ¾nica</button>
<button onclick="setTool('select')" id="selectbtn" disabled>ğŸ‘† Kurzor</button>
<button onclick="zi()" id="zi" disabled>ğŸ”+</button>
<button onclick="zo()" id="zo" disabled>ğŸ”-</button>
<button onclick="zr()" id="zr" disabled>ğŸ”„ ObnoviÅ¥</button>
<button onclick="undo()" id="undo" disabled>â†©ï¸ SpÃ¤Å¥</button>

<div style="width:1px;height:24px;background:#D0D0D0;margin:0 8px"></div>

<button class="ribbon-tab active" onclick="switchRibbonTab('redpen')">âœï¸ RED PEN</button>
<button class="ribbon-tab" onclick="switchRibbonTab('prefab')">ğŸ­ PREFABRIKÃCIA</button>
<button class="ribbon-tab" onclick="switchRibbonTab('vyroba')">ğŸ­ VÃROBA</button>
<button class="ribbon-tab" onclick="switchRibbonTab('kontrola')">ğŸ” KONTROLA</button>
<button class="ribbon-tab" onclick="switchRibbonTab('montaz')">ğŸ—ï¸ MONTÃÅ½/QC</button>
<button class="ribbon-tab" onclick="switchRibbonTab('export')">ğŸ“¦ EXPORT</button>
<button class="ribbon-tab" onclick="switchRibbonTab('progres')">ğŸ“Š PROGRES</button>

<!-- NOTIFIKÃCIE -->
<div style="position:relative;margin-left:20px">
<button onclick="toggleNotifications()" style="position:relative;background:#fff;border:2px solid #0078D4;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:18px">
ğŸ””
<span id="notificationBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ef4444;color:white;border-radius:50%;width:24px;height:24px;font-size:12px;font-weight:bold;line-height:24px;text-align:center"></span>
</button>
</div>

<div style="flex:1"></div>

<button onclick="toggleWeldLog()" id="weldlogbtn" disabled>ğŸ“‹ Weld Log</button>
<button onclick="openWeldBook()" id="weldbookbtn">ğŸ“Š WeldBook</button>
<button onclick="openMTO()" id="mtobtn" disabled>ğŸ“Š MTO</button>
<button onclick="saveProject()" id="saveproj" disabled>ğŸ’¾ Projekt</button>
<button onclick="saveToLibrary()" id="savetolibrary" disabled style="background:#10b981;color:white">â˜ï¸ Do kniÅ¾nice</button>
<button onclick="openOfflinePackageModal()" style="background:#f59e0b;color:white">ğŸ“¦ Offline balÃ­k</button>
<button onclick="openOfflineModeModal()" style="background:#8b5cf6;color:white">ğŸ“± Offline reÅ¾im</button>
<button onclick="document.getElementById('loadproj').click()" id="loadprojbtn" disabled>ğŸ“‚ NaÄÃ­taÅ¥</button>
<button onclick="savePDF()" id="savepdf" disabled>ğŸ“„ PDF</button>
<button onclick="cl()" id="cl" disabled>ğŸ—‘ï¸ ZmazaÅ¥</button>
<button onclick="openAdminPanel()" id="adminBtn" style="background:#8b5cf6;color:white;margin-left:10px;display:none">âš™ï¸ ADMIN</button>
<button onclick="openAdminChatHistory()" id="adminChatHistoryBtn" style="background:#667eea;color:white;margin-left:5px;display:none">ğŸ“œ Chat histÃ³ria</button>
<button onclick="toggleNotificationsPanel()" id="notificationsBtn" style="position:relative;background:transparent;border:2px solid #e5e7eb;color:#6b7280;margin-left:10px;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:18px">
ğŸ””
<span id="notificationsBadge" style="display:none;position:absolute;top:-5px;right:-5px;background:#ef4444;color:white;border-radius:50%;width:20px;height:20px;font-size:11px;font-weight:700;line-height:20px;text-align:center"></span>
</button>
<div id="offlineIndicator" style="display:inline-flex;align-items:center;gap:8px;margin-left:10px;padding:8px 16px;background:#10b981;color:white;border-radius:6px;font-weight:600;font-size:13px">
<span id="connectionStatus">ğŸŸ¢ Online</span>
<span id="pendingSyncCount" style="display:none;background:rgba(255,255,255,0.3);padding:2px 8px;border-radius:4px;font-size:11px"></span>
</div>
<button onclick="showPendingChangesModal()" id="detailsBtn" style="display:none;background:#6366f1;color:white;margin-left:10px">ğŸ“‹ Detaily</button>
<button onclick="syncOfflineData()" id="syncBtn" style="display:none;background:#f59e0b;color:white;margin-left:10px;animation:pulse 2s infinite">ğŸ“¤ NahraÅ¥ zmeny</button>
<button onclick="logout()" style="background:#ef4444;color:white;margin-left:10px">ğŸšª OdhlÃ¡siÅ¥</button>
</div>

<!-- RIBBON MENU - uÅ¾Å¡Ã­ pod-menu -->
<div class="ribbon-container">
<!-- OBSAH POD ZÃLOÅ½KAMI -->
<div id="ribbonRedpen" class="ribbon-content active">
<div class="ribbon-group">
<button onclick="setWeldMode(true)" id="oneclickbtn" disabled>ğŸ¯ 1-klik</button>
<button onclick="setWeldMode(false)" id="twoclickbtn" disabled>âœ‹ 2-kliky</button>
</div>
<div class="ribbon-group">
<button onclick="toggleEditMode()" id="editmode" disabled>âœï¸ Edit zvary</button>
</div>
<div class="ribbon-group" title="VeÄ¾kosÅ¥ zvarov (krÃºÅ¾ky + ÄÃ­sla)">
<button onclick="adjustWeldScale(-0.1)" id="weldscaleminus" disabled style="font-size:16px;padding:2px 8px">â–</button>
<span id="weldScaleDisplay" style="display:inline-block;min-width:50px;text-align:center;font-size:11px;font-weight:bold">100%</span>
<button onclick="adjustWeldScale(0.1)" id="weldscaleplus" disabled style="font-size:16px;padding:2px 8px">â•</button>
</div>
<div class="ribbon-group">
<button onclick="activateDrawTool('line')" id="linebtn" disabled>ğŸ“ PaliÄka</button>
<button onclick="activateDrawTool('text')" id="textbtn" disabled>T Text</button>
<button onclick="activateDrawTool('curve')" id="curvebtn" disabled>âŒ¢ OblÃºÄik</button>
<button onclick="activateDrawTool('arrow')" id="arrowbtn" disabled>â†’ Å Ã­pka</button>
<button onclick="activateDrawTool('doublearrow')" id="doublearrowbtn" disabled>â†” DvojÅ¡Ã­pka</button>
</div>

</div>

<!-- ZDIEÄ½ANÃ‰ TOOLBARY PRE RED PEN A PREFABRIKÃCIU -->
<div id="lineOptions" class="ribbon-group" style="display:none">
<select id="lineColor" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="#FF0000" selected>ğŸ”´ ÄŒervenÃ¡</option>
<option value="#000000">âš« ÄŒierna</option>
<option value="#0078D4">ğŸ”µ ModrÃ¡</option>
<option value="#10b981">ğŸŸ¢ ZelenÃ¡</option>
<option value="#f97316">ğŸŸ  OranÅ¾ovÃ¡</option>
<option value="#FFD700">ğŸŸ¡ Å½ltÃ¡</option>
</select>
<select id="lineWidth" onchange="lineWidth=parseFloat(this.value);console.log('ğŸ“ Line width:',lineWidth)" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="0.5">0.5px</option>
<option value="1">1px</option>
<option value="1.5">1.5px</option>
<option value="2" selected>2px</option>
<option value="2.5">2.5px</option>
<option value="3">3px</option>
<option value="4">4px</option>
<option value="5">5px</option>
</select>
</div>

<div id="textOptions" class="ribbon-group" style="display:none">
<select id="textColor" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="#FF0000" selected>ğŸ”´ ÄŒervenÃ¡</option>
<option value="#000000">âš« ÄŒierna</option>
<option value="#0078D4">ğŸ”µ ModrÃ¡</option>
<option value="#10b981">ğŸŸ¢ ZelenÃ¡</option>
<option value="#f97316">ğŸŸ  OranÅ¾ovÃ¡</option>
</select>
<select id="textSize" onchange="textSize=parseInt(this.value);console.log('ğŸ“ Text size:',textSize)" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="10">10px</option>
<option value="12" selected>12px</option>
<option value="14">14px</option>
<option value="16">16px</option>
<option value="18">18px</option>
<option value="20">20px</option>
<option value="24">24px</option>
</select>
</div>

<div id="arrowOptions" class="ribbon-group" style="display:none">
<select id="arrowColor" onchange="updateArrowSettings()" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="#FF0000" selected>ğŸ”´ ÄŒervenÃ¡</option>
<option value="#000000">âš« ÄŒierna</option>
<option value="#0078D4">ğŸ”µ ModrÃ¡</option>
<option value="#10b981">ğŸŸ¢ ZelenÃ¡</option>
<option value="#f97316">ğŸŸ  OranÅ¾ovÃ¡</option>
</select>
<select id="arrowWidth" onchange="updateArrowSettings()" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="0.3">0.3px</option>
<option value="0.5">0.5px</option>
<option value="1">1px</option>
<option value="1.5">1.5px</option>
<option value="2" selected>2px</option>
<option value="2.5">2.5px</option>
<option value="3">3px</option>
<option value="4">4px</option>
</select>
</div>

<div id="dimensionOptions" class="ribbon-group" style="display:none">
<select id="dimensionColor" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="#FF0000" selected>ğŸ”´ ÄŒervenÃ¡</option>
<option value="#000000">âš« ÄŒierna</option>
<option value="#0078D4">ğŸ”µ ModrÃ¡</option>
<option value="#10b981">ğŸŸ¢ ZelenÃ¡</option>
<option value="#f97316">ğŸŸ  OranÅ¾ovÃ¡</option>
</select>
<select id="dimensionFontSize" onchange="dimensionFontSize=parseInt(this.value);console.log('ğŸ“ Dimension size:',dimensionFontSize)" style="padding:4px 6px;font-size:10px;border:1px solid #D0D0D0;border-radius:3px">
<option value="12">12px</option>
<option value="14">14px</option>
<option value="16" selected>16px</option>
<option value="18">18px</option>
<option value="20">20px</option>
<option value="24">24px</option>
<option value="28">28px</option>
<option value="32">32px</option>
</select>
</div>

<div id="ribbonPrefab" class="ribbon-content">
<div class="ribbon-group">
<button onclick="setTool('spool')" id="spoolbtn" disabled>ğŸ”§ Spool</button>
</div>
<div class="ribbon-group">
<button onclick="toggleEditCrossesMode()" id="editcrossmode" disabled>âœï¸ Edit krÃ­Å¾iky</button>
<button onclick="setTool('cross')" id="crossbtn" disabled>âœ–ï¸ KrÃ­Å¾ik</button>
</div>
<div class="ribbon-group">
<button onclick="activateDimension()" id="dimensionbtn" disabled>ğŸ“ Domerok</button>
</div>
<div class="ribbon-group">
<button onclick="activateDrawTool('line')" id="prefab_linebtn" disabled>ğŸ“ PaliÄka</button>
<button onclick="activateDrawTool('text')" id="prefab_textbtn" disabled>ğŸ“ Text</button>
<button onclick="activateDrawTool('curve')" id="prefab_curvebtn" disabled>â˜ï¸ OblaÄik</button>
<button onclick="activateDrawTool('arrow')" id="prefab_arrowbtn" disabled>â¡ï¸ Å Ã­pka</button>
<button onclick="activateDrawTool('doublearrow')" id="prefab_doublearrowbtn" disabled>â¬Œ DvojÅ¡Ã­pka</button>
</div>
<div class="ribbon-group">
<button onclick="ex()" id="ex" disabled>ğŸ’¾ Export CSV</button>
</div>

</div>

<div id="ribbonVyroba" class="ribbon-content">
<div class="ribbon-group">
<button onclick="document.getElementById('loadIsos').click()" id="loadisosbtn">ğŸ“‚ NaÄÃ­taÅ¥ izometrie</button>
<input type="file" id="loadIsos" accept=".pdf" multiple style="display:none" onchange="loadIsometries(this.files)">
</div>
<div class="ribbon-group">
<button onclick="showVyrobaList()" id="vyrobalistbtn">ğŸ“‹ Zoznam vÃ½roby</button>
</div>
</div>

<div id="ribbonKontrola" class="ribbon-content">
<div class="ribbon-group">
<button onclick="showSpoolList()" id="spoollistbtn" disabled>ğŸ“‹ Zoznam spoolov</button>
</div>
<div class="ribbon-group">
<button onclick="refreshSpoolList()" id="refreshspoolbtn" disabled>ğŸ”„ ObnoviÅ¥</button>
</div>
</div>
</div>

<div id="ribbonMontaz" class="ribbon-content">
<div class="ribbon-group">
<label style="display:block;margin-bottom:5px;font-weight:600">FILTER ZOBRAZENIE:</label>
<label style="display:block;margin:3px 0;cursor:pointer"><input type="checkbox" id="filterShowPrefab" checked onchange="updateDisplayFilter()"> <span style="color:#10b981">â—</span> Prefab zvary</label>
<label style="display:block;margin:3px 0;cursor:pointer"><input type="checkbox" id="filterShowSite" checked onchange="updateDisplayFilter()"> <span style="color:#fff">â—</span> Site zvary</label>
<label style="display:block;margin:3px 0;cursor:pointer"><input type="checkbox" id="filterShowNew" checked onchange="updateDisplayFilter()"> <span style="color:#fbbf24">â—</span> NovÃ© zvary</label>
</div>
<div class="ribbon-group">
<button onclick="addMontazWeld()" id="addmontazweld" disabled>â• PridaÅ¥ zvar</button>
<button onclick="deleteMontazWeld()" id="montazdeletebtn" disabled style="background:#ef4444">ğŸ—‘ï¸ VymazaÅ¥ zvar</button>
<button onclick="showSpoolsPreview()" id="spoolspreview" disabled>ğŸ“‹ NÃ¡hÄ¾ad spoolov</button>
</div>
<div class="ribbon-group">
<button onclick="activateDrawTool('line')" id="montaz_linebtn" disabled>ğŸ“ PaliÄka</button>
<button onclick="activateDrawTool('text')" id="montaz_textbtn" disabled>ğŸ“ Text</button>
<button onclick="activateDrawTool('curve')" id="montaz_curvebtn" disabled>â˜ï¸ OblaÄik</button>
<button onclick="activateDrawTool('arrow')" id="montaz_arrowbtn" disabled>â¡ï¸ Å Ã­pka</button>
<button onclick="activateDrawTool('doublearrow')" id="montaz_doublearrowbtn" disabled>â¬Œ DvojÅ¡Ã­pka</button>
</div>
</div>

<div id="ribbonProgres" class="ribbon-content">
<div class="ribbon-group">
<button onclick="showProgressDashboard()">ğŸ“Š Dashboard</button>
<button onclick="showProgressByIso()">ğŸ“ˆ Progres po izometriÃ¡ch</button>
</div>
<div class="ribbon-group">
<button onclick="showWeldStats()">ğŸ“‰ Å tatistiky zvarov</button>
<button onclick="exportProgressReport()">ğŸ“„ Export reportu</button>
</div>
</div>

<div id="ribbonExport" class="ribbon-content">
<div class="ribbon-group">
<button onclick="createPackage()">ğŸ“¦ VytvoriÅ¥ balÃ­k</button>
<button onclick="showPackageList()">ğŸ“‹ Zoznam balÃ­kov</button>
</div>
<div class="ribbon-group">
<button onclick="createDeliveryNote()">ğŸšš DodacÃ­ list</button>
<button onclick="showDeliveryNotesHistory()" style="background:#8b5cf6;color:white">ğŸ“‹ HistÃ³ria</button>
</div>
<div class="ribbon-group">
<button onclick="openQRInfoScanner()">ğŸ” QR Info</button>
</div>
</div>
</div>

<input type="file" id="loadproj" accept=".json" style="display:none">
<input type="file" id="mtopdffiles" accept=".pdf" multiple style="display:none">
<div id="progressContainer">
<div class="progress-bar-bg">
<div id="progressBar"></div>
<div id="progressText">0%</div>
</div>
</div>
<input type="file" id="f" accept=".pdf,image/*" style="display:none">
</div>

<!-- NOTIFIKAÄŒNÃ PANEL -->
<div id="notificationsPanel" style="display:none;position:fixed;top:120px;right:20px;width:420px;max-height:600px;background:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);border:2px solid #e5e7eb;z-index:9999;overflow:hidden">
<div style="padding:15px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;display:flex;justify-content:space-between;align-items:center">
<h3 style="margin:0;font-size:16px">ğŸ”” HistÃ³ria zmien projektov</h3>
<button onclick="toggleNotificationsPanel()" style="background:transparent;border:none;color:white;font-size:20px;cursor:pointer;padding:0">âœ•</button>
</div>
<div id="notificationsContent" style="max-height:500px;overflow-y:auto;padding:10px">
<div style="text-align:center;color:#999;padding:20px">Å½iadne zmeny</div>
</div>
</div>

<div class="main">
<div class="pdf-area">
<div id="up" class="upload-zone">
<h2 style="margin-bottom:15px">ğŸ“„ OtvoriÅ¥ sÃºbor</h2>
<p style="color:#666;margin-bottom:25px">ZaÄnite novÃ½ projekt alebo otvorte existujÃºci</p>
<div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap">
<div style="text-align:center">
<button onclick="document.getElementById('f').click()" style="padding:20px 40px;font-size:16px;min-width:200px">
ğŸ“ NovÃ¡ izometria<br><span style="font-size:12px;opacity:0.8">PDF, JPG, PNG</span>
</button>
</div>
<div style="text-align:center">
<button onclick="document.getElementById('loadproj').click()" style="padding:20px 40px;font-size:16px;min-width:200px">
ğŸ“‚ OtvoriÅ¥ projekt<br><span style="font-size:12px;opacity:0.8">JSON sÃºbor</span>
</button>
</div>
</div>
<div class="quality-badge" style="margin-top:25px">âœ¨ VysokÃ¡ kvalita exportu</div>
</div>
<div id="cw" class="canvas-wrapper" style="display:none">
<div class="canvas-inner">
<canvas id="can"></canvas>
<svg id="ov" style="position:absolute;top:0;left:0;pointer-events:none"></svg>
</div>
</div>
</div>

<div class="mto-window" id="mtoWindow">
<div class="mto-header" id="mtoHeader">
<h3><span id="mtoTitle">ğŸ“Š Material Take-Off</span></h3>
<div class="mto-controls">
<button onclick="minimizeMTO()" title="Minimize">â”€</button>
<button onclick="closeMTO()" title="Close">Ã—</button>
</div>
</div>
<div class="mto-body" id="mtoBody">
<button onclick="document.getElementById('mtopdffiles').click()" style="width:100%;padding:15px;font-size:16px">ğŸ“ VybraÅ¥ PDF sÃºbory</button>
<div class="mto-file-list" id="mtoFileList"></div>
<div class="mto-summary" id="mtoSummary" style="display:none">
<strong>Celkom:</strong> <span id="mtoTotalFiles">0</span> sÃºborov<br>
<strong>SpracovanÃ½ch:</strong> <span id="mtoProcessed">0</span> / <span id="mtoTotal">0</span>
</div>
<div class="mto-footer" id="mtoFooter" style="display:none">
<button onclick="downloadMTOExcel()" id="mtoDownloadBtn">ğŸ’¾ StiahnuÅ¥ Excel</button>
<button onclick="resetMTO()">ğŸ”„ Znova</button>
</div>
</div>
</div>

<div class="weld-focus-view" id="weldFocusView">
<button class="close-focus-btn" onclick="closeFocusView()">Ã—</button>
<div class="weld-zoom-section">
<canvas id="weldZoomCanvas" class="weld-zoom-canvas"></canvas>
</div>
<div class="materials-table-section" id="materialsTableSection">
<h3 style="margin:0 0 15px 0;color:#1f2937">ğŸ“Š Materials Table</h3>
<div id="materialsTableContent"></div>
</div>
</div>

<div class="weld-log-panel" id="weldLogPanel">
<div class="weld-log-header">
<h2>ğŸ“‹ Weld Log</h2>
<p style="font-size:13px;color:#6b7280">VyplÅˆ komponenty pre kaÅ¾dÃ½ zvar</p>
</div>

<div class="materials-section">
<h3>ğŸ“¦ MateriÃ¡ly z vÃ½kresu</h3>
<div id="materialsList">
<div class="material-item" style="text-align:center;color:#999">Klikni na "ğŸ“‹ NaÄÃ­taÅ¥ z izometrie"</div>
</div>
<div style="display:flex;gap:8px;margin-top:12px">
<button class="btn-blue btn-small" onclick="openMTOForWeldLog()" style="flex:1">ğŸ“‹ NaÄÃ­taÅ¥ z izometrie</button>
<button class="btn-secondary btn-small" onclick="loadMaterialsFromMTO()" style="flex:1">ğŸ“Š NaÄÃ­taÅ¥ z MTO</button>
<button class="btn-green btn-small" onclick="addMaterialManually()">â• PridaÅ¥</button>
<button class="btn-secondary btn-small" onclick="editMaterials()">âœï¸ UpraviÅ¥</button>
<button class="btn-gray btn-small" onclick="debugShowPdfText()" title="Debug - ukÃ¡Å¾ text z PDF">ğŸ” Debug</button>
</div>
</div>

<div id="weldEntriesList">
<!-- Zvary sa naÄÃ­tajÃº dynamicky -->
</div>
</div>

<div class="spool-panel" id="spoolPanel">
<h3>ğŸ”§ SPOOLY <span class="spool-count" id="spoolCount">0</span></h3>
<div id="spoolList">
<div style="text-align:center;color:#999;padding:20px">Pridaj krÃ­Å¾iky na zvary<br>a klikni "ğŸ”§ Spool"</div>
</div>
</div>

</div>

</div>

<div id="zoomInfo" class="zoom-info" style="display:none">Zoom: <span id="zoomLevel">150%</span></div>

<!-- BOÄŒNÃ PANEL PRE PROJEKTY -->
<div id="projectsPanel" class="projects-panel">
  <div class="panel-tab" onclick="toggleProjectsPanel()">â–º</div>
  
  <div class="panel-content">
    <div class="panel-header">ğŸ¢ Projekty</div>
    
    <div class="panel-section">
      <div class="section-label">Projekt:</div>
      <div id="projectsList" class="parts-list"></div>
      <button class="btn-panel" onclick="promptNewProject()">â• NovÃ½ projekt</button>
      <button class="btn-panel" onclick="fullResetAndRestore()" style="background:#ef4444;color:white;margin-top:5px;font-weight:bold">ğŸ”¥ FULL RESET</button>
    </div>
    
    <div class="panel-section">
      <div class="section-label">ÄŒasÅ¥:</div>
      <div id="currentPartDisplay" class="current-display">-</div>
      <button class="btn-panel" onclick="promptNewPart()">â• NovÃ¡ ÄasÅ¥</button>
    </div>
    
    <div class="panel-section">
      <div class="section-label">VÅ¡etky Äasti:</div>
      <div id="partsList" class="parts-list"></div>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
var pd=null,sc=1.0,ca=document.getElementById('can'),ct=ca.getContext('2d'),ov=document.getElementById('ov'),ws=[],pt=null,cn=1,startNum=1,originalFileName='',editMode=false,moveMode=false,selectedWeldId=null,editCrossMode=false,activeTab='redpen';
var loadedImage=null,baseImageWidth=0,baseImageHeight=0; // Pre zoom PNG obrÃ¡zkov
var weldHistory=[];
var projectsData={
  currentProject: null,
  currentPart: null,
  projects: {}
};
var currentTool='select';
var oneClickMode=false; // Defaultne vypnutÃ© - pouÅ¾Ã­vateÄ¾ musÃ­ kliknÃºÅ¥ "1-klik" tlaÄidlo
var weldScale=1.0; // GlobÃ¡lny scale faktor pre zvary (krÃºÅ¾ky + text)
var spools=[];
var spoolMode=false;
var dimensions=[];
var dimensionMode=false;
var dimensionText='';
var dimensionFontSize=16;
var spoolData=[];
var spoolNum=1;
var crosses=[];
var crossPt=null;
var editCrossesMode=false;
var lines=[];
var linePt=null;
var lineColor='#FF0000';
var lineWidth=2;
var selectedLineId=null;
var moveLineMode=false;
var isPanning=false;
var panStartX=0;
var panStartY=0;
var panOffsetX=0;
var panOffsetY=0;
var mouseX=0;
var mouseY=0;
var texts=[];
var textColor='#FF0000';
var textSize=12;
var curves=[];
var curvePts=[];
var curveColor='#FF0000';
var curveWidth=2;
var isDragging=false;
var dragType=null;
var dragObject=null;
var justFinishedDrag=false;
var justFinishedRotation=false;
var selectedTextForRotation=null;
var isRotating=false;
var rotationStartAngle=0;

// ============= KONTROLA SYSTÃ‰M - GLOBAL DATA =============
var kontrolaData={
  expandedRoutes:{},
  expandedSpools:{},
  completedWelds:{},
  welderData:{},
  dateData:{}
};

function saveKontrolaData(){
  if(!projectsData.currentProject || !projectsData.currentPart)return;
  var key='kontrola_'+projectsData.currentProject+'_'+projectsData.currentPart;
  localStorage.setItem(key,JSON.stringify(kontrolaData));
  console.log('ğŸ’¾ Kontrola data uloÅ¾enÃ© do localStorage');
  
  // UloÅ¾iÅ¥ aj do Firebase
  saveProjectsToFirebase();
}

function loadKontrolaData(){
  if(!projectsData.currentProject || !projectsData.currentPart)return;
  var key='kontrola_'+projectsData.currentProject+'_'+projectsData.currentPart;
  var saved=localStorage.getItem(key);
  if(saved){
    kontrolaData=JSON.parse(saved);
    console.log('ğŸ“‚ Kontrola data naÄÃ­tanÃ©');
  }else{
    kontrolaData={expandedRoutes:{},expandedSpools:{},completedWelds:{},welderData:{},dateData:{},qrCodes:{}};
  }
}
var arrows=[];
var arrowPt=null;
var arrowColor='#FF0000';
var arrowWidth=2;
var arrowType='single';

function setStartNumber(){
var input=document.getElementById('startNumInput');
var num=parseInt(input.value);
if(!isNaN(num)&&num>0){
startNum=num;
cn=num;
document.getElementById('setstart').textContent='âš™ï¸ NastaviÅ¥';
up();
alert('âœ… ZaÄiatoÄnÃ© ÄÃ­slo nastavenÃ© na: '+num);
}else{
alert('âŒ Zadaj platnÃ© ÄÃ­slo vÃ¤ÄÅ¡ie ako 0!');
}
}

// ============= RIBBON MENU PREPÃNANIE =============
function switchRibbonTab(tabName) {
  // OdstrÃ¡Åˆ active zo vÅ¡etkÃ½ch zÃ¡loÅ¾iek
  var tabs = document.querySelectorAll('.ribbon-tab');
  tabs.forEach(function(tab) {
    tab.classList.remove('active');
  });
  
  // Skry vÅ¡etky obsahy
  var contents = document.querySelectorAll('.ribbon-content');
  contents.forEach(function(content) {
    content.classList.remove('active');
  });
  
  // Aktivuj vybranÃº zÃ¡loÅ¾ku a obsah
  event.target.classList.add('active');
  document.getElementById('ribbon' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
  
  // UloÅ¾ aktÃ­vnu zÃ¡loÅ¾ku
  activeTab=tabName;
  
  // MONTÃÅ½ - aktivuj filter, vypni editMode (len oznaÄovanie)
  if(tabName==='montaz'){
    displayFilter.enabled=true;
    editMode=false;  // âœ… Default: len oznaÄovanie kruhov
    console.log('ğŸ—ï¸ MONTÃÅ½ mode - filter ENABLED, editMode DISABLED (oznaÄovanie)');
  } else {
    displayFilter.enabled=false;
    // editMode zostane ako je (prepÃ­na sa tlaÄidlom v PREFABRIKÃCIA)
  }
  
  // Skry boÄnÃ½ panel pri prepnutÃ­ zÃ¡loÅ¾iek
  var spoolPanel=document.getElementById('spoolPanel');
  if(spoolPanel){
    spoolPanel.style.display='none';
  }
  
  // PrekreslÃ­ s layer filtrom
  dw();
  
  console.log('ğŸ¯ PrepnutÃ© na zÃ¡loÅ¾ku:', tabName);
}

// ============= SET TOOL =============
// ============= PALIÄŒKA - NASTAVENIA =============
function activateDrawTool(tool) {
  // Skry vÅ¡etky option menu (bezpeÄne)
  var optionsToHide = ['lineOptions', 'textOptions', 'curveOptions', 'arrowOptions', 'dimensionOptions'];
  optionsToHide.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  
  // Resetuj opacity vÅ¡etkÃ½ch tlaÄidiel (bezpeÄne)
  var buttonsToReset = ['linebtn', 'textbtn', 'curvebtn', 'arrowbtn', 'doublearrowbtn'];
  buttonsToReset.forEach(function(id) {
    var btn = document.getElementById(id);
    if (btn) btn.style.opacity = '0.7';
  });
  
  // Aktivuj vybranÃ½ nÃ¡stroj
  if (tool === 'line') {
    document.getElementById('lineOptions').style.display = 'flex';
    var btn = document.getElementById('linebtn');
    if (btn) btn.style.opacity = '1';
    currentTool = 'line';
    lineColor = document.getElementById('lineColor').value;
    lineWidth = parseFloat(document.getElementById('lineWidth').value);
  } else if (tool === 'text') {
    document.getElementById('textOptions').style.display = 'flex';
    var btn = document.getElementById('textbtn');
    if (btn) btn.style.opacity = '1';
    currentTool = 'text';
    textColor = document.getElementById('textColor').value;
    textSize = parseInt(document.getElementById('textSize').value);
  } else if (tool === 'curve') {
    var curveOpt = document.getElementById('curveOptions');
    if (curveOpt) curveOpt.style.display = 'flex';
    var btn = document.getElementById('curvebtn');
    if (btn) btn.style.opacity = '1';
    currentTool = 'curve';
    curvePts = [];
  } else if (tool === 'arrow') {
    document.getElementById('arrowOptions').style.display = 'flex';
    var btn = document.getElementById('arrowbtn');
    if (btn) btn.style.opacity = '1';
    currentTool = 'arrow';
    arrowType = 'single';
    arrowPt = null; // Reset
    arrowColor = document.getElementById('arrowColor').value;
    arrowWidth = parseFloat(document.getElementById('arrowWidth').value);
  } else if (tool === 'doublearrow') {
    document.getElementById('arrowOptions').style.display = 'flex';
    var btn = document.getElementById('doublearrowbtn');
    if (btn) btn.style.opacity = '1';
    currentTool = 'arrow';
    arrowType = 'double';
    arrowPt = null; // Reset
    arrowColor = document.getElementById('arrowColor').value;
    arrowWidth = parseFloat(document.getElementById('arrowWidth').value);
  }
  
  ca.style.cursor = 'crosshair';
  console.log('ğŸ¨ AktivovanÃ½ nÃ¡stroj:', tool);
}

function updateLineSettings() {
  lineColor = document.getElementById('lineColor').value;
  lineWidth = parseFloat(document.getElementById('lineWidth').value);
  console.log('ğŸ¨ PaliÄka nastavenia:', lineColor, lineWidth + 'px');
}

function updateArrowSettings() {
  arrowColor = document.getElementById('arrowColor').value;
  arrowWidth = parseFloat(document.getElementById('arrowWidth').value);
  console.log('ğŸ¨ Å Ã­pka nastavenia:', arrowColor, arrowWidth + 'px');
}

// ============= SET TOOL =============
function setTool(tool){
currentTool=tool;
pt=null;
crossPt=null;
linePt=null;
arrowPt=null; // Reset arrow point
curvePts=[]; // Reset curve points
dimensionMode=false;
moveLineMode=false;

console.log('ğŸ”§ Tool changed to:', tool);

// Skry draw tool menu pri prepnutÃ­ (bezpeÄne)
if(document.getElementById('lineOptions')) document.getElementById('lineOptions').style.display='none';
if(document.getElementById('textOptions')) document.getElementById('textOptions').style.display='none';
if(document.getElementById('curveOptions')) document.getElementById('curveOptions').style.display='none';
if(document.getElementById('linebtn')) document.getElementById('linebtn').style.opacity='0.7';
if(document.getElementById('textbtn')) document.getElementById('textbtn').style.opacity='0.7';
if(document.getElementById('curvebtn')) document.getElementById('curvebtn').style.opacity='0.7';

if(tool==='spool'){
spoolMode=true;
calculateSpoools();
if(document.getElementById('spoolPanel')) document.getElementById('spoolPanel').classList.add('active');
}else{
spoolMode=false;
if(document.getElementById('spoolPanel')) document.getElementById('spoolPanel').classList.remove('active');
}
if(document.getElementById('selectbtn')) document.getElementById('selectbtn').style.opacity=tool==='select'?'1':'0.7';
document.getElementById('crossbtn').style.opacity=tool==='cross'?'1':'0.7';
document.getElementById('spoolbtn').style.opacity=tool==='spool'?'1':'0.7';
document.getElementById('dimensionbtn').style.opacity='0.7';
ca.style.cursor=tool==='select'?'default':'crosshair';
dw();
}

function setWeldMode(oneClick){
oneClickMode=oneClick;
currentTool=''; // Reset tool aby fungoval oneClickMode
pt=null;
document.getElementById('oneclickbtn').style.opacity=oneClick?'1':'0.7';
document.getElementById('twoclickbtn').style.opacity=oneClick?'0.7':'1';
console.log('âš™ï¸ Weld mode:', oneClick?'ONE-CLICK':'TWO-CLICK', '| currentTool:', currentTool);
dw();
}

function adjustWeldScale(delta){
weldScale += delta;
if(weldScale < 0.3) weldScale = 0.3; // Min 30%
if(weldScale > 2.0) weldScale = 2.0; // Max 200%
document.getElementById('weldScaleDisplay').textContent = Math.round(weldScale * 100) + '%';
console.log('ğŸ“ Weld scale changed:', Math.round(weldScale * 100) + '%');
dw(); // Prekreslenie
}

document.getElementById('f').onchange=function(e){
var fi=e.target.files[0];
if(!fi)return;
originalFileName=fi.name.replace(/\.[^/.]+$/,'');

// VYÄŒISTI kontrolaData pre novÃ½ PDF
console.log('ğŸ§¹ VyÄisÅ¥ujem kontrolaData pre novÃ½ PDF:', originalFileName);
kontrolaData = {
expandedRoutes: {},
expandedSpools: {},
completedWelds: {},
welderData: {},
dateData: {}
};
saveKontrolaData();

weldLogMaterials=[];
weldAssignments={};
document.getElementById('materialsList').innerHTML='<div class="material-item" style="text-align:center;color:#999">Klikni na "ğŸ“‹ NaÄÃ­taÅ¥ z izometrie"</div>';
if(fi.type==='application/pdf'){
var rd=new FileReader();
rd.onload=function(){
var dt=new Uint8Array(this.result);
pdfjsLib.getDocument(dt).promise.then(function(p){
pd=p;
originalFileName=fi.name.replace(/\.[^/.]+$/,'');
var fileNameSpan=document.getElementById('fileName');
if(fileNameSpan)fileNameSpan.textContent=fi.name;
document.getElementById('up').style.display='none';
document.getElementById('cw').style.display='block';
document.getElementById('zoomInfo').style.display='block';
document.getElementById('zi').disabled=false;
document.getElementById('zo').disabled=false;
document.getElementById('zr').disabled=false;
document.getElementById('savepdf').disabled=false;
document.getElementById('saveproj').disabled=false;document.getElementById('savetolibrary').disabled=false;
document.getElementById('loadprojbtn').disabled=false;
document.getElementById('editmode').disabled=false;
document.getElementById('editcrossmode').disabled=false;
document.getElementById('setstart').disabled=false;
document.getElementById('selectbtn').disabled=false;
document.getElementById('crossbtn').disabled=false;
document.getElementById('spoolbtn').disabled=false;document.getElementById('spoollistbtn').disabled=false;document.getElementById('refreshspoolbtn').disabled=false;document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;document.getElementById('spoolspreview').disabled=false;document.getElementById('montaz_linebtn').disabled=false;document.getElementById('montaz_textbtn').disabled=false;document.getElementById('montaz_curvebtn').disabled=false;document.getElementById('montaz_arrowbtn').disabled=false;document.getElementById('montaz_doublearrowbtn').disabled=false;

document.getElementById('weldlogbtn').disabled=false;
document.getElementById('oneclickbtn').disabled=false;
document.getElementById('twoclickbtn').disabled=false;document.getElementById('weldscaleminus').disabled=false;document.getElementById('weldscaleplus').disabled=false;
document.getElementById('mtobtn').disabled=false;document.getElementById('dimensionbtn').disabled=false;document.getElementById('prefab_linebtn').disabled=false;document.getElementById('prefab_textbtn').disabled=false;document.getElementById('prefab_arrowbtn').disabled=false;document.getElementById('prefab_doublearrowbtn').disabled=false;document.getElementById('prefab_curvebtn').disabled=false;document.getElementById('linebtn').disabled=false;document.getElementById('textbtn').disabled=false;document.getElementById('curvebtn').disabled=false;document.getElementById('arrowbtn').disabled=false;document.getElementById('doublearrowbtn').disabled=false;document.getElementById('undo').disabled=false;
pd.getPage(1).then(function(firstPage){
var totalPages=pd.numPages;
console.log('PDF mÃ¡',totalPages,'strÃ¡n');
var promises=[];
for(var pageNum=1;pageNum<=totalPages;pageNum++){
promises.push(
pd.getPage(pageNum).then(function(page){
return page.getTextContent();
}).then(function(textContent){
var text='';
var lastY=null;
textContent.items.forEach(function(item){
if(lastY!==null&&item.transform&&item.transform[5]!==lastY){
text+='\n';
}
text+=item.str+' ';
if(item.transform)lastY=item.transform[5];
});
return text;
})
);
}
return Promise.all(promises);
}).then(function(pages){
currentPdfText=pages.join('\n\n');
console.log('âœ… PDF text naÄÃ­tanÃ½, dÄºÅ¾ka:',currentPdfText.length);
}).catch(function(err){
console.log('âŒ PDF nemÃ¡ textovÃº vrstvu',err);
currentPdfText='';
});
rp();
});
};
rd.readAsArrayBuffer(fi);
}else{
var rd=new FileReader();
rd.onload=function(ev){
var im=new Image();
im.onload=function(){
originalFileName=fi.name.replace(/\.[^/.]+$/,'');
var fileNameSpan=document.getElementById('fileName');
if(fileNameSpan)fileNameSpan.textContent=fi.name;
ca.width=im.width;
ca.height=im.height;
ov.setAttribute('width',im.width);
ov.setAttribute('height',im.height);
ct.imageSmoothingEnabled=false;
ct.drawImage(im,0,0);
document.getElementById('up').style.display='none';
document.getElementById('cw').style.display='block';
document.getElementById('zoomInfo').style.display='block';
document.getElementById('zi').disabled=false;
document.getElementById('zo').disabled=false;
document.getElementById('zr').disabled=false;
document.getElementById('savepdf').disabled=false;
document.getElementById('saveproj').disabled=false;document.getElementById('savetolibrary').disabled=false;
document.getElementById('loadprojbtn').disabled=false;
document.getElementById('editmode').disabled=false;
document.getElementById('editcrossmode').disabled=false;
document.getElementById('setstart').disabled=false;
document.getElementById('selectbtn').disabled=false;
document.getElementById('crossbtn').disabled=false;
document.getElementById('spoolbtn').disabled=false;document.getElementById('spoollistbtn').disabled=false;document.getElementById('refreshspoolbtn').disabled=false;document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;document.getElementById('spoolspreview').disabled=false;document.getElementById('montaz_linebtn').disabled=false;document.getElementById('montaz_textbtn').disabled=false;document.getElementById('montaz_curvebtn').disabled=false;document.getElementById('montaz_arrowbtn').disabled=false;document.getElementById('montaz_doublearrowbtn').disabled=false;

document.getElementById('weldlogbtn').disabled=false;
document.getElementById('oneclickbtn').disabled=false;
document.getElementById('twoclickbtn').disabled=false;document.getElementById('weldscaleminus').disabled=false;document.getElementById('weldscaleplus').disabled=false;
document.getElementById('mtobtn').disabled=false;document.getElementById('dimensionbtn').disabled=false;document.getElementById('prefab_linebtn').disabled=false;document.getElementById('prefab_textbtn').disabled=false;document.getElementById('prefab_arrowbtn').disabled=false;document.getElementById('prefab_doublearrowbtn').disabled=false;document.getElementById('prefab_curvebtn').disabled=false;document.getElementById('linebtn').disabled=false;document.getElementById('textbtn').disabled=false;document.getElementById('curvebtn').disabled=false;document.getElementById('arrowbtn').disabled=false;document.getElementById('doublearrowbtn').disabled=false;document.getElementById('undo').disabled=false;
dw();
};
im.src=ev.target.result;
};
rd.readAsDataURL(fi);
}
};

function rp(){
pd.getPage(1).then(function(pg){
var vp=pg.getViewport({scale:sc});
ca.height=vp.height;
ca.width=vp.width;
ov.setAttribute('width',vp.width);
ov.setAttribute('height',vp.height);
ct.imageSmoothingEnabled=false;
pg.render({canvasContext:ct,viewport:vp}).promise.then(dw);
updateZoomDisplay();
});
}

function updateZoomDisplay(){
document.getElementById('zoomLevel').textContent=Math.round(sc*100)+'%';
}


// ============= PAN FUNKCIA - DrÅ¾Ã­m Ä¾avÃ© tlaÄidlo = posÃºvam PDF =============
function detectObjectAt(x,y){
// PRIORITY 1: Zvary (ak je editMode)
if(editMode){
for(var i=ws.length-1;i>=0;i--){
var w=ws[i];
var endX=w.end.x*ca.width;
var endY=w.end.y*ca.height;
// Detekcia krÃºÅ¾ku (radius zÃ¡visÃ­ od dÄºÅ¾ky ÄÃ­sla)
var numLen=String(w.displayNum).length;
var radius=22;
if(numLen>=4)radius=30;
else if(numLen>=3)radius=26;
else if(numLen>=2)radius=24;
if(Math.sqrt(Math.pow(x-endX,2)+Math.pow(y-endY,2))<radius){
return {type:'weld',index:i,object:w};
}
}
}

// Texts
for(var i=texts.length-1;i>=0;i--){
var txt=texts[i];
var txtX=txt.x*ca.width;
var txtY=txt.y*ca.height;
if(Math.sqrt(Math.pow(x-txtX,2)+Math.pow(y-txtY,2))<30)return {type:'text',index:i,object:txt};
}
for(var i=lines.length-1;i>=0;i--){
var line=lines[i];
var x1=line.start.x*ca.width,y1=line.start.y*ca.height;
var x2=line.end.x*ca.width,y2=line.end.y*ca.height;
var A=x-x1,B=y-y1,C=x2-x1,D=y2-y1;
var dot=A*C+B*D,lenSq=C*C+D*D;
var param=lenSq!==0?dot/lenSq:-1;
var xx=param<0?x1:param>1?x2:x1+param*C;
var yy=param<0?y1:param>1?y2:y1+param*D;
if(Math.sqrt(Math.pow(x-xx,2)+Math.pow(y-yy,2))<10)return {type:'line',index:i,object:line};
}
for(var i=arrows.length-1;i>=0;i--){
var arrow=arrows[i];
var x1=arrow.start.x*ca.width,y1=arrow.start.y*ca.height;
var x2=arrow.end.x*ca.width,y2=arrow.end.y*ca.height;
var A=x-x1,B=y-y1,C=x2-x1,D=y2-y1;
var dot=A*C+B*D,lenSq=C*C+D*D;
var param=lenSq!==0?dot/lenSq:-1;
var xx=param<0?x1:param>1?x2:x1+param*C;
var yy=param<0?y1:param>1?y2:y1+param*D;
if(Math.sqrt(Math.pow(x-xx,2)+Math.pow(y-yy,2))<10)return {type:'arrow',index:i,object:arrow};
}
for(var i=curves.length-1;i>=0;i--){
var curve=curves[i];
for(var j=0;j<curve.points.length;j++){
var pt1=curve.points[j];
var pt2=curve.points[(j+1)%curve.points.length];
var x1=pt1.x*ca.width,y1=pt1.y*ca.height;
var x2=pt2.x*ca.width,y2=pt2.y*ca.height;
var A=x-x1,B=y-y1,C=x2-x1,D=y2-y1;
var dot=A*C+B*D,lenSq=C*C+D*D;
var param=lenSq!==0?dot/lenSq:-1;
var xx=param<0?x1:param>1?x2:x1+param*C;
var yy=param<0?y1:param>1?y2:y1+param*D;
if(Math.sqrt(Math.pow(x-xx,2)+Math.pow(y-yy,2))<15)return {type:'curve',index:i,object:curve};
}
}

// Dimensions (domerky)
for(var i=dimensions.length-1;i>=0;i--){
var dim=dimensions[i];
var dimX=dim.x*ca.width;
var dimY=dim.y*ca.height;
if(Math.sqrt(Math.pow(x-dimX,2)+Math.pow(y-dimY,2))<40)return {type:'dimension',index:i,object:dim};
}

return null;
}

ca.onmousedown=function(e){
if(e.button===0 && currentTool==='select'){
var rc=ca.getBoundingClientRect();
var x=e.clientX-rc.left;
var y=e.clientY-rc.top;

// Kontrola kliku na rotation ikonu
if(selectedTextForRotation){
var obj=selectedTextForRotation.object;
var objX=obj.x*ca.width;
var objY=obj.y*ca.height;
var bbox;
if(selectedTextForRotation.type==='text'){
bbox={x:objX-10,y:objY-obj.size,width:obj.text.length*obj.size*0.6+20,height:obj.size*2};
}else{
bbox={x:objX-70,y:objY-20,width:140,height:40};
}
var iconX=bbox.x+bbox.width;
var iconY=bbox.y;
var distToIcon=Math.sqrt(Math.pow(x-iconX,2)+Math.pow(y-iconY,2));

if(distToIcon<15){
isRotating=true;
var angle=Math.atan2(y-objY,x-objX);
rotationStartAngle=angle-(obj.rotation||0)*Math.PI/180;
ca.style.cursor='grab';
console.log('ğŸ”„ ZaÄÃ­nam rotÃ¡ciu');
return;
}
}

var detected=detectObjectAt(x,y);

if(detected){
// Ak je to text, Å¡Ã­pka alebo domerok, nastav ho ako vybranÃ½ pre rotÃ¡ciu
if(detected.type==='text' || detected.type==='arrow' || detected.type==='dimension'){
selectedTextForRotation={type:detected.type,object:detected.object};
console.log('âœ…',detected.type,'vybranÃ½ pre rotÃ¡ciu');
dw(); // Prekreslenie aby sa zobrazila rotaÄnÃ¡ ikona
}

isDragging=true;
dragType=detected.type;
dragObject=detected.object;
ca.style.cursor='grabbing';
}else{
// Ak klik mimo - zruÅ¡ vÃ½ber
selectedTextForRotation=null;
dw();

isPanning=true;
panStartX=e.clientX;
panStartY=e.clientY;
ca.style.cursor='grabbing';
}
}
};

ca.onmousemove=function(e){
var rc=ca.getBoundingClientRect();
mouseX=e.clientX-rc.left;
mouseY=e.clientY-rc.top;

if(isPanning){
var dx=e.clientX-panStartX;
var dy=e.clientY-panStartY;
var cw=document.getElementById('cw');
cw.scrollLeft-=dx;
cw.scrollTop-=dy;
panStartX=e.clientX;
panStartY=e.clientY;
}

if(isDragging && dragObject){
var newX=mouseX/ca.width;
var newY=mouseY/ca.height;
if(dragType==='weld'){
// Posun celÃ©ho zvaru (start aj end)
var dx=newX-dragObject.end.x;
var dy=newY-dragObject.end.y;
dragObject.start.x+=dx;
dragObject.start.y+=dy;
dragObject.end.x=newX;
dragObject.end.y=newY;
}else if(dragType==='text'){
dragObject.x=newX;
dragObject.y=newY;
}else if(dragType==='line'){
var midX=(dragObject.start.x+dragObject.end.x)/2;
var midY=(dragObject.start.y+dragObject.end.y)/2;
var dx=newX-midX;
var dy=newY-midY;
dragObject.start.x+=dx;
dragObject.start.y+=dy;
dragObject.end.x+=dx;
dragObject.end.y+=dy;
}else if(dragType==='arrow'){
var midX=(dragObject.start.x+dragObject.end.x)/2;
var midY=(dragObject.start.y+dragObject.end.y)/2;
var dx=newX-midX;
var dy=newY-midY;
dragObject.start.x+=dx;
dragObject.start.y+=dy;
dragObject.end.x+=dx;
dragObject.end.y+=dy;
}else if(dragType==='curve'){
var sumX=0,sumY=0;
dragObject.points.forEach(function(pt){sumX+=pt.x;sumY+=pt.y;});
var centerX=sumX/dragObject.points.length;
var centerY=sumY/dragObject.points.length;
var dx=newX-centerX;
var dy=newY-centerY;
dragObject.points.forEach(function(pt){pt.x+=dx;pt.y+=dy;});
}else if(dragType==='dimension'){
dragObject.x=newX;
dragObject.y=newY;
}
dw();
}

// ROTÃCIA textu/domerku
if(isRotating && selectedTextForRotation){
var obj=selectedTextForRotation.object;
var objX=obj.x*ca.width;
var objY=obj.y*ca.height;
var angle=Math.atan2(mouseY-objY,mouseX-objX);
var rotationDeg=(angle-rotationStartAngle)*180/Math.PI;
obj.rotation=Math.round(rotationDeg);
dw();
}

// Prekreslenie ak kreslÃ­me paliÄka
if(linePt && currentTool==='line'){
dw();
}
if(arrowPt && currentTool==='arrow'){
dw();
}
};

ca.ondblclick=function(e){
if(currentTool!=='select')return;
var rc=ca.getBoundingClientRect();
var x=e.clientX-rc.left;
var y=e.clientY-rc.top;

// Detekuj text alebo domerok
for(var i=texts.length-1;i>=0;i--){
var txt=texts[i];
var txtX=txt.x*ca.width;
var txtY=txt.y*ca.height;
if(Math.sqrt(Math.pow(x-txtX,2)+Math.pow(y-txtY,2))<30){
selectedTextForRotation={type:'text',object:txt,index:i};
dw();
console.log('ğŸ“ Text vybranÃ½ na rotÃ¡ciu');
return;
}
}

for(var i=dimensions.length-1;i>=0;i--){
var dim=dimensions[i];
var dimX=dim.x*ca.width;
var dimY=dim.y*ca.height;
if(Math.sqrt(Math.pow(x-dimX,2)+Math.pow(y-dimY,2))<30){
selectedTextForRotation={type:'dimension',object:dim,index:i};
dw();
console.log('ğŸ“ Domerok vybranÃ½ na rotÃ¡ciu');
return;
}
}

// Klik mimo â†’ zruÅ¡ vÃ½ber
selectedTextForRotation=null;
dw();
};

ca.onmouseup=function(e){
if(isPanning){
isPanning=false;
ca.style.cursor='default';
}
if(isDragging){
isDragging=false;
dragType=null;
dragObject=null;
ca.style.cursor='default';
justFinishedDrag=true;
setTimeout(function(){justFinishedDrag=false;},100);
dw();
}
if(isRotating){
isRotating=false;
ca.style.cursor='default';
justFinishedRotation=true; // ZabrÃ¡ni len montazWeldMode hneÄ po rotÃ¡cii
setTimeout(function(){justFinishedRotation=false;},200);
console.log('âœ… RotÃ¡cia ukonÄenÃ¡:',selectedTextForRotation.object.rotation+'Â°');
dw();
}
};

ca.onclick=function(e){
if(justFinishedDrag)return;
var rc=ca.getBoundingClientRect();
var x=e.clientX-rc.left;
var y=e.clientY-rc.top;
if(dimensionMode){
var dimensionColor = document.getElementById('dimensionColor').value;
dimensions.push({
id:'dim_'+Date.now()+'_'+Math.random(),
text:dimensionText,
x:x/ca.width,
y:y/ca.height,
rotation:0,
fontSize:dimensionFontSize,
color:dimensionColor
});
console.log('Added dimension:',dimensionText,'fontSize:',dimensionFontSize,'color:',dimensionColor,'at',x,y);
dw();
return;
}

// MONTÃÅ½ MODE - pridanie novÃ©ho zvaru
if(montazWeldMode){
console.log('ğŸ—ï¸ MONTÃÅ½ click - montazWeldMode=true');
if(justFinishedRotation){
  console.log('âš ï¸ BlokovanÃ© - prÃ¡ve skonÄila rotÃ¡cia');
  return;
}
if(!pt){
// 1. KLIK - uloÅ¾ zaÄiatok (normalizovanÃ½)
console.log('ğŸ“ 1. KLIK - x:', x, 'y:', y, 'ca.width:', ca.width, 'ca.height:', ca.height);
pt={x:x/ca.width, y:y/ca.height};
console.log('ğŸ“ ZaÄiatok zvaru (normalizovanÃ½):', pt);
}else{
// 2. KLIK - vytvor zvar
console.log('ğŸ“ 2. KLIK - x:', x, 'y:', y);
console.log('ğŸ“ pt pred vytvorenÃ­m zvaru:', pt);
var weldId=Date.now()+'_'+Math.random();
ws.push({
id:weldId,
start:{x:pt.x, y:pt.y},  // UÅ¾ normalizovanÃ©
end:{x:x/ca.width, y:y/ca.height},  // Normalizuj koniec
displayNum:montazWeldNumber,
source:'new'  // NOVÃ ZVAR
});
console.log('âœ… Zvar vytvorenÃ½:', {start: pt, end: {x:x/ca.width, y:y/ca.height}});

// Pridaj do WeldBook
var splitName=splitIsometricName(originalFileName || 'Unknown');
addWeldToWeldBook({
part:splitName.part,
isometric:splitName.isometric,
sheets:1,
weldId:String(montazWeldNumber),
source:'new',
item1:'',item2:'',ped:'',rev:'',pipeClass:'',
heatNr1:'',certNr1:'',dimension1:'',thickness1:'',material1:'',matGroup1:'',
heatNr2:'',certNr2:'',dimension2:'',thickness2:'',material2:'',matGroup2:'',
wps:'',wpqr:'',weldingMethod:'',jointType:'',weldingType:'',weldingGas:'',
heatNrWeld:'',certNrWeld:'',welderId:'',dateWelding:'',
vtPercent:'',vtDate:'',vtReport:'',vtResult:'',
ptPercent:'',ptDate:'',ptReport:'',ptResult:'',
rtPercent:'',rtDate:'',rtReport:'',rtResult:'',
pmpInch:'',andritzInch:'',pressureGroup:'',note:''
});

pt=null;
montazWeldMode=false;
ca.style.cursor='default';
dw();
up();
console.log('âœ… NovÃ½ zvar',montazWeldNumber,'pridanÃ½ (Å½LTÃ)');
return;
}
}

if(editCrossMode){
for(var i=0;i<ws.length;i++){
if(ws[i].id===selectedWeldId){
ws[i].start={x:x/ca.width,y:y/ca.height};
break;
}
}
editCrossMode=false;
selectedWeldId=null;
ca.style.cursor='crosshair';
up();
dw();
return;
}
if(moveMode){
if(!pt){
pt={x:x,y:y};
}else{
for(var i=0;i<ws.length;i++){
if(ws[i].id===selectedWeldId){
ws[i].start={x:pt.x/ca.width,y:pt.y/ca.height};
ws[i].end={x:x/ca.width,y:y/ca.height};
break;
}
}
pt=null;
selectedWeldId=null;
moveMode=false;
ca.style.cursor='crosshair';
up();
dw();
return;
}
return;
}

if(currentTool==='select'){

if(editCrossesMode){
var clickedCross=null;
for(var i=0;i<crosses.length;i++){
var c=crosses[i];
var crossX=c.pos.x*ca.width;
var crossY=c.pos.y*ca.height;
var dist=Math.sqrt(Math.pow(x-crossX,2)+Math.pow(y-crossY,2));
if(dist<15){
clickedCross=c;
break;
}
}
if(clickedCross){
var action=prompt('1=PresunÃºÅ¥ krÃ­Å¾ik, 2=ZmazaÅ¥ krÃ­Å¾ik','1');
if(action==='1'){
var newX=prompt('NovÃ¡ pozÃ­cia X:',Math.round(clickedCross.pos.x*ca.width));
var newY=prompt('NovÃ¡ pozÃ­cia Y:',Math.round(clickedCross.pos.y*ca.height));
if(newX!==null&&newY!==null){
clickedCross.pos={x:parseFloat(newX)/ca.width,y:parseFloat(newY)/ca.height};
dw();
}
}else if(action==='2'){
if(confirm('ZmazaÅ¥ tento krÃ­Å¾ik?')){
crosses=crosses.filter(function(cr){return cr.id!==clickedCross.id;});
dw();
}
}
return;
}
}

var clickedSpool=null;
var spoolClickType='';
for(var i=0;i<spools.length;i++){
var s=spools[i];
var distEnd=Math.sqrt(Math.pow(x-s.end.x,2)+Math.pow(y-s.end.y,2));
var distStart=Math.sqrt(Math.pow(x-s.start.x,2)+Math.pow(y-s.start.y,2));
if(distEnd<30){
clickedSpool=s;
spoolClickType='end';
break;
}else if(distStart<10){
clickedSpool=s;
spoolClickType='start';
break;
}
}

if(clickedSpool){
if(editMode&&spoolClickType==='end'){
var newText=prompt('NovÃ© oznaÄenie spoolu:',clickedSpool.displayNum);
if(newText!==null&&newText.trim()!==''){
clickedSpool.displayNum=newText.trim();
dw();
}
return;
}
// MENU: 1=UpraviÅ¥ text, 2=PresunÃºÅ¥, 3=ZmazaÅ¥
var action=prompt('1=UpraviÅ¥ text, 2=PresunÃºÅ¥, 3=ZmazaÅ¥','1');
if(action==='1'){
var newText=prompt('NovÃ© oznaÄenie spoolu:',clickedSpool.displayNum);
if(newText!==null&&newText.trim()!==''){
clickedSpool.displayNum=newText.trim();
dw();
console.log('âœï¸ Spool text upravenÃ½:',newText);
}
}else if(action==='2'){
var newX=prompt('NovÃ¡ pozÃ­cia X:',Math.round(spoolClickType==='end'?clickedSpool.end.x:clickedSpool.start.x));
var newY=prompt('NovÃ¡ pozÃ­cia Y:',Math.round(spoolClickType==='end'?clickedSpool.end.y:clickedSpool.start.y));
if(newX!==null&&newY!==null){
if(spoolClickType==='end'){
clickedSpool.end={x:parseFloat(newX),y:parseFloat(newY)};
}else{
clickedSpool.start={x:parseFloat(newX),y:parseFloat(newY)};
}
dw();
}
}else if(action==='3'){
if(confirm('ZmazaÅ¥ tento spool?')){
spools=spools.filter(function(sp){return sp.id!==clickedSpool.id;});
dw();
console.log('ğŸ—‘ï¸ Spool zmazanÃ½');
}
}
return;
}
}

var clickedWeld=null;
var clickType='';

// MONTÃÅ½ MODE - klik na kruh zvaru pre oznaÄenie/odznaÄenie
if(displayFilter.enabled && !montazWeldMode){
if(window.montazDeleteMode){
for(var i=0;i<ws.length;i++){
var w=ws[i];
var wEndX=w.end.x*ca.width;
var wEndY=w.end.y*ca.height;
var distEnd=Math.sqrt(Math.pow(x-wEndX,2)+Math.pow(y-wEndY,2));
if(distEnd<25){
if(confirm('VymazaÅ¥ zvar #'+w.displayNum+'?')){
ws=ws.filter(function(weld){return weld.id!==w.id;});
removeWeldFromWeldBook(w.displayNum);
crosses=crosses.filter(function(c){return c.weldId!==w.id;});
dw();up();
}
window.montazDeleteMode=false;
ca.style.cursor='default';
return;
}
}
alert('âŒ Klikli ste mimo zvaru.');
window.montazDeleteMode=false;
ca.style.cursor='default';
return;
}

for(var i=0;i<ws.length;i++){
var w=ws[i];
var wEndX=w.end.x*ca.width;
var wEndY=w.end.y*ca.height;
var distEnd=Math.sqrt(Math.pow(x-wEndX,2)+Math.pow(y-wEndY,2));

// Klik na KRUH (nie na paliÄka)
if(distEnd<25){ // RovnakÃ½ radius ako v editMode
clickedWeld=w;

// Check Äi mÃ¡ vyplnenÃ©ho zvaraÄa v WeldBook
var hasWelder=false;
var weldBookEntry=null;
if(weldBookData){
for(var wbi=0;wbi<weldBookData.length;wbi++){
var wbEntry = weldBookData[wbi];
// âœ… KRITICKÃ OPRAVA - kontroluj aj izometriu!
var isThisWeld = String(wbEntry.weldId) === String(w.displayNum);
var isThisIsometric = false;

if(wbEntry.isometric && originalFileName){
// Exact match alebo obsahuje
if(wbEntry.isometric === originalFileName || 
   originalFileName.includes(wbEntry.isometric) ||
   wbEntry.isometric.includes(originalFileName)){
isThisIsometric = true;
}
}

if(isThisWeld && isThisIsometric){
weldBookEntry=wbEntry;
if(weldBookEntry.welderId && weldBookEntry.welderId.trim()!==''){
hasWelder=true;
}
break;
}
}
}

if(hasWelder){
// ODZNAÄŒ - vymaÅ¾ zvaraÄa
if(confirm('OdznaÄiÅ¥ zvar '+w.displayNum+'? (vymaÅ¾e sa zvaraÄ z WeldBook)')){
weldBookEntry.welderId='';
weldBookEntry.dateWelding='';
saveCurrentPartWeldBook();
dw();
console.log('âŒ Zvar',w.displayNum,'odznaÄenÃ½ - zvaraÄ vymazanÃ½');
}
}else{
// OZNAÄŒIÅ¤ - otvor modal
openMontazWelderModal(w, weldBookEntry);
}
return; // Exit po MONTÃÅ½ interakcii
}
}
}

// NORMÃLNY klik handling (pre ostatnÃ© reÅ¾imy)
for(var i=0;i<ws.length;i++){
var w=ws[i];
var wEndX=w.end.x*ca.width;
var wEndY=w.end.y*ca.height;
var wStartX=w.start.x*ca.width;
var wStartY=w.start.y*ca.height;
var distEnd=Math.sqrt(Math.pow(x-wEndX,2)+Math.pow(y-wEndY,2));
var distStart=Math.sqrt(Math.pow(x-wStartX,2)+Math.pow(y-wStartY,2));
if(distEnd<25){
clickedWeld=w;
clickType='end';
break;
}else if(distStart<10){
clickedWeld=w;
clickType='start';
break;
}
}
if(clickedWeld){
if(editMode && clickType==='end' && !displayFilter.enabled){
// PREFABRIKÃCIA - zmena ÄÃ­sla zvaru na kruhu
var newNum=prompt('NovÃ© oznaÄenie (napr: 5, 12A, 15b, 3X):',clickedWeld.displayNum);
if(newNum!==null&&newNum.trim()!==''){
clickedWeld.displayNum=newNum.trim();
up();
dw();
}
return;
}
if(clickType==='start'){
if(!editMode){
var existingCross=crosses.find(function(c){return c.weldId===clickedWeld.id;});
if(existingCross){
alert('KrÃ­Å¾ik uÅ¾ existuje na tomto zvare!');
return;
}
crosses.push({
id:'cross_'+Date.now()+'_'+Math.random(),
weldId:clickedWeld.id,
pos:{x:wStartX/ca.width,y:wStartY/ca.height}
});
console.log('PridanÃ½ krÃ­Å¾ik na zvar #'+clickedWeld.displayNum);
dw();
return;
}
var action=prompt('1=PresunÃºÅ¥ paliÄka, 2=CelÃ½ zvar, 3=ZmazaÅ¥','1');
if(action==='1'){
editCrossMode=true;
selectedWeldId=clickedWeld.id;
ca.style.cursor='move';
return;
}else if(action==='2'){
moveMode=true;
selectedWeldId=clickedWeld.id;
ca.style.cursor='move';
dw();
return;
}else if(action==='3'){
if(confirm('ZmazaÅ¥?')){
var deletedWeld = clickedWeld;
ws=ws.filter(function(w){return w.id!==clickedWeld.id;});
removeWeldFromWeldBook(deletedWeld.displayNum);

// OdstrÃ¡Åˆ aj z kontrolaData (vÅ¡etky kÄ¾ÃºÄe obsahujÃºce displayNum)
for(var key in kontrolaData.completedWelds){
if(key.indexOf('_'+deletedWeld.displayNum)>-1){
delete kontrolaData.completedWelds[key];
}
}
for(var key in kontrolaData.welderData){
if(key.indexOf('_'+deletedWeld.displayNum+'_')>-1){
delete kontrolaData.welderData[key];
}
}
for(var key in kontrolaData.dateData){
if(key.indexOf('_'+deletedWeld.displayNum+'_')>-1){
delete kontrolaData.dateData[key];
}
}
saveKontrolaData();
console.log('ğŸ—‘ï¸ Zvar',deletedWeld.displayNum,'zmazanÃ½ zo vÅ¡etkÃ½ch dÃ¡t');

up();
dw();
}
return;
}
return;
}else{
var action=prompt('1=PresunÃºÅ¥ krÃºÅ¾ok, 2=CelÃ½ zvar, 3=ZmazaÅ¥','1');
if(action==='1'){
moveMode=true;
selectedWeldId=clickedWeld.id;
ca.style.cursor='move';
return;
}else if(action==='2'){
moveMode=true;
selectedWeldId=clickedWeld.id;
ca.style.cursor='move';
pt=clickedWeld.start;
dw();
return;
}else if(action==='3'){
if(confirm('ZmazaÅ¥?')){
var deletedWeld = clickedWeld;
ws=ws.filter(function(w){return w.id!==clickedWeld.id;});
removeWeldFromWeldBook(deletedWeld.displayNum);

// OdstrÃ¡Åˆ aj z kontrolaData (vÅ¡etky kÄ¾ÃºÄe obsahujÃºce displayNum)
for(var key in kontrolaData.completedWelds){
if(key.indexOf('_'+deletedWeld.displayNum)>-1){
delete kontrolaData.completedWelds[key];
}
}
for(var key in kontrolaData.welderData){
if(key.indexOf('_'+deletedWeld.displayNum+'_')>-1){
delete kontrolaData.welderData[key];
}
}
for(var key in kontrolaData.dateData){
if(key.indexOf('_'+deletedWeld.displayNum+'_')>-1){
delete kontrolaData.dateData[key];
}
}
saveKontrolaData();
console.log('ğŸ—‘ï¸ Zvar',deletedWeld.displayNum,'zmazanÃ½ zo vÅ¡etkÃ½ch dÃ¡t');

up();
dw();
}
return;
}
}
}


if(currentTool==='line'){
if(!linePt){
linePt={x:x,y:y};
dw();
document.getElementById('undo').disabled=false;
}else{
var id=Date.now()+'_'+Math.random();
lines.push({
id:id,
start:{x:linePt.x/ca.width,y:linePt.y/ca.height},
end:{x:x/ca.width,y:y/ca.height},
color:lineColor,
width:lineWidth
});
linePt=null;
dw();
console.log('âœ… PaliÄka vytvorenÃ¡');
if(typeof autoSaveCurrentProject==='function')try{autoSaveCurrentProject()}catch(e){}
}
return;
}

if(currentTool==='text'){
var userText=prompt('Zadajte text:');
if(userText && userText.trim()!==''){
var id=Date.now()+'_'+Math.random();
texts.push({
id:id,
text:userText.trim(),
x:x/ca.width,
y:y/ca.height,
color:textColor,
size:textSize,
rotation:0
});
dw();
console.log('âœ… Text vytvorenÃ½:',userText);
document.getElementById('undo').disabled=false;
}
return;
}

if(currentTool==='curve'){
// PrvÃ½ bod - zaÄiatok
if(curvePts.length===0){
curvePts.push({x:x,y:y});
dw();
console.log('ğŸŒ€ OblÃºÄik zaÄal - kliknite ÄalÅ¡ie body');
document.getElementById('undo').disabled=false;
return;
}

// Skontroluj Äi sme blÃ­zko zaÄiatku (20px) - UZAVRETIE
var firstPt=curvePts[0];
var distToStart=Math.sqrt(Math.pow(x-firstPt.x,2)+Math.pow(y-firstPt.y,2));

if(distToStart<20 && curvePts.length>=3){
// UZAVRI oblÃºÄik!
var id=Date.now()+'_'+Math.random();
var normalizedPts=curvePts.map(function(pt){
return {x:pt.x/ca.width,y:pt.y/ca.height};
});
curves.push({
id:id,
points:normalizedPts,
color:curveColor,
width:curveWidth
});
curvePts=[];
dw();
console.log('âœ… OblÃºÄik uzavretÃ½!');
document.getElementById('undo').disabled=false;
return;
}

// Pridaj ÄalÅ¡Ã­ bod
curvePts.push({x:x,y:y});
dw();
console.log('ğŸŒ€ Bod pridanÃ½ ('+curvePts.length+' bodov)');
return;
}

if(currentTool==='cross'){
crosses.push({id:Date.now()+'_'+Math.random(),pos:{x:x/ca.width,y:y/ca.height}});
dw();
return;
}

if(currentTool==='arrow'){
if(!arrowPt){
arrowPt={x:x,y:y};
console.log('â†’ Å Ã­pka zaÄala');
document.getElementById('undo').disabled=false;
}else{
var id=Date.now()+'_'+Math.random();
arrows.push({
id:id,
start:{x:arrowPt.x/ca.width,y:arrowPt.y/ca.height},
end:{x:x/ca.width,y:y/ca.height},
color:arrowColor,
width:arrowWidth,
type:arrowType
});
arrowPt=null;
console.log('âœ… Å Ã­pka vytvorenÃ¡');
document.getElementById('undo').disabled=false;
dw();
}
return;
}

if(currentTool==='spool'){
if(!pt){
pt={x:x,y:y};
dw();
document.getElementById('undo').disabled=false;
}else{
var id=Date.now()+'_'+Math.random();
spools.push({
id:id,
start:{x:pt.x/ca.width,y:pt.y/ca.height},
end:{x:x/ca.width,y:y/ca.height},
displayNum:'SP'+spoolNum
});
pt=null;
spoolNum++;
dw();
}
return;
}

if(oneClickMode && currentTool!=='select'){
if(!pt){
var clickPos={x:x,y:y};
var id=Date.now()+'_'+Math.random();
var smartEnd=findBestCirclePosition(clickPos.x,clickPos.y);
ws.push({
id:id,
start:{x:clickPos.x/ca.width,y:clickPos.y/ca.height},
end:{x:smartEnd.x/ca.width,y:smartEnd.y/ca.height},
displayNum:cn,
source:'site'
});
weldHistory.push({
id:id,
start:{x:clickPos.x/ca.width,y:clickPos.y/ca.height},
end:{x:smartEnd.x/ca.width,y:smartEnd.y/ca.height},
displayNum:cn,
source:'site'
});
if(weldHistory.length>10)weldHistory.shift();
var splitName=splitIsometricName(originalFileName || 'Unknown');
addWeldToWeldBook({
part: splitName.part,
isometric: splitName.isometric,
sheets: 1,
weldId: String(cn),
source:'site',
item1: '', item2: '',
ped: '', rev: '', pipeClass: '',
heatNr1: '', certNr1: '', dimension1: '', thickness1: '', material1: '', matGroup1: '',
heatNr2: '', certNr2: '', dimension2: '', thickness2: '', material2: '', matGroup2: '',
wps: '', wpqr: '', weldingMethod: '', jointType: '', weldingType: '', weldingGas: '',
heatNrWeld: '', certNrWeld: '', welderId: '', dateWelding: '',
vtPercent: '', vtDate: '', vtReport: '', vtResult: '',
ptPercent: '', ptDate: '', ptReport: '', ptResult: '',
rtPercent: '', rtDate: '', rtReport: '', rtResult: '',
pmpInch: '', andritzInch: '', pressureGroup: '', note: ''
});
pt=null;
cn++;
up();
dw();
document.getElementById('undo').disabled=false;
}
}else if(currentTool!=='select' && !montazWeldMode){
// TWO-CLICK MODE - len ak NIEJE select tool A NIE JE montazWeldMode
if(!pt){
pt={x:x,y:y};
dw();
document.getElementById('undo').disabled=false;
}else{
var id=Date.now()+'_'+Math.random();
ws.push({
id:id,
start:{x:pt.x/ca.width,y:pt.y/ca.height},
end:{x:x/ca.width,y:y/ca.height},
displayNum:cn,
source:'site'
});
weldHistory.push({
id:id,
start:{x:pt.x/ca.width,y:pt.y/ca.height},
end:{x:x/ca.width,y:y/ca.height},
displayNum:cn,
source:'site'
});
if(weldHistory.length>10)weldHistory.shift();
var splitName=splitIsometricName(originalFileName || 'Unknown');
addWeldToWeldBook({
part: splitName.part,
isometric: splitName.isometric,
sheets: 1,
weldId: String(cn),
source:'site',
item1: '', item2: '',
ped: '', rev: '', pipeClass: '',
heatNr1: '', certNr1: '', dimension1: '', thickness1: '', material1: '', matGroup1: '',
heatNr2: '', certNr2: '', dimension2: '', thickness2: '', material2: '', matGroup2: '',
wps: '', wpqr: '', weldingMethod: '', jointType: '', weldingType: '', weldingGas: '',
heatNrWeld: '', certNrWeld: '', welderId: '', dateWelding: '',
vtPercent: '', vtDate: '', vtReport: '', vtResult: '',
ptPercent: '', ptDate: '', ptReport: '', ptResult: '',
rtPercent: '', rtDate: '', rtReport: '', rtResult: '',
pmpInch: '', andritzInch: '', pressureGroup: '', note: ''
});
pt=null;
cn++;
up();
dw();
}
}
};

// DVOJKLIK - EditovaÅ¥ ÄÃ­slo zvaru
ca.ondblclick=function(e){
var rc=ca.getBoundingClientRect();
var x=e.clientX-rc.left;
var y=e.clientY-rc.top;

var detected=detectObjectAt(x,y);
if(detected && detected.type==='weld'){
var newNum=prompt('âœï¸ NovÃ© ÄÃ­slo zvaru:',detected.object.displayNum);
if(newNum!==null && newNum.trim()!==''){
var oldNum=detected.object.displayNum;
detected.object.displayNum=newNum.trim();
updateWeldInWeldBook(oldNum,newNum.trim());
dw();
up();
showNotification('âœ… ÄŒÃ­slo zvaru zmenenÃ©: '+oldNum+' â†’ '+newNum.trim());
}
}
};

ca.oncontextmenu=function(e){
e.preventDefault();
var rc=ca.getBoundingClientRect();
var x=e.clientX-rc.left;
var y=e.clientY-rc.top;

// PRAVÃ‰ TLAÄŒIDLO - ZmazaÅ¥
if(currentTool==='select'){
var detected=detectObjectAt(x,y);
if(detected){
// ZVAR - ZmazaÅ¥
if(detected.type==='weld'){
if(confirm('ğŸ—‘ï¸ ZmazaÅ¥ zvar #'+detected.object.displayNum+'?')){
ws.splice(detected.index,1);
removeWeldFromWeldBook(detected.object.displayNum);

// OdstrÃ¡Åˆ aj z kontrolaData (vÅ¡etky kÄ¾ÃºÄe obsahujÃºce displayNum)
for(var key in kontrolaData.completedWelds){
if(key.indexOf('_'+detected.object.displayNum)>-1){
delete kontrolaData.completedWelds[key];
}
}
for(var key in kontrolaData.welderData){
if(key.indexOf('_'+detected.object.displayNum+'_')>-1){
delete kontrolaData.welderData[key];
}
}
for(var key in kontrolaData.dateData){
if(key.indexOf('_'+detected.object.displayNum+'_')>-1){
delete kontrolaData.dateData[key];
}
}
saveKontrolaData();
console.log('ğŸ—‘ï¸ Zvar',detected.object.displayNum,'zmazanÃ½ zo vÅ¡etkÃ½ch dÃ¡t');

dw();
up();
showNotification('Zvar zmazanÃ½: #'+detected.object.displayNum);
}
return false;
}

// TEXT - MENU: UpraviÅ¥ / ZmazaÅ¥
if(detected.type==='text'){
var action=prompt('1=UpraviÅ¥ text, 2=ZmazaÅ¥','1');
if(action==='1'){
var newText=prompt('UpraviÅ¥ text:',detected.object.text);
if(newText!==null && newText.trim()!==''){
detected.object.text=newText.trim();
dw();
console.log('âœï¸ Text upravenÃ½:',newText);
}
}else if(action==='2'){
if(confirm('ZmazaÅ¥ text?')){
texts.splice(detected.index,1);
dw();
console.log('ğŸ—‘ï¸ Text zmazanÃ½');
}
}
return false;
}

// OstatnÃ© objekty - priamo zmazaÅ¥
var confirmMsg='ZmazaÅ¥ ';
if(detected.type==='line')confirmMsg+='paliÄka?';
else if(detected.type==='arrow')confirmMsg+='Å¡Ã­pku?';
else if(detected.type==='curve')confirmMsg+='oblÃºÄik?';

if(confirm(confirmMsg)){
if(detected.type==='line'){
lines.splice(detected.index,1);
}else if(detected.type==='arrow'){
arrows.splice(detected.index,1);
}else if(detected.type==='curve'){
curves.splice(detected.index,1);
}
dw();
console.log('ğŸ—‘ï¸ ZmazanÃ©:',detected.type);
}
return false;
}
}

// DOMERKY - MENU: UpraviÅ¥ / ZmazaÅ¥
var clickedDim=null;
var clickedDimIndex=-1;
for(var i=0;i<dimensions.length;i++){
var dim=dimensions[i];
var dimX=dim.x*ca.width;
var dimY=dim.y*ca.height;
var dist=Math.sqrt(Math.pow(x-dimX,2)+Math.pow(y-dimY,2));
if(dist<30){
clickedDim=dim;
clickedDimIndex=i;
break;
}
}
if(clickedDim){
var action=prompt('1=UpraviÅ¥ domerok, 2=ZmazaÅ¥','1');
if(action==='1'){
var newText=prompt('UpraviÅ¥ domerok:',clickedDim.text);
if(newText!==null && newText.trim()!==''){
clickedDim.text=newText.trim();
dw();
console.log('âœï¸ Domerok upravenÃ½:',newText);
}
}else if(action==='2'){
if(confirm('OdstrÃ¡niÅ¥ domerok "'+clickedDim.text+'"?')){
dimensions.splice(clickedDimIndex,1);
console.log('ğŸ—‘ï¸ Domerok zmazanÃ½:',clickedDim.text);
dw();
}
}
}
return false;
};



function findBestCirclePosition(startX,startY){
var imageData=ct.getImageData(0,0,ca.width,ca.height);
var bestPos={x:startX+80,y:startY};
var bestScore=-1;
var angles=[0,30,60,90,120,150,180,210,240,270,300,330];
for(var i=0;i<angles.length;i++){
var angle=angles[i]*(Math.PI/180);
for(var dist=70;dist<=160;dist+=20){
var testX=startX+Math.cos(angle)*dist;
var testY=startY+Math.sin(angle)*dist;
if(testX<45||testX>ca.width-45||testY<45||testY>ca.height-45)continue;
var tooCloseToOtherWeld=false;
for(var j=0;j<ws.length;j++){
var weldEndX=ws[j].end.x*ca.width;
var weldEndY=ws[j].end.y*ca.height;
var distToWeld=Math.sqrt(Math.pow(testX-weldEndX,2)+Math.pow(testY-weldEndY,2));
if(distToWeld<80){
tooCloseToOtherWeld=true;
break;
}
}
if(tooCloseToOtherWeld)continue;
var score=checkWhiteSpace(imageData,testX,testY,35);
if(score>bestScore&&score>0.85){
bestScore=score;
bestPos={x:testX,y:testY};
}
}
}
return bestPos;
}

function checkWhiteSpace(imageData,cx,cy,radius){
var whiteCount=0;
var totalCount=0;
for(var dy=-radius;dy<=radius;dy+=3){
for(var dx=-radius;dx<=radius;dx+=3){
if(dx*dx+dy*dy>radius*radius)continue;
var px=Math.round(cx+dx);
var py=Math.round(cy+dy);
if(px<0||px>=imageData.width||py<0||py>=imageData.height)continue;
var idx=(py*imageData.width+px)*4;
var r=imageData.data[idx];
var g=imageData.data[idx+1];
var b=imageData.data[idx+2];
var brightness=(r+g+b)/3;
totalCount++;
if(brightness>250)whiteCount++;
}
}
return totalCount>0?whiteCount/totalCount:0;
}

function dw(){
ov.innerHTML='';
ws.forEach(function(w){
// MONTÃÅ½ MODE - ZobrazÃ­me VÅ ETKY zvary, len menime farbu
// Filter uÅ¾ neblokuje zobrazenie, len urÄuje farbu kruhu (zelenÃ½/ÄervenÃ½)

var startX=w.start.x*ca.width;
var startY=w.start.y*ca.height;
var endX=w.end.x*ca.width;
var endY=w.end.y*ca.height;
var dx=endX-startX;
var dy=endY-startY;
var len=Math.sqrt(dx*dx+dy*dy);
var numLen=String(w.displayNum).length;
// âœ… Å kÃ¡luj radius podÄ¾a zoom (sc) A weldScale
var baseRadius=22;
if(numLen>=4)baseRadius=30;
else if(numLen>=3)baseRadius=26;
else if(numLen>=2)baseRadius=24;
var radius=baseRadius*sc*weldScale; // Å kÃ¡luj s zoom A weldScale!
var ratio=(len-radius)/len;
var lineEndX=startX+dx*ratio;
var lineEndY=startY+dy*ratio;

// FARBA podÄ¾a WELDBOOK - ak mÃ¡ vyplnenÃ©ho zvaraÄa
var weldColor='#FF0000'; // Stroke VÅ½DY ÄervenÃ½!
var fillColor='none'; // Default nevyplnenÃ½

// Ak je filter enabled (MONTÃÅ½ mode), check WeldBook
if(displayFilter.enabled){
// Check Äi mÃ¡ tento zvar vyplnenÃ©ho zvaraÄa v WeldBook
var hasWelder = false;

// Prejdi WeldBook a nÃ¡jdi tento zvar
if(weldBookData && weldBookData.length > 0){
for(var wbi=0; wbi<weldBookData.length; wbi++){
var wbEntry = weldBookData[wbi];
// âœ… KRITICKÃ OPRAVA - Match podÄ¾a weldId A isometric!
var isThisWeld = String(wbEntry.weldId) === String(w.displayNum);

// âœ… DEBUG - vypisuj kaÅ¾dÃ½ pokus o match pre zvar 1 a 9
if(w.displayNum === 1 || w.displayNum === 9){
console.log('ğŸ” DEBUG zvar', w.displayNum, ':');
console.log('  wbEntry.weldId:', wbEntry.weldId);
console.log('  wbEntry.isometric:', wbEntry.isometric);
console.log('  originalFileName:', originalFileName);
console.log('  isThisWeld:', isThisWeld);
}

// FlexibilnÃ© porovnanie izometrie
var isThisIsometric = false;
if(wbEntry.isometric && originalFileName){
// Exact match
if(wbEntry.isometric === originalFileName){
isThisIsometric = true;
}
// Match bez prÃ­pony
else if(wbEntry.isometric === originalFileName.replace(/\.[^/.]+$/, '')){
isThisIsometric = true;
}
// Match obsahuje nÃ¡zov
else if(originalFileName.includes(wbEntry.isometric)){
isThisIsometric = true;
}
// Match opaÄne
else if(wbEntry.isometric.includes(originalFileName)){
isThisIsometric = true;
}
}

if(w.displayNum === 1 || w.displayNum === 9){
console.log('  isThisIsometric:', isThisIsometric);
}
                       
if(isThisWeld && isThisIsometric){
// Check Äi mÃ¡ vyplnenÃ©ho zvaraÄa (welderId nie welder!)
if(wbEntry.welderId && wbEntry.welderId.trim() !== ''){
hasWelder = true;
console.log('âœ… MONTÃÅ½: Zvar',w.displayNum,'izometria:',originalFileName,'mÃ¡ zvaraÄa:',wbEntry.welderId);
break;
}
}
}
}

// Ak mÃ¡ zvaraÄa â†’ vyplÅˆ jasnou zvÃ½razÅˆovaÄovou zelenou
if(hasWelder){
fillColor = '#00FF00'; // JASNÃ KRIKÄ½AVÃ ZELENÃ (zvÃ½razÅˆovaÄ)
// weldColor zostÃ¡va ÄervenÃ½!
} else {
// NemÃ¡ zvaraÄa â†’ ÄervenÃ½ prÃ¡zdny (poziÄnÃ½)
fillColor = 'none';
weldColor = '#FF0000'; // ÄŒervenÃ½
}
}

var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
ln.setAttribute('x1',startX);
ln.setAttribute('y1',startY);
ln.setAttribute('x2',lineEndX);
ln.setAttribute('y2',lineEndY);
ln.setAttribute('stroke',weldColor);
ln.setAttribute('stroke-width',2.5*sc); // Å kÃ¡luj s zoom
ov.appendChild(ln);

var crossSize=1.6*sc; // Å kÃ¡luj s zoom
var l1=document.createElementNS('http://www.w3.org/2000/svg','line');
l1.setAttribute('x1',startX-crossSize);
l1.setAttribute('y1',startY-crossSize);
l1.setAttribute('x2',startX+crossSize);
l1.setAttribute('y2',startY+crossSize);
l1.setAttribute('stroke',weldColor);
l1.setAttribute('stroke-width',2*sc); // Å kÃ¡luj s zoom
ov.appendChild(l1);

var l2=document.createElementNS('http://www.w3.org/2000/svg','line');
l2.setAttribute('x1',startX-crossSize);
l2.setAttribute('y1',startY+crossSize);
l2.setAttribute('x2',startX+crossSize);
l2.setAttribute('y2',startY-crossSize);
l2.setAttribute('stroke',weldColor);
l2.setAttribute('stroke-width',2*sc); // Å kÃ¡luj s zoom
ov.appendChild(l2);

var cr=document.createElementNS('http://www.w3.org/2000/svg','circle');
cr.setAttribute('cx',endX);
cr.setAttribute('cy',endY);
cr.setAttribute('r',radius);
cr.setAttribute('fill',fillColor); // VYPLÅ‡ ak je hotovÃ½!
cr.setAttribute('stroke',weldColor);
cr.setAttribute('stroke-width',1.5*sc*weldScale); // Å kÃ¡luj s zoom A weldScale
ov.appendChild(cr);

// âœ… Å kÃ¡luj fontSize podÄ¾a zoom (sc) A weldScale
var baseFontSize=34;
if(numLen>=4)baseFontSize=24;
else if(numLen>=3)baseFontSize=28;
else if(numLen>=2)baseFontSize=30;
var fontSize=baseFontSize*sc*weldScale; // Å kÃ¡luj s zoom A weldScale!

var tx=document.createElementNS('http://www.w3.org/2000/svg','text');
tx.setAttribute('x',endX);
tx.setAttribute('y',endY);
tx.setAttribute('fill',weldColor);
tx.setAttribute('font-size',fontSize);
tx.setAttribute('font-weight','normal');
tx.setAttribute('text-anchor','middle');
tx.setAttribute('dominant-baseline','middle');
tx.setAttribute('font-family','Arial');
tx.textContent=w.displayNum;
ov.appendChild(tx);
});

// LAYER FILTER - krÃ­Å¾iky len v PREFABRIKÃCIA a KONTROLA
if(activeTab==='prefab' || activeTab==='kontrola'){
crosses.forEach(function(c){
var crossX=c.pos.x*ca.width;
var crossY=c.pos.y*ca.height;
var crossSize=13.2;
var l1=document.createElementNS('http://www.w3.org/2000/svg','line');
l1.setAttribute('x1',crossX-crossSize);
l1.setAttribute('y1',crossY-crossSize);
l1.setAttribute('x2',crossX+crossSize);
l1.setAttribute('y2',crossY+crossSize);
l1.setAttribute('stroke','#FF0000');
l1.setAttribute('stroke-width','4');
ov.appendChild(l1);
var l2=document.createElementNS('http://www.w3.org/2000/svg','line');
l2.setAttribute('x1',crossX-crossSize);
l2.setAttribute('y1',crossY+crossSize);
l2.setAttribute('x2',crossX+crossSize);
l2.setAttribute('y2',crossY-crossSize);
l2.setAttribute('stroke','#FF0000');
l2.setAttribute('stroke-width','4');
ov.appendChild(l2);
});
}

// LAYER FILTER - spooly len v PREFABRIKÃCIA a KONTROLA
if(activeTab==='prefab' || activeTab==='kontrola'){
spools.forEach(function(s){
var startX=s.start.x*ca.width;
var startY=s.start.y*ca.height;
var endX=s.end.x*ca.width;
var endY=s.end.y*ca.height;
var dx=endX-startX;
var dy=endY-startY;
var len=Math.sqrt(dx*dx+dy*dy);
var textLen=String(s.displayNum).length;
var radius=30;
if(textLen>=4)radius=36;
else if(textLen>=3)radius=33;
var ratio=(len-radius)/len;
var lineEndX=startX+dx*ratio;
var lineEndY=startY+dy*ratio;

var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
ln.setAttribute('x1',startX);
ln.setAttribute('y1',startY);
ln.setAttribute('x2',lineEndX);
ln.setAttribute('y2',lineEndY);
ln.setAttribute('stroke','#FF0000');
ln.setAttribute('stroke-width','2.5');
ov.appendChild(ln);

var crossSize=1.6;
var l1=document.createElementNS('http://www.w3.org/2000/svg','line');
l1.setAttribute('x1',startX-crossSize);
l1.setAttribute('y1',startY-crossSize);
l1.setAttribute('x2',startX+crossSize);
l1.setAttribute('y2',startY+crossSize);
l1.setAttribute('stroke','#FF0000');
l1.setAttribute('stroke-width','2');
ov.appendChild(l1);
var l2=document.createElementNS('http://www.w3.org/2000/svg','line');
l2.setAttribute('x1',startX-crossSize);
l2.setAttribute('y1',startY+crossSize);
l2.setAttribute('x2',startX+crossSize);
l2.setAttribute('y2',startY-crossSize);
l2.setAttribute('stroke','#FF0000');
l2.setAttribute('stroke-width','2');
ov.appendChild(l2);

var cr=document.createElementNS('http://www.w3.org/2000/svg','circle');
cr.setAttribute('cx',endX);
cr.setAttribute('cy',endY);
cr.setAttribute('r',radius);
cr.setAttribute('fill','none');
cr.setAttribute('stroke','#FF0000');
cr.setAttribute('stroke-width','1.5');
ov.appendChild(cr);

var fontSize=44;
if(textLen>=4)fontSize=31;
else if(textLen>=3)fontSize=36;

var tx=document.createElementNS('http://www.w3.org/2000/svg','text');
tx.setAttribute('x',endX);
tx.setAttribute('y',endY);
tx.setAttribute('fill','#FF0000');
tx.setAttribute('font-size',fontSize);
tx.setAttribute('font-weight','normal');
tx.setAttribute('text-anchor','middle');
tx.setAttribute('dominant-baseline','middle');
tx.setAttribute('font-family','Arial');
tx.textContent=s.displayNum;
ov.appendChild(tx);
});
}

// Kreslenie palÃ­Äok - VÅ UDE (RED PEN aj PREFAB)
lines.forEach(function(line){
var startX=line.start.x*ca.width;
var startY=line.start.y*ca.height;
var endX=line.end.x*ca.width;
var endY=line.end.y*ca.height;

var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
ln.setAttribute('x1',startX);
ln.setAttribute('y1',startY);
ln.setAttribute('x2',endX);
ln.setAttribute('y2',endY);
ln.setAttribute('stroke',line.color);
ln.setAttribute('stroke-width',line.width);
ln.setAttribute('data-line-id',line.id);
ov.appendChild(ln);
});

// Kreslenie Å¡Ã­pok - VÅ UDE (RED PEN aj PREFAB)
arrows.forEach(function(arrow){
var x1=arrow.start.x*ca.width;
var y1=arrow.start.y*ca.height;
var x2=arrow.end.x*ca.width;
var y2=arrow.end.y*ca.height;

// HlavnÃ¡ Äiara
var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
ln.setAttribute('x1',x1);
ln.setAttribute('y1',y1);
ln.setAttribute('x2',x2);
ln.setAttribute('y2',y2);
ln.setAttribute('stroke',arrow.color);
ln.setAttribute('stroke-width',arrow.width);
ov.appendChild(ln);

// Hrot Å¡Ã­pky
var angle=Math.atan2(y2-y1,x2-x1);
var arrowSize=12;

if(arrow.type==='single' || arrow.type==='double'){
// Å Ã­pka na konci
var a1x=x2-arrowSize*Math.cos(angle-Math.PI/6);
var a1y=y2-arrowSize*Math.sin(angle-Math.PI/6);
var a2x=x2-arrowSize*Math.cos(angle+Math.PI/6);
var a2y=y2-arrowSize*Math.sin(angle+Math.PI/6);

var p1=document.createElementNS('http://www.w3.org/2000/svg','line');
p1.setAttribute('x1',x2);p1.setAttribute('y1',y2);
p1.setAttribute('x2',a1x);p1.setAttribute('y2',a1y);
p1.setAttribute('stroke',arrow.color);p1.setAttribute('stroke-width',arrow.width);
ov.appendChild(p1);

var p2=document.createElementNS('http://www.w3.org/2000/svg','line');
p2.setAttribute('x1',x2);p2.setAttribute('y1',y2);
p2.setAttribute('x2',a2x);p2.setAttribute('y2',a2y);
p2.setAttribute('stroke',arrow.color);p2.setAttribute('stroke-width',arrow.width);
ov.appendChild(p2);
}

if(arrow.type==='double'){
// Å Ã­pka na zaÄiatku
var b1x=x1+arrowSize*Math.cos(angle-Math.PI/6);
var b1y=y1+arrowSize*Math.sin(angle-Math.PI/6);
var b2x=x1+arrowSize*Math.cos(angle+Math.PI/6);
var b2y=y1+arrowSize*Math.sin(angle+Math.PI/6);

var p3=document.createElementNS('http://www.w3.org/2000/svg','line');
p3.setAttribute('x1',x1);p3.setAttribute('y1',y1);
p3.setAttribute('x2',b1x);p3.setAttribute('y2',b1y);
p3.setAttribute('stroke',arrow.color);p3.setAttribute('stroke-width',arrow.width);
ov.appendChild(p3);

var p4=document.createElementNS('http://www.w3.org/2000/svg','line');
p4.setAttribute('x1',x1);p4.setAttribute('y1',y1);
p4.setAttribute('x2',b2x);p4.setAttribute('y2',b2y);
p4.setAttribute('stroke',arrow.color);p4.setAttribute('stroke-width',arrow.width);
ov.appendChild(p4);
}
});

// DoÄasnÃ¡ Å¡Ã­pka (pri kreslenÃ­)
if(arrowPt && currentTool==='arrow'){
var x1=arrowPt.x;
var y1=arrowPt.y;
var x2=mouseX;
var y2=mouseY;

var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
ln.setAttribute('x1',x1);ln.setAttribute('y1',y1);
ln.setAttribute('x2',x2);ln.setAttribute('y2',y2);
ln.setAttribute('stroke',arrowColor);ln.setAttribute('stroke-width',arrowWidth);
ln.setAttribute('stroke-dasharray','5,5');ln.setAttribute('opacity','0.7');
ov.appendChild(ln);

var angle=Math.atan2(y2-y1,x2-x1);
var arrowSize=12;

if(arrowType==='single' || arrowType==='double'){
var a1x=x2-arrowSize*Math.cos(angle-Math.PI/6);
var a1y=y2-arrowSize*Math.sin(angle-Math.PI/6);
var a2x=x2-arrowSize*Math.cos(angle+Math.PI/6);
var a2y=y2-arrowSize*Math.sin(angle+Math.PI/6);

var p1=document.createElementNS('http://www.w3.org/2000/svg','line');
p1.setAttribute('x1',x2);p1.setAttribute('y1',y2);
p1.setAttribute('x2',a1x);p1.setAttribute('y2',a1y);
p1.setAttribute('stroke',arrowColor);p1.setAttribute('stroke-width',arrowWidth);
p1.setAttribute('stroke-dasharray','5,5');p1.setAttribute('opacity','0.7');
ov.appendChild(p1);

var p2=document.createElementNS('http://www.w3.org/2000/svg','line');
p2.setAttribute('x1',x2);p2.setAttribute('y1',y2);
p2.setAttribute('x2',a2x);p2.setAttribute('y2',a2y);
p2.setAttribute('stroke',arrowColor);p2.setAttribute('stroke-width',arrowWidth);
p2.setAttribute('stroke-dasharray','5,5');p2.setAttribute('opacity','0.7');
ov.appendChild(p2);
}

if(arrowType==='double'){
var b1x=x1+arrowSize*Math.cos(angle-Math.PI/6);
var b1y=y1+arrowSize*Math.sin(angle-Math.PI/6);
var b2x=x1+arrowSize*Math.cos(angle+Math.PI/6);
var b2y=y1+arrowSize*Math.sin(angle+Math.PI/6);

var p3=document.createElementNS('http://www.w3.org/2000/svg','line');
p3.setAttribute('x1',x1);p3.setAttribute('y1',y1);
p3.setAttribute('x2',b1x);p3.setAttribute('y2',b1y);
p3.setAttribute('stroke',arrowColor);p3.setAttribute('stroke-width',arrowWidth);
p3.setAttribute('stroke-dasharray','5,5');p3.setAttribute('opacity','0.7');
ov.appendChild(p3);

var p4=document.createElementNS('http://www.w3.org/2000/svg','line');
p4.setAttribute('x1',x1);p4.setAttribute('y1',y1);
p4.setAttribute('x2',b2x);p4.setAttribute('y2',b2y);
p4.setAttribute('stroke',arrowColor);p4.setAttribute('stroke-width',arrowWidth);
p4.setAttribute('stroke-dasharray','5,5');p4.setAttribute('opacity','0.7');
ov.appendChild(p4);
}
}

// DoÄasnÃ¡ paliÄka (pri kreslenÃ­) - Äiara ide k myÅ¡i
if(linePt && currentTool==='line'){
var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
ln.setAttribute('x1',linePt.x);
ln.setAttribute('y1',linePt.y);
ln.setAttribute('x2',mouseX);
ln.setAttribute('y2',mouseY);
ln.setAttribute('stroke',lineColor);
ln.setAttribute('stroke-width',lineWidth);
ln.setAttribute('stroke-dasharray','5,5');
ln.setAttribute('opacity','0.7');
ov.appendChild(ln);
}

// Kreslenie textov - VÅ ADE (RED PEN aj PREFAB)
texts.forEach(function(txt){
var txtX=txt.x*ca.width;
var txtY=txt.y*ca.height;
var t=document.createElementNS('http://www.w3.org/2000/svg','text');
t.setAttribute('x',txtX);
t.setAttribute('y',txtY);
t.setAttribute('fill',txt.color);
t.setAttribute('font-size',txt.size);
t.setAttribute('font-weight','bold');
t.setAttribute('font-family','Arial');
t.setAttribute('text-anchor','start');
t.setAttribute('dominant-baseline','middle');
t.setAttribute('data-text-id',txt.id);
if(txt.rotation){
t.setAttribute('transform','rotate('+txt.rotation+' '+txtX+' '+txtY+')');
}
t.textContent=txt.text;
ov.appendChild(t);
});

// RÃ¡mÄek + rotation ikona pre vybranÃ½ objekt (text, arrow, dimension)
if(selectedTextForRotation){
var obj=selectedTextForRotation.object;
var objX=obj.x*ca.width;
var objY=obj.y*ca.height;
var bbox;

if(selectedTextForRotation.type==='text'){
bbox={x:objX-10,y:objY-obj.size,width:obj.text.length*obj.size*0.6+20,height:obj.size*2};
}else if(selectedTextForRotation.type==='dimension'){
bbox={x:objX-10,y:objY-20,width:obj.text.length*12+20,height:40};
}else if(selectedTextForRotation.type==='arrow'){
var x1=obj.start.x*ca.width;
var y1=obj.start.y*ca.height;
var x2=obj.end.x*ca.width;
var y2=obj.end.y*ca.height;
var minX=Math.min(x1,x2)-10;
var minY=Math.min(y1,y2)-10;
var maxX=Math.max(x1,x2)+10;
var maxY=Math.max(y1,y2)+10;
bbox={x:minX,y:minY,width:maxX-minX,height:maxY-minY};
objX=(x1+x2)/2;
objY=(y1+y2)/2;
}

var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
rect.setAttribute('x',bbox.x);
rect.setAttribute('y',bbox.y);
rect.setAttribute('width',bbox.width);
rect.setAttribute('height',bbox.height);
rect.setAttribute('fill','none');
rect.setAttribute('stroke','#0078D4');
rect.setAttribute('stroke-width','2');
rect.setAttribute('stroke-dasharray','5,5');
ov.appendChild(rect);

// Rotation ikona (ğŸ”„) v pravom hornom rohu
var iconX=bbox.x+bbox.width;
var iconY=bbox.y;
var icon=document.createElementNS('http://www.w3.org/2000/svg','circle');
icon.setAttribute('cx',iconX);
icon.setAttribute('cy',iconY);
icon.setAttribute('r','12');
icon.setAttribute('fill','#0078D4');
icon.setAttribute('stroke','white');
icon.setAttribute('stroke-width','2');
icon.setAttribute('data-rotation-handle','true');
ov.appendChild(icon);

var arrowPath=document.createElementNS('http://www.w3.org/2000/svg','path');
arrowPath.setAttribute('d','M '+(iconX-6)+' '+(iconY)+' A 6 6 0 1 1 '+(iconX)+' '+(iconY-6));
arrowPath.setAttribute('stroke','white');
arrowPath.setAttribute('stroke-width','2');
arrowPath.setAttribute('fill','none');
arrowPath.setAttribute('data-rotation-handle','true');
ov.appendChild(arrowPath);
}

// Kreslenie oblÃºÄikov (uzavretÃ© tvary) - VLNOVKOVÃ BUBLINA
curves.forEach(function(curve){
if(curve.points.length<2)return;

var pathData='';
var allPts=curve.points.slice();
allPts.push(curve.points[0]);

for(var i=0;i<allPts.length-1;i++){
var pt1=allPts[i];
var pt2=allPts[i+1];
var x1=pt1.x*ca.width;
var y1=pt1.y*ca.height;
var x2=pt2.x*ca.width;
var y2=pt2.y*ca.height;

var dx=x2-x1;
var dy=y2-y1;
var dist=Math.sqrt(dx*dx+dy*dy);

// RozdeliÅ¥ na malÃ© segmenty
var segments=Math.max(20,Math.floor(dist/5));

if(i===0){
pathData='M '+x1+' '+y1+' ';
}

for(var s=0;s<=segments;s++){
var t=s/segments;
var x=x1+dx*t;
var y=y1+dy*t;

// OblÃºÄik kolmo na Äiaru
var angle=Math.atan2(dy,dx)+Math.PI/2;
var amplitude=4*Math.sin(t*Math.PI*12);
x+=Math.cos(angle)*amplitude;
y+=Math.sin(angle)*amplitude;

pathData+='L '+x+' '+y+' ';
}
}

var path=document.createElementNS('http://www.w3.org/2000/svg','path');
path.setAttribute('d',pathData);
path.setAttribute('stroke',curve.color);
path.setAttribute('stroke-width',curve.width);
path.setAttribute('fill','none');
path.setAttribute('stroke-linejoin','round');
path.setAttribute('data-curve-id',curve.id);
ov.appendChild(path);
});

// DoÄasnÃ½ oblÃºÄik (pri kreslenÃ­)
if(curvePts.length>0 && currentTool==='curve'){
curvePts.forEach(function(pt,idx){
var cr=document.createElementNS('http://www.w3.org/2000/svg','circle');
cr.setAttribute('cx',pt.x);
cr.setAttribute('cy',pt.y);
cr.setAttribute('r',idx===0?8:5);
cr.setAttribute('fill',idx===0?curveColor:'white');
cr.setAttribute('stroke',curveColor);
cr.setAttribute('stroke-width','2');
ov.appendChild(cr);
});

if(curvePts.length>=3){
var firstPt=curvePts[0];
var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
rect.setAttribute('x',firstPt.x-10);
rect.setAttribute('y',firstPt.y-10);
rect.setAttribute('width','20');
rect.setAttribute('height','20');
rect.setAttribute('fill','none');
rect.setAttribute('stroke',curveColor);
rect.setAttribute('stroke-width','1');
rect.setAttribute('stroke-dasharray','3,3');
rect.setAttribute('opacity','0.5');
ov.appendChild(rect);
}

if(curvePts.length===1){
var pt=curvePts[0];
var x1=pt.x;
var y1=pt.y;
var x2=mouseX;
var y2=mouseY;
var dx=x2-x1;
var dy=y2-y1;
var dist=Math.sqrt(dx*dx+dy*dy);

if(dist>5){
var pathData='M '+x1+' '+y1+' ';
var segments=Math.max(20,Math.floor(dist/5));
var angle=Math.atan2(dy,dx)+Math.PI/2;

for(var s=0;s<=segments;s++){
var t=s/segments;
var x=x1+dx*t;
var y=y1+dy*t;
var amplitude=4*Math.sin(t*Math.PI*12);
x+=Math.cos(angle)*amplitude;
y+=Math.sin(angle)*amplitude;
pathData+='L '+x+' '+y+' ';
}

var path=document.createElementNS('http://www.w3.org/2000/svg','path');
path.setAttribute('d',pathData);
path.setAttribute('stroke',curveColor);
path.setAttribute('stroke-width',curveWidth);
path.setAttribute('fill','none');
path.setAttribute('stroke-dasharray','5,5');
path.setAttribute('opacity','0.7');
ov.appendChild(path);
}
}else if(curvePts.length>1){
var pathData='';
for(var i=0;i<curvePts.length;i++){
var pt1=curvePts[i];
var pt2=i<curvePts.length-1?curvePts[i+1]:{x:mouseX,y:mouseY};
var x1=pt1.x;
var y1=pt1.y;
var x2=pt2.x;
var y2=pt2.y;
var dx=x2-x1;
var dy=y2-y1;
var dist=Math.sqrt(dx*dx+dy*dy);

if(dist<5)continue;

var segments=Math.max(20,Math.floor(dist/5));
var angle=Math.atan2(dy,dx)+Math.PI/2;

if(i===0){
pathData='M '+x1+' '+y1+' ';
}

for(var s=0;s<=segments;s++){
var t=s/segments;
var x=x1+dx*t;
var y=y1+dy*t;
var amplitude=4*Math.sin(t*Math.PI*12);
x+=Math.cos(angle)*amplitude;
y+=Math.sin(angle)*amplitude;
pathData+='L '+x+' '+y+' ';
}
}

var path=document.createElementNS('http://www.w3.org/2000/svg','path');
path.setAttribute('d',pathData);
path.setAttribute('stroke',curveColor);
path.setAttribute('stroke-width',curveWidth);
path.setAttribute('fill','none');
path.setAttribute('stroke-dasharray','5,5');
path.setAttribute('opacity','0.7');
ov.appendChild(path);
}
}

if(isDragging && dragObject){
var crossX,crossY;
if(dragType==='text'){
crossX=dragObject.x*ca.width;
crossY=dragObject.y*ca.height;
}else if(dragType==='line'){
crossX=(dragObject.start.x+dragObject.end.x)/2*ca.width;
crossY=(dragObject.start.y+dragObject.end.y)/2*ca.height;
}else if(dragType==='arrow'){
crossX=(dragObject.start.x+dragObject.end.x)/2*ca.width;
crossY=(dragObject.start.y+dragObject.end.y)/2*ca.height;
}else if(dragType==='curve'){
var sumX=0,sumY=0;
dragObject.points.forEach(function(pt){sumX+=pt.x*ca.width;sumY+=pt.y*ca.height;});
crossX=sumX/dragObject.points.length;
crossY=sumY/dragObject.points.length;
}
var l1=document.createElementNS('http://www.w3.org/2000/svg','line');
l1.setAttribute('x1',crossX-12);l1.setAttribute('y1',crossY-12);
l1.setAttribute('x2',crossX+12);l1.setAttribute('y2',crossY+12);
l1.setAttribute('stroke','#0078D4');l1.setAttribute('stroke-width','3');
ov.appendChild(l1);
var l2=document.createElementNS('http://www.w3.org/2000/svg','line');
l2.setAttribute('x1',crossX-12);l2.setAttribute('y1',crossY+12);
l2.setAttribute('x2',crossX+12);l2.setAttribute('y2',crossY-12);
l2.setAttribute('stroke','#0078D4');l2.setAttribute('stroke-width','3');
ov.appendChild(l2);
var cr=document.createElementNS('http://www.w3.org/2000/svg','circle');
cr.setAttribute('cx',crossX);cr.setAttribute('cy',crossY);cr.setAttribute('r','18');
cr.setAttribute('fill','none');cr.setAttribute('stroke','#0078D4');
cr.setAttribute('stroke-width','2');cr.setAttribute('opacity','0.5');
ov.appendChild(cr);
}

// Domerky - len v PREFABRIKÃCIA
if(activeTab==='prefab'){
dimensions.forEach(function(dim){
var dimX=dim.x*ca.width;
var dimY=dim.y*ca.height;
var tx=document.createElementNS('http://www.w3.org/2000/svg','text');
tx.setAttribute('x',dimX);
tx.setAttribute('y',dimY);
tx.setAttribute('fill', dim.color || '#FF0000'); // PouÅ¾ij vlastnÃº farbu alebo default ÄervenÃ¡
tx.setAttribute('font-size', dim.fontSize || 28);
tx.setAttribute('font-weight','bold');
tx.setAttribute('text-anchor','middle');
tx.setAttribute('dominant-baseline','middle');
tx.setAttribute('font-family','Arial');
if(dim.rotation){
tx.setAttribute('transform','rotate('+dim.rotation+' '+dimX+' '+dimY+')');
}
tx.textContent=dim.text;
ov.appendChild(tx);
});
} // End dimensions filter

// RÃ¡mÄek + rotation ikona pre vybranÃ½ domerok
if(selectedTextForRotation && selectedTextForRotation.type==='dimension'){
var dim=selectedTextForRotation.object;
var dimX=dim.x*ca.width;
var dimY=dim.y*ca.height;
var bbox={x:dimX-70,y:dimY-20,width:140,height:40};

var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
rect.setAttribute('x',bbox.x);
rect.setAttribute('y',bbox.y);
rect.setAttribute('width',bbox.width);
rect.setAttribute('height',bbox.height);
rect.setAttribute('fill','none');
rect.setAttribute('stroke','#0078D4');
rect.setAttribute('stroke-width','2');
rect.setAttribute('stroke-dasharray','5,5');
ov.appendChild(rect);

var iconX=bbox.x+bbox.width;
var iconY=bbox.y;
var icon=document.createElementNS('http://www.w3.org/2000/svg','circle');
icon.setAttribute('cx',iconX);
icon.setAttribute('cy',iconY);
icon.setAttribute('r','12');
icon.setAttribute('fill','#0078D4');
icon.setAttribute('stroke','white');
icon.setAttribute('stroke-width','2');
icon.setAttribute('data-rotation-handle','true');
ov.appendChild(icon);

var arrowPath=document.createElementNS('http://www.w3.org/2000/svg','path');
arrowPath.setAttribute('d','M '+(iconX-6)+' '+(iconY)+' A 6 6 0 1 1 '+(iconX)+' '+(iconY-6));
arrowPath.setAttribute('stroke','white');
arrowPath.setAttribute('stroke-width','2');
arrowPath.setAttribute('fill','none');
arrowPath.setAttribute('data-rotation-handle','true');
ov.appendChild(arrowPath);
}

if(pt){
var crossSize=1.6;
var l1=document.createElementNS('http://www.w3.org/2000/svg','line');
l1.setAttribute('x1',pt.x-crossSize);
l1.setAttribute('y1',pt.y-crossSize);
l1.setAttribute('x2',pt.x+crossSize);
l1.setAttribute('y2',pt.y+crossSize);
l1.setAttribute('stroke','#FF0000');
l1.setAttribute('stroke-width','2');
ov.appendChild(l1);

var l2=document.createElementNS('http://www.w3.org/2000/svg','line');
l2.setAttribute('x1',pt.x-crossSize);
l2.setAttribute('y1',pt.y+crossSize);
l2.setAttribute('x2',pt.x+crossSize);
l2.setAttribute('y2',pt.y-crossSize);
l2.setAttribute('stroke','#FF0000');
l2.setAttribute('stroke-width','2');
ov.appendChild(l2);
}
}

function up(){
var weldCountSpan=document.getElementById('weldCount');
if(weldCountSpan)weldCountSpan.textContent=ws.length;
if(ws.length>0){
document.getElementById('ex').disabled=false;
document.getElementById('cl').disabled=false;
}else{
document.getElementById('ex').disabled=true;
document.getElementById('cl').disabled=true;
}
}

function toggleEditMode(){
editMode=!editMode;
document.getElementById('editmode').style.background=editMode?'#ef4444':'#8b5cf6';
document.getElementById('editmode').textContent=editMode?'ğŸ”’ Edit zvary':'âœï¸ Edit zvary';
}

function toggleEditCrossesMode(){
editCrossesMode=!editCrossesMode;
document.getElementById('editcrossmode').style.background=editCrossesMode?'#ef4444':'#8b5cf6';
document.getElementById('editcrossmode').textContent=editCrossesMode?'ğŸ”’ Edit krÃ­Å¾iky':'âœï¸ Edit krÃ­Å¾iky';
}

var weldLogMaterials=[];
var weldAssignments={};
var currentPdfText='';

function parseMaterialsFromPDF(text){
console.log('=== SUPER PARSER V3 - START ===');
console.log('Text length:',text.length);
var lines=text.split('\n');
var allRows=[];
var currentSection='';
var currentCategory='';
var isInTable=false;
var rowBuffer=[];
for(var i=0;i<lines.length;i++){
var line=lines[i].trim();
if(line.length===0){
if(rowBuffer.length>0){
var item=processBufferSmart(rowBuffer,currentSection,currentCategory);
if(item)allRows.push(item);
rowBuffer=[];
}
continue;
}
if(line.match(/FABRICATION\s*MATERIALS/i)||line.match(/^FABRICATION$/i)){
console.log('>>> FABRICATION');
currentSection='FABRICATION';
isInTable=true;
allRows.push({type:'SECTION',section:'FABRICATION MATERIALS',ptNo:'',description:'',standard:'',dimensions:'',material:'',qty:'',weight:''});
continue;
}
if(line.match(/ERECTION\s*MATERIALS/i)||line.match(/^ERECTION$/i)){
console.log('>>> ERECTION');
if(rowBuffer.length>0){
var item=processBufferSmart(rowBuffer,currentSection,currentCategory);
if(item)allRows.push(item);
rowBuffer=[];
}
currentSection='ERECTION';
isInTable=true;
allRows.push({type:'SECTION',section:'ERECTION MATERIALS',ptNo:'',description:'',standard:'',dimensions:'',material:'',qty:'',weight:''});
continue;
}
if(line.match(/TOTAL\s*(FABRICATION\s*)?WEIGHT/i)&&!line.match(/FABRICATION\s*MATERIALS/i)){
console.log('>>> END TABLE');
if(rowBuffer.length>0){
var item=processBufferSmart(rowBuffer,currentSection,currentCategory);
if(item)allRows.push(item);
rowBuffer=[];
}
isInTable=false;
continue;
}
if(!isInTable)continue;
if(line.match(/PT\s*NO|PART\s*DESCRIPTION|^\s*NO\s+DESCRIPTION/i))continue;
var categoryMatch=line.match(/^(PIPE|FITTINGS|FLANGES|GASKETS|BOLTS|VALVES|INSTRUMENTS|SUPPORTS|VALVES\s*\/\s*IN-LINE\s*ITEMS|IN-LINE\s*ITEMS)/i);
if(categoryMatch){
console.log('>>> CATEGORY:',categoryMatch[1]);
if(rowBuffer.length>0){
var item=processBufferSmart(rowBuffer,currentSection,currentCategory);
if(item)allRows.push(item);
rowBuffer=[];
}
currentCategory=categoryMatch[1].trim().toUpperCase();
allRows.push({type:'CATEGORY',category:currentCategory,ptNo:'',description:'',standard:'',dimensions:'',material:'',qty:'',weight:''});
continue;
}
var ptMatch=line.match(/^\s*(\d{1,4})\s+(.+)$/);
if(ptMatch){
console.log('>>> PT#'+ptMatch[1]);
if(rowBuffer.length>0){
var item=processBufferSmart(rowBuffer,currentSection,currentCategory);
if(item)allRows.push(item);
rowBuffer=[];
}
rowBuffer.push({ptNo:ptMatch[1],text:ptMatch[2].trim()});
continue;
}
if(rowBuffer.length>0){
rowBuffer.push({ptNo:'',text:line});
}
}
if(rowBuffer.length>0){
var item=processBufferSmart(rowBuffer,currentSection,currentCategory);
if(item)allRows.push(item);
}
console.log('=== PARSED:',allRows.filter(r=>r.type==='ITEM').length,'items ===');
return allRows;
}
function processBufferSmart(buffer,section,category){
if(buffer.length===0)return null;
var ptNo=buffer[0].ptNo;
var fullText=buffer.map(b=>b.text).join(' ');
console.log('Parsing:',fullText);
var parsed=parseLineWithPatterns(fullText);
return{
type:parsed.description||category,
size:parsed.dimensions,
material:parsed.material,
section:section,
category:category,
ptNo:ptNo,
description:parsed.description,
standard:parsed.standard,
dimensions:parsed.dimensions,
qty:parsed.qty,
weight:parsed.weight
};
}
function parseLineWithPatterns(text){
var result={description:'',standard:'',dimensions:'',diameter:'',thickness:'',material:'',qty:'',weight:''};

// 1. WEIGHT (poslednÃ© ÄÃ­slo s desatinnÃ½mi miestami)
var weightMatch=text.match(/\s+(\d+\.\d{1,3})\s*$/);
if(weightMatch){
result.weight=weightMatch[1];
text=text.replace(weightMatch[0],'');
}

// 2. QUANTITY (poslednÃ© celÃ© ÄÃ­slo alebo ÄÃ­slo s "mm")
var qtyMatch=text.match(/\s+(\d+)\s*(mm)?\s*$/);
if(qtyMatch){
result.qty=qtyMatch[1];
if(qtyMatch[2]){
// Je to v mm (napr. PIPE mÃ¡ "16540 mm")
result.qty=qtyMatch[1]; // UloÅ¾Ã­ mm hodnotu
}
text=text.replace(qtyMatch[0],'');
}

// 3. STANDARD (EN, ISO, ASME, DIN, API, SS-EN, ANSI)
var standardMatch=text.match(/\b(EN\s*\d+[\-\.\d]*|ISO\s*\d+[\-\.\d]*|ASME\s*[\w\-\.]+|DIN\s*\d+[\-\.\d]*|API\s*[\w\-\.]+|SS-EN\s*[\w\-\.]+|ANSI\s*[\w\-\.]+)/i);
if(standardMatch){
result.standard=standardMatch[1];
text=text.replace(standardMatch[0],'');
}

// 4. DIMENSIONS (rozÅ¡Ã­renÃ½ regex pre lepÅ¡ie rozpoznanie)
// Podporuje: 88.9x2, 33.7x4, DN50, M16, 2"x3", SCH40
var dimMatch=text.match(/\b(DN\s*\d+(?:\s*PN\s*\d+)?|M\s*\d+|\d+\.?\d*\s*[xXÃ—]\s*\d+\.?\d*(?:\s*[xXÃ—]\s*\d+\.?\d*)?|\d+\/?\d*"(?:\s*[xXÃ—]\s*\d+\/?\d*")?|\d+"\s*SCH\s*\d+|SCH\s*\d+)/i);
if(dimMatch){
result.dimensions=dimMatch[1].trim();
text=text.replace(dimMatch[0],'');

// ROZDELENIE na DIAMETER + THICKNESS
// FormÃ¡ty: 88.9x2, 33.7x4, 168.3x5, atÄ.
var splitMatch=result.dimensions.match(/^(\d+\.?\d*)\s*[xXÃ—]\s*(\d+\.?\d*)$/);
if(splitMatch){
result.diameter=splitMatch[1];
result.thickness=splitMatch[2];
console.log('  â†’ Split:',result.diameter,'x',result.thickness);
}else{
// Nie je to pipe rozmer, nechaj dimensions ako je
result.diameter=result.dimensions;
result.thickness='';
}
}

// 5. MATERIAL (P235GH, 1.4432, S355, atÄ.)
var materialMatch=text.match(/\b([A-Z]?\d+\.?\d+[A-Z]*|P\d+[A-Z]+|S\d+[A-Z]*|[A-Z]{1,4}\d+[A-Z]*)\b(?:\s+[A-Z]+\s+\d+[\-\.\d]*(?:\s*,\s*\d+\.?\d+\s*mm)?)?/i);
if(materialMatch){
result.material=materialMatch[0].trim();
text=text.replace(materialMatch[0],'');
}

// 6. DESCRIPTION (zvyÅ¡ok textu)
result.description=text.trim().replace(/\s+/g,' ');
result.description=result.description.replace(/,\s*$/,'');
result.material=result.material.replace(/,\s*$/,'');

// VyÄistenie popisu od zvyÅ¡kov
result.description=result.description.replace(/\bmm\b/gi,'').trim();
result.description=result.description.replace(/\s{2,}/g,' ').trim();

console.log('  â†’ Desc:',result.description);
console.log('  â†’ Std:',result.standard);
console.log('  â†’ Dim:',result.dimensions);
console.log('  â†’ Diameter:',result.diameter);
console.log('  â†’ Thickness:',result.thickness);
console.log('  â†’ Mat:',result.material);
console.log('  â†’ Qty:',result.qty);
console.log('  â†’ Weight:',result.weight);

return result;
}

function openMTOForWeldLog(){
if(!currentPdfText){
alert('âŒ Å½iadny PDF text!\n\nPDF nemÃ¡ textovÃº vrstvu alebo je to obrÃ¡zok.');
return;
}
console.log('=== WELD LOG - Using MTO Parser ===');
var materials=parseMaterialsFromPDF(currentPdfText);
console.log('Parsed materials:',materials);
var items=[];
materials.forEach(function(m){
if(m.ptNo||m.description){
var cleanType=m.description||m.category||'Item';
cleanType=cleanType.replace(/\bmm\b/gi,'');
cleanType=cleanType.replace(/\d+\s*mm/gi,'');
cleanType=cleanType.replace(/\d+\.?\d*\s*[xX]\s*\d+\.?\d*/g,'');
cleanType=cleanType.replace(/\d+\.?\d*\s*-\s*\d+\.?\d*/g,'');
cleanType=cleanType.replace(/\s*(EN|ISO|DIN|ASME|API|ANSI|SS-EN)\s*\d+[\-\.\d]*/gi,'');
cleanType=cleanType.replace(/\s*P\d+[A-Z]+/gi,'');
cleanType=cleanType.replace(/\s*S\d+[A-Z]*/gi,'');
cleanType=cleanType.replace(/\s*\d+\.\d+[A-Z]*/gi,'');
cleanType=cleanType.replace(/\s*DN\s*\d+/gi,'');
cleanType=cleanType.replace(/\s*M\s*\d+/gi,'');
cleanType=cleanType.replace(/\s*SCH\s*\d+/gi,'');
cleanType=cleanType.replace(/\s*PN\s*\d+/gi,'');
cleanType=cleanType.replace(/\s*type\s*[A-Z0-9]+/gi,'');
cleanType=cleanType.replace(/\s*Table\s*[A-Z0-9\.]+/gi,'');
cleanType=cleanType.replace(/[,\.]+/g,' ');
cleanType=cleanType.replace(/\s+/g,' ');
cleanType=cleanType.trim();
if(cleanType.length>30)cleanType=cleanType.substring(0,30);
if(cleanType.length<2)cleanType=m.category||'Item';
items.push({
type:cleanType||'Item',
diameter:m.diameter||m.dimensions||'',
thickness:m.thickness||'',
material:m.material||'',
original:m
});
}
});
console.log('Filtered items:',items);
if(items.length===0){
alert('âŒ NenaÅ¡li sa Å¾iadne materiÃ¡ly!\n\nSkÃºste "âœï¸ UpraviÅ¥" a zadajte manuÃ¡lne.');
return;
}
var modal=document.createElement('div');
modal.id='mtoSelectModal';
modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px';
var content='<div style="background:white;border-radius:4px;padding:30px;max-width:1000px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">';
content+='<h2 style="margin:0 0 10px 0;color:#667eea;font-size:24px">ğŸ“‹ Vyber materiÃ¡ly pre Weld Log</h2>';
content+='<p style="color:#666;margin-bottom:20px;font-size:14px">ZaÄiarkni materiÃ¡ly ktorÃ© chceÅ¡ pouÅ¾iÅ¥ pri oznaÄovanÃ­ zvarov:</p>';
content+='<div style="margin-bottom:15px">';
content+='<button onclick="selectAllMTO(true)" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px">âœ… VybraÅ¥ vÅ¡etko</button>';
content+='<button onclick="selectAllMTO(false)" style="padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer">âŒ ZruÅ¡iÅ¥ vÃ½ber</button>';
content+='</div>';
content+='<div style="max-height:450px;overflow-y:auto;border:2px solid #e5e7eb;border-radius:3px;padding:10px;background:#f9fafb">';
items.forEach(function(m,idx){
var sizeDisplay=m.diameter?(m.thickness?m.diameter+'x'+m.thickness:m.diameter):'';
var displayText='<strong>'+m.type+'</strong> '+sizeDisplay+' - '+m.material;
content+='<div style="padding:12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:12px;background:white;margin-bottom:8px;border-radius:6px">';
content+='<input type="checkbox" id="mtochk_'+idx+'" class="mto-checkbox" checked style="width:20px;height:20px;cursor:pointer">';
content+='<label for="mtochk_'+idx+'" style="cursor:pointer;flex:1;font-size:14px">'+displayText+'</label>';
content+='</div>';
});
content+='</div>';
content+='<div style="display:flex;gap:12px;margin-top:20px">';
content+='<button onclick="applyMTOSelection()" style="flex:1;padding:16px;background:#10b981;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:700;font-size:16px">âœ… PouÅ¾iÅ¥ oznaÄenÃ©</button>';
content+='<button onclick="document.getElementById(\'mtoSelectModal\').remove()" style="padding:16px 32px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">ZruÅ¡iÅ¥</button>';
content+='</div>';
content+='</div>';
modal.innerHTML=content;
document.body.appendChild(modal);
window.tempMTOItems=items;
}

function addMaterialManually(){
var type=prompt('Typ komponenty (napr. Pipe, Elbow, Flange):','');
if(!type)return;
var diameter=prompt('Priemer (napr. 88.9, DN50):','');
if(!diameter)return;
var thickness=prompt('HrÃºbka (napr. 2, 4):','');
if(!thickness)return;
var material=prompt('MateriÃ¡l (napr. P235GH, 1.4432):','');
if(!material)return;

weldLogMaterials.push({
type:type.trim(),
diameter:diameter.trim(),
thickness:thickness.trim(),
material:material.trim()
});

var list=document.getElementById('materialsList');
var html='';
weldLogMaterials.forEach(function(m){
html+='<div class="material-item">'+m.type+' '+m.diameter+'x'+m.thickness+' - '+m.material+'</div>';
});
list.innerHTML=html;
loadWeldLog();
alert('âœ… MateriÃ¡l pridanÃ½!');
}

function selectAllMTO(checked){
var checkboxes=document.querySelectorAll('.mto-checkbox');
checkboxes.forEach(function(cb){cb.checked=checked;});
}

function applyMTOSelection(){
var items=window.tempMTOItems||[];
var selected=[];
items.forEach(function(m,idx){
var chk=document.getElementById('mtochk_'+idx);
if(chk&&chk.checked){
selected.push({
type:m.type,
diameter:m.diameter||'',
thickness:m.thickness||'',
material:m.material
});
}
});
if(selected.length===0){
alert('âŒ Nevybrali ste Å¾iadne materiÃ¡ly!');
return;
}
weldLogMaterials=selected;
var list=document.getElementById('materialsList');
var html='';
selected.forEach(function(m){
var sizeDisplay=m.diameter?(m.thickness?m.diameter+'x'+m.thickness:m.diameter):'';
html+='<div class="material-item">'+m.type+' '+sizeDisplay+' - '+m.material+'</div>';
});
list.innerHTML=html;
document.getElementById('mtoSelectModal').remove();
loadWeldLog();
alert('âœ… NaÄÃ­tanÃ©!\n\nMateriÃ¡lov: '+selected.length);
}

function toggleWeldLog(){
var panel=document.getElementById('weldLogPanel');
panel.classList.toggle('active');
if(panel.classList.contains('active')){
loadWeldLog();
}
}

function loadMaterialsFromPDF(){
if(!currentPdfText){
alert('âŒ Å½iadny PDF text!\n\nPDF nemÃ¡ textovÃº vrstvu alebo je to obrÃ¡zok.\nPouÅ¾ite "âœï¸ UpraviÅ¥" a zadajte materiÃ¡ly manuÃ¡lne.');
return;
}
var materials=parseMaterialsFromPDF(currentPdfText);
var debugMsg='DEBUG:\n\n';
if(materials.length>0){
materials.forEach(function(m,idx){
if(m.type&&m.type!=='SECTION'){
debugMsg+=(idx+1)+'. '+m.type+' '+m.size+' '+m.material+'\n';
}
});
}else{
debugMsg='NenaÅ¡lo niÄ!\n';
}
var itemCount=materials.filter(function(m){return m.type&&m.type!=='SECTION';}).length;
if(itemCount===0){
alert('âŒ NenaÅ¡li sa Å¾iadne materiÃ¡ly!\n\n'+debugMsg+'\n\nPouÅ¾ite "âœï¸ UpraviÅ¥" a zadajte manuÃ¡lne.');
return;
}
weldLogMaterials=materials;
var list=document.getElementById('materialsList');
var html='';
materials.forEach(function(m){
if(m.type&&m.type!=='SECTION'){
html+='<div class="material-item">'+m.type+' '+m.size+' - '+m.material+'</div>';
}
});
list.innerHTML=html;
loadWeldLog();
alert('âœ… NaÄÃ­tanÃ© z PDF!\n\nKomponentov: '+materials.length+'\n\n'+debugMsg+'\n\nSkontroluj Äi je vÅ¡etko sprÃ¡vne.');
}

function debugShowPdfText(){
if(!currentPdfText){
alert('âŒ Å½iadny text!\n\nPDF nemÃ¡ textovÃº vrstvu.');
return;
}
var preview=currentPdfText.substring(0,3000);
var modal=document.createElement('div');
modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px';
modal.innerHTML='<div style="background:white;border-radius:4px;padding:30px;max-width:800px;width:100%;max-height:80vh;overflow-y:auto"><h2 style="margin:0 0 20px 0">ğŸ” Text z PDF (prvÃ½ch 3000 znakov)</h2><textarea readonly style="width:100%;height:400px;font-family:monospace;font-size:11px;padding:10px;border:2px solid #ddd;border-radius:3px">'+preview+'</textarea><button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:12px 24px;background:#667eea;color:white;border:none;border-radius:3px;cursor:pointer;width:100%">ZavrieÅ¥</button></div>';
document.body.appendChild(modal);
modal.onclick=function(e){if(e.target===modal)modal.remove();};
}

function loadWeldLog(){
var materialsList=document.getElementById('materialsList');
var html='';
weldLogMaterials.forEach(function(m){
// SpÃ¤tnÃ¡ kompatibilita - ak existuje size, rozdeliÅ¥ na diameter + thickness
if(m.size && !m.diameter){
var parts=m.size.split('x');
m.diameter=parts[0]||'';
m.thickness=parts[1]||'';
}
html+='<div class="material-item">'+m.type+' '+m.diameter+'x'+m.thickness+' - '+m.material+'</div>';
});
materialsList.innerHTML=html;

var weldsList=document.getElementById('weldEntriesList');
var weldsHtml='';
ws.forEach(function(w){
var assignment=weldAssignments[w.id]||{from:'',to:''};
weldsHtml+='<div class="weld-entry">';
weldsHtml+='<div class="weld-entry-header">âš¡ Zvar #'+w.displayNum+'</div>';
weldsHtml+='<div class="weld-field">';
weldsHtml+='<label>From (ZaÄiatok)</label>';
weldsHtml+='<select id="weld_'+w.id+'_from" onchange="saveWeldAssignment(\''+w.id+'\',\'from\',this.value)" onclick="openFocusView(\''+w.id+'\')">';
weldsHtml+='<option value="">-- Vyber komponent --</option>';
var fromFound=false;
weldLogMaterials.forEach(function(m){
// SpÃ¤tnÃ¡ kompatibilita
if(m.size && !m.diameter){
var parts=m.size.split('x');
m.diameter=parts[0]||'';
m.thickness=parts[1]||'';
}
var optVal=m.type+' '+m.diameter+'x'+m.thickness+' '+m.material;
var selected=assignment.from===optVal?' selected':'';
if(selected)fromFound=true;
weldsHtml+='<option value="'+optVal+'"'+selected+'>'+m.type+' '+m.diameter+'x'+m.thickness+' - '+m.material+'</option>';
});
if(assignment.from&&!fromFound){
weldsHtml+='<option value="'+assignment.from+'" selected style="color:#ef4444">âš ï¸ '+assignment.from+' (uÅ¾ neexistuje)</option>';
}
weldsHtml+='</select>';
weldsHtml+='</div>';
weldsHtml+='<div class="weld-field">';
weldsHtml+='<label>To (Koniec)</label>';
weldsHtml+='<select id="weld_'+w.id+'_to" onchange="saveWeldAssignment(\''+w.id+'\',\'to\',this.value)" onclick="openFocusView(\''+w.id+'\')">';
weldsHtml+='<option value="">-- Vyber komponent --</option>';
var toFound=false;
weldLogMaterials.forEach(function(m){
// SpÃ¤tnÃ¡ kompatibilita
if(m.size && !m.diameter){
var parts=m.size.split('x');
m.diameter=parts[0]||'';
m.thickness=parts[1]||'';
}
var optVal=m.type+' '+m.diameter+'x'+m.thickness+' '+m.material;
var selected=assignment.to===optVal?' selected':'';
if(selected)toFound=true;
weldsHtml+='<option value="'+optVal+'"'+selected+'>'+m.type+' '+m.diameter+'x'+m.thickness+' - '+m.material+'</option>';
});
if(assignment.to&&!toFound){
weldsHtml+='<option value="'+assignment.to+'" selected style="color:#ef4444">âš ï¸ '+assignment.to+' (uÅ¾ neexistuje)</option>';
}
weldsHtml+='</select>';
weldsHtml+='</div>';
weldsHtml+='</div>';
});

if(ws.length===0){
weldsHtml='<p style="text-align:center;color:#999;padding:40px">ZatiaÄ¾ Å¾iadne zvary.<br>OznaÄ zvary na vÃ½krese!</p>';
}

weldsList.innerHTML=weldsHtml;
}

function saveWeldAssignment(weldId,field,value){
if(!weldAssignments[weldId])weldAssignments[weldId]={from:'',to:''};
weldAssignments[weldId][field]=value;

// AUTOMATICKÃ PRENOS DO WELDBOOK
updateWeldBookFromAssignment(weldId);
}

function updateWeldBookFromAssignment(weldId){
var weld=ws.find(function(w){return w.id===weldId;});
if(!weld)return;

var assignment=weldAssignments[weldId];
if(!assignment)return;

// NÃ¡jdi zvar v WeldBook
var splitName=splitIsometricName(originalFileName || 'Unknown');
var weldBookRow=null;
var weldBookIndex=-1;

for(var i=0;i<weldBookData.length;i++){
if(String(weldBookData[i].weldId)===String(weld.displayNum) && weldBookData[i].isometric===splitName.isometric){
weldBookRow=weldBookData[i];
weldBookIndex=i;
break;
}
}

// AUTO-CREATE: Ak zvar nie je v WeldBook, vytvor ho!
if(!weldBookRow){
console.log('â• Zvar',weld.displayNum,'nie je v WeldBook - vytvÃ¡ram novÃ½ zÃ¡znam');

// Vytvor novÃ½ riadok
weldBookRow = {
part: splitName.part,
isometric: splitName.isometric,
sheets: 1, // default
weldId: String(weld.displayNum),

// Item 1/2 - vyplnia sa niÅ¾Å¡ie
item1: '',
item2: '',

// VÅ¡etky ostatnÃ© stÄºpce prÃ¡zdne
ped: '', rev: '', pipeClass: '',
heatNr1: '', certNr1: '', dimension1: '', thickness1: '', material1: '', matGroup1: '',
heatNr2: '', certNr2: '', dimension2: '', thickness2: '', material2: '', matGroup2: '',
wps: '', wpqr: '', weldingMethod: '', jointType: '', weldingType: '', weldingGas: '',
heatNrWeld: '', certNrWeld: '', welderId: '', dateWelding: '',
vtPercent: '', vtDate: '', vtReport: '', vtResult: '',
ptPercent: '', ptDate: '', ptReport: '', ptResult: '',
rtPercent: '', rtDate: '', rtReport: '', rtResult: '',
pmpInch: '', andritzInch: '', pressureGroup: '', note: ''
};

// Pridaj do WeldBook
addWeldToWeldBook(weldBookRow);

console.log('âœ… Zvar',weld.displayNum,'pridanÃ½ do WeldBook');
}

// Parse FROM (item1)
if(assignment.from){
var fromParts=parseWeldLogAssignment(assignment.from);
weldBookRow.item1=fromParts.type;
weldBookRow.dimension1=fromParts.diameter;
weldBookRow.thickness1=fromParts.thickness;
weldBookRow.material1=fromParts.material;
}

// Parse TO (item2)
if(assignment.to){
var toParts=parseWeldLogAssignment(assignment.to);
weldBookRow.item2=toParts.type;
weldBookRow.dimension2=toParts.diameter;
weldBookRow.thickness2=toParts.thickness;
weldBookRow.material2=toParts.material;
}

// Aktualizuj grid
if(weldBookGrid && weldBookGrid.api){
weldBookGrid.api.refreshCells();
}

saveCurrentPartWeldBook();
console.log('âœ… WeldBook aktualizovanÃ½ pre zvar',weld.displayNum);
}

function parseWeldLogAssignment(assignmentString){
// Format: "Pipe EN 100 88.9x2 P235GH"
// Alebo: "Elbow 90 88.9x2 P235GH"
var result={type:'',diameter:'',thickness:'',material:''};

// RozdelÃ­ na Äasti
var parts=assignmentString.split(' ');

// PoslednÃ¡ ÄasÅ¥ je material (napr. P235GH)
if(parts.length>0){
result.material=parts[parts.length-1];
}

// PredposlednÃ¡ ÄasÅ¥ mÃ´Å¾e byÅ¥ rozmer (88.9x2)
if(parts.length>1){
var dimPart=parts[parts.length-2];
var dimMatch=dimPart.match(/^(\d+\.?\d*)[xXÃ—](\d+\.?\d*)$/);
if(dimMatch){
result.diameter=dimMatch[1];
result.thickness=dimMatch[2];
// ZvyÅ¡ok je type
result.type=parts.slice(0,parts.length-2).join(' ');
}else{
// Nie je to rozmer, je to ÄasÅ¥ typu
result.type=parts.slice(0,parts.length-1).join(' ');
}
}

return result;
}

function openFocusView(weldId){
var weld=ws.find(function(w){return w.id===weldId;});
if(!weld)return;
var focusView=document.getElementById('weldFocusView');
focusView.classList.add('active');
var zoomCanvas=document.getElementById('weldZoomCanvas');
var zoomCtx=zoomCanvas.getContext('2d');
var zoomFactor=3;
var viewSize=600;
zoomCanvas.width=viewSize;
zoomCanvas.height=viewSize;
var startX=weld.start.x*ca.width;
var startY=weld.start.y*ca.height;
var endX=weld.end.x*ca.width;
var endY=weld.end.y*ca.height;
var minX=Math.min(startX,endX);
var maxX=Math.max(startX,endX);
var minY=Math.min(startY,endY);
var maxY=Math.max(startY,endY);
var width=maxX-minX;
var height=maxY-minY;
var padding=Math.max(width,height)*0.5;
var centerX=(minX+maxX)/2;
var centerY=(minY+maxY)/2;
var halfWidth=(viewSize/(2*zoomFactor))+padding;
var halfHeight=(viewSize/(2*zoomFactor))+padding;
var sx=Math.max(0,centerX-halfWidth);
var sy=Math.max(0,centerY-halfHeight);
var sw=halfWidth*2;
var sh=halfHeight*2;
if(sx+sw>ca.width)sx=ca.width-sw;
if(sy+sh>ca.height)sy=ca.height-sh;
if(sx<0){sw+=sx;sx=0;}
if(sy<0){sh+=sy;sy=0;}
zoomCtx.clearRect(0,0,zoomCanvas.width,zoomCanvas.height);
zoomCtx.drawImage(ca,sx,sy,sw,sh,0,0,viewSize,viewSize);
zoomCtx.save();
var scaleX=viewSize/sw;
var scaleY=viewSize/sh;
zoomCtx.translate(-sx*scaleX,-sy*scaleY);
zoomCtx.scale(scaleX,scaleY);
zoomCtx.strokeStyle='#ef4444';
zoomCtx.lineWidth=3;
zoomCtx.beginPath();
zoomCtx.arc(weld.start.x*ca.width,weld.start.y*ca.height,20,0,Math.PI*2);
zoomCtx.stroke();
zoomCtx.fillStyle='rgba(239,68,68,0.2)';
zoomCtx.fill();
zoomCtx.beginPath();
zoomCtx.arc(weld.end.x*ca.width,weld.end.y*ca.height,25,0,Math.PI*2);
zoomCtx.stroke();
zoomCtx.fillStyle='#ef4444';
zoomCtx.font='bold 40px Arial';
zoomCtx.textAlign='center';
zoomCtx.textBaseline='middle';
zoomCtx.fillText(weld.displayNum,weld.end.x*ca.width,weld.end.y*ca.height);
zoomCtx.restore();
var materialsTable=document.getElementById('materialsTableContent');
var html='<div style="background:#f9fafb;padding:15px;border-radius:3px;border:2px solid #e5e7eb">';
html+='<table style="width:100%;border-collapse:collapse;font-size:13px">';
html+='<tr style="background:#667eea;color:white;font-weight:600"><th style="padding:8px;text-align:left">Type</th><th style="padding:8px;text-align:left">Size</th><th style="padding:8px;text-align:left">Material</th></tr>';
weldLogMaterials.forEach(function(m){
html+='<tr style="border-bottom:1px solid #e5e7eb"><td style="padding:8px">'+m.type+'</td><td style="padding:8px">'+m.size+'</td><td style="padding:8px">'+m.material+'</td></tr>';
});
html+='</table></div>';
materialsTable.innerHTML=html;
}

function closeFocusView(){
var focusView=document.getElementById('weldFocusView');
focusView.classList.remove('active');
}

var mtoFiles=[];
var mtoResults=[];
window.allMTOData=[];
var mtoWindow=document.getElementById('mtoWindow');
var mtoHeader=document.getElementById('mtoHeader');
var isDragging=false;
var currentX;
var currentY;
var initialX;
var initialY;
var xOffset=0;
var yOffset=0;

window.addEventListener('load',function(){
document.getElementById('mtobtn').disabled=false;document.getElementById('dimensionbtn').disabled=false;document.getElementById('prefab_linebtn').disabled=false;document.getElementById('prefab_textbtn').disabled=false;document.getElementById('prefab_arrowbtn').disabled=false;document.getElementById('prefab_doublearrowbtn').disabled=false;document.getElementById('prefab_curvebtn').disabled=false;document.getElementById('linebtn').disabled=false;document.getElementById('textbtn').disabled=false;document.getElementById('curvebtn').disabled=false;document.getElementById('arrowbtn').disabled=false;document.getElementById('doublearrowbtn').disabled=false;document.getElementById('undo').disabled=false;
});

mtoHeader.addEventListener('mousedown',function(e){
initialX=e.clientX-xOffset;
initialY=e.clientY-yOffset;
if(e.target===mtoHeader||e.target.tagName==='H3'||e.target.tagName==='SPAN'){
isDragging=true;
}
});

document.addEventListener('mousemove',function(e){
if(isDragging){
e.preventDefault();
currentX=e.clientX-initialX;
currentY=e.clientY-initialY;
xOffset=currentX;
yOffset=currentY;
setTranslate(currentX,currentY,mtoWindow);
}
});

document.addEventListener('mouseup',function(e){
initialX=currentX;
initialY=currentY;
isDragging=false;
});

function setTranslate(xPos,yPos,el){
el.style.transform='translate3d('+xPos+'px, '+yPos+'px, 0)';
}

function openMTO(){
// NOVÃ MTO Grid systÃ©m
openMTOGrid();

// StarÃ½ MTO (zatiaÄ¾ skrytÃ½, ale pouÅ¾ijeme parsing)
// mtoWindow.classList.add('active');
// mtoWindow.classList.remove('minimized');
// document.getElementById('mtoBody').classList.remove('hidden');
}

function closeMTO(){
mtoWindow.classList.remove('active');
resetMTO();
}

function minimizeMTO(){
mtoWindow.classList.toggle('minimized');
document.getElementById('mtoBody').classList.toggle('hidden');
var title=document.getElementById('mtoTitle');
if(mtoWindow.classList.contains('minimized')){
var processed=document.getElementById('mtoProcessed').textContent;
var total=document.getElementById('mtoTotal').textContent;
var percent=total>0?Math.round((processed/total)*100):0;
title.textContent='ğŸ“Š MTO ('+processed+'/'+total+') '+percent+'%';
}else{
title.textContent='ğŸ“Š Material Take-Off';
}
}

function resetMTO(){
mtoFiles=[];
mtoResults=[];
window.allMTOData=[];
document.getElementById('mtoFileList').innerHTML='';
document.getElementById('mtoSummary').style.display='none';
document.getElementById('mtoFooter').style.display='none';
}

document.getElementById('mtopdffiles').onchange=async function(e){
mtoFiles=Array.from(e.target.files);
mtoResults=[];
window.allMTOData=[];
if(mtoFiles.length===0)return;
document.getElementById('mtoFileList').innerHTML='';
document.getElementById('mtoSummary').style.display='block';
document.getElementById('mtoTotalFiles').textContent=mtoFiles.length;
document.getElementById('mtoTotal').textContent=mtoFiles.length;
document.getElementById('mtoProcessed').textContent='0';
for(var i=0;i<mtoFiles.length;i++){
var fileItem=document.createElement('div');
fileItem.className='mto-file-item';
fileItem.id='mtoFile'+i;
fileItem.innerHTML='<div class="mto-file-name">ğŸ“„ '+mtoFiles[i].name+'</div><div class="mto-progress-bar"><div class="mto-progress-fill" id="mtoProgress'+i+'" style="width:0%">0%</div></div>';
document.getElementById('mtoFileList').appendChild(fileItem);
}
await processMTOFiles();
};

async function processMTOFiles(){
for(var i=0;i<mtoFiles.length;i++){
var file=mtoFiles[i];
var progressBar=document.getElementById('mtoProgress'+i);
try{
progressBar.style.width='10%';
progressBar.textContent='10%';
var text=await extractPDFText(file);
progressBar.style.width='40%';
progressBar.textContent='40%';
var materials=parseMaterialsFromPDF(text);
progressBar.style.width='100%';
progressBar.textContent='100% ('+materials.length+' mat.)';
mtoResults.push({fileName:file.name,materials:materials});
window.allMTOData=mtoResults;
}catch(err){
progressBar.style.width='100%';
progressBar.style.background='#ef4444';
progressBar.textContent='Chyba: '+err.message;
console.error('MTO Error:',err);
}
document.getElementById('mtoProcessed').textContent=(i+1);
if(mtoWindow.classList.contains('minimized')){
var percent=Math.round(((i+1)/mtoFiles.length)*100);
document.getElementById('mtoTitle').textContent='ğŸ“Š MTO ('+(i+1)+'/'+mtoFiles.length+') '+percent+'%';
}
}
document.getElementById('mtoFooter').style.display='flex';
}

async function extractPDFText(file){
return new Promise(function(resolve,reject){
var reader=new FileReader();
reader.onload=function(){
var data=new Uint8Array(this.result);
pdfjsLib.getDocument(data).promise.then(function(pdf){
console.log('PDF mÃ¡',pdf.numPages,'strÃ¡n');
var promises=[];
for(var pageNum=1;pageNum<=pdf.numPages;pageNum++){
promises.push(
pdf.getPage(pageNum).then(function(page){
return page.getTextContent();
}).then(function(textContent){
var text='';
var lastY=null;
textContent.items.forEach(function(item){
if(lastY!==null&&item.transform&&item.transform[5]!==lastY){
text+='\n';
}
text+=item.str+' ';
if(item.transform)lastY=item.transform[5];
});
return text;
})
);
}
return Promise.all(promises);
}).then(function(pages){
var fullText=pages.join('\n\n');
console.log('Text extrahovanÃ½, dÄºÅ¾ka:',fullText.length);
resolve(fullText);
}).catch(reject);
};
reader.readAsArrayBuffer(file);
});
}

function downloadMTOExcel(){
try{
if(mtoResults.length===0){alert('âŒ Å½iadne dÃ¡ta!');return;}
if(typeof XLSX==='undefined'){alert('âŒ XLSX kniÅ¾nica chÃ½ba!');return;}
var wb=XLSX.utils.book_new();
var summaryData=[];
summaryData.push(['ğŸ“Š MTO SÃšHRN - VÅ ETKY MATERIÃLY']);
summaryData.push([]);
summaryData.push(['KategÃ³ria','PT NO','Popis','Å tandard','Rozmery','MateriÃ¡l','Celkom QTY','Izometrie']);
var materialMap={};
mtoResults.forEach(function(result){
var isoName=result.fileName.replace('.pdf','');
result.materials.forEach(function(row){
if(row.ptNo||row.description){
var key=row.category+'|'+row.description+'|'+row.dimensions+'|'+row.material;
if(!materialMap[key]){
materialMap[key]={category:row.category||'',ptNo:row.ptNo,description:row.description,standard:row.standard,dimensions:row.dimensions,material:row.material,totalQty:0,sources:[]};
}
var qty=parseInt(row.qty)||0;
materialMap[key].totalQty+=qty;
if(materialMap[key].sources.indexOf(isoName)===-1){
materialMap[key].sources.push(isoName);
}
}
});
});
var categories=['PIPE','FITTINGS','FLANGES','VALVES','BOLTS','GASKETS','SUPPORTS','INSTRUMENTS'];
var totalItems=0;
categories.forEach(function(cat){
var catItems=Object.keys(materialMap).filter(function(key){return materialMap[key].category===cat;});
if(catItems.length>0){
summaryData.push([cat,'','','','','','','']);
catItems.forEach(function(key){
var m=materialMap[key];
summaryData.push(['',m.ptNo,m.description,m.standard,m.dimensions,m.material,m.totalQty,m.sources.join(', ')]);
totalItems++;
});
}
});
summaryData.push([]);
summaryData.push(['','','','','','CELKOM:',totalItems,'']);
var summaryWs=XLSX.utils.aoa_to_sheet(summaryData);
summaryWs['!cols']=[{wch:15},{wch:8},{wch:35},{wch:15},{wch:15},{wch:25},{wch:12},{wch:50}];
XLSX.utils.book_append_sheet(wb,summaryWs,'SÃšMAR');
var indexData=[];
indexData.push(['ğŸ“‹ INDEX - Zoznam izometriÃ­']);
indexData.push([]);
indexData.push(['#','NÃ¡zov izometrie','Items','Link']);
var sheetNames=[];
mtoResults.forEach(function(result,idx){
var fullName=result.fileName.replace('.pdf','');
var shortName='ISO_'+(idx+1);
sheetNames.push(shortName);
var itemCount=result.materials.filter(function(m){return m.ptNo||m.description;}).length;
indexData.push([idx+1,fullName,itemCount,'â†’ '+shortName]);
});
var indexWs=XLSX.utils.aoa_to_sheet(indexData);
indexWs['!cols']=[{wch:5},{wch:50},{wch:10},{wch:20}];
for(var R=3;R<indexData.length;R++){
var cellAddr='D'+(R+1);
if(indexWs[cellAddr]){
indexWs[cellAddr].l={Target:"#'"+sheetNames[R-3]+"'!A1"};
}
}
XLSX.utils.book_append_sheet(wb,indexWs,'INDEX');
mtoResults.forEach(function(result,idx){
var sheetData=[];
var fullName=result.fileName.replace('.pdf','');
sheetData.push(['IZOMETRIA: '+fullName]);
sheetData.push([]);
sheetData.push(['PT NO','POPIS','Å TANDARD','ROZMERY','MATERIÃL','QTY','WEIGHT']);
result.materials.forEach(function(row){
if(row.type==='SECTION'){
sheetData.push([]);
sheetData.push([row.section,'','','','','','']);
}else if(row.type==='CATEGORY'){
sheetData.push([row.category,'','','','','','']);
}else if(row.ptNo||row.description){
sheetData.push([row.ptNo||'',row.description||'',row.standard||'',row.dimensions||'',row.material||'',row.qty||'',row.weight||'']);
}
});
var ws=XLSX.utils.aoa_to_sheet(sheetData);
ws['!cols']=[{wch:8},{wch:35},{wch:15},{wch:15},{wch:25},{wch:8},{wch:10}];
XLSX.utils.book_append_sheet(wb,ws,sheetNames[idx]);
});
XLSX.writeFile(wb,'MTO_Complete_'+new Date().toISOString().slice(0,10)+'.xlsx');
alert('âœ… Excel vytvorenÃ½!\n\n'+mtoResults.length+' izometriÃ­\n'+totalItems+' materiÃ¡lov v sÃºmare');
}catch(err){
alert('âŒ Chyba: '+err.message);
console.error(err);
}
}
function generateShortName(fullName,index){
var parts=fullName.split(/[_,\-]/);
var shortName='';
for(var i=0;i<parts.length&&shortName.length<20;i++){
if(parts[i].length>0){
shortName+=(shortName?'-':'')+parts[i];
}
}
if(shortName.length>25){
shortName=shortName.substring(0,25);
}
shortName=shortName.replace(/[\/\\\[\]\*\?:]/g,'_');
var finalName='ISO_'+(index+1)+'_'+shortName;
if(finalName.length>31){
finalName=finalName.substring(0,31);
}
return finalName;
}

function getCategoryFromType(type){
var t=type.toLowerCase();
if(t.includes('pipe')&&!t.includes('elbow')&&!t.includes('tee')&&!t.includes('branch'))return 'pipe';
if(t.includes('elbow')||t.includes('tee')||t.includes('reducer')||t.includes('cap')||t.includes('branch')||t.includes('stub')||t.includes('swage'))return 'fittings';
if(t.includes('flange'))return 'flanges';
if(t.includes('valve'))return 'valves';
if(t.includes('gasket'))return 'gaskets';
if(t.includes('bolt')||t.includes('nut')||t.includes('washer')||t.includes('stud'))return 'bolts';
if(t.includes('support')||t.includes('clamp')||t.includes('hanger')||t.includes('shoe')||t.includes('guide')||t.includes('anchor')||t.includes('spring'))return 'supports';
if(t.includes('instrument')||t.includes('gauge')||t.includes('transmitter')||t.includes('actuator'))return 'instruments';
return 'fittings';
}

function extractStandard(material){
if(material.includes('EN 10216'))return 'EN 10216-2';
if(material.includes('EN 10253'))return 'EN 10253-2';
if(material.includes('EN 1092'))return 'EN 1092-1';
if(material.includes('SS-EN'))return material.split(',')[0];
return '';
}

function editMaterials(){
var modal=document.createElement('div');
modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center';
modal.onclick=function(e){if(e.target===modal)modal.remove();};
var content=document.createElement('div');
content.style.cssText='background:white;border-radius:4px;padding:30px;max-width:1000px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);position:relative';
content.onclick=function(e){e.stopPropagation();};
content.innerHTML=`
<h2 style="margin:0 0 20px 0;color:#1f2937;font-size:22px">âœï¸ UpraviÅ¥ materiÃ¡ly</h2>
<div style="background:#f8fafc;padding:20px;border-radius:3px;margin-bottom:20px">
<h3 style="font-size:14px;font-weight:600;color:#4b5563;margin-bottom:15px">ğŸ“¦ AktuÃ¡lne komponenty</h3>
<div id="materialEditList"></div>
</div>
<div style="background:#f8fafc;padding:20px;border-radius:3px;margin-bottom:20px">
<h3 style="font-size:14px;font-weight:600;color:#4b5563;margin-bottom:12px">â• PridaÅ¥ novÃ½ komponent</h3>
<div style="display:grid;grid-template-columns:2fr 1.5fr 1fr 2fr 0.5fr;gap:10px;align-items:end">
<div>
<label style="display:block;font-size:12px;font-weight:600;color:#6b7280;margin-bottom:6px">TYP</label>
<select id="newMatType" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:3px;font-size:13px">
<option value="Pipe">Pipe</option>
<option value="Elbow">Elbow</option>
<option value="Tee">Tee</option>
<option value="Reducer">Reducer</option>
<option value="Flange">Flange</option>
<option value="Valve">Valve</option>
<option value="Cap">Cap</option>
<option value="Branch">Branch</option>
<option value="Nipple">Nipple</option>
<option value="Union">Union</option>
<option value="Socket">Socket</option>
</select>
</div>
<div>
<label style="display:block;font-size:12px;font-weight:600;color:#6b7280;margin-bottom:6px">PRIEMER</label>
<input type="text" id="newMatDiameter" placeholder="88.9" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:3px;font-size:13px">
</div>
<div>
<label style="display:block;font-size:12px;font-weight:600;color:#6b7280;margin-bottom:6px">HRÃšBKA</label>
<input type="text" id="newMatThickness" placeholder="2" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:3px;font-size:13px">
</div>
<div>
<label style="display:block;font-size:12px;font-weight:600;color:#6b7280;margin-bottom:6px">MATERIÃL</label>
<input type="text" id="newMatMaterial" placeholder="P235GH" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:3px;font-size:13px">
</div>
<button onclick="addNewMaterial()" style="padding:10px 16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:3px;font-weight:600;cursor:pointer;font-size:13px">â•</button>
</div>
</div>
<div style="display:flex;gap:10px">
<button onclick="saveMaterials()" style="flex:1;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:3px;font-weight:600;cursor:pointer">ğŸ’¾ UloÅ¾iÅ¥</button>
</div>
`;
content.className='modal-container';
modal.appendChild(content);
document.body.appendChild(modal);
updateMaterialEditList();
}

function updateMaterialEditList(){
var list=document.getElementById('materialEditList');
if(!list)return;
var html='';
weldLogMaterials.forEach(function(m,idx){
// SpÃ¤tnÃ¡ kompatibilita - rozdelenie size na diameter + thickness
if(m.size && !m.diameter){
var parts=m.size.split('x');
m.diameter=parts[0]||'';
m.thickness=parts[1]||'';
}
html+=`<div style="display:grid;grid-template-columns:2fr 1.5fr 1fr 2fr 0.5fr;gap:10px;margin-bottom:10px;align-items:center">
<input type="text" value="${m.type||''}" onchange="weldLogMaterials[${idx}].type=this.value" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px" placeholder="Pipe">
<input type="text" value="${m.diameter||''}" onchange="weldLogMaterials[${idx}].diameter=this.value" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px" placeholder="88.9">
<input type="text" value="${m.thickness||''}" onchange="weldLogMaterials[${idx}].thickness=this.value" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px" placeholder="2">
<input type="text" value="${m.material||''}" onchange="weldLogMaterials[${idx}].material=this.value" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px" placeholder="P235GH">
<button onclick="removeMaterial(${idx})" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer">ğŸ—‘ï¸</button>
</div>`;
});
if(weldLogMaterials.length===0){
html='<p style="text-align:center;color:#999;padding:20px">Å½iadne komponenty</p>';
}
list.innerHTML=html;
}

function addNewMaterial(){
var type=document.getElementById('newMatType').value;
var diameter=document.getElementById('newMatDiameter').value.trim();
var thickness=document.getElementById('newMatThickness').value.trim();
var material=document.getElementById('newMatMaterial').value.trim();
if(!diameter||!material){
alert('VyplÅˆ priemer a materiÃ¡l!');
return;
}
weldLogMaterials.push({type:type,diameter:diameter,thickness:thickness,material:material});
document.getElementById('newMatDiameter').value='';
document.getElementById('newMatThickness').value='';
document.getElementById('newMatMaterial').value='';
updateMaterialEditList();
}

function removeMaterial(idx){
if(confirm('ZmazaÅ¥ tento komponent?')){
weldLogMaterials.splice(idx,1);
updateMaterialEditList();
}
}

function saveMaterials(){
var modals=document.querySelectorAll('div[style*="position:fixed"][style*="z-index:2000"]');
modals.forEach(function(m){m.remove();});
var panel=document.getElementById('weldLogPanel');
if(panel&&panel.classList.contains('active')){
loadWeldLog();
}
alert('âœ… MateriÃ¡ly uloÅ¾enÃ©!\n\nKomponentov: '+weldLogMaterials.length);
}


function undo(){
// ZruÅ¡ doÄasnÃ© body
if(pt){
pt=null;
dw();
console.log('â†©ï¸ Undo - zruÅ¡enÃ½ doÄasnÃ½ bod');
return;
}
if(linePt){
linePt=null;
dw();
console.log('â†©ï¸ Undo - zruÅ¡enÃ¡ doÄasnÃ¡ paliÄka');
return;
}
if(arrowPt){
arrowPt=null;
dw();
console.log('â†©ï¸ Undo - zruÅ¡enÃ¡ doÄasnÃ¡ Å¡Ã­pka');
return;
}
if(crossPt){
crossPt=null;
dw();
console.log('â†©ï¸ Undo - zruÅ¡enÃ½ doÄasnÃ½ krÃ­Å¾ik');
return;
}
if(curvePts.length>0){
curvePts=[];
dw();
console.log('â†©ï¸ Undo - zruÅ¡enÃ½ doÄasnÃ½ oblÃºÄik');
return;
}

// HOTOVÃ‰ OBJEKTY SA NEMAÅ½Ãš - LEN MANUÃLNE CEZ EDITÃCIU
console.log('âš ï¸ Undo: HotovÃ© objekty sa maÅ¾Ãº len manuÃ¡lne v editaÄnom mÃ³de');
alert('âš ï¸ Undo funguje len pre nedokonÄenÃ© veci.\n\nHotovÃ© zvary, texty, Å¡Ã­pky sa maÅ¾Ãº manuÃ¡lne:\n1. Click na objekt\n2. Delete key');
}

function zi(){
sc+=0.2;
if(pd)rp();
else if(loadedImage)redrawImageWithZoom();
else dw();
updateZoomDisplay();
}

function zo(){
if(sc>0.1){
sc-=0.2;
if(pd)rp();
else if(loadedImage)redrawImageWithZoom();
else dw();
updateZoomDisplay();
}
}

function zr(){
sc=1.0;
if(pd)rp();
else if(loadedImage)redrawImageWithZoom();
else dw();
updateZoomDisplay();
}

// Funkcia na zoom PNG obrÃ¡zkov z kniÅ¾nice
function redrawImageWithZoom(){
if(!loadedImage)return;
var newWidth=baseImageWidth*sc;
var newHeight=baseImageHeight*sc;
ca.width=newWidth;
ca.height=newHeight;
ov.setAttribute('width',newWidth);
ov.setAttribute('height',newHeight);
ct.clearRect(0,0,newWidth,newHeight);
ct.imageSmoothingEnabled=false;
ct.drawImage(loadedImage,0,0,newWidth,newHeight);
dw();
updateZoomDisplay();
}

// ============= SPOOL LIST SYSTEM =============
function showSpoolList(){
document.getElementById('spoolListModal').style.display='block';
buildSpoolListTable();
console.log('ğŸ“‹ OtvÃ¡ram zoznam spoolov');
}

function closeSpoolList(){
document.getElementById('spoolListModal').style.display='none';
document.getElementById('spoolSearchInput').value='';
}

function buildSpoolListTable(){
var tbody=document.getElementById('spoolListBody');
tbody.innerHTML='';

// ZoskupiÅ¥ spooly podÄ¾a izometrie
var spoolsByIso={};
spools.forEach(function(spool){
var isoName=originalFileName || projectsData.currentPart || 'NeznÃ¡ma izometria';
if(!spoolsByIso[isoName]){
spoolsByIso[isoName]=[];
}
spoolsByIso[isoName].push(spool);
});

// PomocnÃ¡ funkcia - zÃ­skaj zvary pre spool (BOÄŒNÃ PANEL LOGIKA)
function getSpoolWelds(spool){
// NÃ¡jdi vÅ¡etky krÃ­Å¾iky a ich pozÃ­cie v zozname zvarov
var allWelds=[];
for(var i=0;i<ws.length;i++){
allWelds.push({num:ws[i].displayNum,id:ws[i].id,weld:ws[i]});
}
allWelds.sort(function(a,b){
return naturalSort(a.num,b.num);
});

// NÃ¡jdi hranice (krÃ­Å¾iky)
var boundaries=[];
for(var i=0;i<crosses.length;i++){
var cross=crosses[i];
for(var j=0;j<allWelds.length;j++){
if(allWelds[j].id===cross.weldId){
boundaries.push({num:allWelds[j].num,index:j});
break;
}
}
}
boundaries.sort(function(a,b){
return naturalSort(a.num,b.num);
});

console.log('ğŸ” Spool',spool.displayNum,'- krÃ­Å¾iky:',boundaries.map(function(b){return b.num;}));

// NÃ¡jdi ktorÃ© zvary patria MEDZI krÃ­Å¾iky pre tento spool
// PredpokladÃ¡me Å¾e spool mÃ¡ poradie podÄ¾a spoolNum
var spoolIndex=parseInt(spool.displayNum.replace('SP',''))-1;

if(boundaries.length===0){
// Å½iadne krÃ­Å¾iky = vÅ¡etky zvary patria jednÃ©mu spoolu
console.log('âš ï¸ Å½iadne krÃ­Å¾iky - beriem vÅ¡etky zvary');
return allWelds.map(function(w){return w.weld;});
}

var startBoundaryIndex=(spoolIndex>0)?boundaries[spoolIndex-1].index+1:0;
var endBoundaryIndex=(spoolIndex<boundaries.length)?boundaries[spoolIndex].index:allWelds.length-1;

console.log('ğŸ“Š Spool',spool.displayNum,'- zvary od indexu',startBoundaryIndex,'po',endBoundaryIndex);

var result=[];
for(var i=startBoundaryIndex;i<=endBoundaryIndex;i++){
if(i<allWelds.length && allWelds[i]){
result.push(allWelds[i].weld);
}
}

console.log('âœ… Spool',spool.displayNum,'- naÅ¡iel',result.length,'zvarov:',result.map(function(w){return w.displayNum;}));
return result;
}

// STROMOVÃ Å TRUKTÃšRA
for(var isoName in spoolsByIso){
var isoSpools=spoolsByIso[isoName];
var isRouteExpanded=kontrolaData.expandedRoutes[isoName];

// RIADOK TRASY (ROUTE)
var trRoute=document.createElement('tr');
trRoute.className='route-row';
trRoute.style.background='#e8f4f8';
trRoute.style.fontWeight='bold';
trRoute.style.cursor='pointer';
trRoute.onclick=function(iso){
return function(){
kontrolaData.expandedRoutes[iso]=!kontrolaData.expandedRoutes[iso];
saveKontrolaData();
buildSpoolListTable();
};
}(isoName);

var icon=isRouteExpanded?'â–¼':'â–¶';
trRoute.innerHTML='<td colspan="4" style="padding:12px;border:1px solid #0078D4;color:#0078D4">'+
icon+' <strong>'+isoName+'</strong> ('+isoSpools.length+' spoolov)</td>';
tbody.appendChild(trRoute);

// Ak je route rozbalenÃ¡, zobraz spooly
if(isRouteExpanded){
isoSpools.forEach(function(spool){
var isSpoolExpanded=kontrolaData.expandedSpools[spool.id];
var spoolWelds=getSpoolWelds(spool);

// RIADOK SPOOLU
var trSpool=document.createElement('tr');
trSpool.className='spool-row';
trSpool.style.background='#f0f9ff';
trSpool.style.cursor='pointer';

var spoolIcon=isSpoolExpanded?'â–¼':'â–¶';
var completedCount=spoolWelds.filter(function(w){
return kontrolaData.completedWelds[spool.id+'_'+w.displayNum];
}).length;

var html='<td colspan="4" style="padding:10px 10px 10px 30px;border:1px solid #ddd">';
html+='<span onclick="event.stopPropagation();kontrolaData.expandedSpools[\''+spool.id+'\']=!kontrolaData.expandedSpools[\''+spool.id+'\'];saveKontrolaData();buildSpoolListTable();" style="cursor:pointer">'+spoolIcon+'</span> ';
html+='<strong>'+spool.displayNum+'</strong> ';
html+='<span style="color:#666;font-size:11px">('+completedCount+'/'+spoolWelds.length+' hotovo)</span> ';
html+='<button onclick="event.stopPropagation();setWelderForSpool(\''+spool.id+'\')" style="margin-left:10px;background:#10b981;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px">ğŸ‘· ZvaraÄ</button> ';
html+='<button onclick="event.stopPropagation();setDateForSpool(\''+spool.id+'\')" style="background:#f59e0b;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px">ğŸ“… DÃ¡tum</button> ';
html+='<button onclick="event.stopPropagation();addWeldToSpool(\''+spool.id+'\')" style="background:#0078D4;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px">â• PridaÅ¥ zvar</button> ';
html+='<button onclick="event.stopPropagation();openQRScanner(\''+spool.id+'\')" style="background:#8b5cf6;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px">ğŸ“· QR kÃ³d</button>';

if(kontrolaData.welderData[spool.id]){
html+='<span style="margin-left:10px;font-size:11px;color:#666">ğŸ‘· '+kontrolaData.welderData[spool.id]+'</span>';
}
if(kontrolaData.dateData[spool.id]){
html+='<span style="margin-left:10px;font-size:11px;color:#666">ğŸ“… '+kontrolaData.dateData[spool.id]+'</span>';
}
if(spool.qrCode){
html+='<span style="margin-left:10px;font-size:11px;color:#8b5cf6;font-weight:600">ğŸ“± QR: '+spool.qrCode+'</span>';
}

html+='</td>';
trSpool.innerHTML=html;
tbody.appendChild(trSpool);

// Ak je spool rozbalenÃ½, zobraz zvary
if(isSpoolExpanded){
console.log('ğŸ” Zobrazujem zvary pre spool',spool.displayNum,': ',spoolWelds.length,'zvarov');
spoolWelds.forEach(function(weld){
var weldKey=spool.id+'_'+weld.displayNum;
var isCompleted=kontrolaData.completedWelds[weldKey];

var trWeld=document.createElement('tr');
trWeld.className='weld-row';
trWeld.style.background='#fff';

var checkIcon=isCompleted?'â˜‘':'â˜';
var checkColor=isCompleted?'#10b981':'#999';

// ZÃ­skaj zvaraÄa a dÃ¡tum pre tento zvar
// OPRAVA: PouÅ¾Ã­vame spool.displayNum (napr. "SP1") namiesto spool.id (timestamp)
var welderKey=spool.displayNum+'_'+weld.displayNum+'_welder';
var dateKey=spool.displayNum+'_'+weld.displayNum+'_date';
var currentWelder=kontrolaData.welderData[welderKey]||'';
var currentDate=kontrolaData.dateData[dateKey]||(new Date().toISOString().split('T')[0]);

var html='<td colspan="4" style="padding:8px 8px 8px 60px;border:1px solid #ddd">';
html+='<span onclick="toggleWeldComplete(\''+weldKey+'\')" style="cursor:pointer;font-size:16px;color:'+checkColor+'">'+checkIcon+'</span> ';
html+='<span style="margin-left:10px;'+(isCompleted?'text-decoration:line-through;color:#999':'')+';font-weight:600">Zvar #'+weld.displayNum+'</span> ';
html+='<input type="text" placeholder="ÄŒÃ­slo zvaraÄa" value="'+currentWelder+'" oninput="setWelderForWeld(\''+welderKey+'\',this.value)" onblur="setWelderForWeld(\''+welderKey+'\',this.value)" style="width:100px;margin-left:10px;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:11px"> ';
html+='<input type="date" value="'+currentDate+'" onchange="setDateForWeld(\''+dateKey+'\',this.value)" onblur="setDateForWeld(\''+dateKey+'\',this.value)" style="margin-left:5px;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:11px"> ';
html+='<button onclick="event.stopPropagation();removeWeldFromSpool(\''+weld.id+'\',\''+weld.displayNum+'\')" style="margin-left:10px;background:#ef4444;color:white;border:none;padding:3px 8px;border-radius:3px;cursor:pointer;font-size:10px">ğŸ—‘ï¸</button>';
html+='</td>';

trWeld.innerHTML=html;

tbody.appendChild(trWeld);
});
}
});
}
}

if(tbody.children.length===0){
tbody.innerHTML='<tr><td colspan="4" style="padding:20px;text-align:center;color:#999">Å½iadne spooly</td></tr>';
}

console.log('ğŸ“Š Kontrola tabulka vytvorenÃ¡');
}

function naturalSort(a,b){
// Konverzia na string
a=String(a);
b=String(b);
var ax=[],bx=[];
a.replace(/(\d+)|(\D+)/g,function(_,$1,$2){ax.push([$1||Infinity,$2||""]);});
b.replace(/(\d+)|(\D+)/g,function(_,$1,$2){bx.push([$1||Infinity,$2||""]);});
while(ax.length&&bx.length){
var an=ax.shift();
var bn=bx.shift();
var nn=(an[0]-bn[0])||an[1].localeCompare(bn[1]);
if(nn)return nn;
}
return ax.length-bx.length;
}

function toggleWeldComplete(weldKey){
kontrolaData.completedWelds[weldKey]=!kontrolaData.completedWelds[weldKey];
saveKontrolaData();

// AUTO-PREPOJENIE S VÃROBA
if(kontrolaData.completedWelds[weldKey]){
// Zvar bol oznaÄenÃ½ ako hotovÃ½
var isoName=originalFileName || projectsData.currentPart;
if(isoName){
// Auto-vytvor zÃ¡znam vo VÃROBA ak neexistuje
if(!vyrobaData[isoName]){
vyrobaData[isoName]={
started:false,
completed:false,
startedDate:'',
completedDate:''
};
}
// Automaticky oznaÄ "ZaÄatÃ¡ predvÃ½roba" vo VÃROBA
if(!vyrobaData[isoName].started){
vyrobaData[isoName].started=true;
vyrobaData[isoName].startedDate=new Date().toISOString().split('T')[0];
saveVyrobaData();
console.log('ğŸ”— AUTO: ZaÄatÃ¡ predvÃ½roba pre',isoName);
}
}
}

buildSpoolListTable();
console.log('âœ“ Zvar',weldKey,kontrolaData.completedWelds[weldKey]?'hotovÃ½':'nehotovÃ½');
}

function setWelderForSpool(spoolId){
var currentWelder=kontrolaData.welderData[spoolId]||'';
var welder=prompt('Zadajte meno zvaraÄa:',currentWelder);
if(welder!==null){
kontrolaData.welderData[spoolId]=welder.trim();
saveKontrolaData();
buildSpoolListTable();
}
}

function setDateForSpool(spoolId){
var currentDate=kontrolaData.dateData[spoolId]||'';
var date=prompt('Zadajte dÃ¡tum (RRRR-MM-DD):',currentDate);
if(date!==null){
kontrolaData.dateData[spoolId]=date.trim();
saveKontrolaData();
buildSpoolListTable();
}
}

function addWeldToSpool(spoolId){
var weldNum=prompt('Zadajte ÄÃ­slo novÃ©ho zvaru (napr: 5a, 10b):','');
if(weldNum===null || weldNum.trim()==='')return;

weldNum=weldNum.trim();

// NÃ¡jdi spool
var spool=spools.find(function(s){return s.id===spoolId;});
if(!spool){
alert('Spool nenÃ¡jdenÃ½!');
return;
}


// NEKRESLÃME zvar vo vÃ½krese - iba evidencia!
// Zvar sa musÃ­ nakresliÅ¥ ruÄne v RED PEN

// Pridaj do WeldBook s inteligentnÃ½m radenÃ­m
// OPRAVA: PouÅ¾Ã­vame originalFileName (nÃ¡zov PDF) namiesto projectsData.currentPart
var splitName=splitIsometricName(originalFileName || 'Unknown');
console.log('ğŸ“ addWeldToSpool - originalFileName:', originalFileName, 'â†’ part:', splitName.part, ', iso:', splitName.isometric);
addWeldToWeldBook({
part: splitName.part,
isometric: splitName.isometric,
sheets:1,
weldId:weldNum,
item1:'',item2:'',ped:'',rev:'',pipeClass:'',
heatNr1:'',certNr1:'',dimension1:'',thickness1:'',material1:'',matGroup1:'',
heatNr2:'',certNr2:'',dimension2:'',thickness2:'',material2:'',matGroup2:'',
wps:'',wpqr:'',weldingMethod:'',jointType:'',weldingType:'',weldingGas:'',
heatNrWeld:'',certNrWeld:'',welderId:'',dateWelding:'',
vtPercent:'',vtDate:'',vtReport:'',vtResult:'',
ptPercent:'',ptDate:'',ptReport:'',ptResult:'',
rtPercent:'',rtDate:'',rtReport:'',rtResult:'',
pmpInch:'',andritzInch:'',pressureGroup:'',note:''
});

// dw() - NETREBA, lebo sa niÄ nekreslÃ­
saveKontrolaData();
buildSpoolListTable();

// NOTIFIKÃCIA
var isoName=originalFileName||projectsData.currentPart||'NeznÃ¡ma izometria';
addNotification('PridanÃ½ zvar #'+weldNum+' k izometrii: '+isoName+' - treba nakresliÅ¥ v RED PEN!');

console.log('âœ¨ Zvar',weldNum,'pridanÃ½ do WeldBook (nie do vÃ½kresu)');
}

function removeWeldFromSpool(weldId,weldNum){
if(!confirm('OdstrÃ¡niÅ¥ zvar #'+weldNum+'?'))return;

// OdstrÃ¡Åˆ zo ws array
ws=ws.filter(function(w){return w.id!==weldId;});

// OdstrÃ¡Åˆ z WeldBook
removeWeldFromWeldBook(weldNum);

// OdstrÃ¡Åˆ z kontrola data
for(var key in kontrolaData.completedWelds){
if(key.indexOf('_'+weldNum)>-1){
delete kontrolaData.completedWelds[key];
}
}
for(var key in kontrolaData.welderData){
if(key.indexOf('_'+weldNum)>-1){
delete kontrolaData.welderData[key];
}
}
for(var key in kontrolaData.dateData){
if(key.indexOf('_'+weldNum)>-1){
delete kontrolaData.dateData[key];
}
}

dw();
up();
saveKontrolaData();
buildSpoolListTable();
console.log('ğŸ—‘ï¸ Zvar',weldNum,'odstrÃ¡nenÃ½');
}

function setWelderForWeld(welderKey,value){
kontrolaData.welderData[welderKey]=value;
saveKontrolaData();
console.log('ğŸ‘· ZvaraÄ nastavenÃ½:',welderKey,'=',value);

// AUTOMATICKY nastav aj dneÅ¡nÃ½ dÃ¡tum ak eÅ¡te nie je nastavenÃ½
var dateKey = welderKey.replace('_welder', '_date');
if(!kontrolaData.dateData[dateKey]){
var todayDate = new Date().toISOString().split('T')[0];
kontrolaData.dateData[dateKey] = todayDate;
console.log('ğŸ“… Automaticky nastavenÃ½ dÃ¡tum:', dateKey, '=', todayDate);
saveKontrolaData();
}

// Aktualizuj WeldBook
// welderKey mÃ¡ formÃ¡t "SP1_1_welder" alebo "SP1_5A_welder"
// Potrebujeme extrahovaÅ¥ ÄÃ­slo zvaru (1, 5A, atÄ)
var parts = welderKey.split('_');
var weldNum = parts.length >= 3 ? parts[1] : null; // DruhÃ¡ ÄasÅ¥ je ÄÃ­slo zvaru

console.log('ğŸ” HÄ¾adÃ¡m zvar v WeldBook:', weldNum);

if(weldNum){
var updated = false;
for(var i=0; i<weldBookData.length; i++){
if(String(weldBookData[i].weldId) === String(weldNum)){
weldBookData[i].welderId = value;
// Nastav aj dÃ¡tum v WeldBook
if(kontrolaData.dateData[dateKey]){
weldBookData[i].dateWelding = kontrolaData.dateData[dateKey];
}
console.log('âœ… WeldBook aktualizovanÃ½: weldId='+weldNum+', welderId='+value+', dateWelding='+weldBookData[i].dateWelding);
updated = true;
// Refresh WeldBook grid ak je otvorenÃ½
if(weldBookGrid && weldBookGrid.api){
weldBookGrid.api.setGridOption('rowData', weldBookData);
}
saveCurrentPartWeldBook();
break;
}
}
if(!updated){
console.log('âš ï¸ Zvar '+weldNum+' nenÃ¡jdenÃ½ v WeldBook');
}
}

// Refresh UI v Kontrole spoolov aby sa zobrazil aj dÃ¡tum
buildSpoolListTable();
}

function setDateForWeld(dateKey,value){
kontrolaData.dateData[dateKey]=value;
saveKontrolaData();
console.log('ğŸ“… DÃ¡tum nastavenÃ½:',dateKey,'=',value);

// Aktualizuj WeldBook
// dateKey mÃ¡ formÃ¡t "SP1_1_date" alebo "SP1_5A_date"
// Potrebujeme extrahovaÅ¥ ÄÃ­slo zvaru (1, 5A, atÄ)
var parts = dateKey.split('_');
var weldNum = parts.length >= 3 ? parts[1] : null; // DruhÃ¡ ÄasÅ¥ je ÄÃ­slo zvaru

console.log('ğŸ” HÄ¾adÃ¡m zvar v WeldBook:', weldNum);

if(weldNum){
var updated = false;
for(var i=0; i<weldBookData.length; i++){
if(String(weldBookData[i].weldId) === String(weldNum)){
weldBookData[i].dateWelding = value;
console.log('âœ… WeldBook aktualizovanÃ½: weldId='+weldNum+', dateWelding='+value);
updated = true;
// Refresh WeldBook grid ak je otvorenÃ½
if(weldBookGrid && weldBookGrid.api){
weldBookGrid.api.setGridOption('rowData', weldBookData);
}
saveCurrentPartWeldBook();
break;
}
}
if(!updated){
console.log('âš ï¸ Zvar '+weldNum+' nenÃ¡jdenÃ½ v WeldBook');
}
}
}

// ============= VÃROBA SYSTÃ‰M =============
var vyrobaData={};

// ============= MONTÃÅ½ FILTER SYSTÃ‰M =============
var displayFilter={
  enabled:false,
  showPrefab:true,
  showSite:true,
  showNew:true
};

function updateDisplayFilter(){
displayFilter.showPrefab=document.getElementById('filterShowPrefab').checked;
displayFilter.showSite=document.getElementById('filterShowSite').checked;
displayFilter.showNew=document.getElementById('filterShowNew').checked;
dw();
console.log('ğŸ” Filter aktualizovanÃ½:',displayFilter);
}

// ============= MTO SYSTÃ‰M - MATERIAL TAKE-OFF =============
var mtoData={
  materials:[], // CelkovÃ½ MTO pre projekt
  isometricMaterials:{}, // MTO per izometria
  deliveryNotes:[], // HistÃ³ria dodacÃ­ch listov
  stock:[] // Sklad (Heat numbers)
};

// MTO Material Row structure:
// {
//   id: 'mat_123',
//   item: 'ELBOW 90',
//   description: '90Â° koleno',
//   size: '2"',
//   qtyNeeded: 10,
//   qtyInStock: 8,
//   qtyMissing: 2,
//   heatNumbers: ['H123456', 'H789012', ...], // Array pre multi-tavby
//   isometric: 'KF-712-001' // Pre izometric-specific MTO
// }

function loadMTOData(){
if(!projectsData.currentProject || !projectsData.currentPart)return;
var key='mto_'+projectsData.currentProject+'_'+projectsData.currentPart;
var saved=localStorage.getItem(key);
if(saved){
mtoData=JSON.parse(saved);
console.log('ğŸ“‹ MTO data naÄÃ­tanÃ©');
}else{
mtoData={materials:[],isometricMaterials:{},deliveryNotes:[],stock:[]};
}
}

function saveMTOData(){
if(!projectsData.currentProject || !projectsData.currentPart)return;
var key='mto_'+projectsData.currentProject+'_'+projectsData.currentPart;
localStorage.setItem(key,JSON.stringify(mtoData));
console.log('ğŸ’¾ MTO data uloÅ¾enÃ© do localStorage');

// UloÅ¾iÅ¥ aj do Firebase
saveProjectsToFirebase();
}

// ============= EXPORT SYSTÃ‰M - BALÃKY A DODACIE LISTY =============
var exportData={
  packages:{}, // {packageId: {spools:[], created:''}}
  deliveryNotes:[] // [{id, date, packages:[], extraSpools:[], total}]
};
var currentPackageSpools=[];
var packageQRStream=null;
var packageQRActive=false;
var extraSpoolsForDelivery=[];
var extraSpoolsQRStream=null;
var extraSpoolsQRActive=false;

function loadExportData(){
if(!projectsData.currentProject || !projectsData.currentPart)return;
var key='export_'+projectsData.currentProject+'_'+projectsData.currentPart;
var saved=localStorage.getItem(key);
if(saved){
exportData=JSON.parse(saved);
console.log('ğŸ“¦ Export data naÄÃ­tanÃ©');
}else{
exportData={packages:{},deliveryNotes:[]};
}
}

function saveExportData(){
if(!projectsData.currentProject || !projectsData.currentPart)return;
var key='export_'+projectsData.currentProject+'_'+projectsData.currentPart;
localStorage.setItem(key,JSON.stringify(exportData));
console.log('ğŸ’¾ Export data uloÅ¾enÃ© do localStorage');

// UloÅ¾iÅ¥ aj do Firebase
saveProjectsToFirebase();
}

function getNextPackageNumber(){
var keys=Object.keys(exportData.packages);
if(keys.length===0)return 1;
var maxNum=0;
keys.forEach(function(key){
var match=key.match(/BalÃ­k(\d+)/);
if(match){
var num=parseInt(match[1]);
if(num>maxNum)maxNum=num;
}
});
return maxNum+1;
}

// ============= VYTVORIÅ¤ BALÃK =============
function createPackage(){
currentPackageSpools=[];
var packageNum=getNextPackageNumber();
document.getElementById('currentPackageNum').textContent=packageNum;
document.getElementById('scannedSpoolsList').innerHTML='<div style="text-align:center;color:#999">NaÄÃ­tajte QR kÃ³dy spoolov...</div>';
document.getElementById('createPackageModal').style.display='block';
startPackageQRScanner();
}

function closeCreatePackage(){
try {
stopPackageQRScanner();
} catch(e) {
console.error('Chyba pri zastavenÃ­ skenera:',e);
}
document.getElementById('createPackageModal').style.display='none';
currentPackageSpools=[];
console.log('âœ• Modal balÃ­ka zatvorenÃ½');
}

function startPackageQRScanner(){
var video=document.getElementById('packageQRVideo');
var canvas=document.getElementById('packageQRCanvas');

navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
.then(function(stream){
packageQRStream=stream;
video.srcObject=stream;
packageQRActive=true;
console.log('ğŸ“· Package QR skener spustenÃ½');
requestAnimationFrame(scanPackageQR);
}).catch(function(err){
console.error('âŒ Chyba kamery:',err);
alert('Nie je moÅ¾nÃ© zÃ­skaÅ¥ prÃ­stup ku kamere.');
});
}

function scanPackageQR(){
if(!packageQRActive)return;

var video=document.getElementById('packageQRVideo');
var canvas=document.getElementById('packageQRCanvas');
var ctx=canvas.getContext('2d');

if(video.readyState===video.HAVE_ENOUGH_DATA){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.drawImage(video,0,0,canvas.width,canvas.height);

var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
var code=jsQR(imageData.data,imageData.width,imageData.height);

if(code){
console.log('âœ… Package QR naskenovanÃ½:',code.data);
addSpoolToPackage(code.data);
// PokraÄuj skenovaÅ¥ ÄalÅ¡ie
}
}

requestAnimationFrame(scanPackageQR);
}

function stopPackageQRScanner(){
packageQRActive=false;
if(packageQRStream){
packageQRStream.getTracks().forEach(function(track){track.stop();});
packageQRStream=null;
}
// ZastaviÅ¥ video element
var video=document.getElementById('packageQRVideo');
if(video && video.srcObject){
video.srcObject=null;
}
console.log('ğŸ“· Package skener zastavenÃ½');
}

function addSpoolToPackage(qrCode){
// NÃ¡jdi spool podÄ¾a QR kÃ³du
var foundSpool=null;
for(var i=0;i<spools.length;i++){
if(spools[i].qrCode===qrCode){
foundSpool=spools[i];
break;
}
}

if(!foundSpool){
console.log('âš ï¸ Spool s QR kÃ³dom',qrCode,'nebol najdenÃ½');
return;
}

// Kontrola duplicity
var exists=currentPackageSpools.some(function(s){return s.qrCode===qrCode;});
if(exists){
console.log('âš ï¸ Spool uÅ¾ je v balÃ­ku');
return;
}

var isoName=originalFileName||projectsData.currentPart;
currentPackageSpools.push({
spoolId:foundSpool.id,
displayNum:foundSpool.displayNum,
qrCode:qrCode,
isometric:isoName
});

updateScannedSpoolsList();
console.log('âœ… Spool',foundSpool.displayNum,'pridanÃ½ do balÃ­ka');
}

function updateScannedSpoolsList(){
var list=document.getElementById('scannedSpoolsList');
if(currentPackageSpools.length===0){
list.innerHTML='<div style="text-align:center;color:#999">NaÄÃ­tajte QR kÃ³dy spoolov...</div>';
return;
}

var html='<div style="font-weight:600;margin-bottom:10px">NaÄÃ­tanÃ© spooly ('+currentPackageSpools.length+'):</div>';
currentPackageSpools.forEach(function(spool,index){
html+='<div style="padding:8px;background:white;border:1px solid #ddd;border-radius:4px;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center">';
html+='<div><strong>'+spool.displayNum+'</strong><br><span style="font-size:11px;color:#666">'+spool.isometric+'</span></div>';
html+='<button onclick="removeSpoolFromPackage('+index+')" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer">âœ•</button>';
html+='</div>';
});
list.innerHTML=html;
}

function removeSpoolFromPackage(index){
currentPackageSpools.splice(index,1);
updateScannedSpoolsList();
}

function finishPackage(){
if(currentPackageSpools.length===0){
alert('BalÃ­k je prÃ¡zdny! NaÄÃ­tajte aspoÅˆ 1 spool.');
return;
}

var packageNum=getNextPackageNumber();
var packageId=projectsData.currentProject+'_'+projectsData.currentPart+'_BalÃ­k'+packageNum;

exportData.packages[packageId]={
packageNum:packageNum,
project:projectsData.currentProject,
part:projectsData.currentPart,
spools:currentPackageSpools,
created:new Date().toISOString().split('T')[0],
qrCode:'PKG_'+packageId // QR kÃ³d balÃ­ka
};

saveExportData();
alert('âœ… BalÃ­k #'+packageNum+' vytvorenÃ½! ('+currentPackageSpools.length+' spoolov)');
closeCreatePackage();
console.log('âœ… BalÃ­k vytvorenÃ½:',packageId);
}

// ============= NOTIFIKAÄŒNÃ SYSTÃ‰M =============
var notifications=[];

function loadNotifications(){
if(!projectsData.currentProject)return;
var key='notifications_'+projectsData.currentProject;
var saved=localStorage.getItem(key);
if(saved){
notifications=JSON.parse(saved);
console.log('ğŸ”” NotifikÃ¡cie naÄÃ­tanÃ©:',notifications.length);
}else{
notifications=[];
}
updateNotificationBadge();
}

function saveNotifications(){
if(!projectsData.currentProject)return;
var key='notifications_'+projectsData.currentProject;
localStorage.setItem(key,JSON.stringify(notifications));
updateNotificationBadge();
}

function addNotification(message){
var notif={
id:Date.now()+'_'+Math.random(),
message:message,
timestamp:new Date().toISOString()
};
notifications.push(notif);
saveNotifications();
console.log('ğŸ”” NovÃ¡ notifikÃ¡cia:',message);
}

function removeNotification(notifId){
notifications=notifications.filter(function(n){return n.id!==notifId;});
saveNotifications();
buildNotificationList();
console.log('âœ“ NotifikÃ¡cia odstrÃ¡nenÃ¡');
}

function updateNotificationBadge(){
var badge=document.getElementById('notificationBadge');
if(notifications.length>0){
badge.style.display='block';
badge.textContent=notifications.length;
}else{
badge.style.display='none';
}
}

function toggleNotifications(){
var panel=document.getElementById('notificationPanel');
if(panel.style.display==='none'){
panel.style.display='block';
buildNotificationList();
}else{
panel.style.display='none';
}
}

function closeNotifications(){
document.getElementById('notificationPanel').style.display='none';
}

// ============= ZOZNAM BALÃKOV =============
function showPackageList(){
document.getElementById('packageListModal').style.display='block';
buildPackageList();
}

function closePackageList(){
document.getElementById('packageListModal').style.display='none';
}

function buildPackageList(){
var content=document.getElementById('packageListContent');
var packages=Object.keys(exportData.packages);

if(packages.length===0){
content.innerHTML='<div style="text-align:center;color:#999;padding:40px">Å½iadne balÃ­ky<br>PouÅ¾ite "ğŸ“¦ VytvoriÅ¥ balÃ­k"</div>';
return;
}

var html='';
packages.forEach(function(packageId){
var pkg=exportData.packages[packageId];
html+='<div style="background:#f9f9f9;border:2px solid #0078D4;border-radius:8px;padding:15px;margin-bottom:15px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
html+='<h3 style="margin:0">ğŸ“¦ BalÃ­k #'+pkg.packageNum+'</h3>';
html+='<div style="display:flex;gap:10px;align-items:center">';
html+='<span style="font-size:12px;color:#666">'+pkg.created+'</span>';
html+='<button onclick="deletePackage(\''+packageId+'\')" style="background:#ef4444;color:white;border:none;padding:5px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600">ğŸ—‘ï¸ ZmazaÅ¥</button>';
html+='</div>';
html+='</div>';
html+='<div style="font-size:13px;color:#666;margin-bottom:10px">QR: '+pkg.qrCode+'</div>';
html+='<div style="font-weight:600;margin-bottom:5px">Spooly ('+pkg.spools.length+'):</div>';
html+='<div style="max-height:150px;overflow-y:auto;background:white;padding:10px;border-radius:4px">';
pkg.spools.forEach(function(spool){
html+='<div style="padding:5px;border-bottom:1px solid #eee">'+spool.displayNum+' <span style="color:#666;font-size:11px">('+spool.isometric+')</span></div>';
});
html+='</div>';
html+='</div>';
});

content.innerHTML=html;
}

function deletePackage(packageId){
if(!confirm('Naozaj chcete zmazaÅ¥ tento balÃ­k?')){
return;
}
console.log('ğŸ—‘ï¸ MaÅ¾em balÃ­k:',packageId);
delete exportData.packages[packageId];
saveExportData();
buildPackageList();
if(document.getElementById('deliveryNoteModal').style.display==='block'){
buildDeliveryPackagesList();
updateTotalSpoolsCount();
}
showNotification('âœ… BalÃ­k zmazanÃ½!','success');
console.log('âœ… BalÃ­k zmazanÃ½:',packageId);
}

function filterPackages(){
var searchText=document.getElementById('packageSearchInput').value.toLowerCase();
var packages=Object.keys(exportData.packages);
var content=document.getElementById('packageListContent');

var filteredHtml='';
var foundCount=0;

packages.forEach(function(packageId){
var pkg=exportData.packages[packageId];
var matchFound=false;

// HÄ¾adaj v spooloch
pkg.spools.forEach(function(spool){
if(spool.displayNum.toLowerCase().indexOf(searchText)>-1 || spool.isometric.toLowerCase().indexOf(searchText)>-1){
matchFound=true;
}
});

if(matchFound || searchText===''){
foundCount++;
filteredHtml+='<div style="background:#f9f9f9;border:2px solid #0078D4;border-radius:8px;padding:15px;margin-bottom:15px">';
filteredHtml+='<h3>ğŸ“¦ BalÃ­k #'+pkg.packageNum+' <span style="font-size:14px;color:#666">('+pkg.created+')</span></h3>';
filteredHtml+='<div style="font-size:13px;color:#666;margin-bottom:10px">QR: '+pkg.qrCode+'</div>';
filteredHtml+='<div style="max-height:150px;overflow-y:auto;background:white;padding:10px;border-radius:4px">';
pkg.spools.forEach(function(spool){
var highlight=(spool.displayNum.toLowerCase().indexOf(searchText)>-1 || spool.isometric.toLowerCase().indexOf(searchText)>-1)?'background:#fef3c7':'';
filteredHtml+='<div style="padding:5px;border-bottom:1px solid #eee;'+highlight+'">'+spool.displayNum+' <span style="color:#666;font-size:11px">('+spool.isometric+')</span></div>';
});
filteredHtml+='</div></div>';
}
});

if(foundCount===0){
content.innerHTML='<div style="text-align:center;color:#999;padding:40px">NiÄ nenÃ¡jdenÃ©</div>';
}else{
content.innerHTML=filteredHtml;
}
}

// ============= DODACÃ LIST =============
function createDeliveryNote(){
document.getElementById('deliveryNoteModal').style.display='block';
buildDeliveryPackagesList();
extraSpoolsForDelivery=[];
updateExtraSpoolsList();
updateTotalSpoolsCount();
}

function closeDeliveryNote(){
const modal = document.getElementById('deliveryNoteModal');
if (modal) {
  modal.style.display='none';
  console.log('âœ… DodacÃ­ list modal zatvorenÃ½');
} else {
  console.error('âŒ deliveryNoteModal nenÃ¡jdenÃ½!');
}
try {
  stopExtraSpoolsScanner();
} catch(e) {
  console.log('Extra spools scanner uÅ¾ zastavenÃ½');
}
extraSpoolsForDelivery=[];
}

function buildDeliveryPackagesList(){
var list=document.getElementById('deliveryPackagesList');
var packages=Object.keys(exportData.packages);

if(packages.length===0){
list.innerHTML='<div style="color:#999">Å½iadne balÃ­ky</div>';
return;
}

var html='';
packages.forEach(function(packageId){
var pkg=exportData.packages[packageId];
html+='<div style="display:flex;align-items:center;gap:10px;padding:8px;margin-bottom:5px;background:white;border:1px solid #ddd;border-radius:4px">';
html+='<label style="flex:1;cursor:pointer">';
html+='<input type="checkbox" class="delivery-package-checkbox" data-package-id="'+packageId+'" onchange="updateTotalSpoolsCount()"> ';
html+='<strong>BalÃ­k #'+pkg.packageNum+'</strong> ('+pkg.spools.length+' spoolov) - '+pkg.created;
html+='</label>';
html+='<button onclick="deletePackage(\''+packageId+'\')" style="background:#ef4444;color:white;border:none;padding:5px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600">ğŸ—‘ï¸</button>';
html+='</div>';
});

list.innerHTML=html;
}

function scanExtraSpools(){
document.getElementById('deliveryNoteModal').style.display='none';
document.getElementById('qrScannerModal').style.display='block';
document.getElementById('qrResult').style.display='none';
document.getElementById('qrScannerDoneBtn').style.display='block';
startExtraSpoolsScanner();
}

function startExtraSpoolsScanner(){
var video=document.getElementById('qrVideo');
var canvas=document.getElementById('qrCanvas');

navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
.then(function(stream){
extraSpoolsQRStream=stream;
video.srcObject=stream;
extraSpoolsQRActive=true;
console.log('ğŸ“· Extra spooly skener spustenÃ½');
requestAnimationFrame(scanExtraSpoolQR);
}).catch(function(err){
console.error('âŒ Chyba kamery:',err);
alert('Nie je moÅ¾nÃ© zÃ­skaÅ¥ prÃ­stup ku kamere.');
});
}

function scanExtraSpoolQR(){
if(!extraSpoolsQRActive)return;

var video=document.getElementById('qrVideo');
var canvas=document.getElementById('qrCanvas');
var ctx=canvas.getContext('2d');

if(video.readyState===video.HAVE_ENOUGH_DATA){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.drawImage(video,0,0,canvas.width,canvas.height);

var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
var code=jsQR(imageData.data,imageData.width,imageData.height);

if(code){
console.log('âœ… Extra spool QR:',code.data);
addExtraSpool(code.data);
}
}

requestAnimationFrame(scanExtraSpoolQR);
}

function stopExtraSpoolsScanner(){
extraSpoolsQRActive=false;
if(extraSpoolsQRStream){
extraSpoolsQRStream.getTracks().forEach(function(track){track.stop();});
extraSpoolsQRStream=null;
}
// ZastaviÅ¥ video element
var video=document.getElementById('qrVideo');
if(video && video.srcObject){
video.srcObject=null;
}
document.getElementById('qrScannerModal').style.display='none';
document.getElementById('qrScannerDoneBtn').style.display='none';
document.getElementById('deliveryNoteModal').style.display='block';
console.log('ğŸ“· Extra spooly skener zastavenÃ½');
}

function addExtraSpool(qrCode){
var foundSpool=spools.find(function(s){return s.qrCode===qrCode;});
if(!foundSpool)return;

var exists=extraSpoolsForDelivery.some(function(s){return s.qrCode===qrCode;});
if(exists)return;

var isoName=originalFileName||projectsData.currentPart;
extraSpoolsForDelivery.push({
displayNum:foundSpool.displayNum,
qrCode:qrCode,
isometric:isoName
});

updateExtraSpoolsList();
updateTotalSpoolsCount();

// VizuÃ¡lny feedback
document.getElementById('qrResult').style.display='block';
document.getElementById('qrResultText').textContent='PridanÃ½: '+foundSpool.displayNum;
setTimeout(function(){
document.getElementById('qrResult').style.display='none';
},1500);
}

function updateExtraSpoolsList(){
var list=document.getElementById('extraSpoolsList');
if(extraSpoolsForDelivery.length===0){
list.innerHTML='<div style="color:#999">Å½iadne extra spooly</div>';
return;
}

var html='';
extraSpoolsForDelivery.forEach(function(spool,index){
html+='<div style="padding:8px;background:white;border:1px solid #ddd;border-radius:4px;margin-bottom:5px;display:flex;justify-content:space-between">';
html+='<div>'+spool.displayNum+' <span style="font-size:11px;color:#666">('+spool.isometric+')</span></div>';
html+='<button onclick="removeExtraSpool('+index+')" style="background:#ef4444;color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:11px">âœ•</button>';
html+='</div>';
});
list.innerHTML=html;
}

function removeExtraSpool(index){
extraSpoolsForDelivery.splice(index,1);
updateExtraSpoolsList();
updateTotalSpoolsCount();
}

function updateTotalSpoolsCount(){
var total=0;

// BalÃ­ky
var checkboxes=document.querySelectorAll('.delivery-package-checkbox:checked');
checkboxes.forEach(function(cb){
var packageId=cb.getAttribute('data-package-id');
var pkg=exportData.packages[packageId];
if(pkg)total+=pkg.spools.length;
});

// Extra spooly
total+=extraSpoolsForDelivery.length;

document.getElementById('totalSpoolsCount').textContent=total;
}

function generateDeliveryNotePDF(){
var selectedPackages=[];
var checkboxes=document.querySelectorAll('.delivery-package-checkbox:checked');
checkboxes.forEach(function(cb){
var packageId=cb.getAttribute('data-package-id');
selectedPackages.push(packageId);
});

if(selectedPackages.length===0 && extraSpoolsForDelivery.length===0){
alert('âš ï¸ Vyberte aspoÅˆ 1 balÃ­k alebo naÄÃ­tajte extra spooly!');
return;
}

// Vytvor canvas pre PDF
var ca=document.createElement('canvas');
ca.width=2480; // A4 @ 300 DPI
ca.height=3508;
var ctx=ca.getContext('2d');

// Pozadie
ctx.fillStyle='#ffffff';
ctx.fillRect(0,0,ca.width,ca.height);

// HlaviÄka
ctx.fillStyle='#0078D4';
ctx.fillRect(0,0,ca.width,200);
ctx.fillStyle='#ffffff';
ctx.font='bold 80px Arial';
ctx.textAlign='center';
ctx.fillText('DODACÃ LIST',ca.width/2,130);

// DÃ¡tum a ÄÃ­slo
var date=new Date();
var dateStr=date.toLocaleDateString('sk-SK');
var deliveryNum='DN'+date.getTime().toString().slice(-6);

ctx.fillStyle='#000000';
ctx.font='40px Arial';
ctx.textAlign='left';
ctx.fillText('ÄŒÃ­slo: '+deliveryNum,100,300);
ctx.fillText('DÃ¡tum: '+dateStr,100,360);
ctx.fillText('Projekt: '+(projectsData.currentProject||''),100,420);
ctx.fillText('ÄŒasÅ¥: '+(projectsData.currentPart||''),100,480);

// ÄŒiara
ctx.strokeStyle='#0078D4';
ctx.lineWidth=3;
ctx.beginPath();
ctx.moveTo(100,520);
ctx.lineTo(ca.width-100,520);
ctx.stroke();

var yPos=600;

// BALÃKY
if(selectedPackages.length>0){
ctx.font='bold 50px Arial';
ctx.fillText('ğŸ“¦ BALÃKY ('+selectedPackages.length+'):',100,yPos);
yPos+=70;

selectedPackages.forEach(function(packageId){
var pkg=exportData.packages[packageId];
ctx.font='bold 40px Arial';
ctx.fillText('BalÃ­k #'+pkg.packageNum+' ('+pkg.spools.length+' spoolov)',120,yPos);
yPos+=50;

ctx.font='30px Arial';
pkg.spools.forEach(function(spool){
var text='  â€¢ '+spool.displayNum+' - '+spool.isometric;
// SkrÃ¡Å¥ ak je prÃ­liÅ¡ dlhÃ½
if(text.length>80)text=text.substring(0,77)+'...';
ctx.fillText(text,140,yPos);
yPos+=40;
if(yPos>ca.height-200){
// NovÃ¡ strana potrebnÃ¡ (TODO: multi-page support)
ctx.font='20px Arial';
ctx.fillText('... pokraÄovanie na ÄalÅ¡ej strane',140,yPos);
return;
}
});
yPos+=30;
});
}

// EXTRA SPOOLY
if(extraSpoolsForDelivery.length>0){
if(yPos>ca.height-400){
ctx.font='20px Arial';
ctx.fillText('Extra spooly - pozri ÄalÅ¡iu stranu',100,yPos);
}else{
ctx.font='bold 50px Arial';
ctx.fillText('â• EXTRA SPOOLY ('+extraSpoolsForDelivery.length+'):',100,yPos);
yPos+=70;

ctx.font='30px Arial';
extraSpoolsForDelivery.forEach(function(spool){
var text='  â€¢ '+spool.displayNum+' - '+spool.isometric;
if(text.length>80)text=text.substring(0,77)+'...';
ctx.fillText(text,120,yPos);
yPos+=40;
if(yPos>ca.height-200)return;
});
}
}

// CELKOVÃ POÄŒET
yPos+=50;
if(yPos<ca.height-300){
ctx.fillStyle='#0078D4';
ctx.fillRect(100,yPos,ca.width-200,100);
ctx.fillStyle='#ffffff';
ctx.font='bold 50px Arial';
ctx.textAlign='center';
var totalSpools=document.getElementById('totalSpoolsCount').textContent;
ctx.fillText('CELKOM: '+totalSpools+' SPOOLOV',ca.width/2,yPos+65);
}

// Konvertuj na PDF
var imgData=ca.toDataURL('image/png');
var pdf=new jsPDF('p','mm','a4');
var imgWidth=210;
var imgHeight=(ca.height*imgWidth)/ca.width;
pdf.addImage(imgData,'PNG',0,0,imgWidth,imgHeight);
pdf.save('Dodaci_list_'+deliveryNum+'.pdf');

// UloÅ¾ do exportData
exportData.deliveryNotes.push({
id:deliveryNum,
date:dateStr,
packages:selectedPackages,
extraSpools:extraSpoolsForDelivery.slice(),
totalSpools:parseInt(totalSpools)
});
saveExportData();

// ğŸ’¾ UloÅ¾ do Firebase
saveDeliveryNoteToFirebase({
id:deliveryNum,
date:dateStr,
project:projectsData.currentProject||'',
part:projectsData.currentPart||'',
packages:selectedPackages,
extraSpools:extraSpoolsForDelivery.slice(),
totalSpools:parseInt(totalSpools),
pdfData:imgData,
createdBy:window.currentUser?.username||'admin',
timestamp:new Date().toISOString()
});

alert('âœ… DodacÃ­ list '+deliveryNum+' vygenerovanÃ½!');
closeDeliveryNote();
console.log('ğŸ“„ DodacÃ­ list vygenerovanÃ½:',deliveryNum);
}

// ğŸ’¾ ULOÅ½ENIE DODACIEHO LISTU DO FIREBASE
async function saveDeliveryNoteToFirebase(deliveryNote){
try{
if(!db){
console.warn('âš ï¸ Firebase nedostupnÃ½, iba lokÃ¡lne uloÅ¾enie');
return;
}
await db.collection('delivery_notes').doc(deliveryNote.id).set(deliveryNote);
console.log('âœ… DodacÃ­ list uloÅ¾enÃ½ do Firebase:',deliveryNote.id);
}catch(error){
console.error('âŒ Chyba pri ukladanÃ­ dodacieho listu:',error);
alert('âš ï¸ DodacÃ­ list sa nepodarilo uloÅ¾iÅ¥ online. UloÅ¾enÃ½ len lokÃ¡lne.');
}
}

// ============= QR INFO SKENER =============
var infoQRStream=null;
var infoQRActive=false;

function openQRInfoScanner(){
document.getElementById('qrInfoModal').style.display='block';
document.getElementById('qrInfoResult').style.display='none';
startInfoQRScanner();
}

function closeQRInfo(){
stopInfoQRScanner();
document.getElementById('qrInfoModal').style.display='none';
}

function startInfoQRScanner(){
var video=document.getElementById('infoQRVideo');
var canvas=document.getElementById('infoQRCanvas');

navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
.then(function(stream){
infoQRStream=stream;
video.srcObject=stream;
infoQRActive=true;
console.log('ğŸ“· Info QR skener spustenÃ½');
requestAnimationFrame(scanInfoQR);
}).catch(function(err){
console.error('âŒ Chyba kamery:',err);
alert('Nie je moÅ¾nÃ© zÃ­skaÅ¥ prÃ­stup ku kamere.');
});
}

function scanInfoQR(){
if(!infoQRActive)return;

var video=document.getElementById('infoQRVideo');
var canvas=document.getElementById('infoQRCanvas');
var ctx=canvas.getContext('2d');

if(video.readyState===video.HAVE_ENOUGH_DATA){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.drawImage(video,0,0,canvas.width,canvas.height);

var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
var code=jsQR(imageData.data,imageData.width,imageData.height);

if(code){
console.log('âœ… Info QR:',code.data);
displayQRInfo(code.data);
stopInfoQRScanner();
return;
}
}

requestAnimationFrame(scanInfoQR);
}

function stopInfoQRScanner(){
infoQRActive=false;
if(infoQRStream){
infoQRStream.getTracks().forEach(function(track){track.stop();});
infoQRStream=null;
}
}

function displayQRInfo(qrCode){
var result=document.getElementById('qrInfoResult');
var html='<h3 style="margin-top:0">ğŸ“± QR KÃ³d: '+qrCode+'</h3>';

// HÄ¾adaj spool
var foundSpool=spools.find(function(s){return s.qrCode===qrCode;});
if(foundSpool){
var isoName=originalFileName||projectsData.currentPart;
html+='<div style="padding:10px;background:#d1fae5;border-radius:4px;margin-bottom:10px">';
html+='<strong>âœ… SPOOL</strong><br>';
html+='<strong>ÄŒÃ­slo:</strong> '+foundSpool.displayNum+'<br>';
html+='<strong>Izometria:</strong> '+isoName;
html+='</div>';

// HÄ¾adaj v ktorom balÃ­ku je
var foundInPackage=null;
Object.keys(exportData.packages).forEach(function(packageId){
var pkg=exportData.packages[packageId];
var inPkg=pkg.spools.some(function(s){return s.qrCode===qrCode;});
if(inPkg)foundInPackage=pkg;
});

if(foundInPackage){
html+='<div style="padding:10px;background:#e0f2fe;border-radius:4px">';
html+='<strong>ğŸ“¦ V balÃ­ku #'+foundInPackage.packageNum+'</strong><br>';
html+='<span style="font-size:12px">VytvorenÃ½: '+foundInPackage.created+'</span>';
html+='</div>';
}else{
html+='<div style="padding:10px;background:#fee;border-radius:4px;color:#ef4444">';
html+='âš ï¸ Nie je v Å¾iadnom balÃ­ku';
html+='</div>';
}

result.innerHTML=html;
result.style.display='block';
return;
}

// HÄ¾adaj balÃ­k
var foundPackage=null;
Object.keys(exportData.packages).forEach(function(packageId){
var pkg=exportData.packages[packageId];
if(pkg.qrCode===qrCode)foundPackage=pkg;
});

if(foundPackage){
html+='<div style="padding:10px;background:#ddd6fe;border-radius:4px">';
html+='<strong>ğŸ“¦ BALÃK #'+foundPackage.packageNum+'</strong><br>';
html+='<strong>Spoolov:</strong> '+foundPackage.spools.length+'<br>';
html+='<strong>VytvorenÃ½:</strong> '+foundPackage.created;
html+='</div>';
result.innerHTML=html;
result.style.display='block';
return;
}

// NeznÃ¡my QR
html+='<div style="padding:15px;background:#fee;border-radius:4px;color:#ef4444;text-align:center">';
html+='<strong>â“ NeznÃ¡my QR kÃ³d</strong><br>';
html+='Tento QR nie je priradenÃ½ k Å¾iadnemu spoolu ani balÃ­ku.';
html+='</div>';

result.innerHTML=html;
result.style.display='block';
}

// ============= MONTÃÅ½ FUNKCIE =============
var montazWeldMode=false;
var montazWeldNumber='';
var montazCurrentWeld=null; // Pre modal - ktorÃ½ zvar upravujeme

function openMontazWelderModal(weld, weldBookEntry){
montazCurrentWeld={weld:weld, weldBookEntry:weldBookEntry};
document.getElementById('montazWelderWeldNum').textContent='#'+weld.displayNum;
document.getElementById('montazWelderInput').value='';
// Nastav dneÅ¡nÃ½ dÃ¡tum
var today=new Date().toISOString().split('T')[0];
document.getElementById('montazDateInput').value=today;
document.getElementById('montazWelderModal').style.display='flex';
// Focus na input
setTimeout(function(){document.getElementById('montazWelderInput').focus();},100);
}

function closeMontazWelderModal(){
document.getElementById('montazWelderModal').style.display='none';
montazCurrentWeld=null;
}

function saveMontazWelder(){
var welderInput=document.getElementById('montazWelderInput').value.trim();
var dateInput=document.getElementById('montazDateInput').value;

if(!welderInput){
alert('âš ï¸ Zadaj Welder ID!');
return;
}

var weld=montazCurrentWeld.weld;
var weldBookEntry=montazCurrentWeld.weldBookEntry;

// Aktualizuj WeldBook
if(weldBookEntry){
weldBookEntry.welderId=welderInput;
weldBookEntry.dateWelding=dateInput;
}else{
// Vytvor novÃ½ zÃ¡znam ak neexistuje
var splitName=splitIsometricName(originalFileName||'Unknown');
addWeldToWeldBook({
part:splitName.part,
isometric:originalFileName,  // âœ… OPRAVA - pouÅ¾i originalFileName!
sheets:1,
weldId:String(weld.displayNum),
welderId:welderInput,
dateWelding:dateInput
});
}
saveCurrentPartWeldBook();

// âœ… OFFLINE: Pridaj do pending (len ak je offline projekt)
if(typeof currentOfflineProjectId !== 'undefined' && currentOfflineProjectId){
try{
if(typeof addPendingWeldBookChange === 'function'){
addPendingWeldBookChange({
weldId: String(weld.displayNum),
welderId: welderInput,
dateWelding: dateInput,
project: originalFileName || currentOfflineProjectId,
action: 'add',
timestamp: new Date().toISOString()
});
}
if(typeof autoSaveCurrentProject === 'function'){
autoSaveCurrentProject();
}
}catch(e){
console.warn('âš ï¸ Offline auto-save skipped:', e.message);
}
}

dw();
closeMontazWelderModal();
console.log('âœ… Zvar',weld.displayNum,'oznaÄenÃ½ - zvaraÄ:',welderInput,', dÃ¡tum:',dateInput);
}

function addMontazWeld(){
console.log('ğŸš€ addMontazWeld() called');
var weldNum=prompt('Zadajte ÄÃ­slo novÃ©ho zvaru (napr: 5a, 10b):','');
if(weldNum===null || weldNum.trim()===''){
  console.log('âš ï¸ User cancelled or empty number');
  return;
}

montazWeldNumber=weldNum.trim();
montazWeldMode=true;
pt=null;  // âœ… RESET - vyÄisti starÃº hodnotu!
currentTool='weld';
ca.style.cursor='crosshair';
alert('Kliknite na ZAÄŒIATOK zvaru, potom na KONIEC.');
console.log('â• ReÅ¾im pridania zvaru:',montazWeldNumber);
console.log('   montazWeldMode=', montazWeldMode);
console.log('   pt=', pt);
console.log('   currentTool=', currentTool);
}

function deleteMontazWeld(){
alert('Kliknite na KRUH zvaru ktorÃ½ chcete vymazaÅ¥.');
window.montazDeleteMode=true;
ca.style.cursor='crosshair';
}

function showSpoolsPreview(){
alert('ğŸ“‹ NÃ¡hÄ¾ad spoolov - funkcia v implementÃ¡cii');
// TODO: ZobrazÃ­ read-only panel so spoolmi
}

// ============= PROGRES DASHBOARD FUNKCIE =============
function showProgressDashboard(){
document.getElementById('progressDashboardModal').style.display='block';
buildProgressDashboard();
}

function closeProgressDashboard(){
document.getElementById('progressDashboardModal').style.display='none';
}

function buildProgressDashboard(){
var content=document.getElementById('progressDashboardContent');

// SpoÄÃ­taj Å¡tatistiky
var stats=calculateProjectStats();

var html='<div style="padding:20px">';

// CELKOVÃ PROGRES
html+='<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:12px;margin-bottom:30px;text-align:center">';
html+='<h2 style="margin:0 0 20px 0;font-size:32px">ğŸ“Š CELKOVÃ PROGRES</h2>';
html+='<div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:15px;margin-bottom:15px">';
html+='<div style="height:40px;background:rgba(255,255,255,0.3);border-radius:20px;overflow:hidden">';
var totalPercent=stats.totalWelds>0?(stats.completedWelds/stats.totalWelds*100).toFixed(1):0;
html+='<div style="height:100%;background:#10b981;width:'+totalPercent+'%;transition:width 0.5s;display:flex;align-items:center;justify-content:center;font-weight:bold">'+totalPercent+'%</div>';
html+='</div></div>';
html+='<div style="font-size:24px">'+stats.completedWelds+' / '+stats.totalWelds+' zvarov</div>';
html+='</div>';

// Å TATISTIKY V KOCKÃCH
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px">';

html+='<div style="background:#d1fae5;padding:20px;border-radius:8px;border-left:4px solid #10b981">';
html+='<div style="color:#065f46;font-size:14px;margin-bottom:5px">âœ… HOTOVÃ‰</div>';
html+='<div style="font-size:32px;font-weight:bold;color:#047857">'+stats.completedWelds+'</div>';
html+='<div style="color:#059669;font-size:12px">'+totalPercent+'%</div>';
html+='</div>';

html+='<div style="background:#fef3c7;padding:20px;border-radius:8px;border-left:4px solid #fbbf24">';
html+='<div style="color:#92400e;font-size:14px;margin-bottom:5px">âšª ÄŒAKÃ</div>';
html+='<div style="font-size:32px;font-weight:bold;color:#b45309">'+(stats.totalWelds-stats.completedWelds)+'</div>';
html+='<div style="color:#d97706;font-size:12px">'+(100-totalPercent).toFixed(1)+'%</div>';
html+='</div>';

html+='<div style="background:#e0f2fe;padding:20px;border-radius:8px;border-left:4px solid #0ea5e9">';
html+='<div style="color:#075985;font-size:14px;margin-bottom:5px">ğŸ“¦ BALÃKY</div>';
html+='<div style="font-size:32px;font-weight:bold;color:#0369a1">'+Object.keys(exportData.packages||{}).length+'</div>';
html+='<div style="color:#0284c7;font-size:12px">vytvorenÃ½ch</div>';
html+='</div>';

html+='<div style="background:#fce7f3;padding:20px;border-radius:8px;border-left:4px solid #ec4899">';
html+='<div style="color:#9f1239;font-size:14px;margin-bottom:5px">ğŸšš DODACIE LISTY</div>';
html+='<div style="font-size:32px;font-weight:bold;color:#be123c">'+(exportData.deliveryNotes?exportData.deliveryNotes.length:0)+'</div>';
html+='<div style="color:#e11d48;font-size:12px">odoslanÃ½ch</div>';
html+='</div>';

html+='</div>';

// ZVARY PODÄ½A SOURCE
html+='<div style="background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:30px">';
html+='<h3 style="margin:0 0 20px 0;color:#667eea">ğŸ¨ ZVARY PODÄ½A TYPU</h3>';
html+='<div style="display:grid;gap:15px">';

html+='<div style="display:flex;align-items:center;gap:15px">';
html+='<div style="width:50px;height:50px;background:#10b981;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold">'+stats.prefabWelds+'</div>';
html+='<div style="flex:1">';
html+='<div style="font-weight:600;margin-bottom:5px">Prefab zvary</div>';
html+='<div style="height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden">';
var prefabPercent=stats.totalWelds>0?(stats.prefabWelds/stats.totalWelds*100).toFixed(1):0;
html+='<div style="height:100%;background:#10b981;width:'+prefabPercent+'%"></div>';
html+='</div>';
html+='<div style="font-size:12px;color:#6b7280;margin-top:5px">'+prefabPercent+'%</div>';
html+='</div></div>';

html+='<div style="display:flex;align-items:center;gap:15px">';
html+='<div style="width:50px;height:50px;background:#0ea5e9;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold">'+stats.siteWelds+'</div>';
html+='<div style="flex:1">';
html+='<div style="font-weight:600;margin-bottom:5px">Site zvary</div>';
html+='<div style="height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden">';
var sitePercent=stats.totalWelds>0?(stats.siteWelds/stats.totalWelds*100).toFixed(1):0;
html+='<div style="height:100%;background:#0ea5e9;width:'+sitePercent+'%"></div>';
html+='</div>';
html+='<div style="font-size:12px;color:#6b7280;margin-top:5px">'+sitePercent+'%</div>';
html+='</div></div>';

html+='<div style="display:flex;align-items:center;gap:15px">';
html+='<div style="width:50px;height:50px;background:#fbbf24;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold">'+stats.newWelds+'</div>';
html+='<div style="flex:1">';
html+='<div style="font-weight:600;margin-bottom:5px">NovÃ© zvary (site)</div>';
html+='<div style="height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden">';
var newPercent=stats.totalWelds>0?(stats.newWelds/stats.totalWelds*100).toFixed(1):0;
html+='<div style="height:100%;background:#fbbf24;width:'+newPercent+'%"></div>';
html+='</div>';
html+='<div style="font-size:12px;color:#6b7280;margin-top:5px">'+newPercent+'%</div>';
html+='</div></div>';

html+='</div></div>';

html+='</div>';

content.innerHTML=html;
}

function calculateProjectStats(){
var stats={
totalWelds:0,
completedWelds:0,
prefabWelds:0,
siteWelds:0,
newWelds:0
};

// Prejdi vÅ¡etky projekty a Äasti
if(projectsData && projectsData.projects){
Object.keys(projectsData.projects).forEach(function(projName){
var proj=projectsData.projects[projName];
Object.keys(proj.parts).forEach(function(partName){
var part=proj.parts[partName];
if(part.welds){
part.welds.forEach(function(weld){
stats.totalWelds++;
var source=weld.source||'site';
if(source==='prefab')stats.prefabWelds++;
else if(source==='new')stats.newWelds++;
else stats.siteWelds++;
});
}
});
});
}

// SpoÄÃ­taj hotovÃ© zvary z WeldBook
if(weldBookData){
weldBookData.forEach(function(row){
// Tu by bola logika na kontrolu Äi je hotovÃ½
// ZatiaÄ¾ len predpoklad Å¾e vÅ¡etky v WeldBook sÃº hotovÃ©
stats.completedWelds++;
});
}

return stats;
}

function showProgressByIso(){
// Vytvor modal
var modal = document.createElement('div');
modal.id = 'progressByIsoModal';
modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;justify-content:center;align-items:center;padding:20px';

var content = '<div style="background:white;border-radius:12px;max-width:1200px;width:100%;max-height:90vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">';
content += '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;border-radius:12px 12px 0 0;color:white;display:flex;justify-content:space-between;align-items:center">';
content += '<h2 style="margin:0;font-size:24px">ğŸ“Š PROGRES PODÄ½A IZOMETRIÃ</h2>';
content += '<button onclick="closeProgressByIso()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;cursor:pointer;width:40px;height:40px;border-radius:50%;font-weight:bold">âœ•</button>';
content += '</div>';

// Zoskup WeldBook zÃ¡znamy podÄ¾a izometrie
var isoStats = {};
if(weldBookData && weldBookData.length > 0){
  weldBookData.forEach(function(row){
    var iso = row.isometric || 'Unknown';
    if(!isoStats[iso]){
      isoStats[iso] = {total: 0, completed: 0};
    }
    isoStats[iso].total++;
    // HotovÃ½ = mÃ¡ vyplnenÃ©ho zvaraÄa
    if(row.welderId && row.welderId.trim() !== ''){
      isoStats[iso].completed++;
    }
  });
}

// CelkovÃ© Å¡tatistiky
var grandTotal = 0;
var grandCompleted = 0;
Object.keys(isoStats).forEach(function(iso){
  grandTotal += isoStats[iso].total;
  grandCompleted += isoStats[iso].completed;
});

// CELKOVÃ PROGRES HORE
content += '<div style="padding:30px;background:#f8fafc;border-bottom:3px solid #667eea">';
content += '<div style="background:white;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05)">';
content += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">';
content += '<h3 style="margin:0;color:#667eea;font-size:20px">ğŸ¯ CELKOVÃ PROGRES SUL</h3>';
var totalPercent = grandTotal > 0 ? (grandCompleted / grandTotal * 100).toFixed(1) : 0;
content += '<div style="font-size:32px;font-weight:bold;color:#667eea">' + totalPercent + '%</div>';
content += '</div>';
content += '<div style="height:30px;background:#e5e7eb;border-radius:15px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)">';
content += '<div style="height:100%;background:linear-gradient(90deg,#10b981,#059669);width:' + totalPercent + '%;transition:width 0.5s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px">' + (totalPercent > 10 ? totalPercent + '%' : '') + '</div>';
content += '</div>';
content += '<div style="display:flex;justify-content:space-between;margin-top:10px;color:#6b7280;font-size:14px">';
content += '<span>âœ… HotovÃ©: <strong style="color:#10b981">' + grandCompleted + '</strong></span>';
content += '<span>ğŸ“Š Celkom: <strong style="color:#667eea">' + grandTotal + '</strong></span>';
content += '<span>âšª ÄŒakÃ¡: <strong style="color:#f59e0b">' + (grandTotal - grandCompleted) + '</strong></span>';
content += '</div>';
content += '</div></div>';

// TABUÄ½KA IZOMETRIÃ
content += '<div style="padding:30px">';
content += '<table style="width:100%;border-collapse:collapse">';
content += '<thead><tr style="background:#f8fafc;border-bottom:2px solid #667eea">';
content += '<th style="padding:15px;text-align:left;font-weight:600;color:#667eea">Izometria</th>';
content += '<th style="padding:15px;text-align:center;font-weight:600;color:#667eea">Celkom</th>';
content += '<th style="padding:15px;text-align:center;font-weight:600;color:#667eea">HotovÃ©</th>';
content += '<th style="padding:15px;text-align:center;font-weight:600;color:#667eea">ÄŒakÃ¡</th>';
content += '<th style="padding:15px;text-align:left;font-weight:600;color:#667eea">Progres</th>';
content += '<th style="padding:15px;text-align:center;font-weight:600;color:#667eea">%</th>';
content += '</tr></thead><tbody>';

// Zoradi podÄ¾a nÃ¡zvu
var sortedIsos = Object.keys(isoStats).sort();
sortedIsos.forEach(function(iso){
  var stat = isoStats[iso];
  var percent = stat.total > 0 ? (stat.completed / stat.total * 100).toFixed(1) : 0;
  var waiting = stat.total - stat.completed;
  
  // Farba podÄ¾a %
  var barColor = percent >= 100 ? '#10b981' : percent >= 50 ? '#f59e0b' : '#ef4444';
  var bgColor = percent >= 100 ? '#d1fae5' : percent >= 50 ? '#fef3c7' : '#fee2e2';
  
  content += '<tr style="border-bottom:1px solid #e5e7eb;transition:background 0.2s" onmouseover="this.style.background=\'#f8fafc\'" onmouseout="this.style.background=\'white\'">';
  content += '<td style="padding:15px;font-weight:500;color:#1f2937">' + iso + '</td>';
  content += '<td style="padding:15px;text-align:center;font-weight:600;color:#667eea">' + stat.total + '</td>';
  content += '<td style="padding:15px;text-align:center;font-weight:600;color:#10b981">' + stat.completed + '</td>';
  content += '<td style="padding:15px;text-align:center;font-weight:600;color:#f59e0b">' + waiting + '</td>';
  content += '<td style="padding:15px">';
  content += '<div style="height:24px;background:#e5e7eb;border-radius:12px;overflow:hidden">';
  content += '<div style="height:100%;background:' + barColor + ';width:' + percent + '%;transition:width 0.5s"></div>';
  content += '</div></td>';
  content += '<td style="padding:15px;text-align:center"><span style="background:' + bgColor + ';color:' + barColor + ';padding:6px 12px;border-radius:20px;font-weight:bold;font-size:14px">' + percent + '%</span></td>';
  content += '</tr>';
});

content += '</tbody></table>';
content += '</div></div>';

modal.innerHTML = content;
document.body.appendChild(modal);
}

function closeProgressByIso(){
var modal = document.getElementById('progressByIsoModal');
if(modal) modal.remove();
}

function showWeldStats(){
alert('ğŸ“‰ Å tatistiky zvarov - funkcia v implementÃ¡cii');
}

function exportProgressReport(){
alert('ğŸ“„ Export reportu - funkcia v implementÃ¡cii');
}

// ============= MTO GRID SYSTÃ‰M =============
var mtoGrid=null;
var mtoGridData=[];

function openMTOGrid(){
document.getElementById('mtoGridModal').style.display='block';
loadMTOData();

// TEST - pridaj testov acie dÃ¡ta
if(mtoGridData.length===0){
console.log('âš ï¸ Å½iadne dÃ¡ta - pridÃ¡vam test dÃ¡ta');
mtoGridData=[
{rowNum:1,item:'TEST Pipe',description:'Test pipe',size:'88.9x2',qtyNeeded:10,qtyInStock:5,qtyMissing:5,heatNumber:'H123',isometric:'TEST',source:'PDF'},
{rowNum:2,item:'TEST Elbow',description:'Test elbow',size:'88.9x2',qtyNeeded:5,qtyInStock:0,qtyMissing:5,heatNumber:'',isometric:'TEST',source:'PDF'}
];
}

initMTOGrid();
}

function closeMTOGrid(){
document.getElementById('mtoGridModal').style.display='none';
}

function initMTOGrid(){
// KolÃ³ny pre MTO tabuÄ¾ku
var columnDefs=[
{headerName:'#',field:'rowNum',width:60,editable:false,cellStyle:{background:'#f9fafb'}},
{headerName:'Item',field:'item',width:150,editable:true},
{headerName:'Description',field:'description',width:200,editable:true},
{headerName:'Size',field:'size',width:100,editable:true},
{headerName:'Qty Needed',field:'qtyNeeded',width:120,editable:true,type:'numericColumn'},
{headerName:'In Stock',field:'qtyInStock',width:120,editable:true,type:'numericColumn',cellStyle:function(params){
return params.value>0?{background:'#d1fae5',color:'#065f46'}:null;
}},
{headerName:'Missing',field:'qtyMissing',width:120,editable:false,valueGetter:function(params){
var needed=params.data.qtyNeeded||0;
var inStock=params.data.qtyInStock||0;
return Math.max(0,needed-inStock);
},cellStyle:function(params){
return params.value>0?{background:'#fee2e2',color:'#991b1b',fontWeight:'600'}:{background:'#d1fae5',color:'#065f46'};
}},
{headerName:'Heat Number',field:'heatNumber',width:150,editable:true,cellStyle:{background:'#fef3c7'}},
{headerName:'Isometric',field:'isometric',width:180,editable:false},
{headerName:'Source',field:'source',width:100,editable:false,cellStyle:function(params){
if(params.value==='PDF')return {background:'#e0f2fe',color:'#075985'};
if(params.value==='CELKOVÃ‰ MTO')return {background:'#fce7f3',color:'#9f1239'};
if(params.value==='MANUAL')return {background:'#fef3c7',color:'#92400e'};
return null;
}}
];

// Grid options
var gridOptions={
columnDefs:columnDefs,
rowData:mtoGridData,
defaultColDef:{
sortable:true,
filter:true,
resizable:true
},
onCellValueChanged:function(event){
calculateMTOStock();
saveMTOData();
},
onGridReady:function(){
buildMTOData();
updateMTOStats();
}
};

// Vytvor grid
var gridDiv=document.getElementById('mtoGrid');
mtoGrid=agGrid.createGrid(gridDiv,gridOptions);

console.log('ğŸ“‹ MTO Grid inicializovanÃ½');
}

function buildMTOData(){
console.log('ğŸ”¨ buildMTOData() START');
console.log('   mtoData.isometricMaterials:',mtoData.isometricMaterials);
console.log('   mtoData.materials:',mtoData.materials);

mtoGridData=[];
var rowNum=1;

// 1. MATERIÃLY Z PDF IZOMETRIÃ (parsing)
if(mtoData.isometricMaterials){
Object.keys(mtoData.isometricMaterials).forEach(function(isoName){
var materials=mtoData.isometricMaterials[isoName];
console.log('   Processing isometric:',isoName,'materials:',materials.length);
materials.forEach(function(mat){
// Ak je PIPE a qty > 1, vytvor viacero riadkov
if(mat.item && mat.item.toUpperCase().indexOf('PIPE')>-1 && mat.qtyNeeded>1){
for(var i=0;i<mat.qtyNeeded;i++){
mtoGridData.push({
rowNum:rowNum++,
item:mat.item,
description:mat.description||'',
size:mat.size||'',
qtyNeeded:1,
qtyInStock:0,
qtyMissing:1,
heatNumber:'',
isometric:isoName,
source:'PDF'
});
}
}else{
mtoGridData.push({
rowNum:rowNum++,
item:mat.item,
description:mat.description||'',
size:mat.size||'',
qtyNeeded:mat.qtyNeeded||1,
qtyInStock:mat.qtyInStock||0,
qtyMissing:mat.qtyMissing||0,
heatNumber:mat.heatNumber||'',
isometric:isoName,
source:'PDF'
});
}
});
});
}

// 2. CELKOVÃ‰ MTO (dodanÃ© ako sÃºbor)
if(mtoData.materials){
console.log('   Processing CELKOVÃ‰ MTO:',mtoData.materials.length,'items');
mtoData.materials.forEach(function(mat){
var shouldExpand = mat.source !== 'MTO_EXCEL' && mat.item && mat.item.toUpperCase().indexOf('PIPE')>-1 && mat.qtyNeeded>1;
if(shouldExpand){
for(var i=0;i<mat.qtyNeeded;i++){
mtoGridData.push({
rowNum:rowNum++,
item:mat.item,
description:mat.description||'',
size:mat.size||'',
qtyNeeded:1,
qtyInStock:0,
qtyMissing:1,
heatNumber:'',
isometric:'CELKOVÃ‰ MTO',
source:'CELKOVÃ‰ MTO'
});
}
}else{
mtoGridData.push({
rowNum:rowNum++,
item:mat.item,
description:mat.description||'',
size:mat.size||'',
qtyNeeded:mat.qtyNeeded||1,
qtyInStock:mat.qtyInStock||0,
qtyMissing:mat.qtyMissing||0,
heatNumber:mat.heatNumber||'',
isometric:mat.isometric||'CELKOVÃ‰ MTO',
source:'CELKOVÃ‰ MTO'
});
}
});
}

console.log('ğŸ”¨ buildMTOData() END - Total rows:',mtoGridData.length);

if(mtoGrid && mtoGrid.api){
mtoGrid.api.setGridOption('rowData',mtoGridData);
console.log('   Grid updated with',mtoGridData.length,'rows');
}

updateMTOStats();
}

function addMTORow(){
var newRow={
rowNum:mtoGridData.length+1,
item:'',
description:'',
size:'',
qtyNeeded:1,
qtyInStock:0,
qtyMissing:1,
heatNumber:'',
isometric:originalFileName||'Manual',
source:'MANUAL'
};

mtoGridData.push(newRow);

if(mtoGrid && mtoGrid.api){
mtoGrid.api.applyTransaction({add:[newRow]});
}

saveMTOData();
updateMTOStats();
}

function expandPipeRows(){
// RozÅ¡Ã­ri PIPE riadky podÄ¾a dÄºÅ¾ky (6m = 6000mm kusy)
var newData=[];
var rowNum=1;

mtoGridData.forEach(function(row){
if(row.item && row.item.toUpperCase().indexOf('PIPE')>-1){
var qty=row.qtyNeeded||0;
var unit='ks';
var lengthInMm=qty;
var pieceLengthMm=6000; // Å tandardnÃ¡ dÄºÅ¾ka kusu PIPE = 6m

// Detekuj jednotku
if(row.size && (row.size.indexOf('mm')>-1 || String(qty)>1000)){
// MnoÅ¾stvo je v mm
lengthInMm=qty;
unit='mm';
}else if(row.size && row.size.indexOf('m')>-1){
// MnoÅ¾stvo je v metroch
lengthInMm=qty*1000;
unit='m';
}else{
// Predpoklad: ÄÃ­slo > 1000 = mm, inak kusy
if(qty>1000){
lengthInMm=qty;
unit='mm';
}else{
// Je to uÅ¾ poÄet kusov
for(var i=0;i<qty;i++){
newData.push({
rowNum:rowNum++,
item:row.item,
description:row.description,
size:row.size,
qtyNeeded:1,
qtyInStock:0,
qtyMissing:1,
heatNumber:'',
isometric:row.isometric,
source:row.source
});
}
return; // Hotovo pre tento riadok
}
}

// PREPOÄŒET: KoÄ¾ko 6m kusov potrebujeme?
var piecesNeeded=Math.ceil(lengthInMm/pieceLengthMm);
var remainder=lengthInMm%pieceLengthMm;

console.log('ğŸ“ PIPE prepoÄet:',lengthInMm,'mm â†’',piecesNeeded,'kusov (6m), zvyÅ¡ok:',remainder,'mm');

// Vytvor riadky pre plnÃ© 6m kusy
for(var i=0;i<piecesNeeded-1;i++){
newData.push({
rowNum:rowNum++,
item:row.item,
description:row.description||'Potrubie',
size:row.size,
qtyNeeded:pieceLengthMm,
qtyInStock:0,
qtyMissing:pieceLengthMm,
heatNumber:'',
isometric:row.isometric,
source:row.source,
unit:'mm'
});
}

// PoslednÃ½ kus (zvyÅ¡ok alebo plnÃ½ 6m)
var lastPieceLength=remainder>0?remainder:pieceLengthMm;
newData.push({
rowNum:rowNum++,
item:row.item,
description:row.description||'Potrubie',
size:row.size,
qtyNeeded:lastPieceLength,
qtyInStock:0,
qtyMissing:lastPieceLength,
heatNumber:'',
isometric:row.isometric,
source:row.source,
unit:'mm'
});

}else{
// Nie je PIPE - nechaj ako je
newData.push({
rowNum:rowNum++,
item:row.item,
description:row.description,
size:row.size,
qtyNeeded:row.qtyNeeded,
qtyInStock:row.qtyInStock,
qtyMissing:row.qtyMissing,
heatNumber:row.heatNumber,
isometric:row.isometric,
source:row.source
});
}
});

mtoGridData=newData;

if(mtoGrid && mtoGrid.api){
mtoGrid.api.setGridOption('rowData',mtoGridData);
}

saveMTOData();
updateMTOStats();
console.log('ğŸ”„ PIPE riadky rozdelenÃ© na 6m kusy');
}

function calculateMTOStock(){
// PrepoÄÃ­taj Missing stÄºpec pre vÅ¡etky riadky
if(mtoGrid && mtoGrid.api){
mtoGrid.api.refreshCells({columns:['qtyMissing'],force:true});
}
updateMTOStats();
}

function updateMTOStats(){
var totalItems=mtoGridData.length;
var missingItems=0;
var inStockItems=0;

mtoGridData.forEach(function(row){
var missing=Math.max(0,(row.qtyNeeded||0)-(row.qtyInStock||0));
if(missing>0)missingItems++;
if((row.qtyInStock||0)>0)inStockItems++;
});

document.getElementById('mtoTotalItems').textContent=totalItems;
document.getElementById('mtoMissingItems').textContent=missingItems;
document.getElementById('mtoInStockItems').textContent=inStockItems;

// TODO: SpoÄÃ­taj ready izometrie (kde je vÅ¡etok materiÃ¡l)
document.getElementById('mtoReadyIsos').textContent='0';
}

function importMaterialFromPDF(){
// OtvorÃ­ file picker pre PDF sÃºbory
var input=document.createElement('input');
input.type='file';
input.accept='.pdf';
input.multiple=true;
input.onchange=async function(e){
var files=Array.from(e.target.files);
if(files.length===0)return;

alert('â³ SpracovÃ¡vam '+files.length+' PDF sÃºborov...\n\nPoÄkajte prosÃ­m.');

// Clear previous data for this source
mtoData.isometricMaterials={};

for(var i=0;i<files.length;i++){
var file=files[i];
try{
console.log('ğŸ“„ Parsing:',file.name);
var text=await extractPDFText(file);
var materials=parseMaterialsFromPDF(text);

// UloÅ¾iÅ¥ do mtoData
var isoName=file.name.replace('.pdf','');
mtoData.isometricMaterials[isoName]=materials.map(function(mat){
return {
item:mat.type||mat.description||'',  // Parser vracia "type"
description:mat.description||'',
size:mat.dimensions||mat.size||'',
qtyNeeded:parseFloat(mat.qty)||0,
qtyInStock:0,
qtyMissing:parseFloat(mat.qty)||0,
heatNumber:''
};
});

console.log('âœ…',file.name,':',materials.length,'materiÃ¡lov');
}catch(err){
console.error('âŒ Chyba pri',file.name,':',err);
}
}

// Rebuild grid
saveMTOData();
buildMTOData();

alert('âœ… Hotovo! NaÄÃ­tanÃ½ch '+files.length+' izometriÃ­.\n\nKliknite "ğŸ”„ RozdeliÅ¥ PIPE riadky" pre rozdelenie PIPE na 6m kusy.');
};

input.click();
}

function importDeliveryNote(){
var choice=prompt('Vyberte moÅ¾nosÅ¥:\n\n1 = CELKOVÃ‰ MTO (Excel celÃ©ho projektu)\n2 = DodacÃ­ list (Excel s Heat numbers)\n3 = ManuÃ¡lne zadanie','1');

if(choice==='1'){
importCelkoveMTO();
}else if(choice==='2'){
importDeliveryNoteExcel();
}else if(choice==='3'){
addMTORow();
}
}

function importCelkoveMTO(){
// Import celkovÃ©ho MTO z Excel sÃºboru
var input=document.createElement('input');
input.type='file';
input.accept='.xlsx,.xls,.csv';
input.onchange=function(e){
var file=e.target.files[0];
if(!file)return;

var reader=new FileReader();
reader.onload=function(event){
try{
var data=new Uint8Array(event.target.result);
var workbook=XLSX.read(data,{type:'array'});
var sheetName=workbook.SheetNames[0];
var sheet=workbook.Sheets[sheetName];
var json=XLSX.utils.sheet_to_json(sheet);

console.log('ğŸ“Š CELKOVÃ‰ MTO naÄÃ­tanÃ©:',json.length,'riadkov');

// Parse materials
mtoData.materials=[];
json.forEach(function(row){
mtoData.materials.push({
item:row['Item']||row['item']||'',
description:row['Description']||row['description']||'',
size:row['Size']||row['size']||'',
qtyNeeded:parseFloat(row['Qty']||row['qty']||row['Quantity']||0),
qtyInStock:0,
qtyMissing:parseFloat(row['Qty']||row['qty']||row['Quantity']||0),
heatNumber:row['Heat']||row['heat']||row['HeatNumber']||''
});
});

saveMTOData();
buildMTOData();
alert('âœ… CELKOVÃ‰ MTO naÄÃ­tanÃ©: '+json.length+' poloÅ¾iek');
}catch(err){
console.error('âŒ Chyba pri ÄÃ­tanÃ­ Excel:',err);
alert('âŒ Chyba: '+err.message);
}
};
reader.readAsArrayBuffer(file);
};
input.click();
}

function importDeliveryNoteExcel(){
// Import dodacieho listu - doplnÃ­ Heat numbers do existujÃºceho MTO
var input=document.createElement('input');
input.type='file';
input.accept='.xlsx,.xls,.csv';
input.onchange=function(e){
var file=e.target.files[0];
if(!file)return;

var reader=new FileReader();
reader.onload=function(event){
try{
var data=new Uint8Array(event.target.result);
var workbook=XLSX.read(data,{type:'array'});
var sheetName=workbook.SheetNames[0];
var sheet=workbook.Sheets[sheetName];
var json=XLSX.utils.sheet_to_json(sheet);

console.log('ğŸ“¦ DodacÃ­ list naÄÃ­tanÃ½:',json.length,'riadkov');

var matched=0;

// HÄ¾adaj zhody a doplÅˆ Heat numbers + In Stock
json.forEach(function(deliveryRow){
var item=deliveryRow['Item']||deliveryRow['item']||'';
var size=deliveryRow['Size']||deliveryRow['size']||'';
var heat=deliveryRow['Heat']||deliveryRow['heat']||deliveryRow['HeatNumber']||'';
var qty=parseFloat(deliveryRow['Qty']||deliveryRow['qty']||deliveryRow['Quantity']||0);

// NÃ¡jdi v MTO grid
mtoGridData.forEach(function(row){
if(row.item===item && row.size===size && !row.heatNumber){
row.heatNumber=heat;
row.qtyInStock=qty;
matched++;
}
});
});

if(mtoGrid && mtoGrid.api){
mtoGrid.api.setGridOption('rowData',mtoGridData);
}

calculateMTOStock();
saveMTOData();
alert('âœ… DodacÃ­ list spracovanÃ½!\n\nDoplnenÃ½ch: '+matched+' Heat numbers');
}catch(err){
console.error('âŒ Chyba:',err);
alert('âŒ Chyba: '+err.message);
}
};
reader.readAsArrayBuffer(file);
};
input.click();
}

function exportMTOExcel(){
alert('ğŸ’¾ Export do Excel - funkcia v implementÃ¡cii');
// TODO: Export MTO grid to Excel
}

function buildNotificationList(){
var list=document.getElementById('notificationList');
if(notifications.length===0){
list.innerHTML='<div style="text-align:center;color:#999;padding:20px">Å½iadne notifikÃ¡cie</div>';
return;
}

var html='';
notifications.forEach(function(notif){
var date=new Date(notif.timestamp);
var dateStr=date.toLocaleDateString('sk-SK')+' '+date.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'});

html+='<div style="background:#f9f9f9;border:1px solid #ddd;border-radius:4px;padding:12px;margin-bottom:8px;position:relative">';
html+='<button onclick="removeNotification(\''+notif.id+'\')" style="position:absolute;top:8px;right:8px;background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:12px">âœ•</button>';
html+='<div style="font-size:13px;color:#333;margin-bottom:5px;padding-right:40px">'+notif.message+'</div>';
html+='<div style="font-size:11px;color:#666">'+dateStr+'</div>';
html+='</div>';
});

list.innerHTML=html;
}

// ============= QR SCANNER SYSTÃ‰M =============
var qrStream=null;
var qrScannerActive=false;
var currentSpoolForQR=null;

function openQRScanner(spoolId){
currentSpoolForQR=spoolId;
document.getElementById('qrScannerModal').style.display='block';
document.getElementById('qrResult').style.display='none';
document.getElementById('qrError').style.display='none';
startQRScanner();
}

function closeQRScanner(){
stopQRScanner();
document.getElementById('qrScannerModal').style.display='none';
document.getElementById('qrScannerDoneBtn').style.display='none';
currentSpoolForQR=null;
}

function startQRScanner(){
var video=document.getElementById('qrVideo');
var canvas=document.getElementById('qrCanvas');
var ctx=canvas.getContext('2d');

// PoÅ¾iadaj o prÃ­stup ku kamere
navigator.mediaDevices.getUserMedia({
video:{facingMode:'environment'} // ZadnÃ¡ kamera na mobile
}).then(function(stream){
qrStream=stream;
video.srcObject=stream;
qrScannerActive=true;
console.log('ğŸ“· Kamera spustenÃ¡');

// ZaÄni skenovaÅ¥
requestAnimationFrame(scanQRCode);
}).catch(function(err){
console.error('âŒ Chyba prÃ­stupu ku kamere:',err);
document.getElementById('qrError').style.display='block';
document.getElementById('qrErrorText').textContent='Nie je moÅ¾nÃ© zÃ­skaÅ¥ prÃ­stup ku kamere. PovoÄ¾te prÃ­stup v nastaveniach prehliadaÄa.';
});
}

function scanQRCode(){
if(!qrScannerActive)return;

var video=document.getElementById('qrVideo');
var canvas=document.getElementById('qrCanvas');
var ctx=canvas.getContext('2d');

if(video.readyState===video.HAVE_ENOUGH_DATA){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.drawImage(video,0,0,canvas.width,canvas.height);

var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
var code=jsQR(imageData.data,imageData.width,imageData.height);

if(code){
console.log('âœ… QR kÃ³d naskenovanÃ½:',code.data);
onQRCodeScanned(code.data);
return; // Stop scanning
}
}

requestAnimationFrame(scanQRCode);
}

function stopQRScanner(){
qrScannerActive=false;
if(qrStream){
qrStream.getTracks().forEach(function(track){
track.stop();
});
qrStream=null;
console.log('ğŸ“· Kamera zastavenÃ¡');
}
}

function onQRCodeScanned(qrData){
stopQRScanner();

// Zobraz vÃ½sledok
document.getElementById('qrResult').style.display='block';
document.getElementById('qrResultText').textContent=qrData;

// UloÅ¾ QR kÃ³d k spoolu
if(currentSpoolForQR){
var spool=spools.find(function(s){return s.id===currentSpoolForQR;});
if(spool){
spool.qrCode=qrData;
kontrolaData.qrCodes=kontrolaData.qrCodes||{};
kontrolaData.qrCodes[spool.id]=qrData;
saveKontrolaData();
buildSpoolListTable();
console.log('âœ… QR kÃ³d priradenÃ½ k spoolu',spool.displayNum);

// AutomatickÃ© zatvorenie po 2 sekundÃ¡ch
setTimeout(function(){
closeQRScanner();
},2000);
}
}
}

function loadVyrobaData(){
if(!projectsData.currentProject)return;
var key='vyroba_'+projectsData.currentProject;
var saved=localStorage.getItem(key);
if(saved){
vyrobaData=JSON.parse(saved);
console.log('ğŸ“‚ VÃ½roba data naÄÃ­tanÃ©');
}else{
vyrobaData={};
}
}

function saveVyrobaData(){
if(!projectsData.currentProject)return;
var key='vyroba_'+projectsData.currentProject;
localStorage.setItem(key,JSON.stringify(vyrobaData));
console.log('ğŸ’¾ VÃ½roba data uloÅ¾enÃ© do localStorage');

// UloÅ¾iÅ¥ aj do Firebase
saveProjectsToFirebase();
}

function loadIsometries(files){
if(!files || files.length===0)return;
console.log('ğŸ“‚ NaÄÃ­tavam',files.length,'izometriÃ­');

for(var i=0;i<files.length;i++){
var file=files[i];
var fileName=file.name.replace(/\.[^/.]+$/,'');
if(!vyrobaData[fileName]){
vyrobaData[fileName]={
started:false,
completed:false,
startedDate:'',
completedDate:''
};
}
}

saveVyrobaData();
alert('NaÄÃ­tanÃ½ch '+files.length+' izometriÃ­!');
console.log('âœ… Izometrie pridanÃ© do vÃ½roby');
}

function showVyrobaList(){
document.getElementById('vyrobaListModal').style.display='block';
buildVyrobaListTable();
console.log('ğŸ“‹ OtvÃ¡ram zoznam vÃ½roby');
}

function closeVyrobaList(){
document.getElementById('vyrobaListModal').style.display='none';
document.getElementById('vyrobaSearchInput').value='';
}

function buildVyrobaListTable(){
var tbody=document.getElementById('vyrobaListBody');
tbody.innerHTML='';

var isoNames=Object.keys(vyrobaData).sort();

if(isoNames.length===0){
tbody.innerHTML='<tr><td colspan="3" style="padding:20px;text-align:center;color:#999">Å½iadne izometrie<br>PouÅ¾ite tlaÄidlo "ğŸ“‚ NaÄÃ­taÅ¥ izometrie"</td></tr>';
return;
}

isoNames.forEach(function(isoName,index){
var data=vyrobaData[isoName];
var tr=document.createElement('tr');
tr.style.background=index%2===0?'#fff':'#f9f9f9';

var startedIcon=data.started?'â˜‘':'â˜';
var startedColor=data.started?'#10b981':'#999';
var completedIcon=data.completed?'â˜‘':'â˜';
var completedColor=data.completed?'#10b981':'#999';

var startedDate=data.startedDate||'';
var completedDate=data.completedDate||'';

tr.innerHTML='<td style="padding:10px;border:1px solid #ddd;font-weight:600">'+isoName+'</td>'+
'<td style="padding:10px;border:1px solid #ddd">'+
'<div style="display:flex;align-items:center;gap:10px">'+
'<span onclick="toggleVyrobaStarted(\''+isoName+'\')" style="cursor:pointer;font-size:20px;color:'+startedColor+'">'+startedIcon+'</span>'+
'<span style="font-size:11px;color:#666">ZaÄatÃ¡</span>'+
'<input type="date" value="'+startedDate+'" onchange="setVyrobaStartedDate(\''+isoName+'\',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:3px;font-size:11px">'+
'</div>'+
'</td>'+
'<td style="padding:10px;border:1px solid #ddd">'+
'<div style="display:flex;align-items:center;gap:10px">'+
'<span onclick="toggleVyrobaCompleted(\''+isoName+'\')" style="cursor:pointer;font-size:20px;color:'+completedColor+'">'+completedIcon+'</span>'+
'<span style="font-size:11px;color:#666">UkonÄenÃ¡</span>'+
'<input type="date" value="'+completedDate+'" onchange="setVyrobaCompletedDate(\''+isoName+'\',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:3px;font-size:11px">'+
'</div>'+
'</td>';

tbody.appendChild(tr);
});

console.log('ğŸ“Š VÃ½roba tabulka obsahuje',isoNames.length,'izometriÃ­');
}

function filterVyrobaList(){
var searchText=document.getElementById('vyrobaSearchInput').value.toLowerCase();
var tbody=document.getElementById('vyrobaListBody');
var rows=tbody.getElementsByTagName('tr');

for(var i=0;i<rows.length;i++){
var row=rows[i];
var firstCell=row.cells[0];
if(firstCell){
var isoText=firstCell.textContent.toLowerCase();
if(isoText.indexOf(searchText)>-1){
row.style.display='';
}else{
row.style.display='none';
}
}
}
}

function toggleVyrobaStarted(isoName){
vyrobaData[isoName].started=!vyrobaData[isoName].started;
// Auto-nastavenie dÃ¡tumu ak je zaÄatÃ© a dÃ¡tum je prÃ¡zdny
if(vyrobaData[isoName].started && !vyrobaData[isoName].startedDate){
vyrobaData[isoName].startedDate=new Date().toISOString().split('T')[0];
}
saveVyrobaData();
buildVyrobaListTable();
console.log('âœ“ ZaÄatÃ¡ predvÃ½roba:',isoName,vyrobaData[isoName].started);
}

function toggleVyrobaCompleted(isoName){
vyrobaData[isoName].completed=!vyrobaData[isoName].completed;
// Auto-nastavenie dÃ¡tumu ak je ukonÄenÃ© a dÃ¡tum je prÃ¡zdny
if(vyrobaData[isoName].completed && !vyrobaData[isoName].completedDate){
vyrobaData[isoName].completedDate=new Date().toISOString().split('T')[0];
}
saveVyrobaData();
buildVyrobaListTable();
console.log('âœ“ UkonÄenÃ¡ predvÃ½roba:',isoName,vyrobaData[isoName].completed);
}

function setVyrobaStartedDate(isoName,date){
vyrobaData[isoName].startedDate=date;
saveVyrobaData();
console.log('ğŸ“… ZaÄatÃ¡ predvÃ½roba dÃ¡tum:',isoName,date);
}

function setVyrobaCompletedDate(isoName,date){
vyrobaData[isoName].completedDate=date;
saveVyrobaData();
console.log('ğŸ“… UkonÄenÃ¡ predvÃ½roba dÃ¡tum:',isoName,date);
}

function refreshSpoolList(){
loadKontrolaData();
buildSpoolListTable();
console.log('ğŸ”„ Zoznam obnovenÃ½');
}

function filterSpoolList(){
var searchText=document.getElementById('spoolSearchInput').value.toLowerCase();
var tbody=document.getElementById('spoolListBody');
var rows=tbody.getElementsByTagName('tr');

for(var i=0;i<rows.length;i++){
var row=rows[i];
var isoCell=row.cells[0];
if(isoCell){
var isoText=isoCell.textContent.toLowerCase();
if(isoText.indexOf(searchText)>-1){
row.style.display='';
}else{
row.style.display='none';
}
}
}
console.log('ğŸ” Filter:',searchText);
}

function exportSpoolListToExcel(){
var csv='Izometria,Spool,Pocet zvarov,Zvary\n';
var tbody=document.getElementById('spoolListBody');
var rows=tbody.getElementsByTagName('tr');

for(var i=0;i<rows.length;i++){
var row=rows[i];
if(row.style.display==='none')continue;
var cells=row.cells;
if(cells.length>=3){
var iso=cells[0].textContent;
var spool=cells[1].textContent;
var count=cells[2].textContent;

// ZÃ­skaj zvary pre tento spool
var spoolObj=spools.find(function(s){return s.displayNum===spool;});
if(spoolObj){
var spoolWelds=ws.filter(function(w){
var weldX=w.end.x*ca.width;
var weldY=w.end.y*ca.height;
var spoolStartX=spoolObj.start.x;
var spoolStartY=spoolObj.start.y;
var spoolEndX=spoolObj.end.x;
var spoolEndY=spoolObj.end.y;
var A=weldX-spoolStartX;
var B=weldY-spoolStartY;
var C=spoolEndX-spoolStartX;
var D=spoolEndY-spoolStartY;
var dot=A*C+B*D;
var lenSq=C*C+D*D;
var param=lenSq!==0?dot/lenSq:-1;
if(param<0 || param>1)return false;
var xx=spoolStartX+param*C;
var yy=spoolStartY+param*D;
var dist=Math.sqrt(Math.pow(weldX-xx,2)+Math.pow(weldY-yy,2));
return dist<30;
});
var weldNumbers=spoolWelds.map(function(w){return w.displayNum;}).join(';');
csv+='"'+iso+'","'+spool+'","'+count+'","'+weldNumbers+'"\n';
}
}
}

var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
var link=document.createElement('a');
link.href=URL.createObjectURL(blob);
link.download='spool_list_'+projectsData.currentPart+'_'+(new Date().toISOString().split('T')[0])+'.csv';
link.click();
console.log('ğŸ“Š Excel export hotovÃ½');
}

function ex(){
var pr=document.getElementById('proj').value||'P001';
var tx='Projekt,Zvar,Start_X,Start_Y,End_X,End_Y\n';
ws.forEach(function(w){
tx+=pr+','+pr+'-'+String(w.displayNum).padStart(3,'0')+','+Math.round(w.start.x)+','+Math.round(w.start.y)+','+Math.round(w.end.x)+','+Math.round(w.end.y)+'\n';
});
var bl=new Blob([tx],{type:'text/csv'});
var ur=URL.createObjectURL(bl);
var a=document.createElement('a');
a.href=ur;
a.download=(originalFileName||'zvary')+'.csv';
a.click();
}

function saveProject(){
var pdfDataUrl='';
if(pd){
  // UloÅ¾ PDF v PLNOM rozlÃ­Å¡enÃ­ (nie Å¡kÃ¡lovanÃ©!)
  var canvas=document.createElement('canvas');
  var ctx=canvas.getContext('2d');
  
  // PouÅ¾ij ORIGINÃLNU veÄ¾kosÅ¥ PDF, nie zoom
  pd.getPage(1).then(function(pg){
    var viewport = pg.getViewport({scale: 1.4}); // OptimÃ¡lne rozlÃ­Å¡enie 1.4x
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    ctx.imageSmoothingEnabled = false;
    
    pg.render({canvasContext: ctx, viewport: viewport}).promise.then(function(){
      pdfDataUrl = canvas.toDataURL('image/png', 0.95); // VysokÃ¡ kvalita
      savePDFData();
    });
  });
  return; // Async operÃ¡cia
} else if(loadedImage && baseImageWidth > 0){
  // Ak je naÄÃ­tanÃ© z kniÅ¾nice, pouÅ¾ij originÃ¡lnu veÄ¾kosÅ¥
  var canvas=document.createElement('canvas');
  var ctx=canvas.getContext('2d');
  canvas.width = baseImageWidth;
  canvas.height = baseImageHeight;
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(loadedImage, 0, 0, baseImageWidth, baseImageHeight);
  pdfDataUrl = canvas.toDataURL('image/png', 0.95);
} else if(ca.width>0){
  pdfDataUrl=ca.toDataURL('image/png', 0.95);
}

savePDFData();

function savePDFData(){
var projectData={
welds:ws,
spools:spools,
crosses:crosses,
dimensions:dimensions,
lines:lines,
arrows:arrows,
texts:texts,
curves:curves,
spoolData:spoolData,
materials:weldLogMaterials,
weldAssignments:weldAssignments,
currentNumber:cn,
startNumber:startNum,
projectName:originalFileName||'zvary',
weldScale:weldScale,
scale:sc,
canvasWidth:baseImageWidth || ca.width,
canvasHeight:baseImageHeight || ca.height,
pdfData:pdfDataUrl,
savedDate:new Date().toISOString()
};
var json=JSON.stringify(projectData);
var bl=new Blob([json],{type:'application/json'});
var ur=URL.createObjectURL(bl);
var a=document.createElement('a');
a.href=ur;
a.download=(originalFileName||'zvary')+'_projekt.json';
a.click();
URL.revokeObjectURL(ur);
alert('âœ… Projekt uloÅ¾enÃ½!\n\nSÃºbor: '+(originalFileName||'zvary')+'_projekt.json\nZvarov: '+ws.length+'\nVeÄ¾kosÅ¥: ~'+(json.length/1024/1024).toFixed(1)+' MB');
}
}

// UloÅ¾iÅ¥ do Firebase kniÅ¾nice
async function saveToLibrary(){
var pdfDataUrl='';

// Funkcia na uloÅ¾enie dÃ¡t
async function uploadData(){
  console.log('ğŸ’¾ UKLADANIE DO KNIÅ½NICE - DEBUG:');
  console.log('  ws.length:', ws.length);
  console.log('  spools.length:', spools.length);
  console.log('  arrows.length:', arrows.length);
  console.log('  texts.length:', texts.length);
  console.log('  lines.length:', lines.length);
  
  var projectData={
  welds:ws,
  spools:spools,
  crosses:crosses,
  dimensions:dimensions,
  lines:lines,
  arrows:arrows,
  texts:texts,
  curves:curves,
  spoolData:spoolData,
  materials:weldLogMaterials,
  weldAssignments:weldAssignments,
  weldBookData:weldBookData,  // âœ… PRIDANÃ‰: WeldBook dÃ¡ta pre Firebase!
  currentNumber:cn,
  startNumber:startNum,
  projectName:originalFileName||'zvary',
  partName:projectsData.currentPart,
  weldScale:weldScale,
  scale:sc,
  canvasWidth:baseImageWidth || ca.width,
  canvasHeight:baseImageHeight || ca.height,
  pdfData:pdfDataUrl,
  savedDate:new Date().toISOString()
  };
  
  console.log('ğŸ’¾ ProjectData vytvorenÃ©:', {
    welds: projectData.welds.length,
    projectName: projectData.projectName,
    partName: projectData.partName
  });
  try{
  await uploadProjectToFirebase(projectData);
  alert('âœ… Projekt uloÅ¾enÃ½ do kniÅ¾nice!');
  }catch(e){
  alert('âŒ Chyba pri ukladanÃ­:\n'+e.message);
  console.error('Upload error:',e);
  }
}

if(pd){
  // PDF v plnom rozlÃ­Å¡enÃ­
  var canvas=document.createElement('canvas');
  var ctx=canvas.getContext('2d');
  pd.getPage(1).then(function(pg){
    var viewport = pg.getViewport({scale: 1.4});
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    ctx.imageSmoothingEnabled = false;
    pg.render({canvasContext: ctx, viewport: viewport}).promise.then(function(){
      pdfDataUrl = canvas.toDataURL('image/png', 0.95);
      uploadData();
    });
  });
} else if(loadedImage && baseImageWidth > 0){
  // OriginÃ¡lna veÄ¾kosÅ¥ z kniÅ¾nice
  var canvas=document.createElement('canvas');
  var ctx=canvas.getContext('2d');
  canvas.width = baseImageWidth;
  canvas.height = baseImageHeight;
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(loadedImage, 0, 0, baseImageWidth, baseImageHeight);
  pdfDataUrl = canvas.toDataURL('image/png', 0.95);
  await uploadData();
} else if(ca.width>0){
  pdfDataUrl=ca.toDataURL('image/png', 0.95);
  await uploadData();
}
}

document.getElementById('loadproj').onchange=function(e){
var fi=e.target.files[0];
if(!fi)return;
var rd=new FileReader();
rd.onload=function(){
try{
var projectData=JSON.parse(this.result);
if(!projectData.welds){
alert('âŒ NeplatnÃ½ projekt sÃºbor!');
return;
}
// VYÄŒISTIÅ¤ VÅ ETKO PRED NAÄŒÃTANÃM NOVÃ‰HO PROJEKTU!
console.log('ğŸ§¹ ÄŒistenie starÃ½ch dÃ¡t pred naÄÃ­tanÃ­m...');
ws=[];
spools=[];
crosses=[];
dimensions=[];
lines=[];
arrows=[];
texts=[];
curves=[];
spoolData=[];
weldLogMaterials=[];
weldAssignments={};

ws=projectData.welds||[];
spools=projectData.spools||[];
crosses=projectData.crosses||[];
dimensions=projectData.dimensions||[];
lines=projectData.lines||[];
arrows=projectData.arrows||[];
texts=projectData.texts||[];
curves=projectData.curves||[];
spoolData=projectData.spoolData||[];
weldLogMaterials=projectData.materials||[];
weldAssignments=projectData.weldAssignments||{};
cn=projectData.currentNumber||1;
startNum=projectData.startNumber||1;
originalFileName=projectData.projectName||'zvary';
weldScale=projectData.weldScale||1.0;
document.getElementById('weldScaleDisplay').textContent = Math.round(weldScale * 100) + '%';
console.log('ğŸ“ Loaded weldScale:', weldScale);
var fileNameSpan=document.getElementById('fileName');
if(fileNameSpan)fileNameSpan.textContent=originalFileName+'.json';
var startInput=document.getElementById('startNumInput');
if(startInput)startInput.value=startNum;
if(projectData.pdfData){
var img=new Image();
img.onload=function(){
ca.width=img.width;
ca.height=img.height;
ov.setAttribute('width',img.width);
ov.setAttribute('height',img.height);
ct.clearRect(0,0,ca.width,ca.height);
ct.drawImage(img,0,0);
document.getElementById('up').style.display='none';
document.getElementById('cw').style.display='block';
document.getElementById('zoomInfo').style.display='block';
document.getElementById('zi').disabled=false;
document.getElementById('zo').disabled=false;
document.getElementById('zr').disabled=false;
document.getElementById('savepdf').disabled=false;
document.getElementById('saveproj').disabled=false;document.getElementById('savetolibrary').disabled=false;
document.getElementById('loadprojbtn').disabled=false;
if(document.getElementById('savetolibrary'))document.getElementById('savetolibrary').disabled=false;
document.getElementById('editmode').disabled=false;
document.getElementById('editcrossmode').disabled=false;
document.getElementById('setstart').disabled=false;
document.getElementById('selectbtn').disabled=false;
document.getElementById('crossbtn').disabled=false;
document.getElementById('spoolbtn').disabled=false;document.getElementById('spoollistbtn').disabled=false;document.getElementById('refreshspoolbtn').disabled=false;document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;document.getElementById('spoolspreview').disabled=false;document.getElementById('montaz_linebtn').disabled=false;document.getElementById('montaz_textbtn').disabled=false;document.getElementById('montaz_curvebtn').disabled=false;document.getElementById('montaz_arrowbtn').disabled=false;document.getElementById('montaz_doublearrowbtn').disabled=false;
document.getElementById('weldlogbtn').disabled=false;
document.getElementById('oneclickbtn').disabled=false;
document.getElementById('twoclickbtn').disabled=false;document.getElementById('weldscaleminus').disabled=false;document.getElementById('weldscaleplus').disabled=false;
document.getElementById('mtobtn').disabled=false;document.getElementById('dimensionbtn').disabled=false;document.getElementById('prefab_linebtn').disabled=false;document.getElementById('prefab_textbtn').disabled=false;document.getElementById('prefab_arrowbtn').disabled=false;document.getElementById('prefab_doublearrowbtn').disabled=false;document.getElementById('prefab_curvebtn').disabled=false;document.getElementById('linebtn').disabled=false;document.getElementById('textbtn').disabled=false;document.getElementById('curvebtn').disabled=false;document.getElementById('arrowbtn').disabled=false;document.getElementById('doublearrowbtn').disabled=false;document.getElementById('undo').disabled=false;
dw();
up();
var weldLogPanel=document.getElementById('weldLogPanel');
if(weldLogPanel&&weldLogPanel.classList.contains('active')){
loadWeldLog();
}
alert('âœ… Projekt naÄÃ­tanÃ½!\n\nSÃºbor: '+originalFileName+'\nZvarov: '+ws.length+'\nMateriÃ¡lov: '+weldLogMaterials.length+'\nVÃ½berov FROM/TO: '+Object.keys(weldAssignments).length+'\nDÃ¡tum: '+new Date(projectData.savedDate).toLocaleString('sk-SK'));
};
img.src=projectData.pdfData;
}else{
up();
dw();
if(document.getElementById('savetolibrary'))document.getElementById('savetolibrary').disabled=false;
alert('âœ… Projekt naÄÃ­tanÃ½!\n\nZvarov: '+ws.length+'\nâš ï¸ PDF obrÃ¡zok chÃ½ba - nahrajte PDF manuÃ¡lne.');
}
}catch(err){
alert('âŒ Chyba pri naÄÃ­tavanÃ­ projektu:\n'+err.message);
}
};
rd.readAsText(fi);
this.value='';
};

async function savePDF(){
// Priamy export (bez modalu)
console.log('ğŸ“„ Exportujem PDF s weldScale:', weldScale);
await exportPDFActual();
}

async function exportPDFActual(){
const progressContainer=document.getElementById('progressContainer');
const progressBar=document.getElementById('progressBar');
const progressText=document.getElementById('progressText');
const saveBtn=document.getElementById('savepdf');

saveBtn.disabled=true;
progressContainer.style.display='block';

function updateProgress(percent){
progressBar.style.width=percent+'%';
progressText.textContent=Math.round(percent)+'%';
}

try{
updateProgress(10);

const tempCanvas=document.createElement('canvas');
const tempCtx=tempCanvas.getContext('2d',{alpha:false,desynchronized:true});

const dpi=600;
const pdfWidth=420;
const pdfHeight=297;
tempCanvas.width=(pdfWidth*dpi)/25.4;
tempCanvas.height=(pdfHeight*dpi)/25.4;

updateProgress(25);

const scaleFactor=Math.min(tempCanvas.width/ca.width,tempCanvas.height/ca.height);
const offsetX=(tempCanvas.width-ca.width*scaleFactor)/2;
const offsetY=(tempCanvas.height-ca.height*scaleFactor)/2;

tempCtx.fillStyle='white';
tempCtx.fillRect(0,0,tempCanvas.width,tempCanvas.height);

updateProgress(40);

tempCtx.save();
tempCtx.translate(offsetX,offsetY);
tempCtx.scale(scaleFactor,scaleFactor);
tempCtx.drawImage(ca,0,0);

updateProgress(60);

const batchSize=100;
for(let i=0;i<ws.length;i+=batchSize){
const batch=ws.slice(i,i+batchSize);

batch.forEach(function(w){
var startX=w.start.x*ca.width;
var startY=w.start.y*ca.height;
var endX=w.end.x*ca.width;
var endY=w.end.y*ca.height;
var dx=endX-startX;
var dy=endY-startY;
var len=Math.sqrt(dx*dx+dy*dy);
var numLen=String(w.displayNum).length;
// âœ… Radius nezÃ¡vislÃ½ na zoom
var baseRadius=22;
if(numLen>=4)baseRadius=30;
else if(numLen>=3)baseRadius=26;
else if(numLen>=2)baseRadius=24;
// Normalizuj radius na pÃ´vodnÃ½ canvas A aplikuj weldScale!
var radius = baseImageWidth > 0 ? baseRadius * (baseImageWidth / ca.width) * weldScale : baseRadius * weldScale;
var ratio=(len-radius)/len;
var lineEndX=startX+dx*ratio;
var lineEndY=startY+dy*ratio;

tempCtx.strokeStyle='#FF0000';
tempCtx.lineWidth=2.5*weldScale;
tempCtx.beginPath();
tempCtx.moveTo(startX,startY);
tempCtx.lineTo(lineEndX,lineEndY);
tempCtx.stroke();

var hasCross=crosses.some(function(c){return c.weldId===w.id;});
if(hasCross){
var crossSize=8*weldScale;
tempCtx.strokeStyle='#FF0000';
tempCtx.lineWidth=3*weldScale;
tempCtx.beginPath();
tempCtx.moveTo(startX-crossSize,startY-crossSize);
tempCtx.lineTo(startX+crossSize,startY+crossSize);
tempCtx.moveTo(startX-crossSize,startY+crossSize);
tempCtx.lineTo(startX+crossSize,startY-crossSize);
tempCtx.stroke();
}

tempCtx.strokeStyle='#FF0000';
tempCtx.lineWidth=2*weldScale;
tempCtx.beginPath();
tempCtx.arc(endX,endY,radius,0,Math.PI*2);
tempCtx.stroke();

// âœ… Font-size nezÃ¡vislÃ½ na zoom A aplikuj weldScale!
var baseFontSize=34;
if(numLen>=4)baseFontSize=24;
else if(numLen>=3)baseFontSize=28;
else if(numLen>=2)baseFontSize=30;
// Normalizuj font-size na pÃ´vodnÃ½ canvas A aplikuj weldScale!
var fontSize = baseImageWidth > 0 ? baseFontSize * (baseImageWidth / ca.width) * weldScale : baseFontSize * weldScale;

tempCtx.fillStyle='#FF0000';
tempCtx.font=fontSize+'px Arial';
tempCtx.textAlign='center';
tempCtx.textBaseline='middle';
tempCtx.fillText(w.displayNum,endX,endY);
});

dimensions.forEach(function(dim){
var dimX=dim.x*ca.width;
var dimY=dim.y*ca.height;
tempCtx.fillStyle='#FF0000';
tempCtx.font='bold 28px Arial';
tempCtx.textAlign='center';
tempCtx.textBaseline='middle';
tempCtx.fillText(dim.text,dimX,dimY);
});

const progress=60+(i/ws.length)*25;
updateProgress(progress);
}

// LAYER SYSTEM - krÃ­Å¾iky a spooly len ak je PREFABRIKÃCIA
if(activeTab==='prefab'){
console.log('ğŸ“¦ PDF export: PREFAB mode - pridÃ¡vam krÃ­Å¾iky a spooly');

// KrÃ­Å¾iky
crosses.forEach(function(c){
var crossX=c.pos.x*ca.width;
var crossY=c.pos.y*ca.height;
var crossSize=13.2;
tempCtx.strokeStyle='#FF0000';
tempCtx.lineWidth=4;
tempCtx.beginPath();
tempCtx.moveTo(crossX-crossSize,crossY-crossSize);
tempCtx.lineTo(crossX+crossSize,crossY+crossSize);
tempCtx.stroke();
tempCtx.beginPath();
tempCtx.moveTo(crossX-crossSize,crossY+crossSize);
tempCtx.lineTo(crossX+crossSize,crossY-crossSize);
tempCtx.stroke();
});

// Spooly
spools.forEach(function(s){
var startX=s.start.x*ca.width;
var startY=s.start.y*ca.height;
var endX=s.end.x*ca.width;
var endY=s.end.y*ca.height;
var dx=endX-startX;
var dy=endY-startY;
var len=Math.sqrt(dx*dx+dy*dy);
var textLen=String(s.displayNum).length;
var radius=30;
if(textLen>=4)radius=36;
else if(textLen>=3)radius=33;
var ratio=(len-radius)/len;
var lineEndX=startX+dx*ratio;
var lineEndY=startY+dy*ratio;

tempCtx.strokeStyle='#FF0000';
tempCtx.lineWidth=3;
tempCtx.beginPath();
tempCtx.moveTo(startX,startY);
tempCtx.lineTo(lineEndX,lineEndY);
tempCtx.stroke();

tempCtx.beginPath();
tempCtx.arc(endX,endY,radius,0,2*Math.PI);
tempCtx.strokeStyle='#FF0000';
tempCtx.lineWidth=1.5;
tempCtx.stroke();

var fontSize=44;
if(textLen>=4)fontSize=31;
else if(textLen>=3)fontSize=36;

tempCtx.fillStyle='#FF0000';
tempCtx.font=fontSize+'px Arial';
tempCtx.textAlign='center';
tempCtx.textBaseline='middle';
tempCtx.fillText(s.displayNum,endX,endY);
});

// PalliÄky
lines.forEach(function(line){
var x1=line.start.x*ca.width;
var y1=line.start.y*ca.height;
var x2=line.end.x*ca.width;
var y2=line.end.y*ca.height;
tempCtx.strokeStyle=line.color;
tempCtx.lineWidth=line.width;
tempCtx.beginPath();
tempCtx.moveTo(x1,y1);
tempCtx.lineTo(x2,y2);
tempCtx.stroke();
});

// Å Ã­pky
arrows.forEach(function(arrow){
var x1=arrow.start.x*ca.width;
var y1=arrow.start.y*ca.height;
var x2=arrow.end.x*ca.width;
var y2=arrow.end.y*ca.height;
tempCtx.strokeStyle=arrow.color||'#FF0000';
tempCtx.lineWidth=arrow.width||2;
tempCtx.beginPath();
tempCtx.moveTo(x1,y1);
tempCtx.lineTo(x2,y2);
tempCtx.stroke();
// Å Ã­pka
var angle=Math.atan2(y2-y1,x2-x1);
var arrowSize=15;
var a1x=x2-arrowSize*Math.cos(angle-Math.PI/6);
var a1y=y2-arrowSize*Math.sin(angle-Math.PI/6);
var a2x=x2-arrowSize*Math.cos(angle+Math.PI/6);
var a2y=y2-arrowSize*Math.sin(angle+Math.PI/6);
tempCtx.beginPath();
tempCtx.moveTo(x2,y2);
tempCtx.lineTo(a1x,a1y);
tempCtx.moveTo(x2,y2);
tempCtx.lineTo(a2x,a2y);
tempCtx.stroke();
});

// Texty
texts.forEach(function(txt){
var txtX=txt.x*ca.width;
var txtY=txt.y*ca.height;
tempCtx.save();
tempCtx.translate(txtX,txtY);
if(txt.rotation)tempCtx.rotate(txt.rotation*Math.PI/180);
tempCtx.fillStyle=txt.color;
tempCtx.font='bold '+txt.size+'px Arial';
tempCtx.textAlign='start';
tempCtx.textBaseline='middle';
tempCtx.fillText(txt.text,0,0);
tempCtx.restore();
});

// OblÃºÄiky
curves.forEach(function(curve){
if(curve.points.length<2)return;
tempCtx.strokeStyle=curve.color||'#FF0000';
tempCtx.lineWidth=curve.width||2;
tempCtx.beginPath();
var firstPt=curve.points[0];
tempCtx.moveTo(firstPt.x*ca.width,firstPt.y*ca.height);
for(var i=1;i<curve.points.length;i++){
var pt=curve.points[i];
tempCtx.lineTo(pt.x*ca.width,pt.y*ca.height);
}
tempCtx.closePath();
tempCtx.stroke();
});

}else{
console.log('âœï¸ PDF export: RED PEN mode - zvary + text + Å¡Ã­pky + paliÄky');

// RED PEN: PaliÄky
lines.forEach(function(line){
var x1=line.start.x*ca.width;
var y1=line.start.y*ca.height;
var x2=line.end.x*ca.width;
var y2=line.end.y*ca.height;
tempCtx.strokeStyle=line.color||'#FF0000';
tempCtx.lineWidth=line.width||2;
tempCtx.beginPath();
tempCtx.moveTo(x1,y1);
tempCtx.lineTo(x2,y2);
tempCtx.stroke();
});

// RED PEN: Texty
texts.forEach(function(txt){
var txtX=txt.x*ca.width;
var txtY=txt.y*ca.height;
tempCtx.save();
tempCtx.translate(txtX,txtY);
if(txt.rotation)tempCtx.rotate(txt.rotation*Math.PI/180);
tempCtx.fillStyle=txt.color;
tempCtx.font='bold '+txt.size+'px Arial';
tempCtx.textAlign='start';
tempCtx.textBaseline='middle';
tempCtx.fillText(txt.text,0,0);
tempCtx.restore();
});

// RED PEN: Å Ã­pky
arrows.forEach(function(arrow){
var x1=arrow.start.x*ca.width;
var y1=arrow.start.y*ca.height;
var x2=arrow.end.x*ca.width;
var y2=arrow.end.y*ca.height;
tempCtx.strokeStyle=arrow.color||'#FF0000';
tempCtx.lineWidth=arrow.width||2;
tempCtx.beginPath();
tempCtx.moveTo(x1,y1);
tempCtx.lineTo(x2,y2);
tempCtx.stroke();
var angle=Math.atan2(y2-y1,x2-x1);
var arrowSize=15;
var a1x=x2-arrowSize*Math.cos(angle-Math.PI/6);
var a1y=y2-arrowSize*Math.sin(angle-Math.PI/6);
var a2x=x2-arrowSize*Math.cos(angle+Math.PI/6);
var a2y=y2-arrowSize*Math.sin(angle+Math.PI/6);
tempCtx.beginPath();
tempCtx.moveTo(x2,y2);
tempCtx.lineTo(a1x,a1y);
tempCtx.moveTo(x2,y2);
tempCtx.lineTo(a2x,a2y);
tempCtx.stroke();
});
}

tempCtx.restore();

updateProgress(90);

const{jsPDF}=window.jspdf;
const pdf=new jsPDF('l','mm','a3');
const imgData=tempCanvas.toDataURL('image/jpeg',1.0);
pdf.addImage(imgData,'JPEG',0,0,pdfWidth,pdfHeight,undefined,'FAST');

updateProgress(95);

const projEl=document.getElementById('proj');
const pr=(projEl?projEl.value:null)||originalFileName||'Zvary';
pdf.save(pr+'.pdf');

updateProgress(100);

setTimeout(function(){
progressContainer.style.display='none';
progressBar.style.width='0%';
saveBtn.disabled=false;
},500);

}catch(error){
alert('Chyba pri ukladanÃ­ PDF: '+error.message);
progressContainer.style.display='none';
progressBar.style.width='0%';
saveBtn.disabled=false;
}
}

async function renderPDFPreview(){
console.log('ğŸ¨ Rendering PDF preview with weldScale:', weldScale);
const previewCanvas = document.getElementById('pdfPreviewCanvas');
const previewCtx = previewCanvas.getContext('2d');
const tempCanvas = document.createElement('canvas');
const tempCtx = tempCanvas.getContext('2d');
const pdfWidth = 420;
const pdfHeight = 297;
const scale = 3;
tempCanvas.width = pdfWidth * scale;
tempCanvas.height = pdfHeight * scale;
tempCtx.fillStyle = '#FFFFFF';
tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
if(pd){
await pd.getPage(1).then(async function(page){
const viewport = page.getViewport({scale: scale * 1.4});
await page.render({canvasContext: tempCtx, viewport: viewport}).promise;
});
}else if(loadedImage){
tempCtx.drawImage(loadedImage, 0, 0, tempCanvas.width, tempCanvas.height);
}
tempCtx.save();
tempCtx.scale(scale, scale);
ws.forEach(function(w){
const startX = w.start.x * tempCanvas.width / scale;
const startY = w.start.y * tempCanvas.height / scale;
const endX = w.end.x * tempCanvas.width / scale;
const endY = w.end.y * tempCanvas.height / scale;
const dx = endX - startX;
const dy = endY - startY;
const len = Math.sqrt(dx*dx + dy*dy);
const numLen = String(w.displayNum).length;
let baseRadius = 22;
if(numLen >= 4) baseRadius = 30;
else if(numLen >= 3) baseRadius = 26;
else if(numLen >= 2) baseRadius = 24;
const radius = baseRadius * weldScale;
const ratio = (len - radius) / len;
const lineEndX = startX + dx * ratio;
const lineEndY = startY + dy * ratio;
tempCtx.strokeStyle = '#FF0000';
tempCtx.lineWidth = 2.5 * weldScale;
tempCtx.beginPath();
tempCtx.moveTo(startX, startY);
tempCtx.lineTo(lineEndX, lineEndY);
tempCtx.stroke();
const crossSize = 1.6 * weldScale;
tempCtx.lineWidth = 2 * weldScale;
tempCtx.beginPath();
tempCtx.moveTo(startX - crossSize, startY - crossSize);
tempCtx.lineTo(startX + crossSize, startY + crossSize);
tempCtx.stroke();
tempCtx.beginPath();
tempCtx.moveTo(startX + crossSize, startY - crossSize);
tempCtx.lineTo(startX - crossSize, startY + crossSize);
tempCtx.stroke();
tempCtx.beginPath();
tempCtx.arc(endX, endY, radius, 0, Math.PI * 2);
tempCtx.strokeStyle = '#FF0000';
tempCtx.lineWidth = 1.5 * weldScale;
tempCtx.stroke();
let baseFontSize = 34;
if(numLen >= 4) baseFontSize = 24;
else if(numLen >= 3) baseFontSize = 28;
else if(numLen >= 2) baseFontSize = 30;
const fontSize = baseFontSize * weldScale;
tempCtx.fillStyle = '#FF0000';
tempCtx.font = 'bold ' + fontSize + 'px Arial';
tempCtx.textAlign = 'center';
tempCtx.textBaseline = 'middle';
tempCtx.fillText(w.displayNum, endX, endY);
});
tempCtx.restore();
// PouÅ¾ij PLNÃš veÄ¾kosÅ¥ pre preview (nie zmenÅ¡enÃ½)
previewCanvas.width = tempCanvas.width;
previewCanvas.height = tempCanvas.height;
previewCtx.drawImage(tempCanvas, 0, 0);
console.log('âœ… Preview rendered! Size:', previewCanvas.width, 'x', previewCanvas.height, '| weldScale:', weldScale);
}

function activateDimension(){
var text=prompt('Zadaj text pre domerok (napr. +100, -50, EL+1500):','');
if(text===null||text.trim()==='')return;

dimensionText=text.trim();
dimensionFontSize=parseInt(document.getElementById('dimensionFontSize').value) || 16;
dimensionMode=true;
currentTool='dimension';

// Zobraz dimension toolbar
document.getElementById('dimensionOptions').style.display='flex';
document.getElementById('lineOptions').style.display='none';
document.getElementById('textOptions').style.display='none';
document.getElementById('curveOptions').style.display='none';
document.getElementById('arrowOptions').style.display='none';

document.getElementById('dimensionbtn').style.opacity='1';
document.getElementById('selectbtn').style.opacity='0.7';
document.getElementById('crossbtn').style.opacity='0.7';
document.getElementById('spoolbtn').style.opacity='0.7';
ca.style.cursor='crosshair';
document.getElementById('spoolPanel').classList.remove('active');
console.log('Dimension mode activated:',dimensionText,'fontSize:',dimensionFontSize);
}

function calculateSpoools(){
console.log('=== CALCULATING SPOOOLS ===');
if(ws.length===0){
document.getElementById('spoolList').innerHTML='<div style="text-align:center;color:#999;padding:20px">Å½iadne zvary</div>';
document.getElementById('spoolCount').textContent='0';
return;
}
var allWelds=[];
for(var i=0;i<ws.length;i++){
allWelds.push({num:ws[i].displayNum,id:ws[i].id});
}
allWelds.sort(function(a,b){return a.num-b.num;});
var boundaries=[];
for(var i=0;i<crosses.length;i++){
var cross=crosses[i];
for(var j=0;j<allWelds.length;j++){
if(allWelds[j].id===cross.weldId){
boundaries.push(allWelds[j].num);
break;
}
}
}
boundaries.sort(function(a,b){return a-b;});
console.log('Boundaries (krÃ­Å¾iky):',boundaries);
if(boundaries.length===0){
document.getElementById('spoolList').innerHTML='<div style="text-align:center;color:#999;padding:20px">Pridaj aspoÅˆ 1 krÃ­Å¾ik<br>na oznaÄenie konca spoolu</div>';
document.getElementById('spoolCount').textContent='0';
return;
}
var spoolList=[];
var spoolNum=1;
var currentGroup=[];
for(var i=0;i<allWelds.length;i++){
var weldNum=allWelds[i].num;
var isBoundary=boundaries.indexOf(weldNum)!==-1;
if(isBoundary){
if(currentGroup.length>0){
spoolList.push({spoolNum:spoolNum,welds:currentGroup});
spoolNum++;
currentGroup=[];
}
}else{
currentGroup.push(weldNum);
}
}
if(currentGroup.length>0){
spoolList.push({spoolNum:spoolNum,welds:currentGroup});
}
console.log('Spoools:',spoolList);
var html='';
if(spoolList.length===0){
html='<div style="text-align:center;color:#999;padding:20px">VÅ¡etky zvary majÃº krÃ­Å¾iky</div>';
}else{
for(var i=0;i<spoolList.length;i++){
var spool=spoolList[i];
html+='<div class="spool-item">';
html+='<strong>Spool '+spool.spoolNum+':</strong>';
html+='<div class="spool-welds">'+spool.welds.join(', ')+'</div>';
html+='</div>';
}
}
document.getElementById('spoolList').innerHTML=html;
document.getElementById('spoolCount').textContent=spoolList.length;
spoolData=spoolList;
console.log('Spool data saved:',spoolData);
}

function cl(){
if(confirm('ZmazaÅ¥ vÅ¡etko?')){
ws=[];
lines=[];
texts=[];
curves=[];
arrows=[];
crosses=[];
spools=[];
dimensions=[];
weldHistory=[];
pt=null;
linePt=null;
arrowPt=null;
crossPt=null;
curvePts=[];
cn=startNum;
spoolNum=1;
up();
dw();
document.getElementById('undo').disabled=true;
console.log('ğŸ—‘ï¸ VÅ¡etko zmazanÃ©');
}
}
</script>
<script>
// ========================================
// WELDBOOK - AG-GRID INTEGRÃCIA
// DÃ¡tum: 2.1.2026, 8:30
// ========================================

// ============= GLOBÃLNE PREMENNÃ‰ =============
var weldBookGrid = null;
var weldBookData = [];
var currentOfflineProjectId = null; // Tracking offline project for auto-save

// ğŸ”” AUTO-UPDATE CHECKER
var updateCheckInterval = null;
var currentProjectTimestamp = null;
var currentProjectName = null;
var updateHistory = []; // HistÃ³ria vÅ¡etkÃ½ch update notifikÃ¡ciÃ­

// ============= OTVORENIE WELDBOOK PANELU =============
function openWeldBook() {
  // Vytvorenie modÃ¡lneho okna
  var modal = document.createElement('div');
  modal.id = 'weldBookModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:5000;display:flex;align-items:center;justify-content:center;padding:20px';
  
  var content = '<div style="background:white;border-radius:4px;padding:30px;width:95%;height:90vh;display:flex;flex-direction:column">';
  content += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
  content += '<h2 style="margin:0;color:#667eea;font-size:24px">ğŸ“Š WeldBook - VÅ¡etky zvary</h2>';
  content += '<div style="display:flex;gap:10px;flex-wrap:wrap">';
  content += '<button onclick="addWeldBookRow()" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">â• PridaÅ¥ riadok</button>';
  content += '<button onclick="deleteSelectedWeldBookRows()" style="padding:10px 20px;background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">ğŸ—‘ï¸ ZmazaÅ¥ oznaÄenÃ©</button>';
  content += '<button onclick="cleanWeldBook()" style="padding:10px 20px;background:#f59e0b;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">ğŸ§¹ VyÄistiÅ¥ orphaned</button>';
  content += '<button onclick="clearAllWeldBook()" style="padding:10px 20px;background:#dc2626;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600;border:2px solid #991b1b">ğŸ—‘ï¸ VYMAZAÅ¤ VÅ ETKO</button>';
  content += '<button onclick="importJSONProjects()" style="padding:10px 20px;background:#667eea;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">ğŸ“¥ Import z JSON</button>';
  content += '<button onclick="exportWeldBookExcel()" style="padding:10px 20px;background:#8b5cf6;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">ğŸ“Š Export Excel</button>';
  content += '<button onclick="closeWeldBook()" style="padding:10px 20px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>';
  content += '</div></div>';
  content += '<div id="weldBookGrid" class="ag-theme-alpine" style="flex:1;width:100%;height:100%"></div>';
  content += '</div>';
  
  modal.innerHTML = content;
  document.body.appendChild(modal);
  
  // InicializÃ¡cia AG-Grid
  initializeWeldBookGrid();
}

// ============= DETEKCIA DUPLICÃT =============
function isDuplicateWeld(params) {
  var data = params.api.getRenderedNodes().map(function(node) {
    return node.data;
  });
  
  var currentRow = params.data;
  var key = (currentRow.part || '') + '|' + (currentRow.isometric || '') + '|' + (currentRow.weldId || '');
  
  // SpoÄÃ­taj koÄ¾ko riadkov mÃ¡ rovnakÃ½ kÄ¾ÃºÄ
  var count = 0;
  data.forEach(function(row) {
    var rowKey = (row.part || '') + '|' + (row.isometric || '') + '|' + (row.weldId || '');
    if (rowKey === key && key !== '||') { // Ignoruj prÃ¡zdne riadky
      count++;
    }
  });
  
  return count > 1;
}

// ============= INICIALIZÃCIA AG-GRID =============
function initializeWeldBookGrid() {
  // DefinÃ­cia stÄºpcov (46 stÄºpcov podÄ¾a Excel template)
  var columnDefs = [
    // DESCRIPTION
    { headerName: 'ÄŒasÅ¥', field: 'part', width: 200, editable: true, pinned: 'left', cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Izometria', field: 'isometric', width: 200, editable: true, pinned: 'left', cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Sheets', field: 'sheets', width: 80, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'PED', field: 'ped', width: 80, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'REV.', field: 'rev', width: 80, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Pipe Class', field: 'pipeClass', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Weld ID', field: 'weldId', width: 100, editable: true, cellDataType: 'text', valueFormatter: function(params) { return params.value ? String(params.value) : ''; }, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Source', field: 'source', width: 90, editable: true, cellStyle: function(params) { 
      if(params.value==='prefab')return {backgroundColor:'#d1fae5',color:'#065f46',fontWeight:'600'};
      if(params.value==='new')return {backgroundColor:'#fef3c7',color:'#92400e',fontWeight:'600'};
      if(params.value==='site')return {backgroundColor:'#e0f2fe',color:'#075985',fontWeight:'600'};
      return null;
    } },
    
    // ITEM 1
    { headerName: 'Welded Item 1', field: 'item1', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Heat nr. 1', field: 'heatNr1', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Certificate nr. 1', field: 'certNr1', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Dimension 1', field: 'dimension1', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Wall thickness 1', field: 'thickness1', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Material 1', field: 'material1', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Mat. Group 1', field: 'matGroup1', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    
    // ITEM 2
    { headerName: 'Welded Item 2', field: 'item2', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Heat nr. 2', field: 'heatNr2', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Certificate nr. 2', field: 'certNr2', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Dimension 2', field: 'dimension2', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Wall thickness 2', field: 'thickness2', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Material 2', field: 'material2', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Mat. Group 2', field: 'matGroup2', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    
    // WELDING
    { headerName: 'WPS', field: 'wps', width: 100, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'WPQR', field: 'wpqr', width: 100, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Welding method', field: 'weldingMethod', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Type of joint', field: 'jointType', width: 130, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Type of welding', field: 'weldingType', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Welding gas', field: 'weldingGas', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Heat nr.', field: 'heatNrWeld', width: 110, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Certificate nr.', field: 'certNrWeld', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Welder ID', field: 'welderId', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Date of welding', field: 'dateWelding', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    
    // VT INSPECTION
    { headerName: 'VT inspection %', field: 'vtPercent', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Date of testing', field: 'vtDate', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'VT report', field: 'vtReport', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'VT result', field: 'vtResult', width: 110, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    
    // PT INSPECTION
    { headerName: 'PT inspection %', field: 'ptPercent', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Date of testing', field: 'ptDate', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'PT report', field: 'ptReport', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'PT result', field: 'ptResult', width: 110, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    
    // RT INSPECTION
    { headerName: 'RT inspection %', field: 'rtPercent', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Date of testing', field: 'rtDate', width: 140, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'RT report', field: 'rtReport', width: 120, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'RT result', field: 'rtResult', width: 110, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    
    // PROGRESS
    { headerName: 'PMP Montex Inch', field: 'pmpInch', width: 150, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Andritz Inch', field: 'andritzInch', width: 130, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Pressure test group', field: 'pressureGroup', width: 170, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } },
    { headerName: 'Note', field: 'note', width: 200, editable: true, cellStyle: function(params) { return isDuplicateWeld(params) ? {backgroundColor: '#a7c7e7'} : null; } }
  ];
  
  // KonfigurÃ¡cia AG-Grid
  var gridOptions = {
    columnDefs: columnDefs,
    rowData: weldBookData,
    defaultColDef: {
      sortable: true,
      filter: true,
      resizable: true
    },
    enableCellTextSelection: true,
    animateRows: true,
    rowSelection: 'multiple',
    pagination: true,
    paginationPageSize: 50,
    onGridReady: function(params) {
      weldBookGrid = params;
      console.log('âœ… WeldBook AG-Grid initialized!');
    },
    onCellValueChanged: function(params) {
      // Refresh buniek pre detekciu duplicÃ­t
      params.api.refreshCells();
      saveCurrentPartWeldBook();
      console.log('âœï¸ Bunka upravenÃ¡, detekujem duplicity...');
    }
  };
  
  // Vytvorenie gridu
  var gridDiv = document.getElementById('weldBookGrid');
  new agGrid.Grid(gridDiv, gridOptions);
}

// ============= PRIDANIE ZVARU DO WELDBOOK =============
// ============= HELPER: Rozdelenie nÃ¡zvu izometrie =============
function splitIsometricName(fullName){
// fullName = "SUL_PIPE ISOMETRIC,KF-712-20002-4-25-10H1A"
// VÃ½sledok: {part: "SUL_PIPE ISOMETRIC", isometric: "KF-712-20002-4-25-10H1A"}

if(!fullName || fullName.trim()==='')return {part:'',isometric:''};

var parts=fullName.split(',');
if(parts.length>=2){
// VÅ¡etko pred poslednou Äiarkou = ÄasÅ¥
var lastIndex=fullName.lastIndexOf(',');
var part=fullName.substring(0,lastIndex).trim();
var isometric=fullName.substring(lastIndex+1).trim();
return {part:part,isometric:isometric};
}else{
// Å½iadna Äiarka - celÃ½ nÃ¡zov je izometria
return {part:'',isometric:fullName.trim()};
}
}

// Helper funkcia: parsuje weld ID na numerickÃº hodnotu pre sortovanie
function parseWeldId(weldId) {
  if (!weldId) return 0;
  
  // PrÃ­klady: "5" â†’ 5.0, "5a" â†’ 5.1, "5A" â†’ 5.1, "5B" â†’ 5.2, "10C" â†’ 10.3
  var str = String(weldId).trim();
  
  // Extrahuj ÄÃ­selnÃº ÄasÅ¥ (napr. "5a" â†’ "5")
  var numMatch = str.match(/^(\d+)/);
  var baseNum = numMatch ? parseInt(numMatch[1]) : 0;
  
  // Extrahuj pÃ­smenovÃº ÄasÅ¥ (napr. "5a" â†’ "a")
  var letterMatch = str.match(/[A-Za-z]+$/);
  var letterPart = 0;
  
  if (letterMatch) {
    // a/A=0.1, b/B=0.2, c/C=0.3, atÄ.
    var letter = letterMatch[0].toUpperCase();
    letterPart = (letter.charCodeAt(0) - 64) / 10; // A=1â†’0.1, B=2â†’0.2
  }
  
  return baseNum + letterPart;
}

function addWeldToWeldBook(weldData) {
  console.log('â• PridÃ¡vam zvar do WeldBook:', weldData);
  
  // âš ï¸ KRITICKÃ DEBUG - kde vznikajÃº "site" zÃ¡znamy?
  if(weldData.source === 'site') {
    console.error('ğŸš¨ğŸš¨ğŸš¨ SITE ZÃZNAM VYTVORENÃ! ğŸš¨ğŸš¨ğŸš¨');
    console.error('   weldId:', weldData.weldId);
    console.error('   isometric:', weldData.isometric);
    console.error('ğŸ“ FULL STACK TRACE:');
    console.trace();
  }
  
  // Parse weld number pre sorted insert
  var newWeldNum = parseWeldId(weldData.weldId);
  var newIso = weldData.isometric || '';
  
  // NÃ¡jdi sprÃ¡vne miesto v poli (sorted insert v rÃ¡mci tej istej izometrie)
  var insertIndex = weldBookData.length; // Default: na koniec
  
  for (var i = 0; i < weldBookData.length; i++) {
    var existingIso = weldBookData[i].isometric || '';
    
    // Ak je to tÃ¡ istÃ¡ izometria, porovnaj ÄÃ­sla
    if (existingIso === newIso) {
      var existingNum = parseWeldId(weldBookData[i].weldId);
      if (newWeldNum < existingNum) {
        insertIndex = i;
        break;
      }
    }
    // Ak je existujÃºca izometria "vÃ¤ÄÅ¡ia" (abecedne), vloÅ¾ pred Åˆu
    else if (newIso < existingIso) {
      insertIndex = i;
      break;
    }
  }
  
  // VloÅ¾ na sprÃ¡vne miesto
  weldBookData.splice(insertIndex, 0, weldData);
  console.log('âœ… Zvar vloÅ¾enÃ½ na index:', insertIndex, '(iso:', newIso, ', weldId:', weldData.weldId, 'â†’', newWeldNum + ')');
  
  // Ak je grid otvorenÃ½, RELOAD celÃ½ dataset (aby sa zobrazil v sprÃ¡vnom poradÃ­)
  if (weldBookGrid && weldBookGrid.api) {
    weldBookGrid.api.setGridOption('rowData', weldBookData);
    console.log('âœ… WeldBook tabuÄ¾ka aktualizovanÃ¡');
  }
  
  // UloÅ¾ do aktÃ­vnej Äasti projektu
  saveCurrentPartWeldBook();
}

// ============= IMPORT Z JSON PROJEKTOV =============
function importJSONProjects() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.multiple = true;
  
  input.onchange = async function(e) {
    var files = Array.from(e.target.files);
    console.log('ğŸ“¥ Importujem', files.length, 'JSON sÃºborov...');
    
    if (files.length === 0) return;
    
    // VYTVOR PROGRESS MODAL
    showImportProgress(files.length);
    
    // DISABLE vÅ¡etky tlaÄidlÃ¡ a grid
    disableWeldBookInteraction();
    
    var totalWelds = 0;
    var processedCount = 0;
    
    // Spracuj POSTUPNE (nie vÅ¡etky naraz!)
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      
      try {
        // NaÄÃ­taj sÃºbor
        var text = await readFileAsync(file);
        var project = JSON.parse(text);
        
        // Spracuj projekt
        var welds = await processJSONProjectAsync(file.name, project);
        totalWelds += welds;
        
        processedCount++;
        
        // Update progress
        updateImportProgress(processedCount, files.length, totalWelds);
        
        console.log('âœ…', processedCount, '/', files.length, ':', file.name, 'â†’', welds, 'zvarov');
        
      } catch(err) {
        console.error('âŒ Chyba pri ÄÃ­tanÃ­', file.name, ':', err);
        processedCount++;
        updateImportProgress(processedCount, files.length, totalWelds);
      }
      
      // MalÃ¡ pauza aby UI mohol refresh
      await sleep(10);
    }
    
    // HOTOVO!
    console.log('ğŸ‰ Import dokonÄenÃ½!', totalWelds, 'zvarov z', files.length, 'sÃºborov');
    
    // UloÅ¾i do storage
    saveCurrentPartWeldBook();
    
    // Refresh grid
    if (weldBookGrid && weldBookGrid.api) {
      weldBookGrid.api.refreshCells();
    }
    
    // ENABLE spÃ¤Å¥
    enableWeldBookInteraction();
    
    // Zavri progress
    hideImportProgress();
    
    alert('âœ… Import dokonÄenÃ½!\n\n' + 
          'SÃºbory: ' + files.length + '\n' + 
          'Zvary: ' + totalWelds);
  };
  
  input.click();
}

// Helper: Async file read
function readFileAsync(file) {
  return new Promise(function(resolve, reject) {
    var reader = new FileReader();
    reader.onload = function(e) { resolve(e.target.result); };
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

// Helper: Sleep
function sleep(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

// Async verzia processJSONProject
async function processJSONProjectAsync(fileName, project) {
  console.log('ğŸ”„ SpracovÃ¡vam projekt:', fileName);
  
  // Parsing nÃ¡zvu sÃºboru
  var isometric = fileName.replace('_projekt.json', '').replace('.json', '');
  var sheets = 1; // default
  
  // HÄ¾adaj "Sheet X" v nÃ¡zve
  var sheetMatch = fileName.match(/[Ss]heet[\s_-]*(\d+)/);
  if (sheetMatch) {
    sheets = parseInt(sheetMatch[1]);
    isometric = isometric.replace(/[\s_-]*[Ss]heet[\s_-]*\d+/, '');
  }
  
  var weldCount = 0;
  
  // Spracuj kaÅ¾dÃ½ zvar
  if (project.welds && project.welds.length > 0) {
    var splitName = splitIsometricName(isometric);
    
    project.welds.forEach(function(weld) {
      var weldRow = {
        part: splitName.part,
        isometric: splitName.isometric,
        sheets: sheets,
        weldId: String(weld.displayNum || ''),
        
        // Item 1/2 - zatiaÄ¾ prÃ¡zdne
        item1: '',
        item2: '',
        
        // VÅ¡etky ostatnÃ© stÄºpce prÃ¡zdne
        ped: '', rev: '', pipeClass: '',
        heatNr1: '', certNr1: '', dimension1: '', thickness1: '', material1: '', matGroup1: '',
        heatNr2: '', certNr2: '', dimension2: '', thickness2: '', material2: '', matGroup2: '',
        wps: '', wpqr: '', weldingMethod: '', jointType: '', weldingType: '', weldingGas: '',
        heatNrWeld: '', certNrWeld: '', welderId: '', dateWelding: '',
        vtPercent: '', vtDate: '', vtReport: '', vtResult: '',
        ptPercent: '', ptDate: '', ptReport: '', ptResult: '',
        rtPercent: '', rtDate: '', rtReport: '', rtResult: '',
        pmpInch: '', andritzInch: '', pressureGroup: '', note: ''
      };
      
      addWeldToWeldBook(weldRow);
      weldCount++;
    });
  }
  
  return weldCount;
}

// PROGRESS MODAL
function showImportProgress(total) {
  var modal = document.createElement('div');
  modal.id = 'importProgressModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
  
  var content = document.createElement('div');
  content.style.cssText = 'background:white;padding:40px;border-radius:12px;min-width:500px;text-align:center;';
  
  content.innerHTML = `
    <h2 style="color:#667eea;margin-bottom:20px;">ğŸ“¥ Importujem JSON sÃºbory...</h2>
    <div style="background:#e5e7eb;border-radius:8px;height:40px;overflow:hidden;margin:20px 0;">
      <div id="importProgressBar" style="background:linear-gradient(90deg,#667eea,#764ba2);height:100%;width:0%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:18px;">0%</div>
    </div>
    <p id="importProgressText" style="color:#666;font-size:18px;margin:10px 0;">Pripravujem...</p>
    <p style="color:#999;font-size:14px;margin-top:20px;">â³ ProsÃ­m poÄkajte, nepipajte do tabuÄ¾ky...</p>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
}

function updateImportProgress(processed, total, totalWelds) {
  var percent = Math.round((processed / total) * 100);
  
  var bar = document.getElementById('importProgressBar');
  var text = document.getElementById('importProgressText');
  
  if (bar) {
    bar.style.width = percent + '%';
    bar.textContent = percent + '%';
  }
  
  if (text) {
    text.textContent = 'SpracovanÃ©: ' + processed + ' / ' + total + ' sÃºborov (' + totalWelds + ' zvarov)';
  }
}

function hideImportProgress() {
  var modal = document.getElementById('importProgressModal');
  if (modal) {
    modal.remove();
  }
}

// DISABLE interaction
function disableWeldBookInteraction() {
  // Disable grid
  if (weldBookGrid && weldBookGrid.api) {
    weldBookGrid.api.setGridOption('suppressClickEdit', true);
  }
  
  // Disable vÅ¡etky tlaÄidlÃ¡ v WeldBook okne
  var buttons = document.querySelectorAll('#weldBookWindow button');
  buttons.forEach(function(btn) {
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.style.cursor = 'not-allowed';
  });
}

// ENABLE interaction
function enableWeldBookInteraction() {
  // Enable grid
  if (weldBookGrid && weldBookGrid.api) {
    weldBookGrid.api.setGridOption('suppressClickEdit', false);
  }
  
  // Enable vÅ¡etky tlaÄidlÃ¡
  var buttons = document.querySelectorAll('#weldBookWindow button');
  buttons.forEach(function(btn) {
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  });
}

// ============= SPRACOVANIE JSON PROJEKTU =============
function processJSONProject(fileName, project) {
  console.log('ğŸ”„ SpracovÃ¡vam projekt:', fileName);
  
  // Parsing nÃ¡zvu sÃºboru
  var isometric = fileName.replace('_projekt.json', '').replace('.json', '');
  var sheets = 1; // default
  
  // HÄ¾adaj "Sheet X" v nÃ¡zve
  var sheetMatch = fileName.match(/[Ss]heet[\s_-]*(\d+)/);
  if (sheetMatch) {
    sheets = parseInt(sheetMatch[1]);
    // OdstrÃ¡Åˆ " Sheet X" z nÃ¡zvu izometrie
    isometric = isometric.replace(/[\s_-]*[Ss]hee t[\s_-]*\d+/, '');
  }
  
  console.log('  ğŸ“‹ Izometria:', isometric);
  console.log('  ğŸ“„ Sheet:', sheets);
  console.log('  âš¡ Zvary:', project.welds ? project.welds.length : 0);
  
  // Spracuj kaÅ¾dÃ½ zvar
  if (project.welds && project.welds.length > 0) {
    var splitName=splitIsometricName(isometric);
    project.welds.forEach(function(weld) {
      var weldRow = {
        part: splitName.part,
        isometric: splitName.isometric,
        sheets: sheets,
        weldId: String(weld.displayNum || ''),
        
        // Item 1/2 - zatiaÄ¾ prÃ¡zdne (doplnÃ­me neskÃ´r z Weld Log)
        item1: '',
        item2: '',
        
        // VÅ¡etky ostatnÃ© stÄºpce prÃ¡zdne
        ped: '', rev: '', pipeClass: '',
        heatNr1: '', certNr1: '', dimension1: '', thickness1: '', material1: '', matGroup1: '',
        heatNr2: '', certNr2: '', dimension2: '', thickness2: '', material2: '', matGroup2: '',
        wps: '', wpqr: '', weldingMethod: '', jointType: '', weldingType: '', weldingGas: '',
        heatNrWeld: '', certNrWeld: '', welderId: '', dateWelding: '',
        vtPercent: '', vtDate: '', vtReport: '', vtResult: '',
        ptPercent: '', ptDate: '', ptReport: '', ptResult: '',
        rtPercent: '', rtDate: '', rtReport: '', rtResult: '',
        pmpInch: '', andritzInch: '', pressureGroup: '', note: ''
      };
      
      addWeldToWeldBook(weldRow);
    });
    
    console.log('âœ… Projekt spracovanÃ½:', project.welds.length, 'zvarov');
  }
}

// ============= ULOÅ½ENIE DO LOCALSTORAGE =============
function saveWeldBookToStorage() {
  try {
    localStorage.setItem('weldBookData', JSON.stringify(weldBookData));
    console.log('ğŸ’¾ WeldBook uloÅ¾enÃ½ do localStorage');
  } catch(err) {
    console.error('âŒ Chyba pri ukladanÃ­:', err);
  }
}

// ============= NAÄŒÃTANIE Z LOCALSTORAGE =============
function loadWeldBookFromStorage() {
  try {
    var saved = localStorage.getItem('weldBookData');
    if (saved) {
      weldBookData = JSON.parse(saved);
      console.log('ğŸ“‚ NaÄÃ­tanÃ½ch', weldBookData.length, 'zvarov z localStorage');
    }
  } catch(err) {
    console.error('âŒ Chyba pri naÄÃ­tanÃ­:', err);
  }
}

// ============= EXPORT DO EXCEL =============
function exportWeldBookExcel() {
  if (!weldBookGrid || !weldBookGrid.api) {
    alert('âŒ WeldBook nie je otvorenÃ½!');
    return;
  }
  
  // AUTO-BACKUP pred exportom!
  console.log('ğŸ’¾ Auto-backup WeldBook pred exportom...');
  saveCurrentPartWeldBook();
  
  try {
    console.log('ğŸ“Š VytvÃ¡ram Excel export...');
    
    // Vytvor workbook
    var wb = XLSX.utils.book_new();
    
    // HEADER - Riadok 1 (merged groups)
    var headerRow1 = [
      'DESCRIPTION', '', '', '', '', '',  // A-F (merged)
      'ITEM 1', '', '', '', '', '', '',   // G-M (merged)
      'ITEM 2', '', '', '', '', '', '',   // N-T (merged)
      'WELDING', '', '', '', '', '', '', '', '', '',  // U-AD (merged)
      'VT - INSPECTION', '', '', '',      // AE-AH (merged)
      'PT - INSPECTION', '', '', '',      // AI-AL (merged)
      'RT - INSPECTION', '', '', '',      // AM-AP (merged)
      'PROGRESS', '',                     // AQ-AR (merged)
      'Pressure test group',              // AS
      'Note'                              // AT
    ];
    
    // HEADER - Riadok 2 (podstÄºpce)
    var headerRow2 = [
      'Isometric',           // A
      'Sheets',              // B
      'PED',                 // C
      'REV.',                // D
      'Pipe Class',          // E
      'Weld ID',             // F
      'Welded Item 1',       // G
      'Heat nr. 1',          // H
      'Certificate nr. 1',   // I
      'Dimension 1',         // J
      'Wall thickness 1',    // K
      'Material 1',          // L
      'Mat. Group 1',        // M
      'Welded Item 2',       // N
      'Heat nr. 2',          // O
      'Certificate nr. 2',   // P
      'Dimension 2',         // Q
      'Wall thickness 2',    // R
      'Material 2',          // S
      'Mat. Group 2',        // T
      'WPS',                 // U
      'WPQR',                // V
      'Welding method',      // W
      'Type of joint',       // X
      'Type of welding',     // Y
      'Welding gas',         // Z
      'Heat nr.',            // AA
      'Certificate nr.',     // AB
      'Welder ID',           // AC
      'Date of welding',     // AD
      'VT inspection %',     // AE
      'Date of testing',     // AF
      'VT report',           // AG
      'VT result',           // AH
      'PT inspection %',     // AI
      'Date of testing',     // AJ
      'PT report',           // AK
      'PT result',           // AL
      'RT inspection %',     // AM
      'Date of testing',     // AN
      'RT report',           // AO
      'RT result',           // AP
      'PMP Montex Inch',     // AQ
      'Andritz Inch',        // AR
      'Pressure test group', // AS
      'Note'                 // AT
    ];
    
    // DÃTA
    var dataRows = weldBookData.map(function(row) {
      return [
        row.isometric || '',           // A
        row.sheets || '',              // B
        row.ped || '',                 // C
        row.rev || '',                 // D
        row.pipeClass || '',           // E
        row.weldId || '',              // F
        row.item1 || '',               // G
        row.heatNr1 || '',             // H
        row.certNr1 || '',             // I
        row.dimension1 || '',          // J
        row.thickness1 || '',          // K
        row.material1 || '',           // L
        row.matGroup1 || '',           // M
        row.item2 || '',               // N
        row.heatNr2 || '',             // O
        row.certNr2 || '',             // P
        row.dimension2 || '',          // Q
        row.thickness2 || '',          // R
        row.material2 || '',           // S
        row.matGroup2 || '',           // T
        row.wps || '',                 // U
        row.wpqr || '',                // V
        row.weldingMethod || '',       // W
        row.jointType || '',           // X
        row.weldingType || '',         // Y
        row.weldingGas || '',          // Z
        row.heatNrWeld || '',          // AA
        row.certNrWeld || '',          // AB
        row.welderId || '',            // AC
        row.dateWelding || '',         // AD
        row.vtPercent || '',           // AE
        row.vtDate || '',              // AF
        row.vtReport || '',            // AG
        row.vtResult || '',            // AH
        row.ptPercent || '',           // AI
        row.ptDate || '',              // AJ
        row.ptReport || '',            // AK
        row.ptResult || '',            // AL
        row.rtPercent || '',           // AM
        row.rtDate || '',              // AN
        row.rtReport || '',            // AO
        row.rtResult || '',            // AP
        row.pmpInch || '',             // AQ
        row.andritzInch || '',         // AR
        row.pressureGroup || '',       // AS
        row.note || ''                 // AT
      ];
    });
    
    // Vytvor worksheet
    var wsData = [headerRow2].concat(dataRows);  // ZaÄni s row 2 (row 1 pridÃ¡me manuÃ¡lne)
    var ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Nastav Å¡Ã­rky stÄºpcov
    ws['!cols'] = [
      { wch: 25 },  // Isometric
      { wch: 8 },   // Sheets
      { wch: 8 },   // PED
      { wch: 8 },   // REV
      { wch: 12 },  // Pipe Class
      { wch: 10 },  // Weld ID
      { wch: 15 },  // Item 1
      { wch: 12 },  // Heat nr 1
      { wch: 15 },  // Cert nr 1
      { wch: 12 },  // Dimension 1
      { wch: 12 },  // Thickness 1
      { wch: 12 },  // Material 1
      { wch: 12 },  // Mat Group 1
      { wch: 15 },  // Item 2
      { wch: 12 },  // Heat nr 2
      { wch: 15 },  // Cert nr 2
      { wch: 12 },  // Dimension 2
      { wch: 12 },  // Thickness 2
      { wch: 12 },  // Material 2
      { wch: 12 },  // Mat Group 2
      { wch: 12 },  // WPS
      { wch: 12 },  // WPQR
      { wch: 15 },  // Welding method
      { wch: 12 },  // Joint type
      { wch: 12 },  // Welding type
      { wch: 12 },  // Welding gas
      { wch: 12 },  // Heat nr weld
      { wch: 15 },  // Cert nr weld
      { wch: 12 },  // Welder ID
      { wch: 12 },  // Date welding
      { wch: 12 },  // VT %
      { wch: 12 },  // VT date
      { wch: 12 },  // VT report
      { wch: 12 },  // VT result
      { wch: 12 },  // PT %
      { wch: 12 },  // PT date
      { wch: 12 },  // PT report
      { wch: 12 },  // PT result
      { wch: 12 },  // RT %
      { wch: 12 },  // RT date
      { wch: 12 },  // RT report
      { wch: 12 },  // RT result
      { wch: 12 },  // PMP inch
      { wch: 12 },  // Andritz inch
      { wch: 15 },  // Pressure group
      { wch: 20 }   // Note
    ];
    
    // Pridaj worksheet do workbook
    XLSX.utils.book_append_sheet(wb, ws, 'WeldBook');
    
    // STIAHNI SÃšBOR
    var filename = 'WeldBook_' + new Date().toISOString().slice(0, 10) + '.xlsx';
    XLSX.writeFile(wb, filename);
    
    console.log('âœ… Excel vytvorenÃ½:', filename);
    alert('âœ… WeldBook exportovanÃ½ do Excel!\n\n' +
          'SÃºbor: ' + filename + '\n' +
          'ZÃ¡znamy: ' + weldBookData.length + '\n\n' +
          'ğŸ’¾ DÃ¡ta sÃº aj zÃ¡lohovanÃ© v prehliadaÄi.');
    
  } catch (err) {
    console.error('âŒ Export error:', err);
    alert('âŒ Chyba pri exporte: ' + err.message + '\n\nğŸ’¾ DÃ¡ta sÃº vÅ¡ak bezpeÄne uloÅ¾enÃ© v prehliadaÄi!');
  }
}

// ============= ZMAZANIE ZVARU Z WELDBOOK =============
function updateWeldInWeldBook(oldWeldId, newWeldId) {
  console.log('âœï¸ Updatujem zvar v WeldBook:', oldWeldId, 'â†’', newWeldId);
  
  var splitName = splitIsometricName(originalFileName || 'Unknown');
  
  // NÃ¡jdi zvar v WeldBook
  for (var i = 0; i < weldBookData.length; i++) {
    if (String(weldBookData[i].weldId) === String(oldWeldId) && weldBookData[i].isometric === splitName.isometric) {
      weldBookData[i].weldId = String(newWeldId);
      console.log('âœ… WeldBook aktualizovanÃ½');
      
      // Ak je grid otvorenÃ½, refresh
      if (weldBookGrid && weldBookGrid.api) {
        weldBookGrid.api.refreshCells();
      }
      
      // UloÅ¾
      saveCurrentPartWeldBook();
      break;
    }
  }
}

function removeWeldFromWeldBook(weldId) {
  console.log('ğŸ—‘ï¸ MaÅ¾em zvar', weldId, 'z WeldBook');
  
  var splitName = splitIsometricName(originalFileName || 'Unknown');
  
  // NÃ¡jdi a zmaÅ¾ zo dÃ¡t
  var indexToRemove = -1;
  for (var i = 0; i < weldBookData.length; i++) {
    if (String(weldBookData[i].weldId) === String(weldId) && weldBookData[i].isometric === splitName.isometric) {
      indexToRemove = i;
      break;
    }
  }
  
  if (indexToRemove !== -1) {
    var removedRow = weldBookData.splice(indexToRemove, 1)[0];
    console.log('âœ… ZmazanÃ½:', removedRow);
    
    // Ak je grid otvorenÃ½, updatni ho
    if (weldBookGrid && weldBookGrid.api) {
      weldBookGrid.api.applyTransaction({ remove: [removedRow] });
    }
    
    // UloÅ¾
    saveCurrentPartWeldBook();
  } else {
    console.log('âš ï¸ Zvar', weldId, 'nebol nÃ¡jdenÃ½ v WeldBook');
  }
}

// ============= VYÄŒISTENIE WELDBOOK OD ORPHANED ZÃZNAMOV =============
function cleanWeldBook() {
  if (!originalFileName) {
    alert('âŒ Nie je naÄÃ­tanÃ½ Å¾iadny projekt!');
    return;
  }
  
  var splitName = splitIsometricName(originalFileName);
  var currentIso = splitName.isometric;
  
  console.log('ğŸ§¹ ÄŒistenie WeldBook pre izometriu:', currentIso);
  
  // Zoznam weldId ktorÃ© SÃš na vÃ½krese
  var existingWeldIds = ws.map(function(w) { return String(w.displayNum); });
  console.log('ğŸ“Š Zvary na vÃ½krese:', existingWeldIds);
  
  // NÃ¡jdi orphaned zÃ¡znamy (v WeldBook ale NIE na vÃ½krese)
  var toRemove = [];
  for (var i = 0; i < weldBookData.length; i++) {
    var entry = weldBookData[i];
    
    // Kontroluj len zÃ¡znamy pre TÃšTO izometriu
    if (entry.isometric === currentIso) {
      var weldId = String(entry.weldId);
      
      if (!existingWeldIds.includes(weldId)) {
        toRemove.push(entry);
        console.log('ğŸ—‘ï¸ Orphaned zÃ¡znam:', weldId, '(nie je na vÃ½krese)');
      }
    }
  }
  
  if (toRemove.length === 0) {
    alert('âœ… WeldBook je ÄistÃ½! Å½iadne nadbytoÄnÃ© zÃ¡znamy.');
    return;
  }
  
  // Confirm
  if (!confirm('ğŸ§¹ NÃ¡jdenÃ½ch ' + toRemove.length + ' nadbytoÄnÃ½ch zÃ¡znamov.\n\nVymazaÅ¥?')) {
    return;
  }
  
  // VymaÅ¾
  for (var i = 0; i < toRemove.length; i++) {
    var idx = weldBookData.indexOf(toRemove[i]);
    if (idx !== -1) {
      weldBookData.splice(idx, 1);
    }
  }
  
  // Update grid ak je otvorenÃ½
  if (weldBookGrid && weldBookGrid.api) {
    weldBookGrid.api.setGridOption('rowData', weldBookData);
  }
  
  // UloÅ¾
  saveCurrentPartWeldBook();
  
  alert('âœ… VymazanÃ½ch ' + toRemove.length + ' zÃ¡znamov!\n\nWeldBook: ' + weldBookData.length + ' zvarov');
  console.log('âœ… WeldBook vyÄistenÃ½!');
}

// ============= PRIDANIE PRÃZDNEHO RIADKU =============
function addWeldBookRow() {
  if (!weldBookGrid || !weldBookGrid.api) {
    alert('âŒ WeldBook nie je otvorenÃ½!');
    return;
  }
  
  var newRow = {
    part: '',
    isometric: '',
    sheets: 1,
    weldId: '',
    item1: '', item2: '',
    ped: '', rev: '', pipeClass: '',
    heatNr1: '', certNr1: '', dimension1: '', thickness1: '', material1: '', matGroup1: '',
    heatNr2: '', certNr2: '', dimension2: '', thickness2: '', material2: '', matGroup2: '',
    wps: '', wpqr: '', weldingMethod: '', jointType: '', weldingType: '', weldingGas: '',
    heatNrWeld: '', certNrWeld: '', welderId: '', dateWelding: '',
    vtPercent: '', vtDate: '', vtReport: '', vtResult: '',
    ptPercent: '', ptDate: '', ptReport: '', ptResult: '',
    rtPercent: '', rtDate: '', rtReport: '', rtResult: '',
    pmpInch: '', andritzInch: '', pressureGroup: '', note: ''
  };
  
  weldBookData.push(newRow);
  weldBookGrid.api.applyTransaction({ add: [newRow] });
  saveWeldBookToStorage();
  console.log('âœ… PridanÃ½ prÃ¡zdny riadok');
}

// ============= ZMAZANIE OZNAÄŒENÃCH RIADKOV =============
function deleteSelectedWeldBookRows() {
  if (!weldBookGrid || !weldBookGrid.api) {
    alert('âŒ WeldBook nie je otvorenÃ½!');
    return;
  }
  
  var selectedRows = weldBookGrid.api.getSelectedRows();
  if (selectedRows.length === 0) {
    alert('âš ï¸ Najprv oznaÄte riadky na zmazanie!\n\n(Kliknite na riadok aby ste ho oznaÄili)');
    return;
  }
  
  if (!confirm('Naozaj zmazaÅ¥ ' + selectedRows.length + ' riadkov?')) {
    return;
  }
  
  // ZmaÅ¾ z dÃ¡t
  selectedRows.forEach(function(row) {
    var index = weldBookData.findIndex(function(r) {
      return r.isometric === row.isometric && r.sheets === row.sheets && r.weldId === row.weldId;
    });
    if (index !== -1) {
      weldBookData.splice(index, 1);
    }
  });
  
  // ZmaÅ¾ z gridu
  weldBookGrid.api.applyTransaction({ remove: selectedRows });
  
  // UloÅ¾ do localStorage
  saveWeldBookToStorage();
  
  // UloÅ¾ aj do Firebase projektu
  saveCurrentPartWeldBook();
  
  console.log('ğŸ—‘ï¸ ZmazanÃ½ch', selectedRows.length, 'riadkov');
}

// ============= VYMAZAÅ¤ VÅ ETKO =============
function clearAllWeldBook() {
  if (!weldBookGrid || !weldBookGrid.api) {
    alert('âŒ WeldBook nie je otvorenÃ½!');
    return;
  }
  
  var totalRows = weldBookData.length;
  
  if (totalRows === 0) {
    alert('âš ï¸ WeldBook je uÅ¾ prÃ¡zdny!');
    return;
  }
  
  // DVOJITÃ‰ POTVRDENIE!
  var confirm1 = confirm('âš ï¸ POZOR! VYMAZAÅ¤ VÅ ETKO?\n\n' +
                         'ZmaÅ¾e sa ' + totalRows + ' zÃ¡znamov z WeldBook!\n\n' +
                         'DÃ¡ta sÃº uloÅ¾enÃ© v prehliadaÄi a BUDÃš STRATENÃ‰!\n\n' +
                         'PokraÄovaÅ¥?');
  
  if (!confirm1) {
    console.log('âŒ ZruÅ¡enÃ© uÅ¾Ã­vateÄ¾om');
    return;
  }
  
  // DruhÃ© potvrdenie
  var confirm2 = confirm('ğŸš¨ SI SI ISTÃ?\n\n' +
                         'Toto je NEVRATNÃ operÃ¡cia!\n\n' +
                         'VÅ¡etky dÃ¡ta (' + totalRows + ' zvarov) budÃº VYMAZANÃ‰!\n\n' +
                         'Naozaj pokraÄovaÅ¥?');
  
  if (!confirm2) {
    console.log('âŒ ZruÅ¡enÃ© uÅ¾Ã­vateÄ¾om');
    return;
  }
  
  console.log('ğŸ—‘ï¸ MaÅ¾em VÅ ETKO:', totalRows, 'zÃ¡znamov...');
  
  // VymaÅ¾ VÅ ETKO z dÃ¡t
  weldBookData = [];
  
  // VymaÅ¾ z gridu
  weldBookGrid.api.setGridOption('rowData', []);
  
  // VymaÅ¾ z LocalStorage
  try {
    localStorage.removeItem('weldBookData');
    
    // VymaÅ¾ aj vÅ¡etky part-specific zÃ¡lohy
    var keysToRemove = [];
    for (var i = 0; i < localStorage.length; i++) {
      var key = localStorage.key(i);
      if (key && key.startsWith('weldbook_')) {
        keysToRemove.push(key);
      }
    }
    
    keysToRemove.forEach(function(key) {
      localStorage.removeItem(key);
      console.log('  ğŸ—‘ï¸ ZmazanÃ©:', key);
    });
    
    console.log('âœ… LocalStorage vyÄistenÃ½!');
  } catch(err) {
    console.error('âŒ Chyba pri mazanÃ­ LocalStorage:', err);
  }
  
  // VymaÅ¾ aj z aktuÃ¡lneho Firebase projektu
  if (projectsData.currentProject && projectsData.currentPart) {
    var currentProj = projectsData.projects[projectsData.currentProject];
    var currentPart = currentProj.parts[projectsData.currentPart];
    currentPart.weldBookData = [];
    saveProjectsToStorage();
    console.log('âœ… WeldBook vymazanÃ½ aj z Firebase projektu!');
  }
  
  console.log('âœ… WeldBook kompletne VYMAZANÃ!');
  
  alert('âœ… HOTOVO!\n\n' +
        'VÅ¡etky dÃ¡ta (' + totalRows + ' zvarov) boli vymazanÃ©!\n\n' +
        'WeldBook je teraz prÃ¡zdny.\n\n' +
        'ğŸ’¡ Teraz mÃ´Å¾eÅ¡ naimportovaÅ¥ novÃ© JSON sÃºbory.');
}

// ============= ZATVORENIE WELDBOOK =============
function closeWeldBook() {
  var modal = document.getElementById('weldBookModal');
  if (modal) {
    modal.remove();
    weldBookGrid = null;
  }
}

// ============= PROJEKTY & ÄŒASTI - localStorage =============

// ğŸ”¥ FIREBASE PROJEKT MANAGEMENT (nahradza localStorage)

async function saveProjectsToFirebase() {
  if(!db || !window.currentUser) {
    console.warn('âš ï¸ Firebase alebo user nie je dostupnÃ½');
    return;
  }
  
  try {
    // UloÅ¾iÅ¥ Å¡truktÃºru projektov do Firebase
    await db.collection('projects_structure').doc('_metadata').set({
      lastModified: firebase.firestore.FieldValue.serverTimestamp(),
      modifiedBy: window.currentUser.username
    });
    
    // UloÅ¾iÅ¥ kaÅ¾dÃ½ projekt
    for(const projectName in projectsData.projects) {
      const project = projectsData.projects[projectName];
      
      // NaÄÃ­taÅ¥ VÃ½roba data pre tento projekt
      const vyrobaKey = 'vyroba_' + projectName;
      let vyrobaDataForProject = {};
      try {
        const saved = localStorage.getItem(vyrobaKey);
        if(saved) {
          vyrobaDataForProject = JSON.parse(saved);
        }
      } catch(e) {
        console.warn('âš ï¸ Chyba pri naÄÃ­tanÃ­ VÃ½roba pre', projectName, e);
      }
      
      await db.collection('projects_structure').doc(projectName).set({
        name: projectName,
        parts: Object.keys(project.parts),
        vyrobaData: vyrobaDataForProject,
        created: project.created || new Date().toISOString(),
        lastModified: new Date().toISOString(),
        createdBy: project.createdBy || window.currentUser.username
      });
      
      // UloÅ¾iÅ¥ Äasti projektu
      for(const partName in project.parts) {
        const part = project.parts[partName];
        
        // NaÄÃ­taÅ¥ MTO data pre tÃºto ÄasÅ¥ z localStorage
        const mtoKey = 'mto_' + projectName + '_' + partName;
        let mtoDataForPart = {materials:[],isometricMaterials:{},deliveryNotes:[],stock:[]};
        try {
          const saved = localStorage.getItem(mtoKey);
          if(saved) {
            mtoDataForPart = JSON.parse(saved);
          }
        } catch(e) {
          console.warn('âš ï¸ Chyba pri naÄÃ­tanÃ­ MTO pre', partName, e);
        }
        
        // NaÄÃ­taÅ¥ Kontrola data pre tÃºto ÄasÅ¥ z localStorage
        const kontrolaKey = 'kontrola_' + projectName + '_' + partName;
        let kontrolaDataForPart = {expandedRoutes:{},expandedSpools:{},completedWelds:{},welderData:{},dateData:{},qrCodes:{}};
        try {
          const saved = localStorage.getItem(kontrolaKey);
          if(saved) {
            kontrolaDataForPart = JSON.parse(saved);
          }
        } catch(e) {
          console.warn('âš ï¸ Chyba pri naÄÃ­tanÃ­ Kontrola pre', partName, e);
        }
        
        // NaÄÃ­taÅ¥ Export data pre tÃºto ÄasÅ¥ z localStorage
        const exportKey = 'export_' + projectName + '_' + partName;
        let exportDataForPart = {packages:{},deliveryNotes:[]};
        try {
          const saved = localStorage.getItem(exportKey);
          if(saved) {
            exportDataForPart = JSON.parse(saved);
          }
        } catch(e) {
          console.warn('âš ï¸ Chyba pri naÄÃ­tanÃ­ Export pre', partName, e);
        }
        
        await db.collection('projects_structure')
          .doc(projectName)
          .collection('parts')
          .doc(partName)
          .set({
            name: partName,
            weldBookData: part.weldBookData || [],
            mtoData: mtoDataForPart,
            kontrolaData: kontrolaDataForPart,
            exportData: exportDataForPart,
            created: part.created || new Date().toISOString(),
            lastModified: part.lastModified || new Date().toISOString()
          });
      }
    }
    
    console.log('âœ… Projekty uloÅ¾enÃ© do Firebase');
  } catch(err) {
    console.error('âŒ Chyba pri ukladanÃ­ do Firebase:', err);
  }
}

async function loadProjectsFromFirebase() {
  // PoÄkaj maximÃ¡lne 5 sekÃºnd na Firebase
  let attempts = 0;
  while (!db && attempts < 50) {
    console.log('â³ ÄŒakÃ¡m na Firebase... (pokus', attempts + 1, '/ 50)');
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  
  if(!db) {
    console.warn('âš ï¸ Firebase nie je dostupnÃ½ po 5 sekundÃ¡ch, pouÅ¾Ã­vam localStorage');
    loadProjectsFromStorage();
    return;
  }
  
  try {
    console.log('ğŸ“¥ NaÄÃ­tavam projekty z Firebase...');
    
    const projectsSnapshot = await db.collection('projects_structure').get();
    
    if(projectsSnapshot.empty || projectsSnapshot.size === 1) { // Len _metadata
      console.log('ğŸ“­ Å½iadne projekty v Firebase, vytvÃ¡rÃ¡m default');
      await createDefaultProject();
      return;
    }
    
    projectsData.projects = {};
    let hasValidProject = false;
    
    for(const doc of projectsSnapshot.docs) {
      if(doc.id === '_metadata') continue;
      
      const projectData = doc.data();
      const projectName = doc.id;
      
      projectsData.projects[projectName] = {
        parts: {},
        created: projectData.created,
        createdBy: projectData.createdBy
      };
      
      // UloÅ¾iÅ¥ VÃ½roba data do localStorage
      if(projectData.vyrobaData) {
        const vyrobaKey = 'vyroba_' + projectName;
        localStorage.setItem(vyrobaKey, JSON.stringify(projectData.vyrobaData));
        console.log('ğŸ­ VÃ½roba data naÄÃ­tanÃ© pre', projectName);
      }
      
      // NaÄÃ­taÅ¥ Äasti projektu
      const partsSnapshot = await db.collection('projects_structure')
        .doc(projectName)
        .collection('parts')
        .get();
      
      for(const partDoc of partsSnapshot.docs) {
        const partData = partDoc.data();
        projectsData.projects[projectName].parts[partDoc.id] = {
          weldBookData: partData.weldBookData || [],
          created: partData.created,
          lastModified: partData.lastModified
        };
        
        // UloÅ¾iÅ¥ MTO data do localStorage pre tÃºto ÄasÅ¥
        if(partData.mtoData) {
          const mtoKey = 'mto_' + projectName + '_' + partDoc.id;
          localStorage.setItem(mtoKey, JSON.stringify(partData.mtoData));
          console.log('ğŸ“‹ MTO naÄÃ­tanÃ© pre', projectName, '/', partDoc.id);
        }
        
        // UloÅ¾iÅ¥ Kontrola data do localStorage
        if(partData.kontrolaData) {
          const kontrolaKey = 'kontrola_' + projectName + '_' + partDoc.id;
          localStorage.setItem(kontrolaKey, JSON.stringify(partData.kontrolaData));
          console.log('âœ… Kontrola data naÄÃ­tanÃ© pre', projectName, '/', partDoc.id);
        }
        
        // UloÅ¾iÅ¥ Export data do localStorage
        if(partData.exportData) {
          const exportKey = 'export_' + projectName + '_' + partDoc.id;
          localStorage.setItem(exportKey, JSON.stringify(partData.exportData));
          console.log('ğŸ“¦ Export data naÄÃ­tanÃ© pre', projectName, '/', partDoc.id);
        }
      }
      
      hasValidProject = true;
    }
    
    if(!hasValidProject) {
      await createDefaultProject();
    } else {
      // Nastav prvÃ½ projekt ako aktÃ­vny
      const firstProject = Object.keys(projectsData.projects)[0];
      projectsData.currentProject = firstProject;
      const firstPart = Object.keys(projectsData.projects[firstProject].parts)[0];
      projectsData.currentPart = firstPart;
    }
    
    console.log('âœ… Projekty naÄÃ­tanÃ© z Firebase:', Object.keys(projectsData.projects).length);
    updateProjectsUI();
    
  } catch(err) {
    console.error('âŒ Chyba pri naÄÃ­tanÃ­ z Firebase:', err);
    loadProjectsFromStorage(); // Fallback na localStorage
  }
}

// ObnoviÅ¥ projekty z existujÃºcich izometriÃ­
// KOMPLETNÃ RESET A OBNOVA Z IZOMETRIÃ
async function fullResetAndRestore() {
  if(!db) {
    alert('âŒ Firebase nie je dostupnÃ½!');
    return;
  }
  
  if(!confirm('ğŸ”¥ KOMPLETNÃ RESET!\n\nTÃ¡to akcia:\n1. VYMAÅ½E vÅ¡etky projekty z Firebase\n2. VYMAÅ½E vÅ¡etky Äasti\n3. OBNOVÃ Monsteras z izometriÃ­\n4. OBNOVÃ 5 ÄastÃ­: Dry, FLA, Sul, Lig, Lht\n5. Izometrie OSTANÃš!\n\nPokraÄovaÅ¥?')) {
    return;
  }
  
  try {
    console.log('ğŸ”¥ FULL RESET - ZaÄÃ­nam...');
    
    // 1. VYMAZAÅ¤ VÅ ETKO Z projects_structure
    console.log('ğŸ—‘ï¸ VymazÃ¡vam projects_structure...');
    const allProjects = await db.collection('projects_structure').get();
    
    for(const projectDoc of allProjects.docs) {
      // VymazaÅ¥ Äasti
      const parts = await projectDoc.ref.collection('parts').get();
      for(const partDoc of parts.docs) {
        await partDoc.ref.delete();
        console.log('ğŸ—‘ï¸ VymazanÃ¡ ÄasÅ¥:', projectDoc.id, '/', partDoc.id);
      }
      
      // VymazaÅ¥ projekt
      await projectDoc.ref.delete();
      console.log('ğŸ—‘ï¸ VymazanÃ½ projekt:', projectDoc.id);
    }
    
    // 2. VYÄŒISTIÅ¤ PAMÃ„Å¤
    projectsData.projects = {};
    console.log('ğŸ§¹ PamÃ¤Å¥ vyÄistenÃ¡');
    
    // 3. OBNOVIÅ¤ Z IZOMETRIÃ
    console.log('ğŸ”„ Obnovovanie z izometriÃ­...');
    
    const isometricsSnapshot = await db.collection('projects').get();
    const partsFound = new Set();
    
    isometricsSnapshot.forEach(doc => {
      const data = doc.data();
      if(data.part) {
        partsFound.add(data.part);
        console.log('âœ… NaÅ¡iel som ÄasÅ¥:', data.part);
      }
    });
    
    // 4. VYTVORIÅ¤ PROJEKT MONSTERAS
    projectsData.projects['Monsteras'] = {
      parts: {},
      created: new Date().toISOString(),
      createdBy: window.currentUser?.username || 'system'
    };
    
    // 5. VYTVORIÅ¤ 5 ÄŒASTÃ
    const allParts = ['Dry', 'FLA', 'Sul', 'Lig', 'Lht'];
    
    for(const partName of allParts) {
      projectsData.projects['Monsteras'].parts[partName] = {
        weldBookData: [],
        created: new Date().toISOString(),
        lastModified: new Date().toISOString()
      };
      console.log('âœ… VytvorenÃ¡ ÄasÅ¥:', partName);
    }
    
    // 6. ULOÅ½IÅ¤ DO FIREBASE
    console.log('ğŸ’¾ UkladÃ¡m do Firebase...');
    await saveProjectsToFirebase();
    
    // 7. NAÄŒÃTAÅ¤ SPÃ„Å¤
    console.log('ğŸ“¥ NaÄÃ­tavam spÃ¤Å¥...');
    await loadProjectsFromFirebase();
    
    // 8. PREPNÃšÅ¤ NA MONSTERAS
    projectsData.currentProject = 'Monsteras';
    projectsData.currentPart = 'Dry';
    
    // 9. REFRESH UI
    updateProjectsUI();
    
    alert(`âœ… RESET HOTOVÃ!\n\nProjekt: Monsteras\nÄŒasti: 5\n\nDry, FLA, Sul, Lig, Lht\n\nIzometrie: ${isometricsSnapshot.size}\nÄŒasti z izometriÃ­: ${partsFound.size}`);
    
  } catch(err) {
    console.error('âŒ Chyba pri resete:', err);
    alert('âŒ Chyba: ' + err.message);
  }
}

// VyÄistiÅ¥ Firebase od zlÃ½ch projektov a duplicÃ­t
async function cleanupFirebaseProjects() {
  if(!db) {
    alert('âŒ Firebase nie je dostupnÃ½!');
    return;
  }
  
  if(!confirm('ğŸ§¹ VyÄistiÅ¥ Firebase?\n\nTÃ¡to akcia:\n1. VymaÅ¾e zlÃ© projekty (DRY, FLA, SUL, "MÃ´j prvÃ½ projekt")\n2. VymaÅ¾e duplicitnÃ© Äasti v Monsteras\n3. ZachovÃ¡ len sprÃ¡vnu Å¡truktÃºru\n\nPokraÄovaÅ¥?')) {
    return;
  }
  
  try {
    console.log('ğŸ§¹ ÄŒistenie Firebase...');
    
    // 1. VymazaÅ¥ zlÃ© projekty z Firebase
    const badProjects = ['DRY', 'FLA', 'SUL', 'MÃ´j prvÃ½ projekt', 'Moj prvÃ½ projekt', 'My first project'];
    
    for(const badProject of badProjects) {
      try {
        // VymazaÅ¥ subcollection parts
        const partsSnapshot = await db.collection('projects_structure')
          .doc(badProject)
          .collection('parts')
          .get();
        
        for(const partDoc of partsSnapshot.docs) {
          await partDoc.ref.delete();
          console.log('ğŸ—‘ï¸ VymazanÃ¡ ÄasÅ¥:', badProject, '/', partDoc.id);
        }
        
        // VymazaÅ¥ hlavnÃ½ dokument
        await db.collection('projects_structure').doc(badProject).delete();
        console.log('ğŸ—‘ï¸ VymazanÃ½ projekt:', badProject);
      } catch(e) {
        console.log('âš ï¸ Projekt', badProject, 'neexistuje alebo uÅ¾ bol vymazanÃ½');
      }
    }
    
    // 2. VymazaÅ¥ duplicitnÃ© Äasti v Monsteras
    const monsterasPartsSnapshot = await db.collection('projects_structure')
      .doc('Monsteras')
      .collection('parts')
      .get();
    
    const correctParts = ['Dry', 'FLA', 'Sul', 'Lig', 'Lht'];
    
    for(const partDoc of monsterasPartsSnapshot.docs) {
      const partName = partDoc.id;
      
      // Ak ÄasÅ¥ NIE JE v zozname sprÃ¡vnych ÄastÃ­ â†’ vymaÅ¾
      if(!correctParts.includes(partName)) {
        await partDoc.ref.delete();
        console.log('ğŸ—‘ï¸ VymazanÃ¡ duplicitnÃ¡ ÄasÅ¥:', partName);
      }
    }
    
    // 3. VyÄistiÅ¥ projectsData v pamÃ¤ti
    for(const badProject of badProjects) {
      if(projectsData.projects[badProject]) {
        delete projectsData.projects[badProject];
        console.log('ğŸ—‘ï¸ VymazanÃ½ z pamÃ¤te:', badProject);
      }
    }
    
    // 4. NAÄŒÃTAÅ¤ PROJEKTY Z FIREBASE ZNOVA!
    console.log('ğŸ”„ NaÄÃ­tavam projekty z Firebase...');
    await loadProjectsFromFirebase();
    
    // 5. Refresh UI
    updateProjectsUI();
    
    alert('âœ… VyÄistenÃ© a obnovenÃ©!\n\nProjekt Monsteras mÃ¡ teraz 5 ÄastÃ­:\nDry, FLA, Sul, Lig, Lht\n\nDÃ¡ta boli naÄÃ­tanÃ© z Firebase!');
    
  } catch(err) {
    console.error('âŒ Chyba pri ÄistenÃ­:', err);
    alert('âŒ Chyba: ' + err.message);
  }
}

async function restoreProjectsFromIsometrics() {
  if(!db) {
    alert('âŒ Firebase nie je dostupnÃ½!');
    return;
  }
  
  const projectNameInput = prompt('ğŸ“ Zadaj nÃ¡zov projektu:\n\n(VÅ¡etky izometrie budÃº priradenÃ© k tomuto projektu)', 'Monsteras');
  
  if(!projectNameInput || projectNameInput.trim() === '') {
    alert('âŒ NÃ¡zov projektu nemÃ´Å¾e byÅ¥ prÃ¡zdny!');
    return;
  }
  
  const mainProjectName = projectNameInput.trim();
  
  try {
    console.log('ğŸ”„ Obnovovanie projektu:', mainProjectName);
    
    const snapshot = await db.collection('projects').get();
    const partsFound = new Set();
    
    snapshot.forEach(doc => {
      const data = doc.data();
      
      // Pridaj vÅ¡etky Äasti ktorÃ© majÃº part field
      if(data.part) {
        partsFound.add(data.part);
        console.log('âœ… NÃ¡jdenÃ¡ ÄasÅ¥:', data.part, 'z dokumentu:', doc.id);
      }
    });
    
    console.log('ğŸ“Š NÃ¡jdenÃ© Äasti:', Array.from(partsFound));
    
    if(partsFound.size === 0) {
      alert('âŒ Å½iadne Äasti nenÃ¡jdenÃ©!\n\nIzometrie nemajÃº nastavenÃ© pole "part".');
      return;
    }
    
    // VytvoriÅ¥ projekt
    if(!projectsData.projects[mainProjectName]) {
      projectsData.projects[mainProjectName] = {
        parts: {},
        created: new Date().toISOString(),
        createdBy: window.currentUser?.username || 'system'
      };
    }
    
    // VytvoriÅ¥ Äasti
    for(const partName of partsFound) {
      if(!projectsData.projects[mainProjectName].parts[partName]) {
        projectsData.projects[mainProjectName].parts[partName] = {
          weldBookData: [],
          created: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };
        console.log('âœ… VytvorenÃ¡ ÄasÅ¥:', partName);
      }
    }
    
    // Pridaj aj prÃ¡zdne Äasti Lig a Lht ak chÃ½bajÃº
    const standardParts = ['Dry', 'FLA', 'Sul', 'Lig', 'Lht'];
    for(const partName of standardParts) {
      if(!projectsData.projects[mainProjectName].parts[partName]) {
        projectsData.projects[mainProjectName].parts[partName] = {
          weldBookData: [],
          created: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };
        console.log('â• PridanÃ¡ Å¡tandardnÃ¡ ÄasÅ¥:', partName);
      }
    }
    
    // UloÅ¾iÅ¥ do Firebase
    await saveProjectsToFirebase();
    
    // PrepnÃºÅ¥ na tento projekt
    projectsData.currentProject = mainProjectName;
    projectsData.currentPart = Array.from(partsFound)[0] || 'Dry';
    
    // Refresh UI
    updateProjectsUI();
    
    const totalParts = Object.keys(projectsData.projects[mainProjectName].parts).length;
    alert(`âœ… ObnovenÃ©!\n\nProjekt: ${mainProjectName}\nÄŒasti: ${totalParts}\n\n${Array.from(Object.keys(projectsData.projects[mainProjectName].parts)).join(', ')}`);
    
  } catch(err) {
    console.error('âŒ Chyba pri obnove:', err);
    alert('âŒ Chyba: ' + err.message);
  }
}

function saveProjectsToStorage() {
  try {
    localStorage.setItem('projectsData', JSON.stringify(projectsData));
    console.log('ğŸ’¾ Projekty uloÅ¾enÃ© do localStorage (backup)');
  } catch(err) {
    console.error('âŒ Chyba pri ukladanÃ­ projektov:', err);
  }
}

function loadProjectsFromStorage() {
  try {
    var saved = localStorage.getItem('projectsData');
    if (saved) {
      projectsData = JSON.parse(saved);
      console.log('ğŸ“‚ NaÄÃ­tanÃ© projekty z localStorage');
      
      if (Object.keys(projectsData.projects).length === 0) {
        createDefaultProject();
      }
    } else {
      createDefaultProject();
    }
  } catch(err) {
    console.error('âŒ Chyba pri naÄÃ­tanÃ­ projektov:', err);
    createDefaultProject();
  }
}

async function createDefaultProject() {
  console.log('ğŸ†• VytvÃ¡ram default projekt...');
  var defaultProjectName = "MÃ´j prvÃ½ projekt";
  var defaultPartName = "ÄŒasÅ¥ 1";
  
  projectsData.currentProject = defaultProjectName;
  projectsData.currentPart = defaultPartName;
  projectsData.projects[defaultProjectName] = {
    parts: {},
    created: new Date().toISOString(),
    createdBy: window.currentUser?.username || 'system'
  };
  projectsData.projects[defaultProjectName].parts[defaultPartName] = {
    weldBookData: [],
    created: new Date().toISOString().slice(0,10),
    lastModified: new Date().toISOString().slice(0,10)
  };
  
  // UloÅ¾iÅ¥ do Firebase
  await saveProjectsToFirebase();
  
  // Backup do localStorage
  saveProjectsToStorage();
  
  console.log('âœ… Default projekt vytvorenÃ½:', defaultProjectName);
}

async function createNewProject(projectName) {
  if (!projectName || projectName.trim() === '') {
    alert('âŒ NÃ¡zov projektu nemÃ´Å¾e byÅ¥ prÃ¡zdny!');
    return false;
  }
  
  if (projectsData.projects[projectName]) {
    alert('âš ï¸ Projekt s tÃ½mto nÃ¡zvom uÅ¾ existuje!');
    return false;
  }
  
  console.log('ğŸ†• VytvÃ¡ram novÃ½ projekt:', projectName);
  
  var defaultPartName = "ÄŒasÅ¥ 1";
  projectsData.projects[projectName] = {
    parts: {},
    created: new Date().toISOString(),
    createdBy: window.currentUser?.username || 'system'
  };
  projectsData.projects[projectName].parts[defaultPartName] = {
    weldBookData: [],
    created: new Date().toISOString().slice(0,10),
    lastModified: new Date().toISOString().slice(0,10)
  };
  
  projectsData.currentProject = projectName;
  projectsData.currentPart = defaultPartName;
  
  // UloÅ¾iÅ¥ do Firebase
  await saveProjectsToFirebase();
  
  // Backup do localStorage
  saveProjectsToStorage();
  
  console.log('âœ… Projekt vytvorenÃ½:', projectName);
  return true;
}

function createNewPart(partName) {
  if (!projectsData.currentProject) {
    alert('âŒ Najprv vytvorte projekt!');
    return false;
  }
  
  if (!partName || partName.trim() === '') {
    alert('âŒ NÃ¡zov Äasti nemÃ´Å¾e byÅ¥ prÃ¡zdny!');
    return false;
  }
  
  var currentProj = projectsData.projects[projectsData.currentProject];
  if (currentProj.parts[partName]) {
    alert('âš ï¸ ÄŒasÅ¥ s tÃ½mto nÃ¡zvom uÅ¾ existuje!');
    return false;
  }
  
  console.log('ğŸ†• VytvÃ¡ram novÃº ÄasÅ¥:', partName);
  
  currentProj.parts[partName] = {
    weldBookData: [],
    created: new Date().toISOString().slice(0,10),
    lastModified: new Date().toISOString().slice(0,10)
  };
  
  projectsData.currentPart = partName;
  
  // UloÅ¾iÅ¥ do Firebase
  saveProjectsToFirebase();
  
  // Backup do localStorage
  saveProjectsToStorage();
  
  console.log('âœ… ÄŒasÅ¥ vytvorenÃ¡:', partName);
  return true;
}

function switchToProject(projectName) {
  if (!projectsData.projects[projectName]) {
    console.error('âŒ Projekt neexistuje:', projectName);
    return false;
  }
  
  console.log('ğŸ”„ PrepÃ­nam na projekt:', projectName);
  projectsData.currentProject = projectName;
  
  var parts = Object.keys(projectsData.projects[projectName].parts);
  if (parts.length > 0) {
    projectsData.currentPart = parts[0];
  }
  
  saveProjectsToStorage();
  loadCurrentPartWeldBook();
  return true;
}

function switchToPart(partName) {
  if (!projectsData.currentProject) {
    console.error('âŒ Å½iadny aktÃ­vny projekt!');
    return false;
  }
  
  var currentProj = projectsData.projects[projectsData.currentProject];
  if (!currentProj.parts[partName]) {
    console.error('âŒ ÄŒasÅ¥ neexistuje:', partName);
    return false;
  }
  
  console.log('ğŸ”„ PrepÃ­nam na ÄasÅ¥:', partName);
  projectsData.currentPart = partName;
  
  saveProjectsToStorage();
  loadCurrentPartWeldBook();
  return true;
}

function loadCurrentPartWeldBook() {
  if (!projectsData.currentProject || !projectsData.currentPart) {
    console.log('âš ï¸ Å½iadny aktÃ­vny projekt/ÄasÅ¥');
    weldBookData = [];
    return;
  }
  
  var currentProj = projectsData.projects[projectsData.currentProject];
  var currentPart = currentProj.parts[projectsData.currentPart];
  
  weldBookData = currentPart.weldBookData || [];
  
  // MIGRÃCIA: RozdeliÅ¥ starÃ© dÃ¡ta ak nemajÃº stÄºpec "part"
  var needsMigration = false;
  weldBookData.forEach(function(row) {
    if (!row.hasOwnProperty('part') && row.isometric) {
      needsMigration = true;
      var splitName = splitIsometricName(row.isometric);
      row.part = splitName.part;
      row.isometric = splitName.isometric;
    }
  });
  
  if (needsMigration) {
    console.log('ğŸ”„ MigrÃ¡cia: RozdelenÃ© nÃ¡zvy v', weldBookData.length, 'riadkoch');
    saveCurrentPartWeldBook();
  }
  
  console.log('ğŸ“‚ NaÄÃ­tanÃ½ WeldBook pre:', projectsData.currentProject, '/', projectsData.currentPart);
  console.log('   Zvarov:', weldBookData.length);
}

function saveCurrentPartWeldBook() {
  // VÅ¾dy uloÅ¾ do localStorage (pre vÅ¡etky reÅ¾imy)
  saveWeldBookToStorage();
  
  // Ak mÃ¡me naÄÃ­tanÃ½ OFFLINE projekt, uloÅ¾ tam WeldBook
  if (currentOfflineProjectId) {
    try {
      const result = loadOfflineProjectData(currentOfflineProjectId);
      if (result.success) {
        const wrappedData = result.data;
        const projectData = wrappedData.data || wrappedData;
        
        // Aktualizuj weldBookData v projekte
        projectData.weldBookData = weldBookData;
        
        // UloÅ¾ spÃ¤Å¥ do offline storage
        wrappedData.data = projectData;
        saveOfflineProject(currentOfflineProjectId, wrappedData.data);
        
        console.log('ğŸ’¾ WeldBook auto-saved do offline projektu:', currentOfflineProjectId);
      }
    } catch(e) {
      console.error('âš ï¸ Chyba pri auto-save do offline:', e);
    }
  }
  
  // UloÅ¾ aj do starej Å¡truktÃºry (pre kompatibilitu)
  if (projectsData.currentProject && projectsData.currentPart) {
    try {
      var currentProj = projectsData.projects[projectsData.currentProject];
      if (currentProj && currentProj.parts) {
        var currentPart = currentProj.parts[projectsData.currentPart];
        if (currentPart) {
          currentPart.weldBookData = weldBookData;
          currentPart.lastModified = new Date().toISOString().slice(0,10);
          saveProjectsToStorage();
          
          // âœ… KRITICKÃ OPRAVA - UloÅ¾ aj do Firebase!
          saveProjectsToFirebase().catch(function(err) {
            console.error('âš ï¸ Chyba pri Firebase sync:', err);
          });
        }
      }
    } catch(e) {
      console.error('âš ï¸ Chyba pri ukladanÃ­ do projectsData:', e);
    }
  }
  
  console.log('ğŸ’¾ WeldBook uloÅ¾enÃ½ (localStorage + Firebase)');
}

// ============= UI FUNKCIE PRE BOÄŒNÃ PANEL =============

function toggleProjectsPanel() {
  var panel = document.getElementById('projectsPanel');
  if (panel.style.transform === 'translateX(0px)') {
    panel.style.transform = 'translateX(-220px)';
  } else {
    panel.style.transform = 'translateX(0px)';
  }
}

function showNotification(message) {
  const notif = document.createElement('div');
  notif.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;font-size:14px;font-weight:600;';
  notif.textContent = message;
  document.body.appendChild(notif);
  setTimeout(() => {
    notif.style.opacity = '0';
    notif.style.transition = 'opacity 0.3s';
    setTimeout(() => notif.remove(), 300);
  }, 2000);
}

function promptNewProject() {
  var projectName = prompt('Zadajte nÃ¡zov novÃ©ho projektu:', 'Projekt ' + (Object.keys(projectsData.projects).length + 1));
  if (projectName) {
    if (createNewProject(projectName)) {
      updateProjectsUI();
      alert('âœ… Projekt vytvorenÃ½: ' + projectName);
    }
  }
}

function promptNewPart() {
  if (!projectsData.currentProject) {
    alert('âŒ Najprv vytvorte projekt!');
    return;
  }
  
  var currentProj = projectsData.projects[projectsData.currentProject];
  var partCount = Object.keys(currentProj.parts).length;
  var partName = prompt('Zadajte nÃ¡zov novej Äasti:', 'ÄŒasÅ¥ ' + (partCount + 1));
  
  if (partName) {
    if (createNewPart(partName)) {
      updateProjectsUI();
      alert('âœ… ÄŒasÅ¥ vytvorenÃ¡: ' + partName);
    }
  }
}

function updateProjectsUI() {
  // Update projects list
  var projectsList = document.getElementById('projectsList');
  if(projectsList) {
    projectsList.innerHTML = '';
    
    var projectNames = Object.keys(projectsData.projects);
    
    if(projectNames.length === 0) {
      projectsList.innerHTML = '<div style="text-align:center;color:#999;padding:10px;font-size:12px">Å½iadne projekty</div>';
    } else {
      projectNames.forEach(function(projectName) {
        var isActive = projectName === projectsData.currentProject;
        
        var div = document.createElement('div');
        div.className = 'part-item' + (isActive ? ' active' : '');
        div.style.cursor = 'pointer';
        
        var nameSpan = document.createElement('span');
        nameSpan.textContent = 'ğŸ“ ' + projectName;
        nameSpan.style.flex = '1';
        
        div.appendChild(nameSpan);
        
        div.onclick = function() {
          if (switchToProject(projectName)) {
            updateProjectsUI();
            alert('âœ… PrepnutÃ© na projekt: ' + projectName);
          }
        };
        
        projectsList.appendChild(div);
      });
    }
  }
  
  // Update part display (keep for info)
  var currentPartDisplay = document.getElementById('currentPartDisplay');
  if(currentPartDisplay) {
    currentPartDisplay.textContent = projectsData.currentPart || '-';
  }
  
  // Update parts list
  var partsList = document.getElementById('partsList');
  if(partsList) {
    partsList.innerHTML = '';
    
    if (projectsData.currentProject && projectsData.projects[projectsData.currentProject]) {
      var currentProj = projectsData.projects[projectsData.currentProject];
      var parts = Object.keys(currentProj.parts);
      
      if(parts.length === 0) {
        partsList.innerHTML = '<div style="text-align:center;color:#999;padding:10px;font-size:12px">Å½iadne Äasti</div>';
      } else {
        parts.forEach(function(partName) {
          var part = currentProj.parts[partName];
          var weldCount = part.weldBookData ? part.weldBookData.length : 0;
          var isActive = partName === projectsData.currentPart;
          
          var div = document.createElement('div');
          div.className = 'part-item' + (isActive ? ' active' : '');
          
          var nameSpan = document.createElement('span');
          nameSpan.textContent = 'ğŸ“‚ ' + partName;
          nameSpan.style.flex = '1';
          nameSpan.style.cursor = 'pointer';
          nameSpan.onclick = function() {
            if (switchToPart(partName)) {
              updateProjectsUI();
              if (weldBookGrid && weldBookGrid.api) {
                weldBookGrid.api.setRowData(weldBookData);
              }
              alert('âœ… PrepnutÃ© na: ' + partName + '\n\nZvarov: ' + weldCount);
            }
          };
          
          var countSpan = document.createElement('span');
          countSpan.textContent = '(' + weldCount + ')';
          countSpan.style.fontSize = '11px';
          countSpan.style.color = '#999';
          
          div.appendChild(nameSpan);
          div.appendChild(countSpan);
          
          partsList.appendChild(div);
        });
      }
    } else {
      partsList.innerHTML = '<div style="text-align:center;color:#999;padding:10px;font-size:12px">Vyber projekt</div>';
    }
  }
}

function promptRenamePart(oldName) {
  var newName = prompt('NovÃ½ nÃ¡zov Äasti:', oldName);
  if (!newName || newName.trim() === '' || newName === oldName) {
    return;
  }
  
  if (!projectsData.currentProject) {
    alert('âŒ Å½iadny aktÃ­vny projekt!');
    return;
  }
  
  var currentProj = projectsData.projects[projectsData.currentProject];
  
  if (currentProj.parts[newName]) {
    alert('âš ï¸ ÄŒasÅ¥ s nÃ¡zvom "' + newName + '" uÅ¾ existuje!');
    return;
  }
  
  console.log('âœï¸ PremenovÃ¡vam ÄasÅ¥:', oldName, 'â†’', newName);
  
  // SkopÃ­ruj dÃ¡ta
  currentProj.parts[newName] = currentProj.parts[oldName];
  
  // ZmaÅ¾ starÃ½ nÃ¡zov
  delete currentProj.parts[oldName];
  
  // Ak to bola aktÃ­vna ÄasÅ¥, aktualizuj
  if (projectsData.currentPart === oldName) {
    projectsData.currentPart = newName;
  }
  
  saveProjectsToStorage();
  updateProjectsUI();
  alert('âœ… ÄŒasÅ¥ premenovanÃ¡: ' + oldName + ' â†’ ' + newName);
}

function promptDeletePart(partName) {
  if (!projectsData.currentProject) {
    alert('âŒ Å½iadny aktÃ­vny projekt!');
    return;
  }
  
  var currentProj = projectsData.projects[projectsData.currentProject];
  var parts = Object.keys(currentProj.parts);
  
  if (parts.length === 1) {
    alert('âš ï¸ NemÃ´Å¾ete zmazaÅ¥ poslednÃº ÄasÅ¥ projektu!\n\nProjekt musÃ­ maÅ¥ aspoÅˆ jednu ÄasÅ¥.');
    return;
  }
  
  var part = currentProj.parts[partName];
  var weldCount = part.weldBookData ? part.weldBookData.length : 0;
  
  var confirmMsg = 'â— POZOR â—\n\n';
  confirmMsg += 'Naozaj zmazaÅ¥ ÄasÅ¥ "' + partName + '"?\n\n';
  if (weldCount > 0) {
    confirmMsg += 'âš ï¸ StratÃ­te ' + weldCount + ' zvarov!\n\n';
  }
  confirmMsg += 'TÃ¡to akcia je nevratnÃ¡!';
  
  if (!confirm(confirmMsg)) {
    return;
  }
  
  console.log('ğŸ—‘ï¸ MaÅ¾em ÄasÅ¥:', partName);
  
  // ZmaÅ¾ ÄasÅ¥
  delete currentProj.parts[partName];
  
  // Ak to bola aktÃ­vna ÄasÅ¥, prepni na inÃº
  if (projectsData.currentPart === partName) {
    var remainingParts = Object.keys(currentProj.parts);
    projectsData.currentPart = remainingParts[0];
    loadCurrentPartWeldBook();
    if (weldBookGrid && weldBookGrid.api) {
      weldBookGrid.api.setRowData(weldBookData);
    }
  }
  
  saveProjectsToStorage();
  updateProjectsUI();
  alert('âœ… ÄŒasÅ¥ zmazanÃ¡: ' + partName + '\n\nPrepnutÃ© na: ' + projectsData.currentPart);
}

// ============= NAÄŒÃTANIE PRI Å TARTE PROGRAMU =============
window.addEventListener('DOMContentLoaded', async function() {
  // âœ… NaÄÃ­taÅ¥ projekty z Firebase (online)
  await loadProjectsFromFirebase();
  
  loadCurrentPartWeldBook();
  loadKontrolaData();
  loadVyrobaData();
  loadNotifications();
  loadExportData();
  loadMTOData();
  updateProjectsUI();
  console.log('ğŸš€ Program naÄÃ­tanÃ½!');
  console.log('ğŸ“‹ AktÃ­vny projekt:', projectsData.currentProject);
  console.log('ğŸ“ AktÃ­vna ÄasÅ¥:', projectsData.currentPart);
});
function clearMTOTable(){
if(!confirm('âš ï¸ Naozaj vymazaÅ¥ celÃº MTO tabuÄ¾ku?')){return;}
mtoData.materials=[];
mtoData.isometricMaterials={};
saveMTOData();
document.getElementById('mtoSimpleTableBody').innerHTML='<tr><td colspan="10" style="padding:40px;text-align:center;color:#999">TabuÄ¾ka vymazanÃ¡</td></tr>';
document.getElementById('mtoTotalItems').textContent='0';
alert('âœ… TabuÄ¾ka vymazanÃ¡!');
}

function uploadMTOExcel(){
var input=document.createElement('input');
input.type='file';
input.accept='.xlsx,.xls,.csv';
input.onchange=function(e){
var file=e.target.files[0];
if(!file)return;
var reader=new FileReader();
reader.onload=function(event){
try{
var data=new Uint8Array(event.target.result);
var workbook=XLSX.read(data,{type:'array'});
var sheet=workbook.Sheets[workbook.SheetNames[0]];
var json=XLSX.utils.sheet_to_json(sheet);
console.log('ğŸ“Š MTO Excel loaded:',json.length,'rows');
if(!mtoData.materials){mtoData.materials=[];}
var added=0;
json.forEach(function(row){
var item=(row['PART DESCRIPTION']||row['DESCRIPTION']||'').trim();
var size=(row['DIMENSIONS']||'').trim();
var mat=(row['MATERIAL']||'').trim();
var qty=parseFloat(row['QTY']||1);
var fileCol=row['FILE']||row['File']||'';
if(!item)return;
mtoData.materials.push({
item:item,
description:item,
size:size,
qtyNeeded:qty,
qtyInStock:0,
qtyMissing:qty,
heatNumber:'',
isometric:fileCol,
source:'MTO_EXCEL'
});
added++;
});
saveMTOData();
// Renderuj do HTML tabuÄ¾ky
var tbody=document.getElementById('mtoSimpleTableBody');
var html='';
var rowNum=1;
mtoData.materials.forEach(function(mat){
html+='<tr style="border-bottom:1px solid #f0f0f0">';
html+='<td style="padding:10px">'+rowNum+'</td>';
html+='<td style="padding:10px"><strong>'+mat.item+'</strong></td>';
html+='<td style="padding:10px">'+mat.description+'</td>';
html+='<td style="padding:10px">'+mat.size+'</td>';
html+='<td style="padding:10px">'+mat.qtyNeeded+'</td>';
html+='<td style="padding:10px;background:#d4edda">'+mat.qtyInStock+'</td>';
html+='<td style="padding:10px;background:#f8d7da">'+mat.qtyMissing+'</td>';
html+='<td style="padding:10px">'+mat.heatNumber+'</td>';
html+='<td style="padding:10px;font-size:11px">'+mat.isometric+'</td>';
html+='<td style="padding:10px"><span style="background:#e0e7ff;padding:4px 8px;border-radius:4px;font-size:11px">MTO_EXCEL</span></td>';
html+='</tr>';
rowNum++;
});
tbody.innerHTML=html;
// Update stats
document.getElementById('mtoTotalItems').textContent=added;
alert('âœ… NaÄÃ­tanÃ©!\n\n'+added+' poloÅ¾iek zobrazenÃ½ch v tabuÄ¾ke!');
}catch(err){
console.error(err);
alert('âŒ Chyba: '+err.message);
}
};
reader.readAsArrayBuffer(file);
};
input.click();
}
function loadMaterialsFromMTO(){
// ZÃ­skaj nÃ¡zov sÃºboru z display elementu
var fileNameEl=document.getElementById('fileName');
var fullFileName=fileNameEl?fileNameEl.textContent:'';

if(!fullFileName || fullFileName==='Å½iadny sÃºbor'){
alert('âŒ Å½iadny sÃºbor nie je otvorenÃ½!\n\nNajprv otvor izometriu (PDF/JPG/PNG).');
return;
}

// OdstrÃ¡Åˆ prÃ­ponu z aktuÃ¡lneho sÃºboru
var isoName=fullFileName.replace(/\.(pdf|jpg|jpeg|png|json|dxf)$/i,'');
// OdstrÃ¡Åˆ aj _Sheet1 suffix ak existuje
isoName=isoName.replace(/_Sheet\d+$/i,'');

if(!mtoData.materials || mtoData.materials.length===0){
alert('âŒ Å½iadne MTO dÃ¡ta!\n\nNajprv klikni na "ğŸ“Š MTO" a uploadni Excel tabulku.');
return;
}
console.log('Looking for materials for:',isoName);
console.log('Total MTO materials:',mtoData.materials.length);
var materials=mtoData.materials.filter(function(m){
if(!m.isometric)return false;
// OdstrÃ¡Åˆ prÃ­ponu z MTO sÃºboru
var mtoName=m.isometric.replace(/\.(pdf|jpg|jpeg|png|json|dxf)$/i,'');
// OdstrÃ¡Åˆ _Sheet1 suffix
mtoName=mtoName.replace(/_Sheet\d+$/i,'');
var match=mtoName.toLowerCase().includes(isoName.toLowerCase()) || isoName.toLowerCase().includes(mtoName.toLowerCase());
console.log('Checking:',mtoName,'vs',isoName,'â†’',match);
return match;
});
console.log('Found materials for',isoName,':',materials.length);
if(materials.length===0){
alert('âŒ NenaÅ¡li sa materiÃ¡ly pre tÃºto izometriu!\n\nSÃºbor: '+isoName+'\n\nSkontroluj Äi nÃ¡zov v MTO Excel sÃºbore obsahuje nÃ¡zov izometrie.');
return;
}
var items=materials.map(function(m){
var cleanType=(m.item||m.description||'Item').replace(/\bmm\b/gi,'').replace(/\d+\s*mm/gi,'').trim();
if(cleanType.length>30)cleanType=cleanType.substring(0,30);
return{
type:cleanType,
diameter:m.size||'',
thickness:'',
material:m.material||'',
standard:'',
ptNo:'',
original:m
};
});
var modal=document.createElement('div');
modal.id='mtoSelectModal';
modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px';
var content='<div style="background:white;border-radius:4px;padding:30px;max-width:1000px;width:100%;max-height:90vh;overflow-y:auto">';
content+='<h2 style="color:#667eea">ğŸ“Š Vyber materiÃ¡ly z MTO</h2>';
content+='<p style="color:#666;margin-bottom:20px;font-size:14px">ZaÄiarkni materiÃ¡ly ktorÃ© chceÅ¡ pouÅ¾iÅ¥ pri oznaÄovanÃ­ zvarov:</p>';
content+='<div style="margin:15px 0">';
content+='<button onclick="selectAllMTO(true)" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px">âœ… VybraÅ¥ vÅ¡etko</button>';
content+='<button onclick="selectAllMTO(false)" style="padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer">âŒ ZruÅ¡iÅ¥ vÃ½ber</button>';
content+='</div>';
content+='<div style="max-height:450px;overflow-y:auto;border:2px solid #e5e7eb;border-radius:3px;padding:10px">';
items.forEach(function(m,idx){
var txt='<strong>'+m.type+'</strong>';
if(m.diameter)txt+=' - '+m.diameter;
if(m.material)txt+=' - '+m.material;
content+='<div style="padding:12px;border-bottom:1px solid #e5e7eb;background:white;margin-bottom:8px;border-radius:6px">';
content+='<input type="checkbox" id="mtochk_'+idx+'" class="mto-checkbox" checked style="width:20px;height:20px;cursor:pointer"> ';
content+='<label for="mtochk_'+idx+'" style="cursor:pointer">'+txt+'</label>';
content+='</div>';
});
content+='</div>';
content+='<div style="display:flex;gap:12px;margin-top:20px">';
content+='<button onclick="applyMTOSelection()" style="flex:1;padding:16px;background:#10b981;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:700">âœ… PouÅ¾iÅ¥ oznaÄenÃ©</button>';
content+='<button onclick="document.getElementById(\'mtoSelectModal\').remove()" style="padding:16px 32px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer">ZruÅ¡iÅ¥</button>';
content+='</div>';
content+='</div>';
modal.innerHTML=content;
document.body.appendChild(modal);
window.tempMTOItems=items;
}
</script>

<!-- MODAL: Zoznam spoolov -->
<div id="spoolListModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);width:90%;max-width:1200px;max-height:80%;overflow:auto">
<div style="padding:20px;border-bottom:2px solid #0078D4;background:#f5f5f5;display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:#0078D4;font-size:20px">ğŸ“‹ Zoznam spoolov</h2>
<button onclick="closeSpoolList()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>
</div>
<div style="padding:15px;background:#fafafa;border-bottom:1px solid #ddd">
<input type="text" id="spoolSearchInput" placeholder="ğŸ” HÄ¾adaÅ¥ izometriu..." style="width:100%;padding:10px;font-size:14px;border:2px solid #0078D4;border-radius:4px" oninput="filterSpoolList()">
</div>
<div style="padding:20px">
<table id="spoolListTable" style="width:100%;border-collapse:collapse;font-size:13px">
<thead>
<tr style="background:#0078D4;color:white">
<th style="padding:12px;text-align:left;border:1px solid #ddd">ğŸ“‹ Kontrola spoolov - RozbaÄ¾te trasy a spooly</th>
</tr>
</thead>
<tbody id="spoolListBody">
</tbody>
</table>
</div>
<div style="padding:15px;border-top:2px solid #ddd;background:#f5f5f5;text-align:right">
<button onclick="exportSpoolListToExcel()" style="background:#10b981;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-weight:600;margin-right:10px">ğŸ“Š Export do Excel</button>
<button onclick="closeSpoolList()" style="background:#6b7280;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-weight:600">ZavrieÅ¥</button>
</div>
</div>
</div>

<!-- MODAL: Zoznam vÃ½roby -->
<div id="vyrobaListModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);width:90%;max-width:1200px;max-height:80%;overflow:auto">
<div style="padding:20px;border-bottom:2px solid #0078D4;background:#f5f5f5;display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:#0078D4;font-size:20px">ğŸ­ Zoznam vÃ½roby</h2>
<button onclick="closeVyrobaList()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>
</div>
<div style="padding:15px;background:#fafafa;border-bottom:1px solid #ddd">
<input type="text" id="vyrobaSearchInput" placeholder="ğŸ” HÄ¾adaÅ¥ izometriu..." style="width:100%;padding:10px;font-size:14px;border:2px solid #0078D4;border-radius:4px" oninput="filterVyrobaList()">
</div>
<div style="padding:20px">
<table id="vyrobaListTable" style="width:100%;border-collapse:collapse;font-size:13px">
<thead>
<tr style="background:#0078D4;color:white">
<th style="padding:12px;text-align:left;border:1px solid #ddd">NÃ¡zov izometrie</th>
<th style="padding:12px;text-align:center;border:1px solid #ddd;width:150px">â˜ ZaÄatÃ¡ predvÃ½roba</th>
<th style="padding:12px;text-align:center;border:1px solid #ddd;width:150px">â˜ UkonÄenÃ¡ predvÃ½roba</th>
</tr>
</thead>
<tbody id="vyrobaListBody">
</tbody>
</table>
</div>
<div style="padding:15px;border-top:2px solid #ddd;background:#f5f5f5;text-align:right">
<button onclick="closeVyrobaList()" style="background:#6b7280;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-weight:600">ZavrieÅ¥</button>
</div>
</div>
</div>

<!-- PANEL: NotifikÃ¡cie -->
<div id="notificationPanel" style="display:none;position:fixed;top:60px;right:20px;width:400px;max-height:600px;background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:10000;overflow:hidden">
<div style="padding:15px;border-bottom:2px solid #0078D4;background:#f5f5f5;display:flex;justify-content:space-between;align-items:center">
<h3 style="margin:0;color:#0078D4;font-size:16px">ğŸ”” NotifikÃ¡cie</h3>
<button onclick="closeNotifications()" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-weight:600">âœ•</button>
</div>
<div id="notificationList" style="max-height:500px;overflow-y:auto;padding:10px">
<!-- NotifikÃ¡cie sa tu zobrazujÃº -->
</div>
</div>

<!-- MODAL: QR Scanner -->
<div id="qrScannerModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:20000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px">
<div style="background:white;border-radius:8px;padding:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0;color:#0078D4">ğŸ“· Naskenujte QR kÃ³d</h2>
<button onclick="closeQRScanner()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>
</div>
<div style="position:relative;background:#000;border-radius:8px;overflow:hidden">
<video id="qrVideo" style="width:100%;height:auto;display:block" autoplay playsinline></video>
<canvas id="qrCanvas" style="display:none"></canvas>
</div>
<div id="qrResult" style="margin-top:15px;padding:12px;background:#f0f9ff;border:2px solid #0078D4;border-radius:4px;display:none">
<strong>âœ… NaskenovanÃ©:</strong> <span id="qrResultText"></span>
</div>
<div id="qrError" style="margin-top:15px;padding:12px;background:#fee;border:2px solid #ef4444;border-radius:4px;display:none;color:#ef4444">
<strong>âš ï¸ Chyba:</strong> <span id="qrErrorText"></span>
</div>
<button id="qrScannerDoneBtn" onclick="stopExtraSpoolsScanner()" style="display:none;width:100%;margin-top:15px;background:#10b981;color:white;border:none;padding:12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:16px">âœ… Hotovo - SpÃ¤Å¥ na dodacÃ­ list</button>
</div>
</div>
</div>

<!-- MODAL: VytvoriÅ¥ balÃ­k -->
<div id="createPackageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:20000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:700px">
<div style="background:white;border-radius:8px;padding:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0;color:#0078D4">ğŸ“¦ VytvoriÅ¥ balÃ­k #<span id="currentPackageNum">1</span></h2>
<button onclick="closeCreatePackage()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>
</div>
<div style="position:relative;background:#000;border-radius:8px;overflow:hidden;margin-bottom:15px">
<video id="packageQRVideo" style="width:100%;height:auto;display:block" autoplay playsinline></video>
<canvas id="packageQRCanvas" style="display:none"></canvas>
</div>
<div id="scannedSpoolsList" style="max-height:300px;overflow-y:auto;background:#f9f9f9;border:2px solid #ddd;border-radius:4px;padding:10px;margin-bottom:15px">
<div style="text-align:center;color:#999">NaÄÃ­tajte QR kÃ³dy spoolov...</div>
</div>
<div style="display:flex;gap:10px">
<button onclick="finishPackage()" style="flex:1;background:#10b981;color:white;border:none;padding:12px;border-radius:4px;cursor:pointer;font-weight:600">âœ… DokonÄiÅ¥ balÃ­k</button>
<button onclick="closeCreatePackage()" style="flex:1;background:#6b7280;color:white;border:none;padding:12px;border-radius:4px;cursor:pointer;font-weight:600">ZruÅ¡iÅ¥</button>
</div>
</div>
</div>
</div>

<!-- MODAL: Zoznam balÃ­kov -->
<div id="packageListModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);width:90%;max-width:1000px;max-height:80%;overflow:auto">
<div style="padding:20px;border-bottom:2px solid #0078D4;background:#f5f5f5;display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:#0078D4">ğŸ“¦ Zoznam balÃ­kov</h2>
<button onclick="closePackageList()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>
</div>
<div style="padding:15px;background:#fafafa">
<input type="text" id="packageSearchInput" placeholder="ğŸ” HÄ¾adaÅ¥ spool alebo izometriu..." style="width:100%;padding:10px;font-size:14px;border:2px solid #0078D4;border-radius:4px" oninput="filterPackages()">
</div>
<div id="packageListContent" style="padding:20px;max-height:500px;overflow-y:auto">
<!-- Packages list -->
</div>
</div>
</div>

<!-- MODAL: DodacÃ­ list -->
<div id="deliveryNoteModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='deliveryNoteModal')closeDeliveryNote()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);width:90%;max-width:900px;max-height:80%;overflow:auto" onclick="event.stopPropagation()">
<div style="padding:20px;border-bottom:2px solid #0078D4;background:#f5f5f5;display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:#0078D4">ğŸšš VytvoriÅ¥ dodacÃ­ list</h2>
<button onclick="closeDeliveryNote()" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:#999;padding:5px 10px">âœ•</button>
</div>
<div style="padding:20px">
<h3>VybraÅ¥ balÃ­ky:</h3>
<div id="deliveryPackagesList" style="max-height:200px;overflow-y:auto;border:1px solid #ddd;padding:10px;margin-bottom:20px">
<!-- Checkboxes for packages -->
</div>
<h3>Extra spooly (QR skener):</h3>
<button onclick="scanExtraSpools()" style="background:#8b5cf6;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-weight:600;margin-bottom:10px">ğŸ“· NaÄÃ­taÅ¥ QR kÃ³dy</button>
<div id="extraSpoolsList" style="max-height:150px;overflow-y:auto;border:1px solid #ddd;padding:10px;margin-bottom:20px;background:#f9f9f9">
<div style="color:#999">Å½iadne extra spooly</div>
</div>
<div style="padding:15px;background:#e0f2fe;border-radius:4px;margin-bottom:20px">
<strong>SPOLU: <span id="totalSpoolsCount">0</span> spoolov</strong>
</div>
<div style="display:flex;gap:10px">
<button onclick="generateDeliveryNotePDF()" style="flex:1;background:#0078D4;color:white;border:none;padding:12px;border-radius:4px;cursor:pointer;font-weight:600">ğŸ“„ GenerovaÅ¥ PDF</button>
<button onclick="closeDeliveryNote()" style="flex:1;background:#6b7280;color:white;border:none;padding:12px;border-radius:4px;cursor:pointer;font-weight:600">ZruÅ¡iÅ¥</button>
</div>
</div>
</div>
</div>

<!-- MODAL: QR Info Skener -->
<div id="qrInfoModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:20000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px">
<div style="background:white;border-radius:8px;padding:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0;color:#0078D4">ğŸ” QR Info - ÄŒo to je?</h2>
<button onclick="closeQRInfo()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600">âœ• ZavrieÅ¥</button>
</div>
<div style="position:relative;background:#000;border-radius:8px;overflow:hidden;margin-bottom:15px">
<video id="infoQRVideo" style="width:100%;height:auto;display:block" autoplay playsinline></video>
<canvas id="infoQRCanvas" style="display:none"></canvas>
</div>
<div id="qrInfoResult" style="padding:15px;background:#f0f9ff;border:2px solid #0078D4;border-radius:4px;display:none">
<!-- Info o naskenovanom QR -->
</div>
</div>
</div>
</div>

<!-- MODAL: MTO Material Take-Off -->
<div id="mtoGridModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;overflow:auto">
<div style="position:relative;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);width:98%;max-width:1400px;margin:20px auto;min-height:85vh">
<div style="position:sticky;top:0;background:linear-gradient(135deg,#0078D4 0%,#0053a6 100%);color:white;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;z-index:1">
<h2 style="margin:0;font-size:28px">ğŸ“‹ MTO - Material Take-Off</h2>
<button onclick="closeMTOGrid()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:16px">âœ• ZavrieÅ¥</button>
</div>

<div style="padding:20px">
<!-- INFO TEXT -->
<div style="background:#e0f2fe;border-left:4px solid #0284c7;padding:15px;margin-bottom:20px;border-radius:6px">
<p style="margin:0;color:#075985;font-weight:600;font-size:14px">â„¹ï¸ Ako pouÅ¾Ã­vaÅ¥ MTO:</p>
<ul style="margin:10px 0 0 0;padding-left:20px;color:#0369a1;font-size:13px">
<li><strong>ğŸ“„ NaÄÃ­taÅ¥ z PDF</strong> - Parsuje materiÃ¡ly z izometriÃ­ (Source: "PDF")</li>
<li><strong>ğŸ“¦ Import dodacieho listu</strong> â†’ <strong>"1 = CELKOVÃ‰ MTO"</strong> - Nahrajte Excel od zÃ¡kaznÃ­ka</li>
<li><strong>ğŸ”„ RozdeliÅ¥ PIPE</strong> - RozdelÃ­ PIPE na 6m kusy s vlastnÃ½mi Heat numbers</li>
<li>TabuÄ¾ka zobrazuje OBE: MTO z izometriÃ­ + CELKOVÃ‰ MTO od zÃ¡kaznÃ­ka</li>
</ul>
</div>

<!-- RIBBON BUTTONS -->
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button onclick="importMaterialFromPDF()" style="background:#10b981;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ“„ NaÄÃ­taÅ¥ z PDF</button>
<button onclick="uploadMTOExcel()" style="background:#8b5cf6;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ“Š Upload MTO Excel</button>
<button onclick="addMTORow()" style="background:#0078D4;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">â• PridaÅ¥ riadok</button>
<button onclick="importDeliveryNote()" style="background:#8b5cf6;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ“¦ Import dodacieho listu</button>
<button onclick="expandPipeRows()" style="background:#f59e0b;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ”„ RozdeliÅ¥ PIPE riadky</button>
<button onclick="calculateMTOStock()" style="background:#ec4899;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ§® PrepoÄÃ­taÅ¥</button>
<button onclick="exportMTOExcel()" style="background:#6b7280;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ’¾ Export Excel</button>
<button onclick="clearMTOTable()" style="background:#ef4444;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">ğŸ—‘ï¸ VymazaÅ¥ tabuÄ¾ku</button>
</div>

<!-- STATS -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px">
<div style="background:#d1fae5;padding:15px;border-radius:8px;border-left:4px solid #10b981">
<div style="color:#065f46;font-size:12px">CELKOM POLOÅ½IEK</div>
<div style="font-size:24px;font-weight:bold;color:#047857" id="mtoTotalItems">0</div>
</div>
<div style="background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #fbbf24">
<div style="color:#92400e;font-size:12px">CHÃBA</div>
<div style="font-size:24px;font-weight:bold;color:#b45309" id="mtoMissingItems">0</div>
</div>
<div style="background:#e0f2fe;padding:15px;border-radius:8px;border-left:4px solid #0ea5e9">
<div style="color:#075985;font-size:12px">NA SKLADE</div>
<div style="font-size:24px;font-weight:bold;color:#0369a1" id="mtoInStockItems">0</div>
</div>
<div style="background:#d1fae5;padding:15px;border-radius:8px;border-left:4px solid #10b981">
<div style="color:#065f46;font-size:12px">PRIPRAVENÃ‰ IZOMETRIE</div>
<div style="font-size:24px;font-weight:bold;color:#047857" id="mtoReadyIsos">0</div>
</div>
</div>

<!-- AG-GRID TABLE -->
<div style="overflow-x:auto;max-height:600px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:6px">
<table id="mtoSimpleTable" style="width:100%;border-collapse:collapse;font-size:13px;background:white">
<thead style="position:sticky;top:0;background:#667eea;color:white;z-index:10">
<tr>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">#</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Item</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Description</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Size</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Qty Needed</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">In Stock</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Missing</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Heat Number</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Isometric</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb">Source</th>
</tr>
</thead>
<tbody id="mtoSimpleTableBody">
<tr><td colspan="10" style="padding:40px;text-align:center;color:#999">NaÄÃ­taj MTO Excel...</td></tr>
</tbody>
</table>
</div>
<div id="mtoGrid" class="ag-theme-alpine" style="height:500px;width:100%;display:none"></div>
</div>
</div>
</div>

<!-- MODAL: Progres Dashboard -->
<div id="progressDashboardModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;overflow:auto">
<div style="position:relative;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);width:95%;max-width:1200px;margin:20px auto;min-height:80vh">
<div style="position:sticky;top:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;z-index:1">
<h2 style="margin:0;font-size:28px">ğŸ“Š PROGRES PROJEKTU</h2>
<button onclick="closeProgressDashboard()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:16px;transition:background 0.3s">âœ• ZavrieÅ¥</button>
</div>
<div id="progressDashboardContent" style="max-height:calc(100vh - 100px);overflow-y:auto">
<!-- Dashboard content -->
</div>
</div>
</div>


<!-- NOVÃ ADVANCED LIBRARY MANAGER (3 zÃ¡loÅ¾ky) -->
<div id="advancedLibraryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:100000">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:95%;max-width:1200px;max-height:90%;display:flex;flex-direction:column">
<!-- Header -->
<div style="padding:25px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<div>
<h2 style="margin:0;color:white;font-size:24px">ğŸ“š KniÅ¾nica projektov</h2>
<p style="margin:5px 0 0 0;color:rgba(255,255,255,0.9);font-size:13px">Online, Offline & ÃšloÅ¾isko</p>
</div>
<button onclick="closeLibraryManager()" style="background:transparent;border:none;font-size:32px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>

<!-- Tabs -->
<div style="padding:0 25px;background:#f5f5f5;border-bottom:2px solid #e5e7eb;display:flex;gap:5px">
<button id="tabOnline" class="library-tab active-library-tab" onclick="switchLibraryTab('online')" style="padding:15px 25px;border:none;background:transparent;cursor:pointer;font-size:15px;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:all 0.3s">
ğŸŒ Online projekty
</button>
<button id="tabOffline" class="library-tab" onclick="switchLibraryTab('offline')" style="padding:15px 25px;border:none;background:transparent;cursor:pointer;font-size:15px;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:all 0.3s">
ğŸ’¾ Offline projekty
</button>
<button id="tabStorage" class="library-tab" onclick="switchLibraryTab('storage')" style="padding:15px 25px;border:none;background:transparent;cursor:pointer;font-size:15px;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:all 0.3s">
ğŸ“Š ÃšloÅ¾isko
</button>
</div>

<!-- Tab Contents -->
<div style="flex:1;overflow-y:auto;padding:25px">
<!-- ONLINE TAB -->
<div id="onlineTabContent" class="tab-content" style="display:block">
<div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px">
<strong>ğŸŒ Online projekty</strong><br>
<span style="font-size:13px;color:#666">Projekty uloÅ¾enÃ© vo Firebase (vyÅ¾adujÃº internet)</span>
</div>
<div style="margin-bottom:15px">
<input type="text" id="onlineSearch" placeholder="ğŸ” HÄ¾adaÅ¥ projekt..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px" oninput="filterOnlineProjects()">
</div>
<div id="onlineProjectsList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px">
<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">â³ NaÄÃ­tavam online projekty...</div>
</div>
</div>

<!-- OFFLINE TAB -->
<div id="offlineTabContent" class="tab-content" style="display:none">
<div style="background:#fef3c7;padding:15px;border-radius:8px;margin-bottom:20px">
<strong>ğŸ’¾ Offline projekty</strong><br>
<span style="font-size:13px;color:#666">Projekty uloÅ¾enÃ© v prehliadaÄi (fungujÃº aj bez internetu)</span>
</div>
<button onclick="syncAllPendingWeldBook()" id="syncAllBtn" style="width:100%;padding:15px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:20px;transition:all 0.3s">
ğŸ”„ SynchronizovaÅ¥ vÅ¡etky zmeny
</button>
<div style="margin-bottom:15px">
<input type="text" id="offlineSearch" placeholder="ğŸ” HÄ¾adaÅ¥ projekt..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px" oninput="filterOfflineProjects()">
</div>
<div id="offlineProjectsList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px">
<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">â³ NaÄÃ­tavam offline projekty...</div>
</div>
</div>

<!-- STORAGE TAB -->
<div id="storageTabContent" class="tab-content" style="display:none">
<div style="background:#f0f4ff;padding:20px;border-radius:10px;margin-bottom:20px">
<h3 style="margin:0 0 15px 0;color:#667eea">ğŸ“Š Å tatistiky ÃºloÅ¾iska</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px">
<div style="background:white;padding:15px;border-radius:8px;text-align:center">
<div style="font-size:28px;font-weight:600;color:#667eea" id="totalProjects">0</div>
<div style="font-size:12px;color:#666;margin-top:5px">Celkom projektov</div>
</div>
<div style="background:white;padding:15px;border-radius:8px;text-align:center">
<div style="font-size:28px;font-weight:600;color:#10b981" id="offlineProjectsCount">0</div>
<div style="font-size:12px;color:#666;margin-top:5px">Offline projektov</div>
</div>
<div style="background:white;padding:15px;border-radius:8px;text-align:center">
<div style="font-size:28px;font-weight:600;color:#f59e0b" id="pendingSyncCount">0</div>
<div style="font-size:12px;color:#666;margin-top:5px">ÄŒakÃ¡ na sync</div>
</div>
<div style="background:white;padding:15px;border-radius:8px;text-align:center">
<div style="font-size:28px;font-weight:600;color:#8b5cf6" id="storageUsed">0 KB</div>
<div style="font-size:12px;color:#666;margin-top:5px">VyuÅ¾itÃ© miesto</div>
</div>
</div>
</div>

<div>
<h4 style="margin:0 0 15px 0;color:#333">ğŸ› ï¸ NÃ¡stroje ÃºdrÅ¾by</h4>
<button onclick="clearOfflineCache()" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin-bottom:10px">
ğŸ—‘ï¸ VymazaÅ¥ offline cache
</button>
<button onclick="exportOfflineData()" style="width:100%;padding:12px;background:#8b5cf6;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">
ğŸ“¦ ExportovaÅ¥ offline dÃ¡ta
</button>
</div>
</div>
</div>
</div>
</div>

<style>
.library-tab:hover {
color:#667eea !important;
background:rgba(102,126,234,0.05) !important;
}
.active-library-tab {
color:#667eea !important;
border-bottom-color:#667eea !important;
background:rgba(102,126,234,0.1) !important;
}
</style>

<!-- ONLINE KNIÅ½NICA (localStorage) -->
<div id="libraryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999">
<div style="background:white;width:90%;max-width:1200px;height:90%;margin:5% auto;border-radius:12px;overflow:hidden;display:flex;flex-direction:column">
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center">
<div>
<h2 style="margin:0">ğŸ“š Online KniÅ¾nica Projektov</h2>
<div id="libraryCounter" style="font-size:14px;margin-top:5px;opacity:0.9">Projektov: 0</div>
</div>
<button onclick="closeLibrary()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:10px 20px;border-radius:6px;cursor:pointer">âœ• ZavrieÅ¥</button>
</div>
<div style="padding:20px;border-bottom:1px solid #ddd">
<button onclick="uploadToLibrary()" style="background:#10b981;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin-right:10px">ğŸ“¤ Upload JSON</button>
<button onclick="deleteAllProjects()" style="background:#ef4444;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin-right:10px">ğŸ—‘ï¸ VymazaÅ¥ vÅ¡etky</button>
<input type="text" id="librarySearch" placeholder="ğŸ” HÄ¾adaÅ¥ projekt..." style="padding:10px;border:1px solid #ddd;border-radius:6px;width:300px" oninput="filterLibrary()">
</div>
<div id="libraryGrid" style="flex:1;overflow:auto;padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px">
<div style="grid-column:1/-1;text-align:center;padding:60px;color:#999">
<div style="font-size:48px">ğŸ“š</div>
<div style="font-size:18px;margin-top:10px">Å½iadne projekty</div>
<div style="font-size:14px;margin-top:10px">Kliknite "ğŸ“¤ Upload JSON"</div>
</div>
</div>
</div>
</div>

<script>
// KniÅ¾nica - localStorage
function openLibrary() {
  console.log('ğŸ”µ openLibrary called');
  const modal = document.getElementById('libraryModal');
  console.log('ğŸ”µ Modal element:', modal);
  if (modal) {
    modal.style.display = 'block';
    console.log('ğŸ”µ Modal displayed');
  } else {
    console.error('âŒ Modal not found!');
  }
  loadLibrary();
}

function closeLibrary() {
  document.getElementById('libraryModal').style.display = 'none';
}

async function loadLibrary() {
  const grid = document.getElementById('libraryGrid');
  grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#999">â³ NaÄÃ­tavam...</div>';
  
  try {
    const projects = await listProjectsFromFirebase();
    
    if (projects.length === 0) {
      const counterEl = document.getElementById('libraryCounter');
      if(counterEl) counterEl.textContent = 'Projektov: 0';
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#999"><div style="font-size:48px">ğŸ“š</div><div style="font-size:18px;margin-top:10px">Å½iadne projekty pre tÃºto ÄasÅ¥</div><div style="font-size:14px;color:#666;margin-top:10px">AktuÃ¡lna ÄasÅ¥: '+projectsData.currentPart+'</div></div>';
      return;
    }
    
    grid.innerHTML = projects.map((p, i) => {
      const docId = (p.part ? (p.name + '_' + p.part) : p.name).replace(/'/g, "\\'").replace(/"/g, '\\"');
      const displayName = p.name + (p.part ? ' / '+p.part : '');
      return `
      <div onclick="loadFromLibraryFirebase('${docId}')" style="position:relative;border:2px solid #ddd;border-radius:8px;padding:15px;cursor:pointer;transition:all 0.3s;background:white" onmouseover="this.style.borderColor='#667eea';this.style.transform='translateY(-5px)'" onmouseout="this.style.borderColor='#ddd';this.style.transform='translateY(0)'">
        <button onclick="deleteFromFirebase('${docId}'); event.stopPropagation();" style="position:absolute;top:10px;right:10px;background:#dc3545;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;opacity:0;transition:opacity 0.3s;z-index:10;" onmouseover="this.style.background='#c82333';this.parentElement.onmouseout=null;this.parentElement.onmouseover=null;" onmouseout="this.style.background='#dc3545';">ğŸ—‘ï¸</button>
        <div style="font-size:60px;text-align:center;margin-bottom:10px">ğŸ“„</div>
        <div style="font-weight:600;font-size:14px;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${displayName}">${displayName}</div>
        <div style="font-size:12px;color:#666">${(p.size/1024/1024).toFixed(1)} MB</div>
        <div style="font-size:11px;color:#999;margin-top:5px">${new Date(p.date).toLocaleDateString('sk')}</div>
      </div>
    `}).join('');
    
    // Aktualizuj poÄÃ­tadlo
    const counterEl = document.getElementById('libraryCounter');
    if(counterEl) {
      const partInfo = projectsData.currentPart ? ` (ÄasÅ¥: ${projectsData.currentPart})` : '';
      counterEl.textContent = `Projektov: ${projects.length}${partInfo}`;
    }
    
    // Zobraz delete tlaÄidlÃ¡ pri hover
    document.querySelectorAll('#libraryGrid > div').forEach(card => {
      card.addEventListener('mouseenter', function() {
        const btn = this.querySelector('button');
        if (btn) btn.style.opacity = '1';
      });
      card.addEventListener('mouseleave', function() {
        const btn = this.querySelector('button');
        if (btn) btn.style.opacity = '0';
      });
    });
    
  } catch(e) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#f00">âŒ Chyba: ' + e.message + '</div>';
  }
}

// Vymazanie VÅ ETKÃCH projektov
async function deleteAllProjects() {
  const projects = await listProjectsFromFirebase();
  
  if(projects.length === 0) {
    alert('KniÅ¾nica je prÃ¡zdna!');
    return;
  }
  
  const partInfo = projectsData.currentPart ? ` v Äasti "${projectsData.currentPart}"` : '';
  if (!confirm(`âš ï¸ POZOR!\n\nNaozaj vymazaÅ¥ VÅ ETKY projekty${partInfo}?\n\nPoÄet projektov: ${projects.length}\n\nTÃ¡to akcia je NEVRATNÃ!`)) {
    return;
  }
  
  // Progress modal
  const progressDiv = document.createElement('div');
  progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:30000;min-width:400px;';
  progressDiv.innerHTML = `
    <h3 style="margin:0 0 20px 0;color:#ef4444;">ğŸ—‘ï¸ MaÅ¾em projekty...</h3>
    <div style="background:#e0e0e0;height:30px;border-radius:15px;overflow:hidden;margin-bottom:15px;">
      <div id="deleteProgressBar" style="background:#ef4444;height:100%;width:0%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;"></div>
    </div>
    <div id="deleteProgressText" style="text-align:center;color:#666;font-size:14px;">Pripravujem...</div>
  `;
  document.body.appendChild(progressDiv);
  
  await new Promise(resolve => setTimeout(resolve, 100));
  
  const progressBar = document.getElementById('deleteProgressBar');
  const progressText = document.getElementById('deleteProgressText');
  
  let deleted = 0;
  let errors = 0;
  
  for(let i = 0; i < projects.length; i++) {
    const p = projects[i];
    const docId = p.part ? (p.name + '_' + p.part) : p.name;
    
    try {
      const percent = Math.round(((i + 1) / projects.length) * 100);
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      progressText.innerHTML = `ğŸ—‘ï¸ MaÅ¾em: <strong>${docId}</strong><br>${i + 1}/${projects.length}`;
      
      // VymaÅ¾ projekt
      await db.collection('projects').doc(docId).delete();
      
      // VymaÅ¾ chunky
      try {
        const chunksSnapshot = await db.collection('projects').doc(docId).collection('data').get();
        const deletePromises = chunksSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
      } catch(e) {}
      
      deleted++;
      await new Promise(resolve => setTimeout(resolve, 50));
      
    } catch(e) {
      console.error('Chyba pri mazanÃ­:', docId, e);
      errors++;
    }
  }
  
  progressBar.style.width = '100%';
  progressBar.style.background = '#10b981';
  progressBar.textContent = 'âœ… 100%';
  progressText.innerHTML = `<strong style="color:#10b981;">âœ… Hotovo!</strong><br>VymazanÃ©: ${deleted}, Chyby: ${errors}`;
  
  setTimeout(() => {
    document.body.removeChild(progressDiv);
    loadLibrary();
  }, 2000);
}

// Vymazanie projektu z Firebase
async function deleteFromFirebase(projectName) {
  if (!confirm(`Naozaj vymazaÅ¥ projekt "${projectName}"?\n\nTÃ¡to akcia je nevratnÃ¡!`)) {
    return;
  }
  
  try {
    console.log('ğŸ—‘ï¸ Mazanie projektu:', projectName);
    
    // VymaÅ¾ hlavnÃ½ dokument
    await db.collection('projects').doc(projectName).delete();
    
    // VymaÅ¾ aj chunks ak existujÃº
    try {
      const chunksSnapshot = await db.collection('projects').doc(projectName).collection('data').get();
      const deletePromises = chunksSnapshot.docs.map(doc => doc.ref.delete());
      await Promise.all(deletePromises);
      console.log('âœ… VymazanÃ©', chunksSnapshot.size, 'chunkov');
    } catch(e) {
      console.log('â„¹ï¸ Å½iadne chunky na vymazanie');
    }
    
    alert('âœ… Projekt vymazanÃ½!');
    loadLibrary(); // Refresh
    
  } catch(e) {
    console.error('âŒ Chyba pri mazanÃ­:', e);
    alert('âŒ Chyba pri mazanÃ­ projektu:\n' + e.message);
  }
}

function uploadToLibrary() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.multiple = true;
  
  input.onchange = async function(e) {
    const files = Array.from(e.target.files);
    let processed = 0;
    let errors = 0;
    let duplicates = 0;
    
    // NaÄÃ­taj existujÃºce projekty pre kontrolu duplicÃ­t
    const existingProjects = await listProjectsFromFirebase();
    const existingIds = new Set();
    existingProjects.forEach(p => {
      const docId = p.part ? (p.name + '_' + p.part) : p.name;
      existingIds.add(docId);
    });
    
    // Vytvor progress dialog
    const progressDiv = document.createElement('div');
    progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:20000;min-width:400px;';
    progressDiv.innerHTML = `
      <h3 style="margin:0 0 20px 0;color:#333;">ğŸ“¤ NahrÃ¡vam projekty do kniÅ¾nice</h3>
      <div style="background:#e0e0e0;height:30px;border-radius:15px;overflow:hidden;margin-bottom:15px;">
        <div id="uploadProgressBar" style="background:linear-gradient(90deg,#667eea,#764ba2);height:100%;width:0%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;"></div>
      </div>
      <div id="uploadProgressText" style="text-align:center;color:#666;font-size:14px;">Pripravujem...</div>
    `;
    document.body.appendChild(progressDiv);
    
    // PoÄkaj aby sa DOM aktualizoval
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const progressBar = document.getElementById('uploadProgressBar');
    const progressText = document.getElementById('uploadProgressText');
    
    if(!progressBar || !progressText){
      console.error('âŒ Progress elementy sa nenaÅ¡li!');
      return;
    }
    
    console.log('âœ… Progress elementy OK');
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      try {
        // Update progress
        const percent = Math.round(((i + 1) / files.length) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        progressText.innerHTML = `ğŸ“¦ NahrÃ¡vam: <strong>${file.name}</strong><br>${i + 1}/${files.length} sÃºborov`;
        
        console.log(`ğŸ“Š ${percent}% - ${file.name}`);
        
        const text = await file.text();
        const data = JSON.parse(text);
        
        // Nastav projectName z nÃ¡zvu sÃºboru (bez .json)
        const fileName = file.name.replace('.json', '');
        if(!data.projectName) data.projectName = fileName;
        
        // Nastav partName z aktuÃ¡lnej Äasti
        data.partName = projectsData.currentPart;
        
        // Skontroluj duplicitu
        const docId = data.partName ? (data.projectName + '_' + data.partName) : data.projectName;
        if(existingIds.has(docId)){
          console.warn('âš ï¸ Duplicita:', docId, '- prepÃ­Å¡em!');
          duplicates++;
        }
        
        await uploadProjectToFirebase(data);
        processed++;
        
        // Delay medzi uploadmi (zabrÃ¡ni Firebase rate limit)
        await new Promise(resolve => setTimeout(resolve, 150));
        
      } catch(e) {
        console.error('Chyba pri', file.name, ':', e);
        errors++;
      }
    }
    
    // Hotovo
    progressBar.style.width = '100%';
    progressBar.style.background = '#10b981';
    progressBar.textContent = 'âœ… 100%';
    progressText.innerHTML = `<strong style="color:#10b981;">âœ… Hotovo!</strong><br>ÃšspeÅ¡ne: ${processed}, Chyby: ${errors}${duplicates>0?', PrepÃ­sanÃ©: '+duplicates:''}`;
    
    setTimeout(() => {
      document.body.removeChild(progressDiv);
      loadLibrary();
    }, 2000);
  };
  
  input.click();
}

async function loadFromLibraryFirebase(projectName) {
  console.log('ğŸ”µ loadFromLibraryFirebase called:', projectName);
  try {
    console.log('ğŸ”µ Downloading project...');
    const projectData = await downloadProjectFromFirebase(projectName);
    console.log('ğŸ”µ Project downloaded:', projectData);
    
    // ğŸ§¹ VYÄŒISTIÅ¤ VÅ ETKO PRED NAÄŒÃTANÃM NOVÃ‰HO PROJEKTU!
    console.log('ğŸ§¹ ÄŒistenie starÃ½ch dÃ¡t pred naÄÃ­tanÃ­m...');
    ws = [];
    spools = [];
    crosses = [];
    dimensions = [];
    lines = [];
    arrows = [];
    texts = [];
    curves = [];
    spoolData = {};
    weldLogMaterials = [];
    weldAssignments = {};
    // âœ… weldBookData SA NEMAÅ½E! Je to globÃ¡lna databÃ¡za vÅ¡etkÃ½ch zvarov!
    // âœ… kontrolaData SA NEMAÅ½E! Je to globÃ¡lna databÃ¡za kontrol!
    
    ws = projectData.welds || [];
    spools = projectData.spools || [];
    crosses = projectData.crosses || [];
    dimensions = projectData.dimensions || [];
    lines = projectData.lines || [];
    arrows = projectData.arrows || [];
    texts = projectData.texts || [];
    curves = projectData.curves || [];
    // âœ… ZMENENÃ‰: WeldBook sa teraz naÄÃ­tava z projektu (zdieÄ¾anÃ½ cez Firebase)!
    if (projectData.weldBookData && projectData.weldBookData.length > 0) {
      weldBookData = projectData.weldBookData;
      saveWeldBookToStorage(); // UloÅ¾ aj do localStorage pre offline prÃ­stup
      console.log('ğŸ“¥ WeldBook naÄÃ­tanÃ½ z projektu:', weldBookData.length, 'zvarov');
    }
    // âœ… kontrolaData zostÃ¡va globÃ¡lny!
    spoolData = projectData.spoolData || {};
    cn = projectData.currentNumber || 1;
    startNum = projectData.startNumber || 1;
    originalFileName = projectData.projectName || 'zvary';
    
    
    // ğŸ”” Start update checker
    currentProjectName = projectName;
    currentProjectTimestamp = projectData.savedDate || new Date().toISOString();
    console.log('ğŸ”” Update checker - tracking:', currentProjectName, 'timestamp:', currentProjectTimestamp);
    startUpdateChecker();
    
    console.log('ğŸ”µ Data loaded, welds:', ws.length, 'weldBook:', weldBookData.length);
    
    if (projectData.pdfData) {
      console.log('ğŸ”µ Loading PDF...');
      const img = new Image();
      img.onload = function() {
        console.log('ğŸ”µ PDF loaded, drawing...');
        
        // UloÅ¾ obrÃ¡zok pre zoom
        loadedImage = img;
        baseImageWidth = img.naturalWidth || img.width;
        baseImageHeight = img.naturalHeight || img.height;
        
        // Zobraz canvas wrapper
        document.getElementById('up').style.display = 'none';
        document.getElementById('cw').style.display = 'block';
        
        // âœ… AKTIVUJ VÅ ETKY TLAÄŒIDLÃ (s try-catch aby chyba nezastavila celÃº funkciu)
        try {
          document.getElementById('zoomInfo').style.display='block';
          document.getElementById('zi').disabled=false;
          document.getElementById('zo').disabled=false;
          document.getElementById('zr').disabled=false;
          document.getElementById('savepdf').disabled=false;
          document.getElementById('saveproj').disabled=false;document.getElementById('savetolibrary').disabled=false;
          if(document.getElementById('savetolibrary')) document.getElementById('savetolibrary').disabled=false;
          document.getElementById('loadprojbtn').disabled=false;
          document.getElementById('editmode').disabled=false;
          if(document.getElementById('editcrossmode')) document.getElementById('editcrossmode').disabled=false;
          if(document.getElementById('setstart')) document.getElementById('setstart').disabled=false;
          if(document.getElementById('selectbtn')) document.getElementById('selectbtn').disabled=false;
          if(document.getElementById('crossbtn')) document.getElementById('crossbtn').disabled=false;
          if(document.getElementById('spoolbtn')) document.getElementById('spoolbtn').disabled=false;
          if(document.getElementById('spoollistbtn')) document.getElementById('spoollistbtn').disabled=false;
          if(document.getElementById('refreshspoolbtn')) document.getElementById('refreshspoolbtn').disabled=false;
          if(document.getElementById('addmontazweld')) document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;
          if(document.getElementById('spoolspreview')) document.getElementById('spoolspreview').disabled=false;
          if(document.getElementById('montazline')) document.getElementById('montazline').disabled=false;
          if(document.getElementById('montaztext')) document.getElementById('montaztext').disabled=false;
          if(document.getElementById('montaz_linebtn')) document.getElementById('montaz_linebtn').disabled=false;
          if(document.getElementById('montaz_textbtn')) document.getElementById('montaz_textbtn').disabled=false;
          if(document.getElementById('montaz_curvebtn')) document.getElementById('montaz_curvebtn').disabled=false;
          if(document.getElementById('montaz_arrowbtn')) document.getElementById('montaz_arrowbtn').disabled=false;
          if(document.getElementById('montaz_doublearrowbtn')) document.getElementById('montaz_doublearrowbtn').disabled=false;
          if(document.getElementById('weldlogbtn')) document.getElementById('weldlogbtn').disabled=false;
          if(document.getElementById('oneclickbtn')) document.getElementById('oneclickbtn').disabled=false;
          if(document.getElementById('twoclickbtn')) document.getElementById('twoclickbtn').disabled=false;document.getElementById('weldscaleminus').disabled=false;document.getElementById('weldscaleplus').disabled=false;
          if(document.getElementById('mtobtn')) document.getElementById('mtobtn').disabled=false;
          if(document.getElementById('dimensionbtn')) document.getElementById('dimensionbtn').disabled=false;document.getElementById('prefab_linebtn').disabled=false;document.getElementById('prefab_textbtn').disabled=false;document.getElementById('prefab_arrowbtn').disabled=false;document.getElementById('prefab_doublearrowbtn').disabled=false;document.getElementById('prefab_curvebtn').disabled=false;
          if(document.getElementById('linebtn')) document.getElementById('linebtn').disabled=false;
          if(document.getElementById('textbtn')) document.getElementById('textbtn').disabled=false;
          if(document.getElementById('curvebtn')) document.getElementById('curvebtn').disabled=false;
          if(document.getElementById('arrowbtn')) document.getElementById('arrowbtn').disabled=false;
          if(document.getElementById('doublearrowbtn')) document.getElementById('doublearrowbtn').disabled=false;
          if(document.getElementById('undo')) document.getElementById('undo').disabled=false;
          console.log('âœ… VÅ¡etky tlaÄidlÃ¡ aktivovanÃ©');
        } catch(btnError) {
          console.error('âš ï¸ Chyba pri aktivÃ¡cii tlaÄidiel:', btnError);
        }
        
        // Nastav zoom 100%
        sc = 1.0;
        var scaledWidth = baseImageWidth * sc;
        var scaledHeight = baseImageHeight * sc;
        
        ca.width = scaledWidth;
        ca.height = scaledHeight;
        ov.setAttribute('width', scaledWidth);
        ov.setAttribute('height', scaledHeight);
        ct.clearRect(0, 0, scaledWidth, scaledHeight);
        ct.imageSmoothingEnabled = false;
        ct.drawImage(img, 0, 0, scaledWidth, scaledHeight);
        dw();
        updateZoomDisplay();
        
        // âœ… Aktualizuj nÃ¡zov sÃºboru v hlaviÄke
        var fileNameSpan = document.getElementById('fileName');
        if (fileNameSpan) {
          fileNameSpan.textContent = originalFileName;
        }
        
        closeLibrary();
        alert('âœ… Projekt naÄÃ­tanÃ½: ' + originalFileName);
      };
      img.onerror = function() {
        console.error('âŒ PDF load failed!');
        alert('âŒ Chyba pri naÄÃ­tanÃ­ PDF!');
      };
      img.src = projectData.pdfData;
    } else {
      console.warn('âš ï¸ No PDF data in project!');
      alert('âš ï¸ Projekt neobsahuje PDF dÃ¡ta!');
    }
  } catch(e) {
    console.error('âŒ Error:', e);
    alert('âŒ Chyba: ' + e.message);
  }
}

function loadFromLibrary(index) {
  const library = JSON.parse(localStorage.getItem('weldpro_library') || '[]');
  const project = library[index];
  
  if (!project || !project.data) {
    alert('âŒ Chyba pri naÄÃ­tanÃ­ projektu!');
    return;
  }
  
  // NaÄÃ­taj projekt (pouÅ¾ijem existujÃºci kÃ³d z loadproj)
  const projectData = project.data;
  
  ws = projectData.welds || [];
  spools = projectData.spools || [];
  crosses = projectData.crosses || [];
  dimensions = projectData.dimensions || [];
  cn = projectData.currentNumber || 1;
  startNum = projectData.startNumber || 1;
  originalFileName = projectData.projectName || 'zvary';
  
  if (projectData.pdfData) {
    const img = new Image();
    img.onload = function() {
      // UloÅ¾ obrÃ¡zok pre zoom
      loadedImage = img;
      baseImageWidth = img.naturalWidth || img.width;
      baseImageHeight = img.naturalHeight || img.height;
      
      // Nastav zoom 100%
      sc = 1.0;
      var scaledWidth = baseImageWidth * sc;
      var scaledHeight = baseImageHeight * sc;
      
      ca.width = scaledWidth;
      ca.height = scaledHeight;
      ov.setAttribute('width', scaledWidth);
      ov.setAttribute('height', scaledHeight);
      ct.clearRect(0, 0, scaledWidth, scaledHeight);
      ct.imageSmoothingEnabled = false;
      ct.drawImage(img, 0, 0, scaledWidth, scaledHeight);
      dw();
      updateZoomDisplay();
      
      // âœ… Aktualizuj nÃ¡zov sÃºboru v hlaviÄke
      var fileNameSpan = document.getElementById('fileName');
      if (fileNameSpan) {
        fileNameSpan.textContent = originalFileName;
      }
      
      closeLibrary();
      alert('âœ… Projekt naÄÃ­tanÃ½: ' + originalFileName);
    };
    img.src = projectData.pdfData;
  }
}

function filterLibrary() {
  const search = document.getElementById('librarySearch').value.toLowerCase();
  const cards = document.querySelectorAll('#libraryGrid > div');
  cards.forEach(card => {
    const name = card.textContent.toLowerCase();
    card.style.display = name.includes(search) ? 'block' : 'none';
  });
}

// ğŸ“‹ HISTÃ“RIA DODACÃCH LISTOV
async function showDeliveryNotesHistory(){
document.getElementById('deliveryHistoryModal').style.display='block';
await loadDeliveryNotesFromFirebase();
}

function closeDeliveryHistory(){
document.getElementById('deliveryHistoryModal').style.display='none';
}

async function loadDeliveryNotesFromFirebase(){
const content=document.getElementById('deliveryHistoryContent');
content.innerHTML='<div style="text-align:center;color:#999;padding:40px">â³ NaÄÃ­tavam dodacie listy...</div>';

try{
if(!db){
content.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ Firebase nedostupnÃ½</div>';
return;
}

const snapshot=await db.collection('delivery_notes').orderBy('timestamp','desc').get();

if(snapshot.empty){
content.innerHTML='<div style="text-align:center;color:#999;padding:40px">ğŸ“­ Å½iadne dodacie listy<br><small>Vytvorte prvÃ½ dodacÃ­ list v EXPORT zÃ¡loÅ¾ke</small></div>';
return;
}

let html='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px">';

snapshot.forEach(doc=>{
const note=doc.data();
html+=`
<div class="delivery-note-card" data-id="${note.id}" data-project="${note.project}" data-date="${note.date}">
<div style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);padding:15px;border-radius:8px 8px 0 0">
<h3 style="margin:0;color:white;font-size:18px">ğŸšš ${note.id}</h3>
<div style="color:rgba(255,255,255,0.9);font-size:13px;margin-top:5px">${note.date}</div>
</div>
<div style="padding:15px;background:white;border:2px solid #8b5cf6;border-top:none;border-radius:0 0 8px 8px">
<div style="margin-bottom:10px">
<strong style="color:#8b5cf6">Projekt:</strong> ${note.project||'N/A'}<br>
<strong style="color:#8b5cf6">ÄŒasÅ¥:</strong> ${note.part||'N/A'}
</div>
<div style="background:#f5f5f5;padding:10px;border-radius:4px;margin-bottom:10px">
<div style="font-size:24px;font-weight:700;color:#8b5cf6;text-align:center">${note.totalSpools} spoolov</div>
<div style="font-size:12px;text-align:center;color:#666;margin-top:5px">
${note.packages?.length||0} balÃ­kov + ${note.extraSpools?.length||0} extra
</div>
</div>
<div style="font-size:11px;color:#999;margin-bottom:10px">
Vytvoril: ${note.createdBy||'N/A'}
</div>
<button onclick="downloadDeliveryNote('${note.id}')" style="width:100%;background:#8b5cf6;color:white;border:none;padding:10px;border-radius:4px;cursor:pointer;font-weight:600;font-size:14px">ğŸ“¥ StiahnuÅ¥ PDF</button>
</div>
</div>
`;
});

html+='</div>';
content.innerHTML=html;

console.log('âœ… NaÄÃ­tanÃ©',snapshot.size,'dodacÃ­ch listov');

}catch(error){
console.error('âŒ Chyba pri naÄÃ­tavanÃ­ dodacÃ­ch listov:',error);
content.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ Chyba: '+error.message+'</div>';
}
}

async function downloadDeliveryNote(noteId){
try{
if(!db){
alert('âŒ Firebase nedostupnÃ½');
return;
}

const doc=await db.collection('delivery_notes').doc(noteId).get();
if(!doc.exists){
alert('âŒ DodacÃ­ list nenÃ¡jdenÃ½');
return;
}

const note=doc.data();
if(!note.pdfData){
alert('âš ï¸ PDF dÃ¡ta nie sÃº dostupnÃ©');
return;
}

// Vytvor PDF z uloÅ¾enÃ½ch dÃ¡t
const pdf=new jsPDF('p','mm','a4');
const imgWidth=210;
const img=new Image();
img.src=note.pdfData;
img.onload=function(){
const imgHeight=(img.height*imgWidth)/img.width;
pdf.addImage(note.pdfData,'PNG',0,0,imgWidth,imgHeight);
pdf.save('Dodaci_list_'+noteId+'.pdf');
};

console.log('ğŸ“¥ SÅ¥ahujem dodacÃ­ list:',noteId);

}catch(error){
console.error('âŒ Chyba pri sÅ¥ahovanÃ­:',error);
alert('âŒ Chyba: '+error.message);
}
}

function filterDeliveryHistory(){
const searchText=document.getElementById('deliveryHistorySearch').value.toLowerCase();
const cards=document.querySelectorAll('.delivery-note-card');

cards.forEach(card=>{
const id=card.getAttribute('data-id').toLowerCase();
const project=card.getAttribute('data-project').toLowerCase();
const date=card.getAttribute('data-date').toLowerCase();

const matches=id.includes(searchText)||project.includes(searchText)||date.includes(searchText)||searchText==='';

card.style.display=matches?'block':'none';
});
}

// âš™ï¸ ADMIN PANEL - SPRÃVA POUÅ½ÃVATEÄ½OV
function openAdminPanel(){
if(window.currentUser?.role !== 'admin'){
alert('âŒ NemÃ¡te oprÃ¡vnenie!');
return;
}
document.getElementById('adminPanel').style.display='block';
loadAdminUsers();
}

function closeAdminPanel(){
document.getElementById('adminPanel').style.display='none';
}

async function loadAdminUsers(){
const listEl=document.getElementById('adminUsersList');
listEl.innerHTML='<div style="text-align:center;color:#999;padding:20px">â³ NaÄÃ­tavam...</div>';

try{
if(!db){
listEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px">âŒ Firebase nedostupnÃ½</div>';
return;
}

const snapshot=await db.collection('users').orderBy('created','desc').get();

if(snapshot.empty){
listEl.innerHTML='<div style="text-align:center;color:#999;padding:20px">ğŸ“­ Å½iadni pouÅ¾Ã­vatelia</div>';
return;
}

let html='';
snapshot.forEach(doc=>{
const user=doc.data();
const isDisabled=user.disabled||false;
const statusColor=isDisabled?'#ef4444':'#10b981';
const statusIcon=isDisabled?'ğŸ”´':'ğŸŸ¢';

html+=`
<div class="admin-user-card" data-username="${doc.id}" onclick="showUserDetails('${doc.id}')" style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;cursor:pointer;border:2px solid #ddd;transition:all 0.2s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<strong style="font-size:15px;color:#333">${user.displayName||doc.id}</strong>
<span style="color:${statusColor};font-size:12px">${statusIcon}</span>
</div>
<div style="font-size:12px;color:#666;margin-bottom:5px">
<span style="background:#8b5cf6;color:white;padding:2px 8px;border-radius:4px;font-weight:600">${user.role||'N/A'}</span>
</div>
<div style="font-size:11px;color:#999">@${doc.id}</div>
</div>
`;
});

listEl.innerHTML=html;

// Add hover effect
const style=document.createElement('style');
style.textContent='.admin-user-card:hover{border-color:#8b5cf6!important;box-shadow:0 4px 12px rgba(139,92,246,0.2)}';
document.head.appendChild(style);

console.log('âœ… NaÄÃ­tanÃ½ch',snapshot.size,'pouÅ¾Ã­vateÄ¾ov');

}catch(error){
console.error('âŒ Chyba pri naÄÃ­tavanÃ­:',error);
listEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px">âŒ '+error.message+'</div>';
}
}

async function showUserDetails(username){
const contentEl=document.getElementById('adminContent');
contentEl.innerHTML='<div style="text-align:center;padding:40px">â³ NaÄÃ­tavam...</div>';

try{
const doc=await db.collection('users').doc(username).get();
if(!doc.exists){
contentEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ PouÅ¾Ã­vateÄ¾ nenÃ¡jdenÃ½</div>';
return;
}

const user=doc.data();
const isDisabled=user.disabled||false;

contentEl.innerHTML=`
<div style="max-width:700px;margin:0 auto">
<div style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);padding:30px;border-radius:12px;color:white;margin-bottom:30px">
<h2 style="margin:0 0 10px 0;font-size:28px">${user.displayName||username}</h2>
<div style="font-size:14px;opacity:0.9">@${username}</div>
</div>

<div style="background:white;padding:25px;border-radius:12px;border:2px solid #ddd;margin-bottom:20px">
<h3 style="margin:0 0 20px 0;color:#8b5cf6">ğŸ“‹ InformÃ¡cie</h3>
<div style="display:grid;grid-template-columns:120px 1fr;gap:15px;font-size:14px">
<strong>Rola:</strong><span style="background:#8b5cf6;color:white;padding:4px 12px;border-radius:6px;display:inline-block;font-weight:600">${user.role||'N/A'}</span>
<strong>Email:</strong><span>${user.email||'â€”'}</span>
<strong>VytvorenÃ½:</strong><span>${user.created?new Date(user.created).toLocaleString('sk-SK'):'â€”'}</span>
<strong>Posl. prihlÃ¡senie:</strong><span>${user.lastLogin?new Date(user.lastLogin).toLocaleString('sk-SK'):'Nikdy'}</span>
<strong>Status:</strong><span style="color:${isDisabled?'#ef4444':'#10b981'};font-weight:600">${isDisabled?'ğŸ”´ DeaktivovanÃ½':'ğŸŸ¢ AktÃ­vny'}</span>
</div>
</div>

<div style="background:white;padding:25px;border-radius:12px;border:2px solid #ddd;margin-bottom:20px">
<h3 style="margin:0 0 20px 0;color:#8b5cf6">ğŸ”‘ OprÃ¡vnenia</h3>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;font-size:13px">
${Object.entries(user.permissions||{}).map(([key,val])=>`
<div style="padding:10px;background:${val?'#d1fae5':'#fee2e2'};border-radius:6px">
${val?'âœ…':'âŒ'} ${key}
</div>
`).join('')}
</div>
</div>

<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px">
<button onclick="editUser('${username}')" style="background:#3b82f6;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px">âœï¸ UpraviÅ¥</button>
<button onclick="toggleUserStatus('${username}',${!isDisabled})" style="background:${isDisabled?'#10b981':'#f59e0b'};color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px">${isDisabled?'âœ… AktivovaÅ¥':'â¸ï¸ DeaktivovaÅ¥'}</button>
<button onclick="deleteUser('${username}')" style="background:#ef4444;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px">ğŸ—‘ï¸ ZmazaÅ¥</button>
</div>
</div>
`;

}catch(error){
console.error('âŒ Chyba:',error);
contentEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ '+error.message+'</div>';
}
}

function showAddUserForm(){
const contentEl=document.getElementById('adminContent');
contentEl.innerHTML=`
<div style="max-width:600px;margin:0 auto">
<div style="background:linear-gradient(135deg,#10b981,#059669);padding:30px;border-radius:12px;color:white;margin-bottom:30px">
<h2 style="margin:0;font-size:28px">â• PridaÅ¥ pouÅ¾Ã­vateÄ¾a</h2>
</div>

<form onsubmit="createUser(event)" style="background:white;padding:30px;border-radius:12px;border:2px solid #ddd">
<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">PouÅ¾Ã­vateÄ¾skÃ© meno *</label>
<input type="text" id="newUsername" required pattern="[a-zA-Z0-9_-]+" placeholder="napr. jan.technik" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
<small style="color:#666">Len pÃ­smenÃ¡, ÄÃ­slice, _ a -</small>
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">CelÃ© meno *</label>
<input type="text" id="newDisplayName" required placeholder="napr. JÃ¡n Technik" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">Email</label>
<input type="email" id="newEmail" placeholder="jan.technik@firma.sk" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">Heslo *</label>
<input type="password" id="newPassword" required minlength="6" placeholder="Min. 6 znakov" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
</div>

<div style="margin-bottom:25px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">Rola *</label>
<select id="newRole" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
<option value="">-- Vyber rolu --</option>
<option value="technik">Technik</option>
<option value="otk">OTK (kontrola)</option>
<option value="iwt">IWT (inÅ¡pektor)</option>
<option value="predak">PredÃ¡k</option>
</select>
</div>

<div style="display:flex;gap:10px">
<button type="submit" style="flex:1;background:#10b981;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px">âœ… VytvoriÅ¥</button>
<button type="button" onclick="loadAdminUsers();document.getElementById('adminContent').innerHTML='<div style=\\'text-align:center;color:#999;padding:60px\\'><div style=\\'font-size:64px;margin-bottom:20px\\'>ğŸ‘¥</div><h3>Vyber pouÅ¾Ã­vateÄ¾a</h3></div>'" style="flex:1;background:#6b7280;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px">ZruÅ¡iÅ¥</button>
</div>
</form>
</div>
`;
}

async function createUser(event){
event.preventDefault();

const username=document.getElementById('newUsername').value.trim();
const displayName=document.getElementById('newDisplayName').value.trim();
const email=document.getElementById('newEmail').value.trim();
const password=document.getElementById('newPassword').value;
const role=document.getElementById('newRole').value;

if(!username||!displayName||!password||!role){
alert('âŒ VyplÅˆ vÅ¡etky povinnÃ© polia!');
return;
}

try{
// Check if exists
const existingDoc=await db.collection('users').doc(username).get();
if(existingDoc.exists){
alert('âŒ PouÅ¾Ã­vateÄ¾ uÅ¾ existuje!');
return;
}

// Create user
await db.collection('users').doc(username).set({
displayName:displayName,
email:email||'',
password:password,  // TODO: Hash this!
role:role,
permissions:getDefaultPermissions(role),
disabled:false,
created:new Date().toISOString(),
lastLogin:null
});

alert('âœ… PouÅ¾Ã­vateÄ¾ '+displayName+' vytvorenÃ½!');
loadAdminUsers();
showUserDetails(username);

console.log('âœ… PouÅ¾Ã­vateÄ¾ vytvorenÃ½:',username);

}catch(error){
console.error('âŒ Chyba:',error);
alert('âŒ Chyba: '+error.message);
}
}

async function toggleUserStatus(username,disable){
const action=disable?'deaktivovaÅ¥':'aktivovaÅ¥';
if(!confirm(`Naozaj chcete ${action} pouÅ¾Ã­vateÄ¾a?`)){
return;
}

try{
await db.collection('users').doc(username).update({
disabled:disable
});

alert(`âœ… PouÅ¾Ã­vateÄ¾ ${disable?'deaktivovanÃ½':'aktivovanÃ½'}!`);
loadAdminUsers();
showUserDetails(username);

}catch(error){
console.error('âŒ Chyba:',error);
alert('âŒ Chyba: '+error.message);
}
}

async function deleteUser(username){
if(!confirm('âš ï¸ POZOR! Naozaj chcete NATRVALO ZMAZAÅ¤ tohto pouÅ¾Ã­vateÄ¾a?\n\nTÃºto akciu NEMOÅ½NO vrÃ¡tiÅ¥ spÃ¤Å¥!')){
return;
}

const confirmText=prompt('Pre potvrdenie zadajte meno pouÅ¾Ã­vateÄ¾a:');
if(confirmText!==username){
alert('âŒ NesprÃ¡vne meno!');
return;
}

try{
await db.collection('users').doc(username).delete();

alert('âœ… PouÅ¾Ã­vateÄ¾ zmazanÃ½!');
loadAdminUsers();
document.getElementById('adminContent').innerHTML='<div style="text-align:center;color:#999;padding:60px"><div style="font-size:64px;margin-bottom:20px">ğŸ‘¥</div><h3>Vyber pouÅ¾Ã­vateÄ¾a</h3></div>';

console.log('ğŸ—‘ï¸ PouÅ¾Ã­vateÄ¾ zmazanÃ½:',username);

}catch(error){
console.error('âŒ Chyba:',error);
alert('âŒ Chyba: '+error.message);
}
}

async function editUser(username){
const contentEl=document.getElementById('adminContent');
contentEl.innerHTML='<div style="text-align:center;padding:40px">â³ NaÄÃ­tavam...</div>';

try{
const doc=await db.collection('users').doc(username).get();
if(!doc.exists){
contentEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ PouÅ¾Ã­vateÄ¾ nenÃ¡jdenÃ½</div>';
return;
}

const user=doc.data();

contentEl.innerHTML=`
<div style="max-width:700px;margin:0 auto">
<div style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:30px;border-radius:12px;color:white;margin-bottom:30px">
<h2 style="margin:0 0 10px 0;font-size:28px">âœï¸ UpraviÅ¥ pouÅ¾Ã­vateÄ¾a</h2>
<div style="font-size:14px;opacity:0.9">@${username}</div>
</div>

<form onsubmit="saveUserEdit(event,'${username}')" style="background:white;padding:30px;border-radius:12px;border:2px solid #ddd">

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">CelÃ© meno *</label>
<input type="text" id="editDisplayName" value="${user.displayName||''}" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">Email</label>
<input type="email" id="editEmail" value="${user.email||''}" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">Rola *</label>
<select id="editRole" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px" onchange="updatePermissionsPreview(this.value)">
<option value="technik" ${user.role==='technik'?'selected':''}>Technik</option>
<option value="otk" ${user.role==='otk'?'selected':''}>OTK (kontrola)</option>
<option value="iwt" ${user.role==='iwt'?'selected':''}>IWT (inÅ¡pektor)</option>
<option value="predak" ${user.role==='predak'?'selected':''}>PredÃ¡k</option>
</select>
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:12px;color:#333">ğŸ”‘ OprÃ¡vnenia</label>
<div style="background:#f9fafb;padding:20px;border-radius:8px;border:2px solid #e5e7eb">

<div style="display:grid;gap:12px">

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canEdit" ${user.permissions?.canEdit?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">UpravovaÅ¥ projekty</strong>
<small style="color:#666">OznaÄovanie zvarov, pridÃ¡vanie spoolov</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canDelete" ${user.permissions?.canDelete?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">MazaÅ¥ zvary/projekty</strong>
<small style="color:#666">OdstrÃ¡nenie oznaÄenÃ­ a projektov</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canExport" ${user.permissions?.canExport?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">ExportovaÅ¥ PDF</strong>
<small style="color:#666">Generovanie PDF vÃ½stupov</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canCreateProjects" ${user.permissions?.canCreateProjects?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">VytvÃ¡raÅ¥ projekty</strong>
<small style="color:#666">NovÃ© projekty a izometrie</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canMarkWelds" ${user.permissions?.canMarkWelds?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">OznaÄovaÅ¥ zvary (krÃºÅ¾ky)</strong>
<small style="color:#666">PridÃ¡vanie zvarovÃ½ch bodov</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canMarkCrosses" ${user.permissions?.canMarkCrosses?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">OznaÄovaÅ¥ kontrolu (krÃ­Å¾iky)</strong>
<small style="color:#666">OTK znaÄenie vykonanej kontroly</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canManageSpools" ${user.permissions?.canManageSpools?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">SpravovaÅ¥ spooly</strong>
<small style="color:#666">VytvÃ¡ranie a sprÃ¡va spoolov</small>
</div>
</label>

<label style="display:flex;align-items:center;padding:12px;background:white;border-radius:6px;cursor:pointer;border:2px solid #ddd">
<input type="checkbox" id="perm_canViewAll" ${user.permissions?.canViewAll?'checked':''} style="width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#3b82f6">
<div>
<strong style="display:block;color:#333">ZobrazovaÅ¥ vÅ¡etky projekty</strong>
<small style="color:#666">PrÃ­stup k vÅ¡etkÃ½m projektom</small>
</div>
</label>

</div>
</div>
</div>

<div style="margin-bottom:20px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">AktuÃ¡lne heslo</label>
<input type="text" value="${user.password||''}" readonly style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb;color:#059669;font-weight:600">
<small style="color:#666">Len na zobrazenie</small>
</div>

<div style="margin-bottom:25px">
<label style="display:block;font-weight:600;margin-bottom:8px;color:#333">NovÃ© heslo (ponechaj prÃ¡zdne ak nemenÃ­Å¡)</label>
<input type="text" id="editPassword" placeholder="Min. 6 znakov" minlength="6" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px">
<small style="color:#666">Zadaj len ak chceÅ¡ zmeniÅ¥ heslo</small>
</div>

<div style="display:flex;gap:10px">
<button type="submit" style="flex:1;background:#3b82f6;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px">ğŸ’¾ UloÅ¾iÅ¥ zmeny</button>
<button type="button" onclick="showUserDetails('${username}')" style="flex:1;background:#6b7280;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px">ZruÅ¡iÅ¥</button>
</div>

</form>
</div>
`;

}catch(error){
console.error('âŒ Chyba:',error);
contentEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ '+error.message+'</div>';
}
}

async function saveUserEdit(event,username){
event.preventDefault();

const displayName=document.getElementById('editDisplayName').value.trim();
const email=document.getElementById('editEmail').value.trim();
const role=document.getElementById('editRole').value;
const password=document.getElementById('editPassword').value;

// Zbieranie oprÃ¡vnenÃ­
const permissions={
canEdit:document.getElementById('perm_canEdit').checked,
canDelete:document.getElementById('perm_canDelete').checked,
canExport:document.getElementById('perm_canExport').checked,
canCreateProjects:document.getElementById('perm_canCreateProjects').checked,
canMarkWelds:document.getElementById('perm_canMarkWelds').checked,
canMarkCrosses:document.getElementById('perm_canMarkCrosses').checked,
canManageSpools:document.getElementById('perm_canManageSpools').checked,
canViewAll:document.getElementById('perm_canViewAll').checked,
canAdmin:false // Admin len pre hlavnÃ©ho admina
};

try{
const updateData={
displayName:displayName,
email:email,
role:role,
permissions:permissions
};

// Ak je zadanÃ© novÃ© heslo, aktualizuj ho
if(password){
updateData.password=password; // TODO: Hash this!
}

await db.collection('users').doc(username).update(updateData);

alert('âœ… PouÅ¾Ã­vateÄ¾ aktualizovanÃ½!');
loadAdminUsers();
showUserDetails(username);

console.log('âœ… PouÅ¾Ã­vateÄ¾ upravenÃ½:',username);

}catch(error){
console.error('âŒ Chyba:',error);
alert('âŒ Chyba: '+error.message);
}
}

function updatePermissionsPreview(role){
// Automaticky nastaviÅ¥ checkboxy podÄ¾a role
const defaultPerms=getDefaultPermissions(role);

document.getElementById('perm_canEdit').checked=defaultPerms.canEdit;
document.getElementById('perm_canDelete').checked=defaultPerms.canDelete;
document.getElementById('perm_canExport').checked=defaultPerms.canExport;
document.getElementById('perm_canCreateProjects').checked=defaultPerms.canCreateProjects;
document.getElementById('perm_canMarkWelds').checked=defaultPerms.canMarkWelds;
document.getElementById('perm_canMarkCrosses').checked=defaultPerms.canMarkCrosses;
document.getElementById('perm_canManageSpools').checked=defaultPerms.canManageSpools;
document.getElementById('perm_canViewAll').checked=defaultPerms.canViewAll;
}

function filterAdminUsers(){
const searchText=document.getElementById('adminUserSearch').value.toLowerCase();
const cards=document.querySelectorAll('.admin-user-card');

cards.forEach(card=>{
const text=card.textContent.toLowerCase();
card.style.display=text.includes(searchText)?'block':'none';
});
}

// Helper: Get default permissions for role
function getDefaultPermissions(role){
const permissions={
admin:{
canEdit:true,canDelete:true,canExport:true,canAdmin:true,
canViewAll:true,canCreateProjects:true,canMarkWelds:true,
canMarkCrosses:true,canManageSpools:true
},
technik:{
canEdit:true,canDelete:false,canExport:true,canAdmin:false,
canViewAll:true,canCreateProjects:true,canMarkWelds:true,
canMarkCrosses:false,canManageSpools:true
},
otk:{
canEdit:false,canDelete:false,canExport:true,canAdmin:false,
canViewAll:true,canCreateProjects:false,canMarkWelds:false,
canMarkCrosses:true,canManageSpools:false
},
iwt:{
canEdit:false,canDelete:false,canExport:true,canAdmin:false,
canViewAll:true,canCreateProjects:false,canMarkWelds:false,
canMarkCrosses:false,canManageSpools:false
},
predak:{
canEdit:false,canDelete:false,canExport:true,canAdmin:false,
canViewAll:true,canCreateProjects:false,canMarkWelds:false,
canMarkCrosses:false,canManageSpools:true
}
};
return permissions[role]||permissions.iwt;
}

// ğŸ”” REAL-TIME NOTIFIKÃCIE A PRESENCE SYSTEM
let activeSessions=[];
let heartbeatInterval=null;

// Toggle notifikaÄnÃ½ panel
function toggleNotificationsPanel(){
const panel=document.getElementById('notificationsPanel');
if(panel.style.display==='none'){
panel.style.display='block';
loadUpdateHistory(); // NaÄÃ­taj histÃ³riu zmien
}else{
panel.style.display='none';
}
}

// NaÄÃ­taj histÃ³riu update notifikÃ¡ciÃ­
function loadUpdateHistory(){
const content=document.getElementById('notificationsContent');

// NaÄÃ­taj z localStorage
try {
  const saved = localStorage.getItem('weldpro_update_history');
  if (saved) {
    updateHistory = JSON.parse(saved);
  }
} catch (e) {
  console.warn('Failed to load update history:', e);
}

if (updateHistory.length === 0) {
  content.innerHTML = '<div style="text-align:center;color:#999;padding:30px;font-size:14px">ğŸ”” Å½iadne zmeny<br><span style="font-size:12px;opacity:0.7;margin-top:5px;display:block">Tu sa zobrazÃ­ histÃ³ria aktualizÃ¡ciÃ­</span></div>';
  return;
}

// Zobraz histÃ³riu
let html = '';
updateHistory.forEach((notif, index) => {
  const date = new Date(notif.timestamp);
  const timeAgo = getTimeAgo(date);
  const isUnread = !notif.read;
  const wasRefreshed = notif.refreshed;
  
  html += `
    <div style="background:${isUnread ? '#fef3c7' : 'white'};border:1px solid ${isUnread ? '#f59e0b' : '#e5e7eb'};border-radius:8px;padding:12px;margin-bottom:8px;transition:all 0.2s" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px">
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px;color:#333;margin-bottom:3px">
            ${isUnread ? 'ğŸ”” ' : ''}ğŸ“ ${notif.project}
          </div>
          <div style="font-size:11px;color:#666">
            â° ${timeAgo}
          </div>
        </div>
        ${isUnread ? '<span style="background:#f59e0b;color:white;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:bold">NOVÃ‰</span>' : ''}
        ${wasRefreshed ? '<span style="background:#10b981;color:white;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:bold">âœ“ NaÄÃ­tanÃ©</span>' : ''}
      </div>
      ${isUnread ? `
        <div style="display:flex;gap:6px;margin-top:8px">
          <button onclick="refreshSpecificProject('${notif.project}', ${index})" style="flex:1;padding:6px;background:#10b981;color:white;border:none;border-radius:5px;font-size:11px;cursor:pointer;font-weight:600">ğŸ”„ NaÄÃ­taÅ¥</button>
          <button onclick="markAsRead(${index})" style="padding:6px 10px;background:#6b7280;color:white;border:none;border-radius:5px;font-size:11px;cursor:pointer">âœ“</button>
        </div>
      ` : ''}
    </div>
  `;
});

content.innerHTML = html;
}

// NaÄÃ­taj aktÃ­vne sessions
async function loadActiveSessions(){
const content=document.getElementById('notificationsContent');
content.innerHTML='<div style="text-align:center;color:#999;padding:20px">â³ NaÄÃ­tavam...</div>';

try{
if(!db){
content.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px;font-size:13px">âŒ Firebase nedostupnÃ½</div>';
return;
}

const fiveMinutesAgo=new Date(Date.now()-5*60*1000);

// âœ… REAL-TIME LISTENER BEZ where() (nepotrebuje index!)
const unsubscribe=db.collection('active_sessions')
.onSnapshot(snapshot=>{

if(snapshot.empty){
content.innerHTML='<div style="text-align:center;color:#999;padding:30px;font-size:13px">ğŸ“­ Å½iadni aktÃ­vni<br><small>V poslednÃ½ch 5 minÃºtach</small></div>';
updateNotificationsBadge(0);
activeSessions=[];
return;
}

activeSessions=[];
let html='';

snapshot.forEach(doc=>{
const session=doc.data();

// âœ… Filter v kÃ³de namiesto Firebase query
if(!session.lastActivity)return;
const lastActivityTime=session.lastActivity.toDate();
if(lastActivityTime<fiveMinutesAgo)return; // StarÅ¡Ã­ ako 5 minÃºt â†’ preskoÄiÅ¥

if(doc.id!==window.currentUser?.username){
activeSessions.push({id:doc.id,...session});

const timeAgo=getTimeAgo(session.lastActivity.toDate());
const isCurrentProject=session.project===projectsData.currentProject && session.part===projectsData.currentPart;

html+=`
<div style="background:${isCurrentProject?'#fef3c7':'#f9fafb'};border:2px solid ${isCurrentProject?'#f59e0b':'#e5e7eb'};border-radius:8px;padding:12px;margin-bottom:8px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:20px">ğŸŸ¢</span>
<div style="flex:1">
<div style="font-weight:700;font-size:14px;color:#333">${session.displayName||doc.id}</div>
<div style="font-size:11px;color:#666">${timeAgo}</div>
</div>
</div>
${session.project?`
<div style="background:white;padding:8px;border-radius:4px;font-size:12px">
<strong style="color:#667eea">ğŸ“ ${session.project}</strong>
${session.part?' / '+session.part:''}
</div>
`:''}
${session.status?`<div style="font-size:11px;color:#999;margin-top:5px">ğŸ’¬ ${session.status}</div>`:''}
${isCurrentProject?'<div style="margin-top:8px;padding:6px;background:#fbbf24;color:#78350f;border-radius:4px;font-size:11px;font-weight:600;text-align:center">âš ï¸ V ROVNAKOM PROJEKTE!</div>':''}
</div>
`;
}
});

content.innerHTML=html;
updateNotificationsBadge(activeSessions.length);

console.log('ğŸ”” AktÃ­vnych:',activeSessions.length,'â†’',activeSessions.map(s=>s.id));

// âœ… Ak mÃ¡Å¡ otvorenÃ½ chat modal, refresh zoznam pouÅ¾Ã­vateÄ¾ov
const chatModal=document.getElementById('newChatModal');
if(chatModal && chatModal.style.display==='block'){
loadNewChatUsers();
}

},error=>{
console.error('âŒ Chyba pri onSnapshot sessions:',error);
content.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px;font-size:13px">âŒ '+error.message+'</div>';
});

}catch(error){
console.error('âŒ Chyba pri naÄÃ­tanÃ­ sessions:',error);
content.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px;font-size:13px">âŒ '+error.message+'</div>';
}
}

// Aktualizuj badge count
function updateNotificationsBadge(count){
const badge=document.getElementById('notificationsBadge');
if(count>0){
badge.textContent=count;
badge.style.display='block';
}else{
badge.style.display='none';
}
}

// Time ago helper
function getTimeAgo(date){
const seconds=Math.floor((new Date()-date)/1000);
if(seconds<60)return 'pred chvÃ­Ä¾ou';
if(seconds<120)return 'pred minÃºtou';
if(seconds<3600)return 'pred '+Math.floor(seconds/60)+' min';
if(seconds<7200)return 'pred hodinou';
return 'pred '+Math.floor(seconds/3600)+' hod';
}

// Aktualizuj vlastnÃº session (heartbeat)
async function updateMySession(){
if(!db||!window.currentUser||!isOnline)return;

try{
await db.collection('active_sessions').doc(window.currentUser.username).set({
username:window.currentUser.username,
displayName:window.currentUser.displayName||window.currentUser.username,
project:projectsData.currentProject||null,
part:projectsData.currentPart||null,
status:getMyCurrentStatus(),
lastActivity:firebase.firestore.FieldValue.serverTimestamp(),
browser:navigator.userAgent.split('(')[1]?.split(')')[0]||'Unknown'
},{merge:true});

console.log('ğŸ’“ Heartbeat sent');
}catch(error){
console.error('âŒ Heartbeat chyba:',error);
}
}

// ZÃ­skaj aktuÃ¡lny status
function getMyCurrentStatus(){
// Zisti Äo pouÅ¾Ã­vateÄ¾ prÃ¡ve robÃ­
if(document.getElementById('weldlogbtn')?.disabled===false){
return 'PrezerÃ¡ Weld Log';
}
if(document.getElementById('mtobtn')?.disabled===false){
return 'PrezerÃ¡ MTO';
}
return 'Pracuje v projekte';
}

// Skontroluj konflikt pri naÄÃ­tanÃ­ projektu
async function checkProjectConflict(){
if(!db||!projectsData.currentProject)return;

try{
const snapshot=await db.collection('active_sessions')
.where('project','==',projectsData.currentProject)
.where('part','==',projectsData.currentPart)
.get();

const others=[];
snapshot.forEach(doc=>{
if(doc.id!==window.currentUser?.username){
const session=doc.data();
const timeAgo=new Date()-session.lastActivity.toDate();
if(timeAgo<5*60*1000){ // PoslednÃ½ch 5 minÃºt
others.push(session);
}
}
});

if(others.length>0){
const names=others.map(s=>s.displayName||s.username).join(', ');
const result=confirm(`âš ï¸ VAROVANIE!\n\n${names} ${others.length===1?'pracuje':'pracujÃº'} na tomto projekte!\n\nChceÅ¡ pokraÄovaÅ¥?`);

if(!result){
// Zatvor projekt
cl();
return false;
}
}

return true;

}catch(error){
console.error('âŒ Chyba pri check conflict:',error);
return true; // PokraÄuj aj pri chybe
}
}

// Å tart heartbeat systÃ©mu
function startHeartbeat(){
if(heartbeatInterval)clearInterval(heartbeatInterval);

// Update hneÄ
updateMySession();

// KaÅ¾dÃ½ch 30 sekÃºnd
heartbeatInterval=setInterval(updateMySession,30000);

// Pri zatvorenÃ­ strÃ¡nky vymaÅ¾ session
window.addEventListener('beforeunload',async function(){
if(db&&window.currentUser){
try{
await db.collection('active_sessions').doc(window.currentUser.username).delete();
}catch(e){
console.error('Chyba pri cleanup:',e);
}
}
});
}

// Heartbeat sa spÃºÅ¡Å¥a automaticky v session check!
// (riadok ~210)

// Refresh notifikÃ¡ciÃ­ kaÅ¾dÃº minÃºtu
if(window.currentUser){
setInterval(()=>{
if(document.getElementById('notificationsPanel').style.display==='block'){
loadActiveSessions();
}
},60000);
}

// ğŸ“± OFFLINE MODE + SYNCHRONIZÃCIA
let isOnline=navigator.onLine;
let pendingChanges=[];

// NaÄÃ­taj pending changes z localStorage
function loadPendingChanges(){
try{
const stored=localStorage.getItem('weldpro_pending_sync');
if(stored){
pendingChanges=JSON.parse(stored);
updateSyncBadge();
}
}catch(e){
console.error('Chyba pri naÄÃ­tanÃ­ pending changes:',e);
pendingChanges=[];
}
}

// UloÅ¾ pending changes do localStorage
function savePendingChanges(){
try{
localStorage.setItem('weldpro_pending_sync',JSON.stringify(pendingChanges));
updateSyncBadge();
}catch(e){
console.error('Chyba pri ukladanÃ­ pending changes:',e);
}
}

// Aktualizuj badge s poÄtom zmien
function updateSyncBadge(){
const badge=document.getElementById('pendingSyncCount');
const syncBtn=document.getElementById('syncBtn');
const detailsBtn=document.getElementById('detailsBtn');

if(pendingChanges.length>0){
badge.textContent=pendingChanges.length+' zmien';
badge.style.display='inline-block';
if(isOnline){
syncBtn.style.display='inline-block';
detailsBtn.style.display='inline-block';
}else{
syncBtn.style.display='none';
detailsBtn.style.display='inline-block'; // UkÃ¡Å¾ aj offline
}
}else{
badge.style.display='none';
syncBtn.style.display='none';
detailsBtn.style.display='none';
}
}

// Monitor online/offline status
window.addEventListener('online',function(){
isOnline=true;
document.getElementById('connectionStatus').innerHTML='ğŸŸ¢ Online';
document.getElementById('offlineIndicator').style.background='#10b981';
console.log('âœ… PripojenÃ½ k internetu');

// UkÃ¡Å¾ sync tlaÄidlo ak sÃº pending changes
if(pendingChanges.length>0){
document.getElementById('syncBtn').style.display='inline-block';
showNotification('âœ… Online! MÃ´Å¾eÅ¡ teraz nahraÅ¥ zmeny ('+pendingChanges.length+')','success');
}
});

window.addEventListener('offline',function(){
isOnline=false;
document.getElementById('connectionStatus').innerHTML='ğŸ”´ Offline';
document.getElementById('offlineIndicator').style.background='#ef4444';
document.getElementById('syncBtn').style.display='none';
console.log('âš ï¸ OdpojenÃ½ od internetu');
showNotification('âš ï¸ Offline reÅ¾im - zmeny sa uloÅ¾ia lokÃ¡lne','warning');
});

// UloÅ¾ zmenu do pending queue
function addPendingChange(type,data){
const change={
id:Date.now()+'_'+Math.random().toString(36).substr(2,9),
type:type, // 'project', 'weld', 'cross', 'delivery', 'package'
data:data,
timestamp:new Date().toISOString(),
user:window.currentUser?.username||'unknown'
};

pendingChanges.push(change);
savePendingChanges();

console.log('ğŸ’¾ Zmena uloÅ¾enÃ¡ lokÃ¡lne:',type);
showNotification('ğŸ’¾ Zmena uloÅ¾enÃ¡ lokÃ¡lne (offline)','info');
}

// Zobraz pending changes modal s detailami
function showPendingChangesModal(){
document.getElementById('pendingChangesModal').style.display='block';
buildPendingChangesList();
}

function closePendingChanges(){
document.getElementById('pendingChangesModal').style.display='none';
}

// Zobraz zoznam pending changes
function buildPendingChangesList(){
const listEl=document.getElementById('pendingChangesList');

if(pendingChanges.length===0){
listEl.innerHTML='<div style="text-align:center;color:#999;padding:60px"><div style="font-size:64px;margin-bottom:20px">âœ…</div><h3>Å½iadne neuloÅ¾enÃ© zmeny</h3><p>VÅ¡etko je synchronizovanÃ©</p></div>';
return;
}

let html='<div style="margin-bottom:15px;padding:15px;background:#fef3c7;border-radius:8px;border-left:4px solid #f59e0b">';
html+='<strong style="font-size:16px">ğŸ“Š Celkom: '+pendingChanges.length+' zmien</strong>';
html+='<p style="margin:5px 0 0 0;font-size:13px;color:#666">Tieto zmeny budÃº nahranÃ© na server pri synchronizÃ¡cii</p>';
html+='</div>';

pendingChanges.forEach((change,index)=>{
const statusColor=change.status==='uploading'?'#3b82f6':change.status==='success'?'#10b981':change.status==='failed'?'#ef4444':'#6b7280';
const statusIcon=change.status==='uploading'?'â³':change.status==='success'?'âœ…':change.status==='failed'?'âŒ':'â¸ï¸';
const statusText=change.status==='uploading'?'NahrÃ¡vam...':change.status==='success'?'NahratÃ©':change.status==='failed'?'Chyba':'ÄŒakÃ¡';

const typeNames={
project:'Projekt',
weld_update:'AktualizÃ¡cia zvarov',
delivery:'DodacÃ­ list',
package:'BalÃ­k',
cross_update:'OznaÄenie kontroly'
};

const typeName=typeNames[change.type]||change.type;
const typeIcon=change.type==='project'?'ğŸ“':change.type==='weld_update'?'â­•':change.type==='delivery'?'ğŸšš':change.type==='package'?'ğŸ“¦':'ğŸ“';

html+=`
<div class="pending-change-item" data-id="${change.id}" style="background:white;border:2px solid ${statusColor};border-radius:8px;padding:15px;margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
<div style="flex:1">
<div style="font-weight:700;font-size:15px;color:#333;margin-bottom:5px">${typeIcon} ${typeName}</div>
<div style="font-size:12px;color:#666">
${change.data.projectName||change.data.id||''}
</div>
</div>
<div style="background:${statusColor};color:white;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap">
${statusIcon} ${statusText}
</div>
</div>
<div style="font-size:11px;color:#999">
ğŸ“… ${new Date(change.timestamp).toLocaleString('sk-SK')} â€¢ ğŸ‘¤ ${change.user}
</div>
${change.status==='failed'?'<div style="margin-top:10px;padding:10px;background:#fee2e2;border-radius:4px;font-size:12px;color:#991b1b">âš ï¸ '+change.error+'</div>':''}
${change.status==='uploading'?'<div style="margin-top:10px;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden"><div style="height:100%;background:'+statusColor+';width:'+change.progress+'%;transition:width 0.3s"></div></div>':''}
</div>
`;
});

listEl.innerHTML=html;
}

// Synchronizuj vÅ¡etky pending changes
async function syncOfflineData(){
if(!isOnline){
alert('âŒ NemÃ¡Å¡ internet! Pripoj sa najprv.');
return;
}

if(pendingChanges.length===0){
alert('âœ… Å½iadne zmeny na nahratie!');
return;
}

// Otvor modal s progress
showPendingChangesModal();

const totalChanges=pendingChanges.length;
const syncBtn=document.getElementById('syncBtn');
const syncFromModal=document.getElementById('syncFromModal');
syncBtn.disabled=true;
syncFromModal.disabled=true;
syncBtn.textContent='â³ NahrÃ¡vam...';
syncFromModal.textContent='â³ NahrÃ¡vam...';

let successCount=0;
let failCount=0;
const failedChanges=[];

for(let i=0;i<pendingChanges.length;i++){
const change=pendingChanges[i];

// Nastav status
change.status='uploading';
change.progress=0;
buildPendingChangesList();

try{
// Simuluj progress
for(let p=0;p<=100;p+=25){
change.progress=p;
buildPendingChangesList();
await new Promise(r=>setTimeout(r,100));
}

await uploadChange(change);

change.status='success';
successCount++;
buildPendingChangesList();

syncBtn.textContent='â³ NahrÃ¡vam... ('+successCount+'/'+totalChanges+')';
syncFromModal.textContent='â³ NahrÃ¡vam... ('+successCount+'/'+totalChanges+')';

}catch(error){
console.error('âŒ Chyba pri sync:',change.type,error);
change.status='failed';
change.error=error.message||'NeznÃ¡ma chyba';
failCount++;
failedChanges.push(change);
buildPendingChangesList();
}

// Pauza medzi requestami
await new Promise(r=>setTimeout(r,300));
}

// UloÅ¾ len failed changes
pendingChanges=failedChanges.map(c=>{
const clean={...c};
delete clean.status;
delete clean.progress;
delete clean.error;
return clean;
});
savePendingChanges();

syncBtn.disabled=false;
syncFromModal.disabled=false;
syncBtn.textContent='ğŸ“¤ NahraÅ¥ zmeny';

buildPendingChangesList();

if(failCount===0){
showNotification('âœ… VÅ¡etky zmeny ('+successCount+') nahranÃ©!','success');
setTimeout(()=>closePendingChanges(),2000);
}else{
syncFromModal.textContent='ğŸ”„ SkÃºsiÅ¥ znova';
showNotification('âš ï¸ NahranÃ©: '+successCount+', Chyba: '+failCount,'warning');
}

console.log('ğŸ“¤ Sync hotovÃ½:',successCount,'ÃºspeÅ¡nÃ½ch,',failCount,'chÃ½b');
}

// Nahraj jednu zmenu do Firebase
async function uploadChange(change){
if(!db){
throw new Error('Firebase nedostupnÃ½');
}

switch(change.type){
case 'project':
await db.collection('library').doc(change.data.id).set(change.data);
break;

case 'delivery':
await db.collection('delivery_notes').doc(change.data.id).set(change.data);
break;

case 'package':
const exportDataRef=db.collection('export_data').doc('packages');
await exportDataRef.set({
[change.data.id]:change.data
},{merge:true});
break;

case 'weld_update':
// Aktualizuj projekt s novÃ½mi zvarmi
await db.collection('library').doc(change.data.projectId).update({
welds:change.data.welds,
lastModified:firebase.firestore.FieldValue.serverTimestamp()
});
break;

default:
console.warn('Unknown change type:',change.type);
}

console.log('âœ… Uploaded:',change.type,change.id);
}

// NotifikaÄnÃ½ systÃ©m
function showNotification(message,type){
const notification=document.createElement('div');
notification.style.cssText=`
position:fixed;
top:20px;
right:20px;
padding:15px 20px;
background:${type==='success'?'#10b981':type==='warning'?'#f59e0b':type==='error'?'#ef4444':'#3b82f6'};
color:white;
border-radius:8px;
box-shadow:0 4px 12px rgba(0,0,0,0.3);
z-index:100000;
font-weight:600;
animation:slideInRight 0.3s;
`;
notification.textContent=message;
document.body.appendChild(notification);

setTimeout(()=>{
notification.style.animation='slideOutRight 0.3s';
setTimeout(()=>notification.remove(),300);
},3000);
}

// Style pre slide animÃ¡cie
const notifStyle=document.createElement('style');
notifStyle.textContent=`
@keyframes slideInRight {
from { transform: translateX(400px); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
from { transform: translateX(0); opacity: 1; }
to { transform: translateX(400px); opacity: 0; }
}
`;
document.head.appendChild(notifStyle);

// Inicializuj offline mode pri Å¡tarte
loadPendingChanges();

// Override save functions pre offline support
const originalSaveProject=saveProject;
saveProject=function(){
if(!isOnline){
// UloÅ¾ lokÃ¡lne
addPendingChange('project',{
id:projectsData.currentProject+'_'+projectsData.currentPart,
data:exportData,
timestamp:new Date().toISOString()
});
alert('ğŸ’¾ Projekt uloÅ¾enÃ½ lokÃ¡lne (offline)');
}else{
// NormÃ¡lne uloÅ¾enie
originalSaveProject();
}
};

// ğŸ’¬ CHAT SYSTÃ‰M - KONVERZÃCIE + SKUPINA
let currentChatId=null;
let currentChatType=null;
let chatUnreadCount=0;
let chatListeners=[];
const GROUP_CHAT_ID='group_all';

function toggleChatPanel(){
const panel=document.getElementById('chatPanel');
const btn=document.getElementById('chatFloatingBtn');
if(panel.style.display==='none'||panel.style.display===''){
panel.style.display='flex';
btn.style.display='none';
loadConversations();
}else{
panel.style.display='none';
btn.style.display='block';
}
}

async function loadConversations(){
const listEl=document.getElementById('chatConversationsList');
listEl.innerHTML='<div style="text-align:center;color:#999;font-size:12px;padding:20px">â³</div>';
try{
if(!db){listEl.innerHTML='<div style="text-align:center;color:#ef4444;font-size:12px;padding:20px">âŒ</div>';return;}
let html='';
const groupUnread=await getUnreadCountForChat(GROUP_CHAT_ID);
const groupSnapshot=await db.collection('chats').doc(GROUP_CHAT_ID).collection('messages').orderBy('timestamp','desc').limit(1).get();
let groupLastMsg='Å½iadne sprÃ¡vy';
let groupTime='';
if(!groupSnapshot.empty){
const lastMsg=groupSnapshot.docs[0].data();
groupLastMsg=(lastMsg.fromName||lastMsg.from)+': '+(lastMsg.text.length>20?lastMsg.text.substring(0,20)+'...':lastMsg.text);
groupTime=lastMsg.timestamp?getTimeAgo(lastMsg.timestamp.toDate()):'';
}
html+=`<div onclick="openGroupChat()" style="padding:12px;border-radius:8px;cursor:pointer;margin-bottom:8px;background:${currentChatId===GROUP_CHAT_ID?'linear-gradient(135deg,#667eea,#764ba2)':'white'};color:${currentChatId===GROUP_CHAT_ID?'white':'#333'};border:2px solid ${currentChatId===GROUP_CHAT_ID?'#667eea':'#e5e7eb'}"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">ğŸ’¬</span><div style="flex:1"><div style="font-weight:700;font-size:14px">VÅ ETCI (Skupina)</div><div style="font-size:11px;opacity:0.8">${groupLastMsg}</div>${groupTime?`<div style="font-size:10px;opacity:0.6;margin-top:2px">${groupTime}</div>`:''}</div>${groupUnread>0?`<span style="background:#ef4444;color:white;border-radius:50%;width:22px;height:22px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">${groupUnread}</span>`:''}</div></div>`;
const chatsSnapshot=await db.collection('chats').where('participants','array-contains',window.currentUser.username).orderBy('lastTimestamp','desc').get();
for(const chatDoc of chatsSnapshot.docs){
if(chatDoc.id===GROUP_CHAT_ID)continue;
const chat=chatDoc.data();
const otherUser=chat.participants.find(p=>p!==window.currentUser.username);
if(!otherUser)continue;
const userDoc=await db.collection('users').doc(otherUser).get();
const userData=userDoc.exists?userDoc.data():{};
const isOnline=activeSessions.some(s=>s.id===otherUser);
const unread=await getUnreadCountForChat(chatDoc.id);
const lastMsg=chat.lastMessage?(chat.lastMessage.length>25?chat.lastMessage.substring(0,25)+'...':chat.lastMessage):'ZaÄni konverzÃ¡ciu';
const timeAgo=chat.lastTimestamp?getTimeAgo(chat.lastTimestamp.toDate()):'';
html+=`<div onclick="openPrivateChat('${chatDoc.id}','${otherUser}','${userData.displayName||otherUser}')" style="padding:12px;border-radius:8px;cursor:pointer;margin-bottom:8px;background:${currentChatId===chatDoc.id?'linear-gradient(135deg,#667eea,#764ba2)':'white'};color:${currentChatId===chatDoc.id?'white':'#333'};border:2px solid ${currentChatId===chatDoc.id?'#667eea':'#e5e7eb'}"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:16px">${isOnline?'ğŸŸ¢':'ğŸ”´'}</span><div style="flex:1"><div style="font-weight:700;font-size:14px">${userData.displayName||otherUser}</div><div style="font-size:11px;opacity:0.8">${lastMsg}</div>${timeAgo?`<div style="font-size:10px;opacity:0.6;margin-top:2px">${timeAgo}</div>`:''}</div>${unread>0?`<span style="background:#ef4444;color:white;border-radius:50%;width:22px;height:22px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center">${unread}</span>`:''}</div></div>`;
}
listEl.innerHTML=html||'<div style="text-align:center;color:#999;padding:20px;font-size:12px">Å½iadne chaty</div>';
updateTotalUnreadBadge();
}catch(error){console.error(error);listEl.innerHTML='<div style="text-align:center;color:#ef4444;font-size:12px;padding:20px">âŒ</div>';}
}

function openGroupChat(){
currentChatId=GROUP_CHAT_ID;
currentChatType='group';
document.getElementById('chatMessageInput').disabled=false;
document.getElementById('chatSendBtn').disabled=false;
loadConversations();
loadChatMessages(GROUP_CHAT_ID,'group');
}

function openPrivateChat(chatId,otherUser,displayName){
currentChatId=chatId;
currentChatType='private';
document.getElementById('chatMessageInput').disabled=false;
document.getElementById('chatSendBtn').disabled=false;
loadConversations();
loadChatMessages(chatId,'private');
markChatAsRead(chatId);
}

async function loadChatMessages(chatId,type){
const messagesEl=document.getElementById('chatMessagesArea');
messagesEl.innerHTML='<div style="text-align:center;color:#999;padding:20px">â³</div>';
try{
if(!db){messagesEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px">âŒ</div>';return;}
chatListeners.forEach(u=>u());
chatListeners=[];
const unsubscribe=db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp','asc').onSnapshot(s=>displayChatMessages(s,type));
chatListeners.push(unsubscribe);
}catch(error){console.error(error);messagesEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px">âŒ</div>';}
}

function displayChatMessages(snapshot,type){
const messagesEl=document.getElementById('chatMessagesArea');
if(snapshot.empty){messagesEl.innerHTML=`<div style="text-align:center;color:#999;padding:40px;font-size:13px"><div style="font-size:48px;margin-bottom:10px">ğŸ’¬</div><p>${type==='group'?'Skupina VÅ ETCI':'SÃºkromnÃ½ chat'}<br>ZaÄni konverzÃ¡ciu!</p></div>`;return;}
let html='';
snapshot.forEach(doc=>{
const msg=doc.data();
const isOwn=msg.from===window.currentUser.username;
const timeStr=msg.timestamp?new Date(msg.timestamp.toDate()).toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'';
if(type==='group'){
html+=`<div style="margin-bottom:15px"><div style="max-width:75%"><div style="font-size:11px;font-weight:600;color:#667eea;margin-bottom:4px">${msg.fromName||msg.from}</div><div style="padding:12px 16px;border-radius:16px;background:#f3f4f6;color:#1f2937;font-size:14px;line-height:1.4"><div>${msg.text}</div><div style="font-size:10px;opacity:0.7;margin-top:4px">${timeStr}</div></div></div></div>`;
}else{
html+=`<div style="margin-bottom:15px;display:flex;gap:10px;${isOwn?'flex-direction:row-reverse':''}"><div style="max-width:70%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.4;${isOwn?'background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-bottom-right-radius:4px':'background:#f3f4f6;color:#1f2937;border-bottom-left-radius:4px'}"><div>${msg.text}</div><div style="font-size:10px;opacity:0.7;margin-top:4px">${timeStr}</div></div></div>`;
}
});
messagesEl.innerHTML=html;
messagesEl.scrollTop=messagesEl.scrollHeight;
}

async function sendChatMessage(){
const input=document.getElementById('chatMessageInput');
const text=input.value.trim();
if(!text||!currentChatId)return;
try{
const messageData={from:window.currentUser.username,fromName:window.currentUser.displayName||window.currentUser.username,text:text,timestamp:firebase.firestore.FieldValue.serverTimestamp(),read:false};
if(currentChatType==='group'){
await db.collection('chats').doc(GROUP_CHAT_ID).set({type:'group',lastMessage:text,lastTimestamp:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
await db.collection('chats').doc(GROUP_CHAT_ID).collection('messages').add(messageData);
}else{
await db.collection('chats').doc(currentChatId).set({type:'private',participants:currentChatId.split('_'),lastMessage:text,lastTimestamp:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
await db.collection('chats').doc(currentChatId).collection('messages').add(messageData);
}
input.value='';
}catch(error){console.error(error);alert('âŒ '+error.message);}
}

function showNewChatModal(){
document.getElementById('newChatModal').style.display='block';
loadNewChatUsers();
}

function closeNewChatModal(){
document.getElementById('newChatModal').style.display='none';
}

async function loadNewChatUsers(){
const listEl=document.getElementById('newChatUsersList');
listEl.innerHTML='<div style="text-align:center;color:#999;padding:20px">â³ NaÄÃ­tavam pouÅ¾Ã­vateÄ¾ov...</div>';
try{
if(!db){listEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px">âŒ Firebase chyba</div>';return;}
const snapshot=await db.collection('users').get();
let html='';
snapshot.forEach(doc=>{
// Zobraz VÅ ETKÃCH okrem seba
if(doc.id!==window.currentUser?.username){
const user=doc.data();
const isOnline=activeSessions.some(s=>s.id===doc.id);
const displayName=user.displayName||doc.id;
const role=user.role||'';
html+=`<div class="new-chat-user-item" onclick="createNewPrivateChat('${doc.id}','${displayName}')" style="padding:12px;border-radius:8px;cursor:pointer;margin-bottom:8px;background:white;border:2px solid #e5e7eb;transition:all 0.2s" onmouseover="this.style.borderColor='#667eea';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.transform='translateY(0)'"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:16px">${isOnline?'ğŸŸ¢':'ğŸ”´'}</span><div style="flex:1"><div style="font-weight:600;font-size:14px;color:#333">${displayName}</div><div style="font-size:11px;color:#666">${role}</div></div></div></div>`;
}
});
if(html===''){
html='<div style="text-align:center;color:#999;padding:20px">ğŸ‘¤ Å½iadni ÄalÅ¡Ã­ pouÅ¾Ã­vatelia</div>';
}
listEl.innerHTML=html;
console.log('âœ… NaÄÃ­tanÃ­ pouÅ¾Ã­vatelia:', snapshot.size - 1); // -1 lebo nepoÄÃ­tame seba
}catch(error){console.error('âŒ Chyba naÄÃ­tania users:',error);listEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:20px">âŒ Chyba</div>';}
}

function filterNewChatUsers(){
const searchText=document.getElementById('newChatSearch').value.toLowerCase();
document.querySelectorAll('.new-chat-user-item').forEach(item=>{
item.style.display=item.textContent.toLowerCase().includes(searchText)?'block':'none';
});
}

function createNewPrivateChat(otherUser,displayName){
const chatId=getChatId(window.currentUser.username,otherUser);
closeNewChatModal();
toggleChatPanel();
setTimeout(()=>{toggleChatPanel();openPrivateChat(chatId,otherUser,displayName);},100);
}

function getChatId(user1,user2){
return user1<user2?user1+'_'+user2:user2+'_'+user1;
}

async function getUnreadCountForChat(chatId){
try{
if(!db||!window.currentUser)return 0;
const snapshot=await db.collection('chats').doc(chatId).collection('messages').where('from','!=',window.currentUser.username).where('read','==',false).get();
return snapshot.size;
}catch(error){return 0;}
}

async function markChatAsRead(chatId){
try{
const snapshot=await db.collection('chats').doc(chatId).collection('messages').where('from','!=',window.currentUser.username).where('read','==',false).get();
snapshot.forEach(async doc=>await doc.ref.update({read:true}));
updateTotalUnreadBadge();
}catch(error){console.error(error);}
}

async function updateTotalUnreadBadge(){
try{
if(!db||!window.currentUser)return;
let totalUnread=0;
totalUnread+=await getUnreadCountForChat(GROUP_CHAT_ID);
const chatsSnapshot=await db.collection('chats').where('participants','array-contains',window.currentUser.username).get();
for(const chatDoc of chatsSnapshot.docs){
if(chatDoc.id!==GROUP_CHAT_ID){
totalUnread+=await getUnreadCountForChat(chatDoc.id);
}
}
chatUnreadCount=totalUnread;
const floatingBadge=document.getElementById('chatUnreadBadge');
if(chatUnreadCount>0){floatingBadge.textContent=chatUnreadCount;floatingBadge.style.display='block';}else{floatingBadge.style.display='none';}
}catch(error){console.error(error);}
}
if(window.currentUser){
setInterval(updateTotalUnreadBadge,60000);
updateTotalUnreadBadge();
}

// ğŸ“¦ OFFLINE PACKAGE SYSTÃ‰M
let selectedProjects=new Set();
function openOfflinePackageModal(){
document.getElementById('offlinePackageModal').style.display='block';
loadProjectsForOffline();
}

// ============= OFFLINE REÅ½IM - NaÄÃ­tanie stiahnutÃ½ch projektov =============
function openOfflineModeModal(){
document.getElementById('offlineModeModal').style.display='block';
loadOfflineModeProjects();
}

function closeOfflineModeModal(){
document.getElementById('offlineModeModal').style.display='none';
}

function loadOfflineModeProjects(){
const listEl=document.getElementById('offlineModeProjectsList');
listEl.innerHTML='<div style="text-align:center;color:#999;padding:20px">â³ NaÄÃ­tavam...</div>';

const offlineProjects=[];
for(let i=0;i<localStorage.length;i++){
const key=localStorage.key(i);
if(key.startsWith('offline_project_')){
const projectId=key.replace('offline_project_','');
try{
// âœ… POUÅ½IÅ¤ NOVÃš FUNKCIU ktorÃ¡ podporuje GZIP dekompresi!
const result = loadOfflineProjectData(projectId);
if (result.success) {
  offlineProjects.push({id:projectId,data:result.data});
} else {
  console.error('Chyba pri ÄÃ­tanÃ­ offline projektu:',projectId,result.error);
}
}catch(e){
console.error('Chyba pri ÄÃ­tanÃ­ offline projektu:',projectId,e);
}
}
}

if(offlineProjects.length===0){
listEl.innerHTML='<div style="text-align:center;color:#999;padding:40px">ğŸ“­ Å½iadne offline projekty<br><small style="color:#bbb">Najprv stiahni projekty cez "ğŸ“¦ Offline balÃ­k"</small></div>';
return;
}

let html='';
offlineProjects.forEach(proj=>{
const meta=proj.data.projectMeta||{};
const name=meta.name||proj.id;
const date=meta.date?new Date(meta.date).toLocaleDateString('sk-SK'):'';
const size=JSON.stringify(proj.data).length;
html+=`<div class="offline-mode-project" style="background:#e0e7ff;border:2px solid #8b5cf6;border-radius:8px;padding:15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
<div style="flex:1;cursor:pointer" onclick="loadOfflineProject('${proj.id}');closeOfflineModeModal();">
<div style="font-weight:700;font-size:15px;color:#333">${name} <span style="background:#8b5cf6;color:white;padding:2px 8px;border-radius:4px;font-size:11px">ğŸ“± OFFLINE</span></div>
<div style="font-size:12px;color:#666">${(size/1024).toFixed(1)} KB${date?' â€¢ '+date:''}</div>
</div>
<button onclick="event.stopPropagation();deleteOfflineProjectOldModal('${proj.id}','${name}')" style="background:#ef4444;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold">ğŸ—‘ï¸ ZmazaÅ¥</button>
</div>`;
});

listEl.innerHTML=html;
}

function deleteOfflineProjectOldModal(projectId,projectName){
if(!confirm('ZmazaÅ¥ offline projekt "'+projectName+'"?\n\nUvoÄ¾nÃ­ sa miesto v localStorage.')){
return;
}
localStorage.removeItem('offline_project_'+projectId);
console.log('ğŸ—‘ï¸ Offline projekt zmazanÃ½:',projectId);
loadOfflineModeProjects(); // Refresh zoznamu
showNotification('ğŸ—‘ï¸ Projekt zmazanÃ½ z offline ÃºloÅ¾iska','success');
}

function filterOfflineModeProjects(){
const searchText=document.getElementById('offlineModeSearch').value.toLowerCase();
const items=document.querySelectorAll('.offline-mode-project');
items.forEach(item=>{
const text=item.textContent.toLowerCase();
item.style.display=text.includes(searchText)?'block':'none';
});
}

async function loadOfflineProject(projectId){
  // ğŸ”” Stop update checker (offline project)
  stopUpdateChecker();
  currentProjectName = null;
  currentProjectTimestamp = null;
  
try{
// Nastav offline flag aby sa Firebase nevolal
const wasOnline = isOnline;
isOnline = false; // DoÄasne vypni online reÅ¾im

const data=JSON.parse(localStorage.getItem('offline_project_'+projectId));
if(!data){
alert('âŒ Projekt nebol nÃ¡jdenÃ½ v offline ÃºloÅ¾isku');
isOnline = wasOnline;
return;
}

// NaÄÃ­taj projekt data
if(data.ws)ws=data.ws;
if(data.spools)spools=data.spools;
if(data.crosses)crosses=data.crosses;
if(data.lines)lines=data.lines;
if(data.texts)texts=data.texts;
if(data.curves)curves=data.curves;
if(data.arrows)arrows=data.arrows;
if(data.dimensions)dimensions=data.dimensions;
if(data.spoolData)spoolData=data.spoolData;
if(data.weldBookData)weldBookData=data.weldBookData;
if(data.kontrolaData)kontrolaData=data.kontrolaData;

// NaÄÃ­taj PDF ak je
if(data.pdfData){
const pdfBytes=base64ToUint8Array(data.pdfData);

// NaÄÃ­taj PDF cez pdfjsLib
pdfjsLib.getDocument(pdfBytes).promise.then(function(p){
pd=p;
originalFileName=data.projectMeta?.name||projectId;

// Aktualizuj UI elementy
document.getElementById('up').style.display='none';
document.getElementById('cw').style.display='block';
document.getElementById('zoomInfo').style.display='block';
document.getElementById('zi').disabled=false;
document.getElementById('zo').disabled=false;
document.getElementById('zr').disabled=false;
document.getElementById('savepdf').disabled=false;
document.getElementById('saveproj').disabled=false;
document.getElementById('savetolibrary').disabled=false;
document.getElementById('loadprojbtn').disabled=false;
document.getElementById('editmode').disabled=false;
document.getElementById('editcrossmode').disabled=false;
document.getElementById('setstart').disabled=false;
document.getElementById('selectbtn').disabled=false;
document.getElementById('crossbtn').disabled=false;
document.getElementById('spoolbtn').disabled=false;
document.getElementById('spoollistbtn').disabled=false;
document.getElementById('refreshspoolbtn').disabled=false;
document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;
document.getElementById('spoolspreview').disabled=false;
document.getElementById('montaz_linebtn').disabled=false;
document.getElementById('montaz_textbtn').disabled=false;
document.getElementById('montaz_curvebtn').disabled=false;
document.getElementById('montaz_arrowbtn').disabled=false;
document.getElementById('montaz_doublearrowbtn').disabled=false;
document.getElementById('weldlogbtn').disabled=false;
document.getElementById('oneclickbtn').disabled=false;
document.getElementById('twoclickbtn').disabled=false;
document.getElementById('weldscaleminus').disabled=false;
document.getElementById('weldscaleplus').disabled=false;
document.getElementById('mtobtn').disabled=false;
document.getElementById('dimensionbtn').disabled=false;
document.getElementById('prefab_linebtn').disabled=false;
document.getElementById('prefab_textbtn').disabled=false;
document.getElementById('prefab_arrowbtn').disabled=false;
document.getElementById('prefab_doublearrowbtn').disabled=false;
document.getElementById('prefab_curvebtn').disabled=false;
document.getElementById('linebtn').disabled=false;
document.getElementById('textbtn').disabled=false;
document.getElementById('curvebtn').disabled=false;
document.getElementById('arrowbtn').disabled=false;
document.getElementById('doublearrowbtn').disabled=false;
document.getElementById('undo').disabled=false;

// Renderuj prvÃº stranu
rp();

// Aktualizuj UI
up();
dw();
closeOfflineModeModal();

// Obnov online stav
isOnline = wasOnline;

alert('âœ… Offline projekt naÄÃ­tanÃ½: '+(data.projectMeta?.name||projectId));
console.log('ğŸ“± Offline projekt naÄÃ­tanÃ½:',projectId);
}).catch(function(err){
console.error('âŒ Chyba pri naÄÃ­tanÃ­ PDF:',err);
isOnline = wasOnline;
alert('âŒ Chyba pri naÄÃ­tanÃ­ PDF: '+err.message);
});
}else{
// Å½iadne PDF - len data
up();
dw();
closeOfflineModeModal();
isOnline = wasOnline;
alert('âœ… Offline projekt naÄÃ­tanÃ½ (bez PDF): '+(data.projectMeta?.name||projectId));
console.log('ğŸ“± Offline projekt naÄÃ­tanÃ½ (bez PDF):',projectId);
}
}catch(error){
console.error('Chyba pri naÄÃ­tanÃ­ offline projektu:',error);
alert('âŒ Chyba pri naÄÃ­tanÃ­: '+error.message);
// Obnov online stav aj pri chybe
if(typeof wasOnline !== 'undefined') isOnline = wasOnline;
}
}

function base64ToUint8Array(base64){
const binaryString=atob(base64);
const len=binaryString.length;
const bytes=new Uint8Array(len);
for(let i=0;i<len;i++){
bytes[i]=binaryString.charCodeAt(i);
}
return bytes;
}

function closeOfflinePackage(){
document.getElementById('offlinePackageModal').style.display='none';
selectedProjects.clear();
}
async function loadProjectsForOffline(){
const listEl=document.getElementById('offlineProjectsList');
listEl.innerHTML='<div style="text-align:center;color:#999;padding:40px">â³ NaÄÃ­tavam...</div>';
try{
if(!db){listEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ Firebase nedostupnÃ½</div>';return;}
const snapshot=await db.collection('projects').orderBy('date','desc').get();
if(snapshot.empty){listEl.innerHTML='<div style="text-align:center;color:#999;padding:40px">ğŸ“­ Å½iadne projekty v kniÅ¾nici</div>';return;}
let html='';
for(const doc of snapshot.docs){
const meta=doc.data();
const size=meta.size||0;
const isDownloaded=localStorage.getItem('offline_project_'+doc.id)!==null;
html+=`<div class="offline-project-item" data-id="${doc.id}" data-size="${size}" style="background:${isDownloaded?'#d1fae5':'white'};border:2px solid ${isDownloaded?'#10b981':'#e5e7eb'};border-radius:8px;padding:15px;margin-bottom:12px;cursor:pointer" onclick="toggleProjectSelection('${doc.id}')"><div style="display:flex;align-items:center;gap:15px"><input type="checkbox" class="project-checkbox" data-id="${doc.id}" onclick="event.stopPropagation();toggleProjectSelection('${doc.id}')" style="width:20px;height:20px;cursor:pointer"><div style="flex:1"><div style="font-weight:700;font-size:15px;color:#333">${meta.name||doc.id}${isDownloaded?' <span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:11px">âœ…</span>':''}</div><div style="font-size:12px;color:#666">${(size/1024).toFixed(1)} KB â€¢ ${meta.date?new Date(meta.date).toLocaleDateString('sk-SK'):''}</div></div></div></div>`;
}
listEl.innerHTML=html;
const usedSpace=getUsedLocalStorage();
const totalSpace=10*1024*1024; // 10 MB (realistickÃ½ browser limit)
const availableSpace=totalSpace-usedSpace;
document.getElementById('availableSpace').textContent=(availableSpace/1024/1024).toFixed(1)+' MB';
}catch(error){console.error(error);listEl.innerHTML='<div style="text-align:center;color:#ef4444;padding:40px">âŒ '+error.message+'</div>';}
}
function getUsedLocalStorage(){
let total=0;
for(let key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length+key.length;
}
}
return total;
}
function filterOfflineProjects(){
const searchText=document.getElementById('offlinePackageSearch').value.toLowerCase();
const items=document.querySelectorAll('.offline-project-item');
let visibleCount=0;
items.forEach(item=>{
const text=item.textContent.toLowerCase();
if(text.includes(searchText)){
item.style.display='block';
visibleCount++;
}else{
item.style.display='none';
}
});
if(visibleCount===0&&searchText!==''){
document.getElementById('offlineProjectsList').innerHTML='<div style="text-align:center;color:#999;padding:40px">ğŸ” Å½iadne projekty nenÃ¡jdenÃ©</div>';
}
}
function toggleProjectSelection(projectId){
const checkbox=document.querySelector(`.project-checkbox[data-id="${projectId}"]`);
const item=document.querySelector(`.offline-project-item[data-id="${projectId}"]`);
if(selectedProjects.has(projectId)){
selectedProjects.delete(projectId);
checkbox.checked=false;
if(!localStorage.getItem('offline_project_'+projectId)){item.style.background='white';item.style.borderColor='#e5e7eb';}
}else{
selectedProjects.add(projectId);
checkbox.checked=true;
item.style.background='#fef3c7';
item.style.borderColor='#f59e0b';
}
updateSelectionStats();
}
function selectAllProjects(){
document.querySelectorAll('.project-checkbox').forEach(checkbox=>{
selectedProjects.add(checkbox.dataset.id);
checkbox.checked=true;
document.querySelector(`.offline-project-item[data-id="${checkbox.dataset.id}"]`).style.cssText='background:#fef3c7;border-color:#f59e0b;border:2px solid;border-radius:8px;padding:15px;margin-bottom:12px;cursor:pointer';
});
updateSelectionStats();
}
function deselectAllProjects(){
selectedProjects.clear();
document.querySelectorAll('.project-checkbox').forEach(checkbox=>{
checkbox.checked=false;
const item=document.querySelector(`.offline-project-item[data-id="${checkbox.dataset.id}"]`);
if(!localStorage.getItem('offline_project_'+checkbox.dataset.id)){item.style.background='white';item.style.borderColor='#e5e7eb';}
});
updateSelectionStats();
}
function updateSelectionStats(){
const count=selectedProjects.size;
let totalSize=0;
selectedProjects.forEach(id=>{const item=document.querySelector(`.offline-project-item[data-id="${id}"]`);if(item)totalSize+=parseInt(item.dataset.size)||0;});
document.getElementById('selectedCount').textContent=count+' '+(count===1?'projekt':count<5?'projekty':'projektov');
document.getElementById('selectedSize').textContent='('+(totalSize/1024).toFixed(1)+' KB)';
const btn=document.getElementById('downloadOfflineBtn');
if(count>0){btn.disabled=false;btn.textContent=`â¬‡ï¸ StiahnuÅ¥ (${count})`;}else{btn.disabled=true;btn.textContent='â¬‡ï¸ StiahnuÅ¥ (0)';}
}
async function downloadSelectedProjects(){
if(selectedProjects.size===0)return;
const btn=document.getElementById('downloadOfflineBtn');
btn.disabled=true;
let downloaded=0;
let failed=0;
for(const projectId of selectedProjects){
try{
btn.textContent=`â³ SÅ¥ahujem... (${downloaded+1}/${selectedProjects.size})`;
const projectData=await downloadProjectFromFirebase(projectId);
const dataToStore=JSON.stringify({id:projectId,data:projectData,downloadedAt:new Date().toISOString()});
try{
localStorage.setItem('offline_project_'+projectId,dataToStore);
downloaded++;
const item=document.querySelector(`.offline-project-item[data-id="${projectId}"]`);
if(item){item.style.background='#d1fae5';item.style.borderColor='#10b981';}
}catch(storageError){
if(storageError.name==='QuotaExceededError'){
console.error('âŒ Kapacita naplnenÃ¡!');
showNotification('âš ï¸ Kapacita naplnenÃ¡! StiahnutÃ©: '+downloaded,'warning');
failed++;
break;
}
throw storageError;
}
await new Promise(r=>setTimeout(r,300));
}catch(error){console.error('âŒ Chyba pri sÅ¥ahovanÃ­:',projectId,error);failed++;}
}
btn.disabled=false;
btn.textContent=`â¬‡ï¸ StiahnuÅ¥ (0)`;
selectedProjects.clear();
deselectAllProjects();
if(failed>0){
showNotification(`âš ï¸ StiahnutÃ©: ${downloaded}, Zlyhalo: ${failed}`,'warning');
}else{
showNotification(`âœ… ${downloaded} projektov stiahnutÃ½ch!`,'success');
}
}

// ğŸšª LOGOUT funkcia
function logout() {
  if (confirm('Naozaj sa chcete odhlÃ¡siÅ¥?')) {
    localStorage.removeItem('weldpro_session');
    sessionStorage.removeItem('weldpro_session');
    window.location.href = 'login.html';
  }
}

// ==========================================
// ğŸ“¦ OFFLINE SYSTÃ‰M - PRIDANÃ‰ BEZ ZMENY ORIGINÃLNEJ LOGIKY
// ==========================================

// currentOfflineProjectId je uÅ¾ deklarovanÃ½ hore pri weldBookData (riadok ~7615)
let autoSaveTimeout = null;
let pendingWeldBookChanges = [];

// Auto-save (volÃ¡ sa z rÃ´znych miest)
function autoSaveCurrentProject() {
  if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
  
  autoSaveTimeout = setTimeout(() => {
    if (!currentOfflineProjectId) return;
    
    const projectData = {
      welds: ws || [],
      lines: lines || [],
      texts: texts || [],
      arrows: arrows || [],
      curves: curves || [],
      crosses: crosses || [],
      spools: spools || [],
      dimensions: dimensions || [],
      spoolData: spoolData || {},
      weldBookData: weldBookData || [],
      kontrolaData: kontrolaData || {},
      currentNumber: cn,
      startNumber: startNum,
      pdfData: pd
    };
    
    const result = saveOfflineProject(currentOfflineProjectId, projectData);
    if (result.success) {
      console.log('ğŸ’¾ Auto-save:', currentOfflineProjectId);
    }
  }, 500);
}

// Pridaj WeldBook zmenu do pending
function addPendingWeldBookChange(change) {
  loadPendingWeldBookChanges();
  
  const existingIndex = pendingWeldBookChanges.findIndex(
    c => c.project === change.project && c.weldId === change.weldId
  );
  
  if (existingIndex >= 0) {
    pendingWeldBookChanges[existingIndex] = change;
  } else {
    pendingWeldBookChanges.push(change);
  }
  
  savePendingWeldBookChanges();
  console.log('ğŸ“Š WeldBook change added:', change.weldId);
}

function loadPendingWeldBookChanges() {
  const stored = localStorage.getItem('pending_weldbook');
  if (stored) {
    try {
      pendingWeldBookChanges = JSON.parse(stored);
    } catch (e) {
      pendingWeldBookChanges = [];
    }
  }
}

function savePendingWeldBookChanges() {
  localStorage.setItem('pending_weldbook', JSON.stringify(pendingWeldBookChanges));
}

// Kompresia/dekompresia
function saveOfflineProject(projectId, projectData) {
  try {
    const dataObject = {
      id: projectId,
      data: projectData,
      savedAt: new Date().toISOString()
    };
    
    const jsonString = JSON.stringify(dataObject);
    const originalSize = jsonString.length;
    
    if (typeof pako !== 'undefined') {
      const compressed = pako.gzip(jsonString);
      const base64 = btoa(String.fromCharCode.apply(null, compressed));
      const dataToStore = 'GZIP:' + base64;
      
      localStorage.setItem('offline_project_' + projectId, dataToStore);
      
      const compressedSize = dataToStore.length;
      const savings = ((1 - compressedSize/originalSize) * 100).toFixed(1);
      
      return {success: true, originalSize, compressedSize, savings};
    } else {
      localStorage.setItem('offline_project_' + projectId, jsonString);
      return {success: true, originalSize, compressedSize: originalSize, savings: 0};
    }
  } catch (e) {
    console.error('âŒ Save failed:', e);
    return {success: false, error: e.message};
  }
}

// NaÄÃ­taÅ¥ dÃ¡ta z offline projektu (s dekompresiou)
function loadOfflineProjectData(projectId) {
  try {
    const rawData = localStorage.getItem('offline_project_' + projectId);
    if (!rawData) {
      return {success: false, error: 'Not found'};
    }
    
    if (rawData.startsWith('GZIP:')) {
      const base64 = rawData.substring(5);
      const compressedData = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
      const decompressed = pako.ungzip(compressedData, { to: 'string' });
      return {success: true, data: JSON.parse(decompressed)};
    } else {
      return {success: true, data: JSON.parse(rawData)};
    }
  } catch (e) {
    return {success: false, error: e.message};
  }
}

// NaÄÃ­taÅ¥ a zobraziÅ¥ offline projekt
function loadOfflineProject(projectId) {
  try {
    console.log('ğŸ“± Loading offline project:', projectId);
    
    // âœ… Nastav ID aktuÃ¡lneho offline projektu (pre auto-save)
    currentOfflineProjectId = projectId;
    console.log('ğŸ“± Set currentOfflineProjectId:', currentOfflineProjectId);
    
    // NaÄÃ­taj dÃ¡ta
    const result = loadOfflineProjectData(projectId);
    if (!result.success) {
      alert('âŒ Chyba: ' + result.error);
      return;
    }
    
    // OPRAVA: result.data obsahuje {id, data, savedAt}, takÅ¾e potrebujeme .data.data
    const wrappedData = result.data;
    const projectData = wrappedData.data || wrappedData; // Fallback ak nie je wrapped
    console.log('ğŸ“± Project data loaded:', projectData);
    
    // ğŸ§¹ VYÄŒISTIÅ¤ VÅ ETKO PRED NAÄŒÃTANÃM NOVÃ‰HO PROJEKTU!
    console.log('ğŸ§¹ ÄŒistenie starÃ½ch dÃ¡t...');
    ws = [];
    spools = [];
    crosses = [];
    dimensions = [];
    lines = [];
    arrows = [];
    texts = [];
    curves = [];
    spoolData = {};
    weldLogMaterials = [];
    weldAssignments = {};
    // âœ… weldBookData SA NEMAÅ½E! Je to globÃ¡lna databÃ¡za!
    // âœ… kontrolaData SA NEMAÅ½E! Je to globÃ¡lna databÃ¡za!
    
    // NaÄÃ­taj dÃ¡ta
    ws = projectData.welds || [];
    spools = projectData.spools || [];
    crosses = projectData.crosses || [];
    dimensions = projectData.dimensions || [];
    lines = projectData.lines || [];
    arrows = projectData.arrows || [];
    texts = projectData.texts || [];
    curves = projectData.curves || [];
    spoolData = projectData.spoolData || {};
    cn = projectData.currentNumber || 1;
    startNum = projectData.startNumber || 1;
    originalFileName = projectData.projectName || projectId;
    
    // âœ… NaÄÃ­taj weldBookData z offline projektu
    if (projectData.weldBookData && projectData.weldBookData.length > 0) {
      weldBookData = projectData.weldBookData;
      saveWeldBookToStorage(); // UloÅ¾ aj do localStorage
      console.log('ğŸ“± WeldBook naÄÃ­tanÃ½ z offline projektu:', weldBookData.length, 'zvarov');
    }
    
    console.log('ğŸ“± Data loaded, welds:', ws.length, 'weldBook:', weldBookData.length);
    
    // NaÄÃ­taj PDF
    if (projectData.pdfData) {
      console.log('ğŸ“± Loading PDF...');
      const img = new Image();
      img.onload = function() {
        console.log('ğŸ“± PDF loaded!');
        
        loadedImage = img;
        baseImageWidth = img.naturalWidth || img.width;
        baseImageHeight = img.naturalHeight || img.height;
        
        // Zobraz canvas
        document.getElementById('up').style.display = 'none';
        document.getElementById('cw').style.display = 'block';
        
        // Aktivuj tlaÄidlÃ¡
        try {
          document.getElementById('zoomInfo').style.display='block';
          document.getElementById('zi').disabled=false;
          document.getElementById('zo').disabled=false;
          document.getElementById('zr').disabled=false;
          document.getElementById('savepdf').disabled=false;
          document.getElementById('saveproj').disabled=false;
          if(document.getElementById('savetolibrary')) document.getElementById('savetolibrary').disabled=false;
          document.getElementById('loadprojbtn').disabled=false;
          document.getElementById('editmode').disabled=false;
          if(document.getElementById('editcrossmode')) document.getElementById('editcrossmode').disabled=false;
          if(document.getElementById('setstart')) document.getElementById('setstart').disabled=false;
          if(document.getElementById('selectbtn')) document.getElementById('selectbtn').disabled=false;
          if(document.getElementById('crossbtn')) document.getElementById('crossbtn').disabled=false;
          if(document.getElementById('spoolbtn')) document.getElementById('spoolbtn').disabled=false;
          if(document.getElementById('spoollistbtn')) document.getElementById('spoollistbtn').disabled=false;
          if(document.getElementById('refreshspoolbtn')) document.getElementById('refreshspoolbtn').disabled=false;
          if(document.getElementById('addmontazweld')) document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;
          if(document.getElementById('spoolspreview')) document.getElementById('spoolspreview').disabled=false;
          if(document.getElementById('montazline')) document.getElementById('montazline').disabled=false;
          if(document.getElementById('montaztext')) document.getElementById('montaztext').disabled=false;
          if(document.getElementById('montaz_linebtn')) document.getElementById('montaz_linebtn').disabled=false;
          if(document.getElementById('montaz_textbtn')) document.getElementById('montaz_textbtn').disabled=false;
          if(document.getElementById('montaz_curvebtn')) document.getElementById('montaz_curvebtn').disabled=false;
          if(document.getElementById('montaz_arrowbtn')) document.getElementById('montaz_arrowbtn').disabled=false;
          if(document.getElementById('montaz_doublearrowbtn')) document.getElementById('montaz_doublearrowbtn').disabled=false;
          if(document.getElementById('weldlogbtn')) document.getElementById('weldlogbtn').disabled=false;
          if(document.getElementById('oneclickbtn')) document.getElementById('oneclickbtn').disabled=false;
          if(document.getElementById('twoclickbtn')) document.getElementById('twoclickbtn').disabled=false;
          document.getElementById('weldscaleminus').disabled=false;
          document.getElementById('weldscaleplus').disabled=false;
          if(document.getElementById('mtobtn')) document.getElementById('mtobtn').disabled=false;
          if(document.getElementById('dimensionbtn')) document.getElementById('dimensionbtn').disabled=false;
          document.getElementById('prefab_linebtn').disabled=false;
          document.getElementById('prefab_textbtn').disabled=false;
          document.getElementById('prefab_arrowbtn').disabled=false;
          document.getElementById('prefab_doublearrowbtn').disabled=false;
          document.getElementById('prefab_curvebtn').disabled=false;
          if(document.getElementById('linebtn')) document.getElementById('linebtn').disabled=false;
          if(document.getElementById('textbtn')) document.getElementById('textbtn').disabled=false;
          if(document.getElementById('curvebtn')) document.getElementById('curvebtn').disabled=false;
          if(document.getElementById('arrowbtn')) document.getElementById('arrowbtn').disabled=false;
          if(document.getElementById('doublearrowbtn')) document.getElementById('doublearrowbtn').disabled=false;
          if(document.getElementById('undo')) document.getElementById('undo').disabled=false;
          console.log('âœ… VÅ¡etky tlaÄidlÃ¡ aktivovanÃ©');
        } catch(btnError) {
          console.error('âš ï¸ Chyba pri aktivÃ¡cii tlaÄidiel:', btnError);
        }
        
        // Nastav zoom 100%
        sc = 1.0;
        var scaledWidth = baseImageWidth * sc;
        var scaledHeight = baseImageHeight * sc;
        
        ca.width = scaledWidth;
        ca.height = scaledHeight;
        ov.setAttribute('width', scaledWidth);
        ov.setAttribute('height', scaledHeight);
        ct.clearRect(0, 0, scaledWidth, scaledHeight);
        ct.imageSmoothingEnabled = false;
        ct.drawImage(img, 0, 0, scaledWidth, scaledHeight);
        dw();
        updateZoomDisplay();
        
        // Aktualizuj nÃ¡zov sÃºboru
        if(document.getElementById('fileName')) {
          document.getElementById('fileName').textContent = originalFileName;
        }
        
        // Refresh poÄet zvarov
        updateWeldCount();
        
        alert('âœ… Offline projekt naÄÃ­tanÃ½!');
      };
      img.onerror = function() {
        console.error('âŒ PDF load failed!');
        alert('âŒ Chyba pri naÄÃ­tanÃ­ PDF!');
      };
      img.src = projectData.pdfData;
    } else {
      alert('âš ï¸ Projekt neobsahuje PDF dÃ¡ta!');
    }
    
  } catch (error) {
    console.error('âŒ Error loading offline project:', error);
    alert('âŒ Chyba: ' + error.message);
  }
}

function listOfflineProjects() {
  const projects = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('offline_project_')) {
      const id = key.replace('offline_project_', '');
      const data = localStorage.getItem(key);
      projects.push({
        id: id,
        size: data.length,
        compressed: data.startsWith('GZIP:')
      });
    }
  }
  return projects;
}

console.log('ğŸ“¦ Offline systÃ©m pripravenÃ½');
loadPendingWeldBookChanges();

// ========================================
// LIBRARY MANAGER - REAL FUNKCIE
// ========================================

// Otvorenie Library Managera
function openLibraryManagerReal() {
  console.log('ğŸ“š Opening Library Manager...');
  const modal = document.getElementById('advancedLibraryModal');
  if (modal) {
    modal.style.display = 'block';
    // NaÄÃ­taj prvÃº zÃ¡loÅ¾ku (online)
    switchLibraryTab('online');
  } else {
    console.error('âŒ Library Manager modal not found!');
  }
}

// ZavrieÅ¥ Library Manager
function closeLibraryManager() {
  const modal = document.getElementById('advancedLibraryModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// PrepÃ­nanie zÃ¡loÅ¾iek
function switchLibraryTab(tabName) {
  console.log('ğŸ”„ Switching to tab:', tabName);
  
  // OdstrÃ¡Åˆ active zo vÅ¡etkÃ½ch tabov
  document.querySelectorAll('.library-tab').forEach(tab => {
    tab.classList.remove('active-library-tab');
  });
  
  // Skry vÅ¡etky tab contenty
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = 'none';
  });
  
  // Aktivuj sprÃ¡vny tab
  const tabButton = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  const tabContent = document.getElementById(tabName + 'TabContent');
  
  if (tabButton) tabButton.classList.add('active-library-tab');
  if (tabContent) tabContent.style.display = 'block';
  
  // NaÄÃ­taj data pre danÃº zÃ¡loÅ¾ku
  if (tabName === 'online') {
    loadOnlineProjects();
  } else if (tabName === 'offline') {
    loadOfflineProjectsTab();
  } else if (tabName === 'storage') {
    loadStorageInfo();
  }
}

// NaÄÃ­tanie online projektov (Firebase)
async function loadOnlineProjects() {
  const listEl = document.getElementById('onlineProjectsList');
  if (!listEl) return;
  
  listEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">â³ NaÄÃ­tavam...</div>';
  
  try {
    const projects = await listProjectsFromFirebase();
    
    if (projects.length === 0) {
      listEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999"><div style="font-size:48px">ğŸ“š</div><div style="font-size:18px;margin-top:10px">Å½iadne online projekty</div></div>';
      return;
    }
    
    listEl.innerHTML = projects.map(p => `
      <div style="background:#f8f9fa;border-radius:10px;padding:15px;border-left:4px solid #667eea;transition:all 0.3s;cursor:pointer" onmouseover="this.style.transform='translateX(5px)';this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateX(0)';this.style.boxShadow='none'">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600;font-size:16px;color:#333">${p.name}</div>
          <span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;background:#e3f2fd;color:#1976d2">ğŸŒ Online</span>
        </div>
        <div style="font-size:13px;color:#666;margin-bottom:5px">
          ğŸ“… ${new Date(p.timestamp).toLocaleString('sk-SK')}
        </div>
        ${p.part ? `<div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“¦ ÄŒasÅ¥: ${p.part}</div>` : ''}
        <div style="display:flex;gap:10px;margin-top:10px">
          <button onclick="loadAndDisplayProject('${p.name}', '${p.part || ''}'); closeLibraryManager();" style="flex:1;padding:6px 15px;background:#667eea;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer">ğŸ“‚ NaÄÃ­taÅ¥</button>
          <button onclick="downloadToOffline('${p.name}', '${p.part || ''}')" style="flex:1;padding:6px 15px;background:#10b981;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer">ğŸ’¾ Do offline</button>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('âŒ Error loading online projects:', error);
    listEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ef4444"><div style="font-size:48px">âŒ</div><div style="font-size:18px;margin-top:10px">Chyba naÄÃ­tania</div><div style="font-size:14px;margin-top:10px">' + error.message + '</div></div>';
  }
}

// StiahnuÅ¥ projekt do offline
async function downloadToOffline(projectName, part) {
  try {
    console.log('â¬‡ï¸ Downloading to offline:', projectName, part);
    
    // Zostav Firebase document ID (name + _ + part)
    const firebaseDocId = part ? `${projectName}_${part}` : projectName;
    console.log('ğŸ“¥ Firebase document ID:', firebaseDocId);
    
    // NaÄÃ­taj projekt z Firebase
    const projectData = await downloadProjectFromFirebase(firebaseDocId);
    
    // UloÅ¾ do localStorage s offline_ prefixom (pouÅ¾ijeme rovnakÃ© ID)
    const offlineId = firebaseDocId;
    const result = saveOfflineProject(offlineId, projectData);
    
    if (result.success) {
      alert('âœ… Projekt stiahnutÃ½ do offline!');
      // Refresh offline tab ak je otvorenÃ¡
      if (document.getElementById('offlineTabContent').style.display !== 'none') {
        loadOfflineProjectsTab();
      }
    } else {
      alert('âŒ Chyba: ' + result.error);
    }
    
  } catch (error) {
    console.error('âŒ Error downloading to offline:', error);
    alert('âŒ Chyba pri sÅ¥ahovanÃ­: ' + error.message);
  }
}

// NaÄÃ­tanie offline projektov
function loadOfflineProjectsTab() {
  const listEl = document.getElementById('offlineProjectsList');
  if (!listEl) return;
  
  listEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">â³ NaÄÃ­tavam...</div>';
  
  const projects = listOfflineProjects();
  
  if (projects.length === 0) {
    listEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999"><div style="font-size:48px">ğŸ’¾</div><div style="font-size:18px;margin-top:10px">Å½iadne offline projekty</div><div style="font-size:14px;margin-top:10px">Stiahni projekt z Online zÃ¡loÅ¾ky</div></div>';
    return;
  }
  
  // NaÄÃ­taj pending changes
  loadPendingWeldBookChanges();
  const pendingCount = pendingWeldBookChanges.length;
  
  // Update sync button
  const syncBtn = document.getElementById('syncAllBtn');
  if (syncBtn) {
    syncBtn.disabled = pendingCount === 0;
    syncBtn.textContent = pendingCount > 0 ? 
      `ğŸ”„ SynchronizovaÅ¥ vÅ¡etky zmeny (${pendingCount})` : 
      'âœ… VÅ¡etko synchronizovanÃ©';
  }
  
  listEl.innerHTML = projects.map(p => {
    // Zisti Äi mÃ¡ pending changes
    const projectPending = pendingWeldBookChanges.filter(c => c.project === p.id);
    const hasPending = projectPending.length > 0;
    
    return `
      <div style="background:${hasPending ? '#fef3c7' : '#f8f9fa'};border-radius:10px;padding:15px;border-left:4px solid ${hasPending ? '#f59e0b' : '#10b981'};transition:all 0.3s;cursor:pointer" onmouseover="this.style.transform='translateX(5px)';this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateX(0)';this.style.boxShadow='none'">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600;font-size:16px;color:#333">${p.id}</div>
          <span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;background:${hasPending ? '#fff3e0' : '#e8f5e9'};color:${hasPending ? '#f57c00' : '#2e7d32'}">
            ${hasPending ? 'âš ï¸ Pending' : 'âœ… Synced'}
          </span>
        </div>
        <div style="font-size:13px;color:#666;margin-bottom:5px">
          ğŸ“¦ VeÄ¾kosÅ¥: ${(p.size / 1024).toFixed(2)} KB ${p.compressed ? '(komprimovanÃ©)' : ''}
        </div>
        ${hasPending ? `<div style="font-size:13px;color:#f57c00;margin-bottom:5px">ğŸ”„ ${projectPending.length} zmien ÄakÃ¡ na sync</div>` : ''}
        <div style="display:flex;gap:10px;margin-top:10px">
          <button onclick="loadOfflineProject('${p.id}'); closeLibraryManager();" style="flex:1;padding:6px 15px;background:#667eea;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer">ğŸ“‚ NaÄÃ­taÅ¥</button>
          ${hasPending ? `<button onclick="syncProjectWeldBook('${p.id}')" style="flex:1;padding:6px 15px;background:#10b981;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer">ğŸ”„ Sync</button>` : ''}
          <button onclick="deleteOfflineProject('${p.id}')" style="padding:6px 15px;background:#ef4444;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }).join('');
}

// NaÄÃ­tanie info o ÃºloÅ¾isku
function loadStorageInfo() {
  const offlineProjects = listOfflineProjects();
  const totalSize = offlineProjects.reduce((sum, p) => sum + p.size, 0);
  
  loadPendingWeldBookChanges();
  const pendingCount = pendingWeldBookChanges.length;
  
  // Update Å¡tatistiky
  document.getElementById('totalProjects').textContent = offlineProjects.length;
  document.getElementById('offlineProjectsCount').textContent = offlineProjects.length;
  document.getElementById('pendingSyncCount').textContent = pendingCount;
  document.getElementById('storageUsed').textContent = (totalSize / 1024).toFixed(2) + ' KB';
}

// SynchronizovaÅ¥ vÅ¡etky pending zmeny
async function syncAllPendingWeldBook() {
  loadPendingWeldBookChanges();
  
  if (pendingWeldBookChanges.length === 0) {
    alert('âœ… VÅ¡etko je uÅ¾ synchronizovanÃ©!');
    return;
  }
  
  // Group by project
  const byProject = {};
  pendingWeldBookChanges.forEach(change => {
    if (!byProject[change.project]) {
      byProject[change.project] = [];
    }
    byProject[change.project].push(change);
  });
  
  const projectCount = Object.keys(byProject).length;
  const confirmSync = confirm(`ğŸ”„ SynchronizovaÅ¥ ${projectCount} projektov?\n\n${pendingWeldBookChanges.length} celkovÃ½ch zmien bude nahranÃ½ch do Firebase.\n\nOstatnÃ­ uÅ¾Ã­vatelia uvidia zmeny.`);
  
  if (!confirmSync) return;
  
  let synced = 0;
  let errors = 0;
  
  // Sync each project
  for (const projectId of Object.keys(byProject)) {
    try {
      console.log(`ğŸ”„ Syncing project: ${projectId}...`);
      
      // NaÄÃ­taj offline projekt
      const projectData = loadOfflineProjectData(projectId);
      if (!projectData) {
        throw new Error('Projekt sa nepodarilo naÄÃ­taÅ¥!');
      }
      
      // Upload do Firebase
      await uploadProjectToFirebase(projectData);
      
      synced++;
      console.log(`âœ… ${projectId} synchronized!`);
      
    } catch (error) {
      console.error(`âŒ Error syncing ${projectId}:`, error);
      errors++;
    }
  }
  
  // VymaÅ¾ pending changes po ÃºspeÅ¡nom syncu
  if (synced > 0) {
    const successfulProjects = Object.keys(byProject).slice(0, synced);
    pendingWeldBookChanges = pendingWeldBookChanges.filter(c => 
      !successfulProjects.includes(c.project)
    );
    savePendingWeldBookChanges();
  }
  
  if (errors === 0) {
    alert(`âœ… SynchronizÃ¡cia ÃºspeÅ¡nÃ¡!\n\n${synced} projektov nahranÃ½ch do Firebase.`);
  } else {
    alert(`âš ï¸ SynchronizÃ¡cia dokonÄenÃ¡ s chybami:\n\nâœ… ÃšspeÅ¡nÃ©: ${synced}\nâŒ Chyby: ${errors}\n\nSkontroluj internetovÃ© pripojenie.`);
  }
  
  // Refresh offline tab
  loadOfflineProjectsTab();
}

// Sync jednÃ©ho projektu
async function syncProjectWeldBook(projectId) {
  loadPendingWeldBookChanges();
  
  const projectChanges = pendingWeldBookChanges.filter(c => c.project === projectId);
  
  if (projectChanges.length === 0) {
    alert('âœ… Projekt je uÅ¾ synchronizovanÃ½!');
    return;
  }
  
  const confirmSync = confirm(`SynchronizovaÅ¥ ${projectChanges.length} zmien pre projekt ${projectId}?\n\nProjekt bude nahranÃ½ do Firebase.`);
  
  if (!confirmSync) return;
  
  try {
    console.log('ğŸ”„ NaÄÃ­tavam offline projekt:', projectId);
    
    // NaÄÃ­taj offline projekt
    const projectData = loadOfflineProjectData(projectId);
    if (!projectData) {
      throw new Error('Projekt sa nepodarilo naÄÃ­taÅ¥!');
    }
    
    console.log('ğŸ“¤ Uploadujem do Firebase...');
    
    // Upload celÃ½ projekt do Firebase (vrÃ¡tane WeldBook)
    await uploadProjectToFirebase(projectData);
    
    console.log('âœ… Firebase upload ÃºspeÅ¡nÃ½!');
    
    // OdstrÃ¡Åˆ zo pending
    pendingWeldBookChanges = pendingWeldBookChanges.filter(c => c.project !== projectId);
    savePendingWeldBookChanges();
    
    alert('âœ… Projekt synchronizovanÃ½ do Firebase!\n\nOstatnÃ­ uÅ¾Ã­vatelia teraz vidia zmeny.');
    loadOfflineProjectsTab();
    
  } catch (error) {
    console.error('âŒ Error syncing:', error);
    alert('âŒ Chyba pri synchronizÃ¡cii:\n\n' + error.message + '\n\nSkontroluj internetovÃ© pripojenie.');
  }
}

// VymazaÅ¥ offline projekt
function deleteOfflineProject(projectId) {
  const confirmDelete = confirm(`Naozaj vymazaÅ¥ offline projekt "${projectId}"?\n\nTÃ¡to akcia je nevratnÃ¡!`);
  
  if (!confirmDelete) return;
  
  try {
    localStorage.removeItem('offline_project_' + projectId);
    alert('âœ… Projekt vymazanÃ½!');
    loadOfflineProjectsTab();
    loadStorageInfo();
  } catch (error) {
    console.error('âŒ Error deleting:', error);
    alert('âŒ Chyba pri mazanÃ­: ' + error.message);
  }
}

// VymazaÅ¥ celÃ½ offline cache
function clearOfflineCache() {
  const confirmClear = confirm('âš ï¸ VAROVANIE!\n\nNaozaj vymazaÅ¥ VÅ ETKY offline projekty?\n\nTÃ¡to akcia je NEVRATNÃ!');
  
  if (!confirmClear) return;
  
  const doubleConfirm = confirm('Si si naozaj istÃ½?\n\nVÅ¡etky offline projekty budÃº PERMANENTNE vymazanÃ©!');
  
  if (!doubleConfirm) return;
  
  try {
    let deleted = 0;
    const keysToDelete = [];
    
    // Najdi vÅ¡etky offline projekty
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('offline_project_')) {
        keysToDelete.push(key);
      }
    }
    
    // VymaÅ¾ ich
    keysToDelete.forEach(key => {
      localStorage.removeItem(key);
      deleted++;
    });
    
    // VymaÅ¾ aj pending changes
    localStorage.removeItem('pending_weldbook_changes');
    pendingWeldBookChanges = [];
    
    alert(`âœ… Cache vymazanÃ½!\n\nVymazanÃ© projekty: ${deleted}`);
    loadOfflineProjectsTab();
    loadStorageInfo();
    
  } catch (error) {
    console.error('âŒ Error clearing cache:', error);
    alert('âŒ Chyba pri mazanÃ­ cache: ' + error.message);
  }
}

// ExportovaÅ¥ offline dÃ¡ta
function exportOfflineData() {
  try {
    const projects = listOfflineProjects();
    
    if (projects.length === 0) {
      alert('âš ï¸ Å½iadne offline projekty na export!');
      return;
    }
    
    const exportData = {
      timestamp: new Date().toISOString(),
      projects: projects.map(p => {
        const data = localStorage.getItem('offline_project_' + p.id);
        return {
          id: p.id,
          size: p.size,
          compressed: p.compressed,
          data: data
        };
      }),
      pendingChanges: pendingWeldBookChanges
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `weldpro-offline-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… Offline dÃ¡ta exportovanÃ©!');
    
  } catch (error) {
    console.error('âŒ Error exporting:', error);
    alert('âŒ Chyba pri exporte: ' + error.message);
  }
}

// Filter funkcie
function filterOnlineProjects() {
  const searchTerm = document.getElementById('onlineSearch').value.toLowerCase();
  const items = document.querySelectorAll('#onlineProjectsList > div');
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
  });
}

function filterOfflineProjects() {
  const searchTerm = document.getElementById('offlineSearch').value.toLowerCase();
  const items = document.querySelectorAll('#offlineProjectsList > div');
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
  });
}

// NaÄÃ­taÅ¥ a zobraziÅ¥ projekt z Firebase
async function loadAndDisplayProject(projectName, part) {
  // âœ… Resetuj offline ID (naÄÃ­tavame ONLINE projekt)
  currentOfflineProjectId = null;
  
  // Zostav Firebase document ID (name + _ + part)
  const firebaseDocId = part ? `${projectName}_${part}` : projectName;
  console.log('ğŸ”µ loadAndDisplayProject called:', firebaseDocId);
  
  try {
    console.log('ğŸ”µ Downloading project...');
    const projectData = await downloadProjectFromFirebase(firebaseDocId);
    console.log('ğŸ”µ Project downloaded:', projectData);
    
    // ğŸ§¹ VYÄŒISTIÅ¤ VÅ ETKO PRED NAÄŒÃTANÃM NOVÃ‰HO PROJEKTU!
    console.log('ğŸ§¹ ÄŒistenie starÃ½ch dÃ¡t pred naÄÃ­tanÃ­m...');
    ws = [];
    spools = [];
    crosses = [];
    dimensions = [];
    lines = [];
    arrows = [];
    texts = [];
    curves = [];
    spoolData = {};
    weldLogMaterials = [];
    weldAssignments = {};
    // âœ… weldBookData SA NEMAÅ½E! Je to globÃ¡lna databÃ¡za vÅ¡etkÃ½ch zvarov!
    // âœ… kontrolaData SA NEMAÅ½E! Je to globÃ¡lna databÃ¡za kontrol!
    
    ws = projectData.welds || [];
    spools = projectData.spools || [];
    crosses = projectData.crosses || [];
    dimensions = projectData.dimensions || [];
    lines = projectData.lines || [];
    arrows = projectData.arrows || [];
    texts = projectData.texts || [];
    curves = projectData.curves || [];
    // âœ… ZMENENÃ‰: WeldBook sa teraz naÄÃ­tava z projektu (zdieÄ¾anÃ½ cez Firebase)!
    if (projectData.weldBookData && projectData.weldBookData.length > 0) {
      weldBookData = projectData.weldBookData;
      saveWeldBookToStorage(); // UloÅ¾ aj do localStorage pre offline prÃ­stup
      console.log('ğŸ“¥ WeldBook naÄÃ­tanÃ½ z projektu:', weldBookData.length, 'zvarov');
    }
    // âœ… kontrolaData zostÃ¡va globÃ¡lny!
    spoolData = projectData.spoolData || {};
    cn = projectData.currentNumber || 1;
    startNum = projectData.startNumber || 1;
    originalFileName = projectData.projectName || 'zvary';
    
    console.log('ğŸ”µ Data loaded, welds:', ws.length, 'weldBook:', weldBookData.length);
    
    if (projectData.pdfData) {
      console.log('ğŸ”µ Loading PDF...');
      const img = new Image();
      img.onload = function() {
        console.log('ğŸ”µ PDF loaded, drawing...');
        
        // UloÅ¾ obrÃ¡zok pre zoom
        loadedImage = img;
        baseImageWidth = img.naturalWidth || img.width;
        baseImageHeight = img.naturalHeight || img.height;
        
        // Zobraz canvas wrapper
        document.getElementById('up').style.display = 'none';
        document.getElementById('cw').style.display = 'block';
        
        // âœ… AKTIVUJ VÅ ETKY TLAÄŒIDLÃ (s try-catch aby chyba nezastavila celÃº funkciu)
        try {
          document.getElementById('zoomInfo').style.display='block';
          document.getElementById('zi').disabled=false;
          document.getElementById('zo').disabled=false;
          document.getElementById('zr').disabled=false;
          document.getElementById('savepdf').disabled=false;
          document.getElementById('saveproj').disabled=false;
          document.getElementById('savetolibrary').disabled=false;
          if(document.getElementById('savetolibrary')) document.getElementById('savetolibrary').disabled=false;
          document.getElementById('loadprojbtn').disabled=false;
          document.getElementById('editmode').disabled=false;
          if(document.getElementById('editcrossmode')) document.getElementById('editcrossmode').disabled=false;
          if(document.getElementById('setstart')) document.getElementById('setstart').disabled=false;
          if(document.getElementById('selectbtn')) document.getElementById('selectbtn').disabled=false;
          if(document.getElementById('crossbtn')) document.getElementById('crossbtn').disabled=false;
          if(document.getElementById('spoolbtn')) document.getElementById('spoolbtn').disabled=false;
          if(document.getElementById('spoollistbtn')) document.getElementById('spoollistbtn').disabled=false;
          if(document.getElementById('refreshspoolbtn')) document.getElementById('refreshspoolbtn').disabled=false;
          if(document.getElementById('addmontazweld')) document.getElementById('addmontazweld').disabled=false;if(document.getElementById('montazdeletebtn'))document.getElementById('montazdeletebtn').disabled=false;
          if(document.getElementById('spoolspreview')) document.getElementById('spoolspreview').disabled=false;
          if(document.getElementById('montazline')) document.getElementById('montazline').disabled=false;
          if(document.getElementById('montaztext')) document.getElementById('montaztext').disabled=false;
          if(document.getElementById('montaz_linebtn')) document.getElementById('montaz_linebtn').disabled=false;
          if(document.getElementById('montaz_textbtn')) document.getElementById('montaz_textbtn').disabled=false;
          if(document.getElementById('montaz_curvebtn')) document.getElementById('montaz_curvebtn').disabled=false;
          if(document.getElementById('montaz_arrowbtn')) document.getElementById('montaz_arrowbtn').disabled=false;
          if(document.getElementById('montaz_doublearrowbtn')) document.getElementById('montaz_doublearrowbtn').disabled=false;
          if(document.getElementById('weldlogbtn')) document.getElementById('weldlogbtn').disabled=false;
          if(document.getElementById('oneclickbtn')) document.getElementById('oneclickbtn').disabled=false;
          if(document.getElementById('twoclickbtn')) document.getElementById('twoclickbtn').disabled=false;
          document.getElementById('weldscaleminus').disabled=false;
          document.getElementById('weldscaleplus').disabled=false;
          if(document.getElementById('mtobtn')) document.getElementById('mtobtn').disabled=false;
          if(document.getElementById('dimensionbtn')) document.getElementById('dimensionbtn').disabled=false;
          document.getElementById('prefab_linebtn').disabled=false;
          document.getElementById('prefab_textbtn').disabled=false;
          document.getElementById('prefab_arrowbtn').disabled=false;
          document.getElementById('prefab_doublearrowbtn').disabled=false;
          document.getElementById('prefab_curvebtn').disabled=false;
          if(document.getElementById('linebtn')) document.getElementById('linebtn').disabled=false;
          if(document.getElementById('textbtn')) document.getElementById('textbtn').disabled=false;
          if(document.getElementById('curvebtn')) document.getElementById('curvebtn').disabled=false;
          if(document.getElementById('arrowbtn')) document.getElementById('arrowbtn').disabled=false;
          if(document.getElementById('doublearrowbtn')) document.getElementById('doublearrowbtn').disabled=false;
          if(document.getElementById('undo')) document.getElementById('undo').disabled=false;
          console.log('âœ… VÅ¡etky tlaÄidlÃ¡ aktivovanÃ©');
        } catch(btnError) {
          console.error('âš ï¸ Chyba pri aktivÃ¡cii tlaÄidiel:', btnError);
        }
        
        // Nastav zoom 100%
        sc = 1.0;
        var scaledWidth = baseImageWidth * sc;
        var scaledHeight = baseImageHeight * sc;
        
        ca.width = scaledWidth;
        ca.height = scaledHeight;
        ov.setAttribute('width', scaledWidth);
        ov.setAttribute('height', scaledHeight);
        ct.clearRect(0, 0, scaledWidth, scaledHeight);
        ct.imageSmoothingEnabled = false;
        ct.drawImage(img, 0, 0, scaledWidth, scaledHeight);
        dw();
        updateZoomDisplay();
        
        // âœ… Aktualizuj nÃ¡zov sÃºboru v hlaviÄke
        if(document.getElementById('fileName')) {
          document.getElementById('fileName').textContent = originalFileName;
        }
        
        // Refresh poÄet zvarov
        updateWeldCount();
        
        // Zavri kniÅ¾nicu
        closeLibrary();
        
        alert('âœ… Projekt naÄÃ­tanÃ½!');
      };
      img.onerror = function() {
        console.error('âŒ PDF load failed!');
        alert('âŒ Chyba pri naÄÃ­tanÃ­ PDF!');
      };
      img.src = projectData.pdfData;
    } else {
      console.warn('âš ï¸ No PDF data in project!');
      alert('âš ï¸ Projekt neobsahuje PDF dÃ¡ta!');
    }
    
  } catch (error) {
    console.error('âŒ Error loading project:', error);
    alert('âŒ Chyba pri naÄÃ­tanÃ­ projektu: ' + error.message);
  }
}

console.log('âœ… Library Manager REAL funkcie naÄÃ­tanÃ©!');

// ============= ğŸ”” AUTO-UPDATE NOTIFICATION SYSTEM =============

// Start checking for updates
function startUpdateChecker() {
  console.log('ğŸ”” Starting update checker (10s interval)...');
  
  // Clear any existing interval
  if (updateCheckInterval) {
    clearInterval(updateCheckInterval);
  }
  
  // Check every 10 seconds
  updateCheckInterval = setInterval(checkForUpdates, 10000);
}

// Stop checking
function stopUpdateChecker() {
  console.log('ğŸ”” Stopping update checker...');
  if (updateCheckInterval) {
    clearInterval(updateCheckInterval);
    updateCheckInterval = null;
  }
}

// Check if project was updated
async function checkForUpdates() {
  // Only check if we have a project loaded from Firebase
  if (!currentProjectName || !currentProjectTimestamp) {
    return;
  }
  
  // Don't check if offline
  if (!navigator.onLine) {
    return;
  }
  
  try {
    // Get project metadata from Firebase
    const docRef = db.collection('projects').doc(currentProjectName);
    const doc = await docRef.get();
    
    if (!doc.exists) {
      return;
    }
    
    const data = doc.data();
    const firebaseTimestamp = data.savedDate || null;
    
    // Compare timestamps
    if (firebaseTimestamp && firebaseTimestamp !== currentProjectTimestamp) {
      console.log('âš ï¸ UPDATE DETECTED!');
      console.log('  Current:', currentProjectTimestamp);
      console.log('  Firebase:', firebaseTimestamp);
      
      // Show notification
      showUpdateNotification();
      
      // Stop checking (user needs to manually refresh)
      stopUpdateChecker();
    }
    
  } catch (error) {
    console.error('âŒ Error checking for updates:', error);
    // Don't show error to user, just log it
  }
}

// Show update notification banner
function showUpdateNotification() {
  const banner = document.getElementById('updateNotification');
  const projectEl = document.getElementById('updateNotificationProject');
  
  if (banner && projectEl) {
    // Zobraz nÃ¡zov projektu
    projectEl.textContent = `ğŸ“ ${currentProjectName}`;
    banner.style.display = 'block';
    
    // Pridaj do histÃ³rie
    const notification = {
      project: currentProjectName,
      timestamp: new Date().toISOString(),
      read: false
    };
    updateHistory.unshift(notification); // Pridaj na zaÄiatok
    
    // UloÅ¾ do localStorage
    try {
      localStorage.setItem('weldpro_update_history', JSON.stringify(updateHistory));
    } catch (e) {
      console.warn('Failed to save update history:', e);
    }
    
    // Update badge
    updateNotificationBadge();
  }
}

// IgnorovaÅ¥ - skry banner ale nechaj v histÃ³rii
function ignoreUpdateNotification(event) {
  if (event) event.stopPropagation();
  
  const banner = document.getElementById('updateNotification');
  if (banner) {
    banner.style.display = 'none';
  }
  
  // NotifikÃ¡cia zostÃ¡va v histÃ³rii (read: false)
  console.log('â­ï¸ Notification ignored, added to history');
  
  // Restart checker
  startUpdateChecker();
}

// Dismiss notification - vymaÅ¾ z histÃ³rie
function dismissUpdateNotification(event) {
  if (event) event.stopPropagation();
  
  const banner = document.getElementById('updateNotification');
  if (banner) {
    banner.style.display = 'none';
  }
  
  // Mark as read (ale nechaj v histÃ³rii pre audit)
  if (updateHistory.length > 0 && !updateHistory[0].read) {
    updateHistory[0].read = true;
    try {
      localStorage.setItem('weldpro_update_history', JSON.stringify(updateHistory));
    } catch (e) {}
  }
  
  // Update badge
  updateNotificationBadge();
  
  // Restart checker
  startUpdateChecker();
}

// Update badge na zvonÄeku
function updateNotificationBadge() {
  const badge = document.getElementById('notificationsBadge');
  const unreadCount = updateHistory.filter(n => !n.read).length;
  
  if (badge) {
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  }
}

// Refresh project from notification
async function refreshProjectFromNotification(event) {
  if (event) event.stopPropagation();
  
  console.log('ğŸ”„ Refreshing project from notification...');
  
  // Hide notification
  const banner = document.getElementById('updateNotification');
  if (banner) {
    banner.style.display = 'none';
  }
  
  if (!currentProjectName) {
    alert('âŒ Nie je naÄÃ­tanÃ½ Å¾iadny projekt!');
    return;
  }
  
  try {
    // Show loading
    if (banner) {
      banner.innerHTML = '<div style="text-align:center;padding:15px"><div style="font-size:24px">â³</div><div style="font-size:14px;color:white">NaÄÃ­tavam...</div></div>';
      banner.style.display = 'block';
    }
    
    // Mark as read
    if (updateHistory.length > 0 && !updateHistory[0].read) {
      updateHistory[0].read = true;
      updateHistory[0].refreshed = true;
      try {
        localStorage.setItem('weldpro_update_history', JSON.stringify(updateHistory));
      } catch (e) {}
    }
    
    // Reload project from Firebase
    await loadFromLibraryFirebase(currentProjectName);
    
    // Hide banner
    if (banner) {
      banner.style.display = 'none';
    }
    
    alert('âœ… Projekt obnovenÃ½!\n\nNaÄÃ­tanÃ¡ najnovÅ¡ia verzia z Firebase.');
    
    // Update badge
    updateNotificationBadge();
    
    // Restart checker
    startUpdateChecker();
    
  } catch (error) {
    console.error('âŒ Error refreshing:', error);
    alert('âŒ Chyba pri obnove projektu:\n\n' + error.message);
  }
}

console.log('âœ… Update checker system loaded!');

// PomocnÃ© funkcie pre update history

// FormÃ¡tovanie Äasu
function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  if (seconds < 60) return 'PrÃ¡ve teraz';
  if (seconds < 3600) return Math.floor(seconds / 60) + ' min';
  if (seconds < 86400) return Math.floor(seconds / 3600) + ' hod';
  if (seconds < 604800) return Math.floor(seconds / 86400) + ' dnÃ­';
  
  return date.toLocaleDateString('sk-SK');
}

// Mark notification as read
function markAsRead(index) {
  if (updateHistory[index]) {
    updateHistory[index].read = true;
    try {
      localStorage.setItem('weldpro_update_history', JSON.stringify(updateHistory));
    } catch (e) {}
    
    updateNotificationBadge();
    loadUpdateHistory(); // Refresh display
  }
}

// Refresh specific project from history
async function refreshSpecificProject(projectName, index) {
  console.log('ğŸ”„ Refreshing project from history:', projectName);
  
  try {
    // Show loading in panel
    const content = document.getElementById('notificationsContent');
    if (content) {
      content.innerHTML = '<div style="text-align:center;padding:40px"><div style="font-size:32px">â³</div><div style="font-size:14px;margin-top:10px">NaÄÃ­tavam projekt...</div></div>';
    }
    
    // Load project
    await loadFromLibraryFirebase(projectName);
    
    // Mark as read and refreshed
    if (updateHistory[index]) {
      updateHistory[index].read = true;
      updateHistory[index].refreshed = true;
      try {
        localStorage.setItem('weldpro_update_history', JSON.stringify(updateHistory));
      } catch (e) {}
    }
    
    // Close panel
    toggleNotificationsPanel();
    
    alert('âœ… Projekt naÄÃ­tanÃ½!\n\n' + projectName);
    
    updateNotificationBadge();
    
  } catch (error) {
    console.error('âŒ Error refreshing:', error);
    alert('âŒ Chyba pri naÄÃ­tanÃ­:\n\n' + error.message);
    loadUpdateHistory(); // Refresh display
  }
}

// Load update history on startup
(function() {
  try {
    const saved = localStorage.getItem('weldpro_update_history');
    if (saved) {
      updateHistory = JSON.parse(saved);
      updateNotificationBadge();
      console.log('ğŸ“œ Loaded update history:', updateHistory.length, 'notifications');
    }
  } catch (e) {
    console.warn('Failed to load update history:', e);
  }
})();

console.log('âœ… Update notification center loaded!');

</script>


<!-- MODAL: Admin Panel -->
<div id="adminPanel" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='adminPanel')closeAdminPanel()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:95%;max-width:1400px;height:90%;display:flex;flex-direction:column" onclick="event.stopPropagation()">
<div style="padding:25px;background:linear-gradient(135deg,#8b5cf6,#6d28d9);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:white;font-size:24px">âš™ï¸ Admin Panel - SprÃ¡va pouÅ¾Ã­vateÄ¾ov</h2>
<button onclick="closeAdminPanel()" style="background:transparent;border:none;font-size:32px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>

<div style="display:flex;flex:1;overflow:hidden">
<!-- LEFT SIDEBAR - User list -->
<div style="width:350px;background:#f5f5f5;border-right:2px solid #ddd;display:flex;flex-direction:column">
<div style="padding:15px;border-bottom:1px solid #ddd">
<input type="text" id="adminUserSearch" placeholder="ğŸ” HÄ¾adaÅ¥ pouÅ¾Ã­vateÄ¾a..." style="width:100%;padding:10px;border:2px solid #8b5cf6;border-radius:8px;font-size:14px" oninput="filterAdminUsers()">
</div>
<div style="padding:15px;background:linear-gradient(135deg,#10b981,#059669)">
<button onclick="showAddUserForm()" style="width:100%;background:white;color:#10b981;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px">â• PridaÅ¥ pouÅ¾Ã­vateÄ¾a</button>
</div>
<div id="adminUsersList" style="flex:1;overflow-y:auto;padding:10px">
<div style="text-align:center;color:#999;padding:20px">NaÄÃ­tavam...</div>
</div>
</div>

<!-- RIGHT CONTENT - Details/Form -->
<div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
<div id="adminContent" style="flex:1;overflow-y:auto;padding:30px">
<div style="text-align:center;color:#999;padding:60px">
<div style="font-size:64px;margin-bottom:20px">ğŸ‘¥</div>
<h3 style="color:#666">Vyber pouÅ¾Ã­vateÄ¾a zo zoznamu</h3>
<p style="color:#999">alebo klikni na "â• PridaÅ¥ pouÅ¾Ã­vateÄ¾a"</p>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- MODAL: Pending Changes Details -->
<div id="pendingChangesModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='pendingChangesModal')closePendingChanges()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:90%;max-width:900px;height:85%;display:flex;flex-direction:column" onclick="event.stopPropagation()">
<div style="padding:25px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<div>
<h2 style="margin:0;color:white;font-size:24px">ğŸ“‹ NeuloÅ¾enÃ© zmeny</h2>
<p style="margin:5px 0 0 0;color:rgba(255,255,255,0.9);font-size:14px">Tieto zmeny sa nahrÃ¡ pri synchronizÃ¡cii</p>
</div>
<button onclick="closePendingChanges()" style="background:transparent;border:none;font-size:32px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>

<div id="pendingChangesList" style="flex:1;overflow-y:auto;padding:20px">
<div style="text-align:center;color:#999;padding:40px">NaÄÃ­tavam...</div>
</div>

<div style="padding:20px;background:#f5f5f5;border-top:2px solid #ddd;display:flex;gap:10px">
<button onclick="closePendingChanges()" style="flex:1;background:#6b7280;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600">ZavrieÅ¥</button>
<button onclick="closePendingChanges();syncOfflineData()" id="syncFromModal" style="flex:2;background:#f59e0b;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px">ğŸ“¤ NahraÅ¥ teraz</button>
</div>
</div>
</div>

<!-- MODAL: HistÃ³ria dodacÃ­ch listov -->
<div id="deliveryHistoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='deliveryHistoryModal')closeDeliveryHistory()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);width:90%;max-width:1200px;max-height:85%;overflow:hidden;display:flex;flex-direction:column">
<div style="padding:20px;border-bottom:2px solid #8b5cf6;background:linear-gradient(135deg,#8b5cf6,#6d28d9);display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:white">ğŸ“‹ HistÃ³ria dodacÃ­ch listov</h2>
<button onclick="closeDeliveryHistory()" style="background:transparent;border:none;font-size:28px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>
<div style="padding:15px;background:#f5f5f5;border-bottom:1px solid #ddd">
<input type="text" id="deliveryHistorySearch" placeholder="ğŸ” HÄ¾adaÅ¥ podÄ¾a ÄÃ­sla, dÃ¡tumu alebo projektu..." style="width:100%;padding:12px;font-size:14px;border:2px solid #8b5cf6;border-radius:8px" oninput="filterDeliveryHistory()">
</div>
<div id="deliveryHistoryContent" style="padding:20px;overflow-y:auto;flex:1">
<div style="text-align:center;color:#999;padding:40px">NaÄÃ­tavam...</div>
</div>
</div>
</div>

<!-- FLOATING CHAT BUTTON -->
<button onclick="toggleChatPanel()" id="chatFloatingBtn" style="position:fixed;bottom:30px;right:30px;width:65px;height:65px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;box-shadow:0 8px 24px rgba(102,126,234,0.4);cursor:pointer;font-size:28px;z-index:9998;transition:all 0.3s">
ğŸ’¬
<span id="chatUnreadBadge" style="display:none;position:absolute;top:-5px;right:-5px;background:#ef4444;color:white;border-radius:50%;width:24px;height:24px;font-size:12px;font-weight:700;line-height:24px;text-align:center;border:3px solid white"></span>
</button>

<!-- CHAT PANEL -->
<div id="chatPanel" style="display:none;position:fixed;bottom:30px;right:30px;width:380px;height:600px;background:white;border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,0.3);z-index:9999;display:flex;flex-direction:column;overflow:hidden;border:2px solid #e5e7eb">
<!-- Header -->
<div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;justify-content:space-between;align-items:center">
<h3 style="margin:0;font-size:18px">ğŸ’¬ Chat</h3>
<button onclick="toggleChatPanel()" style="background:transparent;border:none;color:white;font-size:24px;cursor:pointer;padding:0">âœ•</button>
</div>

<!-- Conversations List -->
<div id="chatConversationsList" style="padding:10px;background:#f9fafb;border-bottom:1px solid #e5e7eb;max-height:400px;overflow-y:auto">
<div style="text-align:center;color:#999;font-size:12px;padding:20px">NaÄÃ­tavam chaty...</div>
</div>

<!-- New Chat Button -->
<div style="padding:10px;background:#f5f5f5;border-bottom:1px solid #e5e7eb">
<button onclick="showNewChatModal()" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px">â• NovÃ½ chat</button>
</div>

<!-- Messages Area -->
<div id="chatMessagesArea" style="flex:1;overflow-y:auto;padding:15px;background:#ffffff">
<div style="text-align:center;color:#999;padding:40px;font-size:13px">
<div style="font-size:48px;margin-bottom:10px">ğŸ’¬</div>
<p>Vyber konverzÃ¡ciu<br>alebo vytvor novÃº</p>
</div>
</div>

<!-- Message Input -->
<div style="padding:15px;background:#f9fafb;border-top:2px solid #e5e7eb">
<div style="display:flex;gap:10px">
<input type="text" id="chatMessageInput" placeholder="NapÃ­Å¡ sprÃ¡vu..." style="flex:1;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px" onkeypress="if(event.key==='Enter')sendChatMessage()" disabled>
<button onclick="sendChatMessage()" id="chatSendBtn" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600" disabled>ğŸ“¤</button>
</div>
<div id="chatTypingIndicator" style="display:none;font-size:11px;color:#999;margin-top:5px">ğŸ’­ PÃ­Å¡e...</div>
</div>
</div>

<!-- OFFLINE PACKAGE MODAL -->
<div id="offlinePackageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='offlinePackageModal')closeOfflinePackage()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:90%;max-width:700px;max-height:85%;display:flex;flex-direction:column" onclick="event.stopPropagation()">
<div style="padding:25px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<div>
<h2 style="margin:0;color:white;font-size:24px">ğŸ“¦ PripraviÅ¥ projekty pre offline</h2>
<p style="margin:5px 0 0 0;color:rgba(255,255,255,0.9);font-size:13px">Stiahni projekty do prehliadaÄa pre prÃ¡cu bez internetu</p>
</div>
<button onclick="closeOfflinePackage()" style="background:transparent;border:none;font-size:32px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>

<div style="padding:20px;background:#fef3c7;border-bottom:1px solid #fcd34d">
<div style="font-size:13px;color:#78350f">
<strong>ğŸ’¡ Tip:</strong> Vyber projekty ktorÃ© budeÅ¡ potrebovaÅ¥ na stavbe. BudÃº uloÅ¾enÃ© v prehliadaÄi a dostupnÃ© aj bez internetu.
</div>
</div>

<div style="padding:15px 20px;background:#f5f5f5;border-bottom:1px solid #e5e7eb">
<input type="text" id="offlinePackageSearch" placeholder="ğŸ” HÄ¾adaÅ¥ projekt..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px" oninput="filterOfflineProjects()">
</div>

<div id="offlineProjectsList" style="flex:1;overflow-y:auto;padding:20px">
<div style="text-align:center;color:#999;padding:40px">â³ NaÄÃ­tavam projekty...</div>
</div>

<div style="padding:15px 20px;background:#f9fafb;border-top:2px solid #e5e7eb">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<div style="font-size:14px;color:#666">
<strong id="selectedCount">0 projektov</strong> vybranÃ½ch
<span id="selectedSize" style="margin-left:10px;color:#999">(0 KB)</span>
</div>
<div style="font-size:12px;color:#999">
VoÄ¾nÃ©: <span id="availableSpace">~10 MB</span>
</div>
</div>
<div style="display:flex;gap:10px;margin-bottom:10px">
<button onclick="selectAllProjects()" style="flex:1;background:#6b7280;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;font-size:13px">â˜‘ï¸ VybraÅ¥ vÅ¡etky</button>
<button onclick="deselectAllProjects()" style="flex:1;background:#6b7280;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;font-size:13px">â˜ ZruÅ¡iÅ¥ vÃ½ber</button>
</div>
<div style="display:flex;gap:10px">
<button onclick="closeOfflinePackage()" style="flex:1;background:#6b7280;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600">ZruÅ¡iÅ¥</button>
<button onclick="downloadSelectedProjects()" id="downloadOfflineBtn" style="flex:2;background:#f59e0b;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:15px" disabled>â¬‡ï¸ StiahnuÅ¥ vybranÃ© (0)</button>
</div>
</div>
</div>
</div>

<!-- NEW CHAT MODAL -->
<div id="newChatModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001" onclick="if(event.target.id==='newChatModal')closeNewChatModal()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:90%;max-width:450px" onclick="event.stopPropagation()">
<div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<h3 style="margin:0;color:white;font-size:18px">â• NovÃ½ chat</h3>
<button onclick="closeNewChatModal()" style="background:transparent;border:none;color:white;font-size:24px;cursor:pointer;padding:0">âœ•</button>
</div>
<div style="padding:20px">
<input type="text" id="newChatSearch" placeholder="ğŸ” HÄ¾adaÅ¥ pouÅ¾Ã­vateÄ¾a..." style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;margin-bottom:15px;font-size:14px" oninput="filterNewChatUsers()">
<div id="newChatUsersList" style="max-height:400px;overflow-y:auto">
<div style="text-align:center;color:#999;padding:20px">NaÄÃ­tavam...</div>
</div>
</div>
</div>
</div>

<!-- ADMIN CHAT HISTORY MODAL -->
<div id="adminChatHistoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='adminChatHistoryModal')closeAdminChatHistory()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:95%;max-width:1200px;height:90%;display:flex;flex-direction:column" onclick="event.stopPropagation()">
<div style="padding:25px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<h2 style="margin:0;color:white;font-size:24px">ğŸ“œ HistÃ³ria vÅ¡etkÃ½ch chatov (ADMIN)</h2>
<button onclick="closeAdminChatHistory()" style="background:transparent;border:none;font-size:32px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>
<div style="padding:15px;background:#f5f5f5;border-bottom:1px solid #ddd">
<input type="text" id="adminChatSearch" placeholder="ğŸ” HÄ¾adaÅ¥ v sprÃ¡vach, menÃ¡ch, dÃ¡tumoch..." style="width:100%;padding:12px;border:2px solid #667eea;border-radius:8px;font-size:14px" oninput="filterAdminChats()">
</div>
<div id="adminChatHistoryContent" style="flex:1;overflow-y:auto;padding:20px">
<div style="text-align:center;color:#999;padding:40px">NaÄÃ­tavam...</div>
</div>
</div>
</div>

<!-- PDF PREVIEW MODAL -->
<div id="pdfPreviewModal">
<div class="preview-container">
<div class="preview-header">
<h2>ğŸ“„ NÃ¡hÄ¾ad PDF exportu</h2>
<div class="preview-scale-control">
<button onclick="adjustPreviewScale(-0.1)">â–</button>
<span class="preview-scale-display" id="previewScaleDisplay">100%</span>
<button onclick="adjustPreviewScale(0.1)">â•</button>
</div>
</div>
<div class="preview-canvas-wrapper">
<canvas id="pdfPreviewCanvas"></canvas>
</div>
<div class="preview-controls">
<div class="preview-actions">
<button class="preview-btn preview-btn-cancel" onclick="closePDFPreview()">âŒ ZruÅ¡iÅ¥</button>
<button class="preview-btn preview-btn-export" onclick="confirmPDFExport()">âœ… ExportovaÅ¥ PDF</button>
</div>
</div>
</div>
</div>

<!-- MODAL: Offline reÅ¾im - naÄÃ­tanie stiahnutÃ½ch projektov -->
<div id="offlineModeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000" onclick="if(event.target.id==='offlineModeModal')closeOfflineModeModal()">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);width:90%;max-width:600px;max-height:80%;display:flex;flex-direction:column" onclick="event.stopPropagation()">
<div style="padding:25px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
<div>
<h2 style="margin:0;color:white;font-size:24px">ğŸ“± Offline reÅ¾im</h2>
<p style="margin:5px 0 0 0;color:rgba(255,255,255,0.9);font-size:13px">NaÄÃ­taj stiahnutÃ© projekty (funguje aj bez internetu)</p>
</div>
<button onclick="closeOfflineModeModal()" style="background:transparent;border:none;font-size:32px;cursor:pointer;color:white;padding:5px 10px">âœ•</button>
</div>

<div style="padding:15px 20px;background:#f5f5f5;border-bottom:1px solid #e5e7eb">
<input type="text" id="offlineModeSearch" placeholder="ğŸ” HÄ¾adaÅ¥ projekt..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px" oninput="filterOfflineModeProjects()">
</div>

<div id="offlineModeProjectsList" style="flex:1;overflow-y:auto;padding:20px">
<div style="text-align:center;color:#999;padding:40px">ğŸ“± NaÄÃ­tavam offline projekty...</div>
</div>

<div style="padding:15px 20px;background:#f9fafb;border-top:2px solid #e5e7eb">
<button onclick="closeOfflineModeModal()" style="width:100%;background:#6b7280;color:white;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:600">ZavrieÅ¥</button>
</div>
</div>
</div>

<!-- MODAL: PridaÅ¥ zvaraÄa v MONTÃÅ½ -->
<div id="montazWelderModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;justify-content:center;align-items:center;">
<div style="background:white;padding:30px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:400px;width:90%;">
<h3 style="margin:0 0 20px 0;color:#333;">OznaÄiÅ¥ zvar <span id="montazWelderWeldNum"></span></h3>
<div style="margin-bottom:15px;">
<label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Welder ID:</label>
<input type="text" id="montazWelderInput" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;" placeholder="Napr: SD5">
</div>
<div style="margin-bottom:20px;">
<label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">DÃ¡tum zvarania:</label>
<input type="date" id="montazDateInput" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
</div>
<div style="display:flex;gap:10px;">
<button onclick="saveMontazWelder()" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:bold;">âœ… UloÅ¾iÅ¥</button>
<button onclick="closeMontazWelderModal()" style="flex:1;padding:10px;background:#e5e5e5;color:#333;border:none;border-radius:4px;cursor:pointer;font-size:14px;">âŒ ZruÅ¡iÅ¥</button>
</div>
</div>
</div>

</body></html>
